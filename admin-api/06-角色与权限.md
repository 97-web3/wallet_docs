# 角色与权限

> 返回 [后台管理服务目录](./README.md)

---

## 模块概述

角色与权限模块定义系统的 RBAC (基于角色的访问控制) 权限体系，包括角色定义、权限矩阵和接口级权限映射。

---

## 角色定义

### 系统角色

| 角色 | 代码 | 描述 | 用户范围 |
|------|------|------|----------|
| 超级管理员 | super_admin | 最高权限，可管理其他 Admin | 限定少数人 |
| 管理员 | admin | 系统管理权限 | IT/运维人员 |
| 财务 | finance | 财务相关权限 | 财务人员 |
| 员工 | employee | 基础用户权限 | 普通员工 |

### 角色继承关系

```
super_admin
    │
    └── admin
         │
         └── finance
              │
              └── employee (基础权限)
```

---

## RBAC 权限矩阵

### Admin 功能权限

| 功能 | super_admin | admin | finance | employee |
|------|-------------|-------|---------|----------|
| **Dashboard** |
| 查看统计数据 | ✓ | ✓ | ✓ | ✗ |
| 查看 Vault 余额 | ✓ | ✓ | ✓ | ✗ |
| 配置告警阈值 | ✓ | ✓ | ✗ | ✗ |
| **用户管理** |
| 查看用户列表 | ✓ | ✓ | ✗ | ✗ |
| 冻结/解冻用户 | ✓ | ✓ | ✗ | ✗ |
| 离职处理 | ✓ | ✓ | ✗ | ✗ |
| 更新用户角色 | ✓ | ✓* | ✗ | ✗ |
| **薪资发放** |
| 导入薪资批次 | ✓ | ✓ | ✓ | ✗ |
| 审批薪资批次 | ✓ | ✓ | ✓ | ✗ |
| 查看薪资历史 | ✓ | ✓ | ✓ | ✗ |
| 导出薪资报表 | ✓ | ✓ | ✓ | ✗ |
| **提现审批** |
| 查看待审批列表 | ✓ | ✓ | ✓ | ✗ |
| 审批/驳回提现 | ✓ | ✓ | ✓ | ✗ |
| 配置 AML 规则 | ✓ | ✓ | ✗ | ✗ |
| **Swap 配置** |
| 查看 Swap 配置 | ✓ | ✓ | ✗ | ✗ |
| 修改 Swap 配置 | ✓ | ✓ | ✗ | ✗ |
| 管理 DEX 提供商 | ✓ | ✓ | ✗ | ✗ |
| **账本与 Vault** |
| 查看账本记录 | ✓ | ✓ | ✓ | ✗ |
| 导出账本 | ✓ | ✓ | ✓ | ✗ |
| 调整 Vault 余额 | ✓ | ✓ | ✗ | ✗ |
| **角色管理** |
| 查看角色列表 | ✓ | ✓ | ✗ | ✗ |
| 创建 Admin 角色 | ✓ | ✗ | ✗ | ✗ |
| 创建 Finance 角色 | ✓ | ✓ | ✗ | ✗ |

> *admin 只能设置 finance/employee 角色，不能设置 admin/super_admin

---

## 接口权限映射

### API Gateway 路由权限配置

```yaml
# Admin Routes
/api/v1/admin/dashboard/**:
  roles: [super_admin, admin, finance]

/api/v1/admin/users/**:
  roles: [super_admin, admin]

/api/v1/admin/payroll/**:
  roles: [super_admin, admin, finance]

/api/v1/admin/withdraw/**:
  roles: [super_admin, admin, finance]

/api/v1/admin/swap/**:
  roles: [super_admin, admin]

/api/v1/admin/ledger/**:
  roles: [super_admin, admin, finance]

/api/v1/admin/roles/**:
  roles: [super_admin, admin]
```

### 权限检查中间件

```
请求进入
    │
    ▼
┌─────────────────┐
│  JWT Token 解析  │
│  提取 user_id   │
│  提取 role      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  路由权限匹配    │
│  检查 role 是否  │
│  在允许列表内   │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 有权限   │ 无权限
    ▼         ▼
  继续处理   返回 403
```

---

## F-ADMIN-060: 获取角色列表

**描述**: 获取系统角色定义和权限说明。

**gRPC 方法**: `GetRoles`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "roles": [
    {
      "code": "super_admin",
      "name": "超级管理员",
      "description": "最高权限，可管理其他管理员",
      "user_count": 2,
      "permissions": ["*"]
    },
    {
      "code": "admin",
      "name": "管理员",
      "description": "系统管理权限",
      "user_count": 5,
      "permissions": [
        "dashboard:read", "dashboard:write",
        "users:read", "users:write",
        "payroll:*",
        "withdraw:*",
        "swap:*",
        "ledger:read", "ledger:write"
      ]
    },
    {
      "code": "finance",
      "name": "财务",
      "description": "财务相关权限",
      "user_count": 10,
      "permissions": [
        "dashboard:read",
        "payroll:*",
        "withdraw:*",
        "ledger:read"
      ]
    },
    {
      "code": "employee",
      "name": "员工",
      "description": "基础用户权限",
      "user_count": 1000,
      "permissions": []
    }
  ]
}
```

---

## F-ADMIN-061: 分配用户角色

**描述**: 为用户分配系统角色。

**gRPC 方法**: `AssignRole`

**权限要求**:
- super_admin: 可分配任意角色
- admin: 只能分配 finance/employee

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD",
  "role": "finance",
  "reason": "晋升为财务人员"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "角色已分配",
  "uid": "U20251210ABCD",
  "old_role": "employee",
  "new_role": "finance",
  "assigned_at": "2025-12-10T10:00:00Z"
}
```

**业务规则**:
- 角色变更立即生效
- 降级时需检查是否有未完成的审批任务
- 角色变更记入审计日志
- 发送通知给目标用户

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81060 | 用户不存在 |
| 81061 | 无效的角色 |
| 81062 | 无权分配该角色 |
| 81063 | 用户有未完成任务 |

---

## F-ADMIN-062: 查询用户权限

**描述**: 查询指定用户的权限列表。

**gRPC 方法**: `GetUserPermissions`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "uid": "U20251210ABCD",
  "role": "finance",
  "role_name": "财务",
  "permissions": [
    {
      "resource": "dashboard",
      "actions": ["read"],
      "description": "查看 Dashboard"
    },
    {
      "resource": "payroll",
      "actions": ["read", "write", "approve"],
      "description": "薪资发放管理"
    },
    {
      "resource": "withdraw",
      "actions": ["read", "approve", "reject"],
      "description": "提现审批"
    },
    {
      "resource": "ledger",
      "actions": ["read", "export"],
      "description": "账本查询"
    }
  ]
}
```

---

## 权限代码规范

### 权限格式

```
{resource}:{action}
```

### 标准资源列表

| 资源 | 说明 |
|------|------|
| dashboard | Dashboard 统计 |
| users | 用户管理 |
| payroll | 薪资发放 |
| withdraw | 提现审批 |
| swap | Swap 配置 |
| ledger | 账本管理 |
| vault | Vault 管理 |
| roles | 角色管理 |

### 标准操作列表

| 操作 | 说明 |
|------|------|
| read | 读取/查看 |
| write | 创建/修改 |
| delete | 删除 |
| approve | 审批 |
| reject | 驳回 |
| export | 导出 |
| * | 全部操作 |

---

## 双重控制 (Dual Control)

### 适用场景

以下高风险操作需要双重控制（两人审批）：

| 操作 | 第一审批人 | 第二审批人 |
|------|------------|------------|
| 调整 Vault 余额 > 100,000 USDT | finance | admin |
| 审批提现 > 50,000 USDT | finance | admin |
| 创建 Admin 角色 | admin | super_admin |
| 批量薪资发放 > 500,000 USDT | finance | admin |

### 流程

```
操作发起
    │
    ▼
第一审批人审批
    │
    ▼
待第二审批
    │
    ▼
第二审批人审批
    │
    ▼
执行操作
```

---

## 审计日志

权限相关操作记录：

| 字段 | 说明 |
|------|------|
| action | 操作类型 (assign_role/revoke_role) |
| target_uid | 目标用户 |
| old_role | 原角色 |
| new_role | 新角色 |
| operator_id | 操作人 |
| operator_role | 操作人角色 |
| reason | 操作原因 |
| operated_at | 操作时间 |

---

> 返回 [后台管理服务目录](./README.md)
