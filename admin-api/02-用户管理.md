# 用户管理

> 返回 [后台管理服务目录](./README.md)

---

## F-ADMIN-010: 管理员获取用户列表

**描述**: 获取系统用户列表，支持筛选和搜索。

**gRPC 方法**: `AdminListUsers`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "status": "",               // 可选: active/frozen/terminated
  "role": "",                 // 可选: admin/finance/employee
  "search": "",               // 可选: 搜索 UID/手机号/邮箱
  "sort_by": "created_at",    // 排序字段
  "sort_order": "desc"        // asc/desc
}
```

**响应 Schema**:
```json
{
  "success": true,
  "users": [
    {
      "uid": "U20251210ABCD",
      "nickname": "用户昵称",
      "avatar_url": "https://...",
      "phone": "138****0000",         // 脱敏显示
      "email": "a***@gmail.com",      // 脱敏显示
      "status": "active",
      "status_text": "正常",
      "role": "employee",
      "role_text": "员工",
      "has_web2_wallet": true,
      "has_web3_wallet": true,
      "balance_usdt": "1000.00",      // Web2 钱包余额
      "last_login_at": "2025-12-10T08:00:00Z",
      "created_at": "2025-01-15T10:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 1500,
    "total_pages": 75
  }
}
```

**业务规则**:
- 手机号/邮箱脱敏显示，保护用户隐私
- Admin 角色可查看完整信息（需单独接口）
- 默认按创建时间倒序排列

---

## F-ADMIN-011: 冻结用户

**描述**: 冻结用户账户，禁止登录和所有操作。

**gRPC 方法**: `AdminFreezeUser`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD",
  "reason": "涉嫌违规操作",
  "freeze_assets": true,      // 是否同时冻结资产
  "notify_user": true         // 是否通知用户
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "用户已冻结",
  "uid": "U20251210ABCD",
  "new_status": "frozen",
  "frozen_at": "2025-12-10T10:00:00Z",
  "sessions_terminated": 3    // 终止的活跃会话数
}
```

**业务规则**:
- 冻结后立即失效所有 Token，强制登出
- 冻结后禁止登录、转账、提现等所有操作
- `freeze_assets`: 若为 true，同时将用户资产标记为冻结状态
- 冻结操作记入审计日志
- 可选发送通知给用户说明原因

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81001 | 用户不存在 |
| 81002 | 用户已被冻结 |
| 81003 | 无权冻结该用户（如 Admin 不能冻结其他 Admin） |

---

## F-ADMIN-012: 解冻用户

**描述**: 解除用户冻结状态，恢复正常使用。

**gRPC 方法**: `AdminUnfreezeUser`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD",
  "reason": "审核通过，解除冻结",
  "unfreeze_assets": true,    // 是否同时解冻资产
  "notify_user": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "用户已解冻",
  "uid": "U20251210ABCD",
  "new_status": "active",
  "unfrozen_at": "2025-12-10T10:00:00Z"
}
```

**业务规则**:
- 解冻后用户可正常登录
- 若资产被冻结，需 `unfreeze_assets: true` 一并解冻
- 解冻操作记入审计日志
- 可选发送通知告知用户

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81001 | 用户不存在 |
| 81004 | 用户未被冻结 |

---

## F-ADMIN-013: 用户离职处理

**描述**: 处理员工离职，包括账户禁用和资产处理。

**gRPC 方法**: `AdminTerminateUser`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD",
  "reason": "员工离职",
  "asset_handling": "transfer",   // transfer/freeze/keep
  "transfer_to_uid": "U20251210EFGH",  // asset_handling=transfer 时必填
  "notify_user": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "离职处理完成",
  "uid": "U20251210ABCD",
  "new_status": "terminated",
  "terminated_at": "2025-12-10T10:00:00Z",
  "asset_handling_result": {
    "action": "transfer",
    "assets_transferred": [
      { "asset": "USDT", "amount": "1000.00", "to_uid": "U20251210EFGH" }
    ]
  }
}
```

**业务规则**:
- 离职处理前检查是否有待处理交易
- 若有待处理交易，返回错误并列出待处理项
- 资产处理选项：
  - `transfer`: 转移到指定账户
  - `freeze`: 冻结资产（待后续处理）
  - `keep`: 保留不动（用户可能复职）
- 离职后账户状态为 `terminated`，不可登录
- 所有操作记入审计日志

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81001 | 用户不存在 |
| 81005 | 用户有待处理交易，无法离职 |
| 81006 | 转移目标用户不存在 |
| 81007 | 用户已离职 |

---

## F-ADMIN-014: 更新用户角色

**描述**: 更新用户的角色分配。

**gRPC 方法**: `AdminUpdateUserRole`

**权限要求**: Admin 角色

**请求 Schema**:
```json
{
  "uid": "U20251210ABCD",
  "new_role": "finance",      // admin/finance/employee
  "reason": "晋升为财务人员"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "角色已更新",
  "uid": "U20251210ABCD",
  "old_role": "employee",
  "new_role": "finance",
  "updated_at": "2025-12-10T10:00:00Z"
}
```

**业务规则**:
- 角色变更立即生效
- 角色降级时，若有未完成的审批任务需先转交
- Admin 角色变更需要更高级别权限（如超级管理员）
- 角色变更记入审计日志

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81001 | 用户不存在 |
| 81008 | 无效的角色类型 |
| 81009 | 无权设置该角色 |
| 81010 | 用户有未完成任务，需先转交 |

---

## 用户状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| active | 1 | 正常 |
| frozen | 2 | 已冻结 |
| terminated | 3 | 已离职/禁用 |

### 状态流转

```
                    ┌──────────────────────┐
                    │       active         │
                    └──────────┬───────────┘
                               │
              ┌────────────────┼────────────────┐
              │ 冻结            │                │ 离职
              ▼                │                ▼
       ┌──────────────┐       │         ┌──────────────┐
       │    frozen    │       │         │  terminated  │
       └──────┬───────┘       │         └──────────────┘
              │ 解冻           │
              └───────────────┘
```

---

## 审计日志

所有用户管理操作记录以下信息：

| 字段 | 说明 |
|------|------|
| operator_id | 操作人 UID |
| operator_role | 操作人角色 |
| action | 操作类型 (freeze/unfreeze/terminate/update_role) |
| target_uid | 目标用户 UID |
| reason | 操作原因 |
| before_status | 操作前状态 |
| after_status | 操作后状态 |
| client_ip | 客户端 IP |
| operated_at | 操作时间 |

---

> 返回 [后台管理服务目录](./README.md)
