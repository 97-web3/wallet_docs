# 数据模型与配置

> 返回 [后台管理服务目录](./README.md)

---

## 数据库表结构

### vault_balances - Vault 余额表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| asset | VARCHAR(20) | 资产类型 (USDT/TRX/BNB/ETH) |
| chain | VARCHAR(20) | 区块链 (TRX/BSC/ETH) |
| balance | DECIMAL(36,18) | 当前余额 |
| frozen_balance | DECIMAL(36,18) | 冻结余额 |
| hot_wallet_address | VARCHAR(100) | Hot Wallet 地址 |
| cold_wallet_address | VARCHAR(100) | Cold Wallet 地址 |
| min_threshold | DECIMAL(36,18) | 最小阈值 |
| max_threshold | DECIMAL(36,18) | 最大阈值 |
| alert_enabled | BOOLEAN | 是否启用告警 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (asset, chain)

---

### vault_adjustments - Vault 调整记录表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| adjustment_id | VARCHAR(50) | 调整单号 (ADJ + 日期 + 序号) |
| asset | VARCHAR(20) | 资产类型 |
| chain | VARCHAR(20) | 区块链 |
| adjustment_type | TINYINT | 调整类型 (1:增加, 2:减少) |
| amount | DECIMAL(36,18) | 调整金额 |
| balance_before | DECIMAL(36,18) | 调整前余额 |
| balance_after | DECIMAL(36,18) | 调整后余额 |
| reason | VARCHAR(500) | 调整原因 |
| reference_tx | VARCHAR(100) | 关联交易哈希 |
| status | TINYINT | 状态 (1:待审批, 2:已审批, 3:已拒绝, 4:已完成) |
| operator_id | VARCHAR(50) | 操作人 UID |
| approver_id | VARCHAR(50) | 审批人 UID |
| approve_comment | VARCHAR(500) | 审批备注 |
| idempotency_key | VARCHAR(100) | 幂等键 |
| created_at | TIMESTAMP | 创建时间 |
| approved_at | TIMESTAMP | 审批时间 |
| completed_at | TIMESTAMP | 完成时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (adjustment_id)
- UNIQUE KEY (idempotency_key)
- KEY (asset, chain, created_at)
- KEY (operator_id, created_at)
- KEY (status)

---

### payroll_batches - 薪资批次表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| batch_id | VARCHAR(50) | 批次号 (PAY-日期-序号) |
| batch_hash | VARCHAR(64) | 文件内容哈希 (防重复导入) |
| file_name | VARCHAR(200) | 原始文件名 |
| memo | VARCHAR(200) | 批次备注 |
| total_rows | INT | 总行数 |
| valid_rows | INT | 有效行数 |
| invalid_rows | INT | 无效行数 |
| success_count | INT | 成功数 |
| failed_count | INT | 失败数 |
| total_amount_usdt | DECIMAL(36,18) | 总金额(USDT) |
| status | TINYINT | 状态 (见状态机) |
| created_by | VARCHAR(50) | 创建人 UID |
| approved_by | VARCHAR(50) | 审批人 UID |
| reject_reason | VARCHAR(500) | 驳回原因 |
| created_at | TIMESTAMP | 创建时间 |
| expires_at | TIMESTAMP | 过期时间 |
| processed_at | TIMESTAMP | 处理时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (batch_id)
- UNIQUE KEY (batch_hash)
- KEY (status, created_at)
- KEY (created_by, created_at)

**状态枚举**:
| 值 | 状态 | 说明 |
|----|------|------|
| 1 | pending_review | 待审核 |
| 2 | approved | 已审批（处理中） |
| 3 | completed | 已完成 |
| 4 | partial_completed | 部分完成 |
| 5 | rejected | 已驳回 |
| 6 | expired | 已过期 |

---

### payroll_items - 薪资明细表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| batch_id | VARCHAR(50) | 批次号 |
| item_id | VARCHAR(50) | 明细ID |
| row_number | INT | Excel 行号 |
| user_uid | VARCHAR(50) | 员工 UID |
| asset | VARCHAR(20) | 币种 |
| amount | DECIMAL(36,18) | 金额 |
| amount_usdt | DECIMAL(36,18) | USDT 等值 |
| memo | VARCHAR(200) | 备注 |
| status | TINYINT | 状态 (1:待处理, 2:成功, 3:失败, 4:跳过) |
| transfer_id | VARCHAR(50) | 转账ID (成功时) |
| error_code | VARCHAR(50) | 错误码 (失败时) |
| error_message | VARCHAR(500) | 错误信息 |
| processed_at | TIMESTAMP | 处理时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (item_id)
- KEY (batch_id, row_number)
- KEY (user_uid)
- KEY (status)

---

### ledger_entries - 账本流水表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| ledger_id | VARCHAR(50) | 账本ID |
| user_uid | VARCHAR(50) | 用户 UID |
| type | VARCHAR(20) | 类型 (deposit/withdraw/transfer_in/transfer_out/swap_sell/swap_buy/payroll/adjustment/fee/freeze/unfreeze) |
| asset | VARCHAR(20) | 资产 |
| chain | VARCHAR(20) | 区块链 |
| amount | DECIMAL(36,18) | 金额 (正/负) |
| amount_usdt | DECIMAL(36,18) | USDT 等值 |
| fee | DECIMAL(36,18) | 手续费 |
| balance_before | DECIMAL(36,18) | 变动前余额 |
| balance_after | DECIMAL(36,18) | 变动后余额 |
| related_id | VARCHAR(50) | 关联业务ID |
| related_type | VARCHAR(20) | 关联类型 |
| tx_hash | VARCHAR(100) | 链上哈希 |
| from_address | VARCHAR(100) | 来源地址 |
| to_address | VARCHAR(100) | 目标地址 |
| status | TINYINT | 状态 |
| memo | VARCHAR(500) | 备注 |
| created_at | TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (ledger_id)
- KEY (user_uid, created_at)
- KEY (type, created_at)
- KEY (asset, chain, created_at)
- KEY (related_id, related_type)
- KEY (tx_hash)

---

### admin_audit_logs - 管理员审计日志表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| log_id | VARCHAR(50) | 日志ID |
| operator_id | VARCHAR(50) | 操作人 UID |
| operator_role | VARCHAR(20) | 操作人角色 |
| action | VARCHAR(50) | 操作类型 |
| module | VARCHAR(50) | 模块 (user/payroll/withdraw/swap/vault/role) |
| target_id | VARCHAR(50) | 目标ID |
| target_type | VARCHAR(20) | 目标类型 |
| before_value | JSON | 操作前值 |
| after_value | JSON | 操作后值 |
| reason | VARCHAR(500) | 操作原因 |
| client_ip | VARCHAR(50) | 客户端 IP |
| user_agent | VARCHAR(500) | User Agent |
| request_id | VARCHAR(50) | 请求 ID |
| created_at | TIMESTAMP | 操作时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (log_id)
- KEY (operator_id, created_at)
- KEY (action, created_at)
- KEY (module, target_id)
- KEY (created_at)

---

### alert_thresholds - 告警阈值配置表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| alert_type | VARCHAR(50) | 告警类型 |
| asset | VARCHAR(20) | 资产 (可选) |
| chain | VARCHAR(20) | 链 (可选) |
| threshold_value | DECIMAL(36,18) | 阈值 |
| comparison | VARCHAR(10) | 比较方式 (lt/gt/eq) |
| enabled | BOOLEAN | 是否启用 |
| notify_channels | JSON | 通知渠道 |
| updated_by | VARCHAR(50) | 更新人 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (alert_type, asset, chain)

---

### swap_config - Swap 配置表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| config_key | VARCHAR(100) | 配置键 |
| config_value | JSON | 配置值 |
| description | VARCHAR(500) | 描述 |
| updated_by | VARCHAR(50) | 更新人 |
| updated_at | TIMESTAMP | 更新时间 |

**配置键列表**:
| config_key | 说明 | 示例值 |
|------------|------|--------|
| swap_enabled | 闪兑功能开关 | true |
| default_slippage | 默认滑点 | 0.005 |
| min_slippage | 最小滑点 | 0.001 |
| max_slippage | 最大滑点 | 0.50 |
| preset_slippage_options | 预设滑点选项 | [0.001, 0.005, 0.01, 0.03] |
| min_swap_amount_usdt | 最小兑换金额 | "10.00" |
| max_swap_amount_usdt | 最大兑换金额 | "100000.00" |
| daily_swap_limit_usdt | 每日限额 | "500000.00" |
| platform_fee_rate | 平台手续费率 | 0.003 |
| quote_expiration_seconds | 报价有效期 | 30 |
| high_price_impact_threshold | 高价格影响阈值 | 0.05 |

---

### swap_providers - DEX 提供商配置表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | VARCHAR(50) | 提供商ID |
| name | VARCHAR(100) | 提供商名称 |
| api_url | VARCHAR(200) | API 地址 |
| api_key_encrypted | VARCHAR(500) | 加密的 API Key |
| enabled | BOOLEAN | 是否启用 |
| priority | INT | 优先级 (越小越优先) |
| supported_chains | JSON | 支持的链 |
| timeout_ms | INT | 超时时间 |
| max_retries | INT | 最大重试次数 |
| status | VARCHAR(20) | 健康状态 (healthy/degraded/unhealthy) |
| last_health_check | TIMESTAMP | 最后健康检查时间 |
| updated_by | VARCHAR(50) | 更新人 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (provider_id)
- KEY (enabled, priority)

---

## 错误码定义

### Admin 模块错误码 (81000-81999)

#### 用户管理 (81001-81019)

| 错误码 | 说明 |
|--------|------|
| 81001 | 用户不存在 |
| 81002 | 用户已被冻结 |
| 81003 | 无权冻结该用户 |
| 81004 | 用户未被冻结 |
| 81005 | 用户有待处理交易，无法离职 |
| 81006 | 转移目标用户不存在 |
| 81007 | 用户已离职 |
| 81008 | 无效的角色类型 |
| 81009 | 无权设置该角色 |
| 81010 | 用户有未完成任务，需先转交 |

#### 提现审批 (81020-81039)

| 错误码 | 说明 |
|--------|------|
| 81020 | 提现申请不存在 |
| 81021 | 提现状态不可审批 |
| 81022 | Vault 余额不足 |
| 81023 | 重复操作（Idempotency-Key 冲突） |
| 81024 | 提现状态不可驳回 |
| 81025 | 驳回原因不能为空 |

#### Swap 配置 (81040-81049)

| 错误码 | 说明 |
|--------|------|
| 81040 | 配置参数无效 |
| 81041 | 滑点范围不合法 |
| 81042 | 费率超出允许范围 |
| 81043 | 提供商不存在 |
| 81044 | 至少保留一个启用的提供商 |
| 81045 | 代币合约地址无效 |

#### Vault 调整 (81050-81069)

| 错误码 | 说明 |
|--------|------|
| 81050 | 调整金额无效 |
| 81051 | 余额不足（减少时） |
| 81052 | 需要双重审批 |
| 81053 | 调整原因不能为空 |
| 81054 | 重复操作 |
| 81055 | 调整记录不存在 |
| 81056 | 调整状态不可审批 |

#### 角色权限 (81060-81069)

| 错误码 | 说明 |
|--------|------|
| 81060 | 用户不存在 |
| 81061 | 无效的角色 |
| 81062 | 无权分配该角色 |
| 81063 | 用户有未完成任务 |

### Payroll 模块错误码 (80000-80999)

| 错误码 | 说明 |
|--------|------|
| 80001 | 文件格式错误 |
| 80002 | 文件过大 |
| 80003 | 行数超过限制 |
| 80004 | 重复导入（相同 batch_hash） |
| 80010 | 批次不存在 |
| 80011 | 批次已处理 |
| 80012 | 批次已过期 |
| 80013 | Vault 余额不足 |
| 80014 | 无权处理该批次 |

---

## 配置参数

### 系统配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| payroll.max_file_size | 10MB | 薪资文件最大大小 |
| payroll.max_rows | 1000 | 单批次最大行数 |
| payroll.batch_expiry_hours | 24 | 批次过期时间 |
| ledger.export_max_records | 100000 | 账本导出最大记录数 |
| ledger.export_expiry_hours | 1 | 导出文件有效期 |
| vault.dual_control_threshold | 100000 | 双重控制金额阈值 (USDT) |
| audit.retention_days | 永久 | 审计日志保留期 |

### 告警配置

| 告警类型 | 默认阈值 | 说明 |
|----------|----------|------|
| vault_low_balance | 10000 USDT | Vault 余额低于阈值 |
| vault_high_balance | 1000000 USDT | Vault 余额高于阈值 |
| pending_withdraw_count | 50 | 待审批提现数量 |
| pending_withdraw_hours | 24 | 提现等待超时 |
| payroll_pending_hours | 12 | 薪资批次待处理超时 |

---

## 数据保留策略

| 数据类型 | 保留期限 | 说明 |
|----------|----------|------|
| 账本记录 | 永久 | 财务凭证，不可删除 |
| 审计日志 | 永久 | 合规要求 |
| 薪资批次 | 永久 | 财务记录 |
| Vault 调整记录 | 永久 | 资金追溯 |
| 导出文件 | 1 小时 | 临时文件 |
| 告警历史 | 1 年 | 运维参考 |

---

> 返回 [后台管理服务目录](./README.md)
