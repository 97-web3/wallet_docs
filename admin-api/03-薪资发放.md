# 薪资发放

> 返回 [后台管理服务目录](./README.md)

---

## 模块概述

薪资发放模块支持财务人员批量导入薪资数据、审批发放、查看历史记录和导出报表。

### 核心流程

1. 财务人员上传 Excel 文件（包含 UID、币种、金额）
2. 系统校验数据，返回校验结果
3. 财务/管理员审批批次
4. 系统执行发放（创建内部转账）
5. 生成发放报表

---

## F-ADMIN-020: 批量导入薪资

**描述**: 上传薪资 Excel 文件，系统解析并校验数据。

**gRPC 方法**: `BatchImportPayroll`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "file_content": "base64...",    // Excel 文件 Base64 编码
  "file_name": "salary_202512.xlsx",
  "memo": "2025年12月薪资"
}
```

**Excel 文件格式要求**:
| 列名 | 必填 | 说明 |
|------|------|------|
| uid | 是 | 员工 UID (如 U20251210ABCD) |
| asset | 是 | 币种 (如 USDT) |
| amount | 是 | 金额 (支持小数，最多7位) |
| memo | 否 | 备注 (最多100字符) |

**响应 Schema**:
```json
{
  "success": true,
  "batch_id": "PAY-20251210-001",
  "summary": {
    "total_rows": 100,
    "valid_rows": 98,
    "invalid_rows": 2,
    "total_amount": {
      "USDT": "50000.00",
      "TRX": "100000.00"
    },
    "total_amount_usdt": "60000.00"
  },
  "invalid_items": [
    {
      "row": 5,
      "uid": "U20251210XXXX",
      "error_code": "USER_NOT_FOUND",
      "error_message": "用户不存在"
    },
    {
      "row": 23,
      "uid": "U20251210YYYY",
      "error_code": "INVALID_AMOUNT",
      "error_message": "金额格式错误"
    }
  ],
  "status": "pending_review",
  "created_at": "2025-12-10T10:00:00Z",
  "expires_at": "2025-12-11T10:00:00Z"    // 批次 24 小时内需处理
}
```

**业务规则**:
- 文件大小限制: 10MB
- 单批次最大行数: 1000
- 校验规则:
  - UID 必须存在且状态为 active
  - 金额必须 > 0
  - 币种必须是支持的资产
- 批次创建后 24 小时内需处理，否则自动过期
- 相同内容的文件会生成相同的 batch_hash，防止重复导入

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 80001 | 文件格式错误 |
| 80002 | 文件过大 |
| 80003 | 行数超过限制 |
| 80004 | 重复导入（相同 batch_hash） |

---

## F-ADMIN-021: 处理薪资批次

**描述**: 审批并执行薪资发放，或驳回批次。

**gRPC 方法**: `ProcessPayrollBatch`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "batch_id": "PAY-20251210-001",
  "action": "approve",            // approve/reject
  "reject_reason": "",            // action=reject 时必填
  "skip_invalid": true            // 是否跳过无效行继续发放
}
```

**响应 Schema**:
```json
{
  "success": true,
  "batch_id": "PAY-20251210-001",
  "action": "approve",
  "result": {
    "total_processed": 98,
    "success_count": 96,
    "failed_count": 2,
    "total_disbursed": {
      "USDT": "49000.00",
      "TRX": "98000.00"
    },
    "failed_items": [
      {
        "row": 15,
        "uid": "U20251210ZZZZ",
        "error_code": "INSUFFICIENT_VAULT_BALANCE",
        "error_message": "Vault 余额不足"
      }
    ]
  },
  "status": "completed",
  "processed_at": "2025-12-10T10:05:00Z"
}
```

**业务规则**:
- 审批前再次校验用户状态和 Vault 余额
- 发放通过内部转账实现，每笔生成独立 transfer_id
- 部分失败时：
  - `skip_invalid: true`: 继续发放成功的部分
  - `skip_invalid: false`: 全部回滚，返回失败
- 发放完成后自动生成报表
- 审批/驳回操作记入审计日志

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 80010 | 批次不存在 |
| 80011 | 批次已处理 |
| 80012 | 批次已过期 |
| 80013 | Vault 余额不足 |
| 80014 | 无权处理该批次 |

---

## F-ADMIN-022: 获取薪资历史

**描述**: 查询薪资发放历史记录。

**gRPC 方法**: `GetPayrollHistory`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "status": "",                   // pending_review/approved/rejected/expired
  "start_time": "",
  "end_time": "",
  "search": ""                    // 搜索批次ID或备注
}
```

**响应 Schema**:
```json
{
  "success": true,
  "batches": [
    {
      "batch_id": "PAY-20251210-001",
      "memo": "2025年12月薪资",
      "status": "completed",
      "status_text": "已完成",
      "total_rows": 100,
      "success_count": 98,
      "failed_count": 2,
      "total_amount_usdt": "60000.00",
      "created_by": "U20251001ADMIN",
      "created_by_name": "财务张三",
      "approved_by": "U20251001ADMIN2",
      "approved_by_name": "管理员李四",
      "created_at": "2025-12-10T10:00:00Z",
      "processed_at": "2025-12-10T10:05:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 50,
    "total_pages": 3
  }
}
```

---

## F-ADMIN-023: 导出薪资报表

**描述**: 导出指定批次的薪资发放报表。

**gRPC 方法**: `ExportPayrollReport`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "batch_id": "PAY-20251210-001",
  "format": "xlsx"                // xlsx/csv
}
```

**响应 Schema**:
```json
{
  "success": true,
  "download_url": "https://...",  // 临时下载链接，有效期 1 小时
  "file_name": "payroll_PAY-20251210-001.xlsx",
  "expires_at": "2025-12-10T11:00:00Z"
}
```

**报表内容**:
| 列名 | 说明 |
|------|------|
| 序号 | 行号 |
| UID | 员工 UID |
| 姓名 | 员工昵称 |
| 币种 | 发放币种 |
| 金额 | 发放金额 |
| USDT 等值 | USDT 换算值 |
| 状态 | 成功/失败 |
| 失败原因 | 失败时的错误信息 |
| 转账ID | 成功时的 transfer_id |
| 发放时间 | 处理时间 |

---

## 薪资批次状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| pending_review | 1 | 待审核 |
| approved | 2 | 已审批（处理中） |
| completed | 3 | 已完成 |
| partial_completed | 4 | 部分完成 |
| rejected | 5 | 已驳回 |
| expired | 6 | 已过期 |

### 状态流转图

```
                    ┌──────────────────────┐
                    │    pending_review    │
                    └──────────┬───────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         │ 审批通过            │ 驳回                │ 24h 超时
         ▼                     ▼                     ▼
  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
  │   approved   │      │   rejected   │      │   expired    │
  └──────┬───────┘      └──────────────┘      └──────────────┘
         │
    ┌────┴────┐
    │ 全部成功 │ 部分成功
    ▼         ▼
┌───────────┐ ┌───────────────────┐
│ completed │ │ partial_completed │
└───────────┘ └───────────────────┘
```

---

## Idempotency 规范

为防止重复发放，系统使用以下幂等性策略：

1. **批次级别**: 相同文件内容生成相同 `batch_hash`，拒绝重复导入
2. **行级别**: 每行生成唯一 `item_id`，发放时检查是否已处理
3. **转账级别**: 每笔转账使用 `Idempotency-Key` 请求头

---

## 数据保留

| 数据类型 | 保留期限 |
|----------|----------|
| 批次记录 | 永久 |
| 发放明细 | 永久 |
| 导出报表 | 1 年 |
| 审计日志 | 永久 |

---

> 返回 [后台管理服务目录](./README.md)
