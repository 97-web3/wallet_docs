# 提现审批

> 返回 [后台管理服务目录](./README.md)

---

## 模块概述

提现审批模块为管理员和财务人员提供提现申请的审核功能，包括 AML 合规审核、人工审批和批量处理。

### 审核触发条件

详见 [02-business-service/05-提现功能](../02-business-service/05-提现功能.md) 中的审核规则。

| 条件 | 阈值 | 审核类型 |
|------|------|----------|
| 单笔金额 | ≥ 10,000 USDT | AML 审核 |
| 24小时累计 | ≥ 50,000 USDT | AML 审核 |
| 7天累计 | ≥ 200,000 USDT | 人工审核 |
| 新地址首次提现 | 任意金额 | 风控审核 |
| 高风险地址 | 任意金额 | 人工审核 |

---

## F-ADMIN-030: 获取待审批提现列表

**描述**: 获取待审批的提现申请列表。

**gRPC 方法**: `AdminListPendingWithdraws`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "audit_type": "",           // 可选: auto/aml/manual
  "status": "",               // 可选: pending_audit/auditing
  "chain": "",                // 可选: TRX/BSC/ETH
  "min_amount": "",           // 可选: 最小金额筛选
  "max_amount": "",           // 可选: 最大金额筛选
  "search": "",               // 可选: 搜索提现ID/用户UID/地址
  "sort_by": "created_at",
  "sort_order": "asc"         // 默认按申请时间升序（先进先审）
}
```

**响应 Schema**:
```json
{
  "success": true,
  "withdrawals": [
    {
      "withdraw_id": "W20251210001",
      "user_uid": "U20251210ABCD",
      "user_nickname": "用户昵称",
      "asset": "USDT",
      "amount": "15000.00",
      "amount_usdt": "15000.00",
      "chain": "TRX",
      "to_address": "T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb",
      "to_address_risk": "low",           // low/medium/high
      "is_new_address": false,
      "is_bound_address": false,          // 是否为绑定的 Web3 地址
      "audit_type": "aml",
      "audit_type_text": "AML 审核",
      "audit_reason": "单笔金额超过 10,000 USDT",
      "status": "pending_audit",
      "status_text": "待审核",
      "fee": "1.00",
      "created_at": "2025-12-10T08:00:00Z",
      "waiting_hours": 2.5,               // 等待时长
      "user_history": {
        "total_withdrawals": 50,
        "total_amount_usdt": "200000.00",
        "avg_amount_usdt": "4000.00"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 15,
    "total_pages": 1
  },
  "summary": {
    "pending_count": 15,
    "total_pending_amount_usdt": "150000.00",
    "oldest_pending_hours": 12.5
  }
}
```

**业务规则**:
- 默认按申请时间升序，确保先进先审
- 显示用户历史提现统计，辅助审核决策
- 显示目标地址风险评级
- 超过 24 小时未处理的申请标记为紧急

---

## F-ADMIN-031: 审批提现

**描述**: 审批通过提现申请。

**gRPC 方法**: `AdminApproveWithdraw`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "withdraw_id": "W20251210001",
  "comment": "审核通过，用户历史记录良好"
}
```

**请求头**:
```
Idempotency-Key: <UUID>
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现已审批通过",
  "withdraw_id": "W20251210001",
  "new_status": "processing",
  "approved_at": "2025-12-10T10:00:00Z",
  "estimated_completion": "2025-12-10T10:10:00Z"
}
```

**业务规则**:
- 审批通过后状态变为 `processing`，进入链上处理流程
- 必须提供 `Idempotency-Key` 防止重复审批
- 审批操作记入审计日志
- 系统会再次校验 Vault 余额是否充足

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81020 | 提现申请不存在 |
| 81021 | 提现状态不可审批 |
| 81022 | Vault 余额不足 |
| 81023 | 重复操作（Idempotency-Key 冲突） |

---

## F-ADMIN-032: 驳回提现

**描述**: 驳回提现申请，退款到用户账户。

**gRPC 方法**: `AdminRejectWithdraw`

**权限要求**: Finance 或 Admin 角色

**请求 Schema**:
```json
{
  "withdraw_id": "W20251210001",
  "reason": "目标地址存在安全风险",
  "reason_code": "HIGH_RISK_ADDRESS",    // 标准化驳回原因码
  "notify_user": true,
  "block_address": false                  // 是否将该地址加入黑名单
}
```

**请求头**:
```
Idempotency-Key: <UUID>
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现已驳回，金额已退还",
  "withdraw_id": "W20251210001",
  "new_status": "rejected",
  "refund_amount": "15000.00",
  "refund_asset": "USDT",
  "rejected_at": "2025-12-10T10:00:00Z"
}
```

**标准驳回原因码**:
| 原因码 | 说明 |
|--------|------|
| HIGH_RISK_ADDRESS | 目标地址存在安全风险 |
| SUSPICIOUS_ACTIVITY | 账户存在可疑活动 |
| KYC_REQUIRED | 需要补充 KYC 材料 |
| AMOUNT_LIMIT_EXCEEDED | 超过累计限额 |
| ADDRESS_FORMAT_ERROR | 地址格式异常 |
| USER_REQUEST | 用户主动申请取消 |
| OTHER | 其他原因（需填写详细说明） |

**业务规则**:
- 驳回后金额立即退还到用户账户
- 必须提供驳回原因
- 可选将目标地址加入黑名单
- 若 `notify_user: true`，发送通知给用户
- 驳回操作记入审计日志

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 81020 | 提现申请不存在 |
| 81024 | 提现状态不可驳回 |
| 81025 | 驳回原因不能为空 |

---

## AML 提供商集成

### 集成架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  提现申请触发   │────▶│   AML 服务调用   │────▶│  外部 AML API   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │
                               ▼
                        ┌─────────────────┐
                        │   风险评估结果   │
                        │  - 通过         │
                        │  - 需人工审核   │
                        │  - 拒绝         │
                        └─────────────────┘
```

### AML 检查内容

1. **地址风险评估**
   - 检查目标地址是否在制裁名单
   - 检查地址是否关联高风险实体
   - 返回风险评分 (0-100)

2. **交易模式分析**
   - 检查是否存在结构化交易（拆分大额）
   - 检查交易频率异常
   - 检查跨链资金流转模式

3. **用户风险评估**
   - 用户历史行为分析
   - KYC 完成度检查
   - 账户年龄和活跃度

### AML API 配置

```yaml
AML:
  Provider: "chainalysis"          # 或 elliptic, coinfirm
  BaseURL: "https://api.chainalysis.com/v2"
  APIKey: "${AML_API_KEY}"
  Timeout: 30s
  RetryCount: 3
  RetryInterval: 5s
  RiskThreshold:
    Auto_Approve: 30               # 风险分 < 30 自动通过
    Manual_Review: 70              # 风险分 30-70 需人工审核
    Auto_Reject: 100               # 风险分 > 70 自动拒绝
```

### AML 错误处理

| 错误场景 | 处理方式 |
|----------|----------|
| API 超时 | 重试 3 次，仍失败则转人工审核 |
| API 错误 | 记录日志，转人工审核 |
| 风险分临界 | 转人工审核 |
| 网络中断 | 使用本地缓存的黑名单初步筛查 |

---

## 审批工作流

### 完整流程图

```
用户提交提现
      │
      ▼
┌─────────────────┐
│  检查免审批条件  │
│  - 绑定地址?    │
│  - 金额 < 阈值? │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 免审批   │ 需审批
    ▼         ▼
直接处理  ┌─────────────────┐
         │   AML 自动检查   │
         └────────┬────────┘
                  │
        ┌─────────┼─────────┐
        │         │         │
    风险低     风险中     风险高
        │         │         │
        ▼         ▼         ▼
    自动通过   人工审核   自动拒绝
        │         │         │
        ▼         ▼         ▼
    processing  pending   rejected
                审批/驳回
```

---

## 审计日志

所有审批操作记录以下信息：

| 字段 | 说明 |
|------|------|
| withdraw_id | 提现申请 ID |
| operator_id | 操作人 UID |
| operator_role | 操作人角色 |
| action | 操作类型 (approve/reject) |
| reason | 审批/驳回原因 |
| aml_score | AML 风险评分 |
| aml_provider | AML 提供商 |
| client_ip | 客户端 IP |
| operated_at | 操作时间 |

---

## 性能指标

| 指标 | 目标 |
|------|------|
| 列表查询 P95 | ≤ 200ms |
| 审批操作 P95 | ≤ 500ms |
| AML 检查 P95 | ≤ 5s |
| 自动审核比例 | ≥ 80% |

---

> 返回 [后台管理服务目录](./README.md)
