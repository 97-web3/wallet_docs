# 系统状态监控

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-114: 获取状态概览

**描述**: 获取系统状态的整体概览。

**HTTP 方法**: `GET /api/v1/admin/status/overview`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "summary": {
      "overall_status": "healthy",
      "active_networks": 3,
      "total_networks": 3,
      "active_alerts": 1,
      "recent_switches": 2
    },
    "networks": [
      {
        "network": "Ethereum",
        "chain_id": 1,
        "status": "healthy",
        "active_rpc": "Infura",
        "block_height": 18500000,
        "latency_ms": 150,
        "last_sync": "2025-12-10T10:00:00Z"
      },
      {
        "network": "BSC",
        "chain_id": 56,
        "status": "healthy",
        "active_rpc": "BSC Official",
        "block_height": 35000000,
        "latency_ms": 80,
        "last_sync": "2025-12-10T10:00:00Z"
      },
      {
        "network": "Tron",
        "chain_id": -1,
        "status": "degraded",
        "active_rpc": "TronGrid",
        "block_height": 55000000,
        "latency_ms": 450,
        "last_sync": "2025-12-10T09:58:00Z",
        "alert": "延迟偏高"
      }
    ],
    "api_health": {
      "dex_providers": "healthy",
      "price_feeds": "healthy",
      "risk_services": "healthy"
    },
    "system_metrics": {
      "cpu_usage": "35%",
      "memory_usage": "62%",
      "disk_usage": "45%",
      "active_connections": 1256
    }
  }
}
```

**权限要求**:
- 角色: Admin, Finance (只读)

---

## F-ADMIN-115: 获取网络健康状态

**描述**: 获取所有网络的详细健康状态。

**HTTP 方法**: `GET /api/v1/admin/status/networks`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "networks": [
      {
        "network": "Ethereum",
        "chain_id": 1,
        "status": "healthy",
        "rpc_nodes": [
          {
            "id": "infura-main",
            "name": "Infura",
            "endpoint": "https://mainnet.infura.io/v3/xxx",
            "is_active": true,
            "priority": 1,
            "health": {
              "status": "healthy",
              "latency_ms": 150,
              "success_rate_24h": "99.9%",
              "error_count_24h": 5,
              "last_check": "2025-12-10T10:00:00Z"
            }
          },
          {
            "id": "alchemy-backup",
            "name": "Alchemy",
            "endpoint": "https://eth-mainnet.alchemyapi.io/v2/xxx",
            "is_active": false,
            "priority": 2,
            "health": {
              "status": "healthy",
              "latency_ms": 180,
              "success_rate_24h": "99.8%",
              "last_check": "2025-12-10T10:00:00Z"
            }
          }
        ],
        "sync_status": {
          "current_block": 18500000,
          "synced_block": 18499995,
          "blocks_behind": 5,
          "sync_percentage": "99.99%",
          "estimated_sync_time": "10s"
        },
        "metrics_24h": {
          "total_requests": 125000,
          "failed_requests": 125,
          "avg_latency_ms": 145,
          "p99_latency_ms": 350
        }
      },
      {
        "network": "BSC",
        "chain_id": 56,
        "status": "healthy",
        "rpc_nodes": [
          {
            "id": "bsc-official",
            "name": "BSC Official",
            "endpoint": "https://bsc-dataseed.binance.org/",
            "is_active": true,
            "priority": 1,
            "health": {
              "status": "healthy",
              "latency_ms": 80,
              "success_rate_24h": "99.95%"
            }
          }
        ]
      },
      {
        "network": "Tron",
        "chain_id": -1,
        "status": "degraded",
        "rpc_nodes": [
          {
            "id": "trongrid-main",
            "name": "TronGrid",
            "endpoint": "https://api.trongrid.io",
            "is_active": true,
            "priority": 1,
            "health": {
              "status": "degraded",
              "latency_ms": 450,
              "success_rate_24h": "98.5%",
              "error_count_24h": 156,
              "last_error": {
                "message": "Request timeout",
                "timestamp": "2025-12-10T09:55:00Z"
              }
            }
          }
        ]
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin, Finance (只读)

---

## F-ADMIN-116: 获取链详情

**描述**: 获取指定链的详细状态信息。

**HTTP 方法**: `GET /api/v1/admin/status/networks/{chain_id}`

**路径参数**:
- `chain_id`: 链 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "network": "Ethereum",
    "chain_id": 1,
    "status": "healthy",
    "rpc_nodes": [
      {
        "id": "infura-main",
        "name": "Infura",
        "endpoint": "https://mainnet.infura.io/v3/xxx",
        "is_active": true,
        "priority": 1,
        "config": {
          "timeout_ms": 5000,
          "max_retries": 3,
          "rate_limit": 100
        },
        "health": {
          "status": "healthy",
          "latency_ms": 150,
          "success_rate_1h": "100%",
          "success_rate_24h": "99.9%",
          "error_count_1h": 0,
          "error_count_24h": 5
        },
        "metrics": {
          "requests_1h": 5200,
          "requests_24h": 125000,
          "avg_latency_1h": 145,
          "p50_latency_1h": 130,
          "p99_latency_1h": 320
        }
      }
    ],
    "block_info": {
      "current_height": 18500000,
      "synced_height": 18499995,
      "blocks_behind": 5,
      "avg_block_time": "12s",
      "last_block_time": "2025-12-10T10:00:00Z"
    },
    "gas_info": {
      "current_gas_price_gwei": "25",
      "avg_gas_price_24h_gwei": "28",
      "max_gas_price_24h_gwei": "150",
      "min_gas_price_24h_gwei": "15"
    },
    "transaction_stats_24h": {
      "total_deposits": 120,
      "total_withdrawals": 85,
      "pending_transactions": 3,
      "failed_transactions": 2
    },
    "recent_errors": [
      {
        "timestamp": "2025-12-10T08:30:00Z",
        "rpc_node": "infura-main",
        "error_type": "timeout",
        "message": "Request timeout after 5000ms",
        "request_id": "req-123456"
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-117: 测试 RPC 连接

**描述**: 测试指定 RPC 节点的连接状态。

**HTTP 方法**: `POST /api/v1/admin/status/networks/{chain_id}/test`

**路径参数**:
- `chain_id`: 链 ID

**请求 Schema**:
```json
{
  "rpc_node_id": "infura-main",    // 可选，不填则测试所有节点
  "test_type": "full"              // quick, full
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "测试完成",
  "data": {
    "results": [
      {
        "rpc_node_id": "infura-main",
        "name": "Infura",
        "tests": [
          {"name": "连接测试", "status": "pass", "latency_ms": 120},
          {"name": "区块查询", "status": "pass", "latency_ms": 150},
          {"name": "余额查询", "status": "pass", "latency_ms": 180},
          {"name": "交易模拟", "status": "pass", "latency_ms": 250}
        ],
        "overall_status": "healthy",
        "avg_latency_ms": 175
      },
      {
        "rpc_node_id": "alchemy-backup",
        "name": "Alchemy",
        "tests": [
          {"name": "连接测试", "status": "pass", "latency_ms": 140},
          {"name": "区块查询", "status": "pass", "latency_ms": 170}
        ],
        "overall_status": "healthy",
        "avg_latency_ms": 155
      }
    ],
    "tested_at": "2025-12-10T10:00:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-118: 手动故障转移

**描述**: 手动切换到备用 RPC 节点。

**HTTP 方法**: `POST /api/v1/admin/status/networks/{chain_id}/switch`

**路径参数**:
- `chain_id`: 链 ID

**请求 Schema**:
```json
{
  "target_rpc_id": "alchemy-backup",
  "reason": "主节点延迟过高，手动切换",
  "2fa_code": "123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "已切换到备用节点",
  "data": {
    "network": "Ethereum",
    "previous_rpc": {
      "id": "infura-main",
      "name": "Infura"
    },
    "current_rpc": {
      "id": "alchemy-backup",
      "name": "Alchemy"
    },
    "switched_at": "2025-12-10T10:00:00Z",
    "switched_by": "admin@company.com",
    "switch_type": "manual"
  }
}
```

**业务规则**:
- 需要 2FA 验证
- 切换前自动测试目标节点
- 记录切换日志
- 自动通知相关人员

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| RPC_NODE_NOT_FOUND | 404 | RPC 节点不存在 |
| RPC_NODE_UNHEALTHY | 400 | 目标节点不健康 |
| ALREADY_ACTIVE | 409 | 目标节点已是当前活跃节点 |

---

## F-ADMIN-119: 获取 RPC 日志

**描述**: 获取 RPC 请求日志和错误记录。

**HTTP 方法**: `GET /api/v1/admin/status/networks/{chain_id}/logs`

**路径参数**:
- `chain_id`: 链 ID

**请求参数**:
```
?page=1
&page_size=50
&level=                      // error, warn, info
&rpc_node_id=
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": "log-001",
        "timestamp": "2025-12-10T09:55:00Z",
        "level": "error",
        "rpc_node_id": "infura-main",
        "rpc_node_name": "Infura",
        "method": "eth_getBalance",
        "error_type": "timeout",
        "message": "Request timeout after 5000ms",
        "request_id": "req-123456",
        "latency_ms": 5000,
        "retries": 3
      },
      {
        "id": "log-002",
        "timestamp": "2025-12-10T09:50:00Z",
        "level": "warn",
        "rpc_node_id": "infura-main",
        "rpc_node_name": "Infura",
        "method": "eth_sendRawTransaction",
        "message": "High latency detected",
        "latency_ms": 2500
      }
    ],
    "summary": {
      "total_errors_24h": 15,
      "total_warnings_24h": 45,
      "most_common_error": "timeout"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 60,
    "total_pages": 2
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-120: 获取第三方 API 健康状态

**描述**: 获取第三方 API 服务的健康状态。

**HTTP 方法**: `GET /api/v1/admin/status/api-health`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "services": [
      {
        "category": "DEX Providers",
        "providers": [
          {
            "id": "uniswap",
            "name": "Uniswap",
            "status": "healthy",
            "latency_ms": 200,
            "success_rate_24h": "99.9%",
            "last_check": "2025-12-10T10:00:00Z"
          },
          {
            "id": "pancakeswap",
            "name": "PancakeSwap",
            "status": "healthy",
            "latency_ms": 180,
            "success_rate_24h": "99.8%"
          }
        ]
      },
      {
        "category": "Price Feeds",
        "providers": [
          {
            "id": "coingecko",
            "name": "CoinGecko",
            "status": "healthy",
            "latency_ms": 150,
            "success_rate_24h": "99.95%"
          },
          {
            "id": "coinmarketcap",
            "name": "CoinMarketCap",
            "status": "healthy",
            "latency_ms": 180,
            "success_rate_24h": "99.9%"
          }
        ]
      },
      {
        "category": "Risk Services",
        "providers": [
          {
            "id": "chainalysis",
            "name": "Chainalysis",
            "status": "healthy",
            "latency_ms": 300,
            "success_rate_24h": "99.99%"
          }
        ]
      }
    ],
    "last_updated": "2025-12-10T10:00:00Z"
  }
}
```

**权限要求**:
- 角色: Admin, Finance (只读)

---

## F-ADMIN-121: 刷新 API 健康检查

**描述**: 手动触发第三方 API 健康检查。

**HTTP 方法**: `POST /api/v1/admin/status/api-health/refresh`

**响应 Schema**:
```json
{
  "success": true,
  "message": "健康检查已触发",
  "data": {
    "check_id": "check-20251210-001",
    "status": "running",
    "started_at": "2025-12-10T10:00:00Z",
    "estimated_time": 30
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-122: 获取故障转移历史

**描述**: 获取 RPC 故障转移的历史记录。

**HTTP 方法**: `GET /api/v1/admin/status/switch-history`

**请求参数**:
```
?page=1
&page_size=20
&chain_id=                   // 链筛选
&switch_type=                // auto, manual
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "switches": [
      {
        "id": "switch-001",
        "network": "Ethereum",
        "chain_id": 1,
        "switch_type": "auto",
        "from_rpc": {
          "id": "infura-main",
          "name": "Infura"
        },
        "to_rpc": {
          "id": "alchemy-backup",
          "name": "Alchemy"
        },
        "reason": "连续 5 次请求超时",
        "trigger": {
          "type": "error_threshold",
          "threshold": 5,
          "actual": 5
        },
        "operator": "system",
        "switched_at": "2025-12-09T15:30:00Z",
        "duration_before_switch_back": "2h 15m",
        "switched_back_at": "2025-12-09T17:45:00Z"
      },
      {
        "id": "switch-002",
        "network": "Ethereum",
        "chain_id": 1,
        "switch_type": "manual",
        "from_rpc": {
          "id": "alchemy-backup",
          "name": "Alchemy"
        },
        "to_rpc": {
          "id": "infura-main",
          "name": "Infura"
        },
        "reason": "主节点恢复正常",
        "operator": "admin@company.com",
        "switched_at": "2025-12-09T17:45:00Z"
      }
    ],
    "summary": {
      "total_switches_30d": 8,
      "auto_switches": 5,
      "manual_switches": 3,
      "avg_downtime": "45m"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 8,
    "total_pages": 1
  }
}
```

**权限要求**:
- 角色: Admin

---

## 网络状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 健康 | healthy | 正常运行 |
| 降级 | degraded | 部分功能受限 |
| 不可用 | unavailable | 服务不可用 |
| 维护中 | maintenance | 计划维护 |

## RPC 健康状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 健康 | healthy | 正常运行 |
| 降级 | degraded | 延迟偏高或部分错误 |
| 不健康 | unhealthy | 服务不可用 |

## 切换类型枚举

| 类型 | 代码 | 描述 |
|------|------|------|
| 自动 | auto | 系统自动故障转移 |
| 手动 | manual | 管理员手动切换 |

---

> 返回 [Admin 服务目录](./README.md)
