# 账本与交易

> 返回 [Admin 服务目录](./README.md)

---

> 说明：`/admin/ledger` 下的“充值记录 Tab / 内部转账记录 Tab”已拆分为独立 SRD 文档：
> - [16-充值记录](./16-充值记录.md)
> - [17-内部转账记录](./17-内部转账记录.md)

## F-ADMIN-030: 获取账本记录

**描述**: 获取系统账本记录，支持多维度筛选和排序。

**HTTP 方法**: `GET /api/v1/admin/ledger`

**请求参数**:
```
?page=1                      // 页码，默认 1
&page_size=20                // 每页条数，默认 20
&type=                       // 交易类型: deposit, withdrawal, transfer, swap, adjustment
&network=                    // 网络筛选: Ethereum, BSC, Tron, Polygon
&currency=                   // 币种筛选
&user_id=                    // 用户 ID
&direction=                  // 方向: in, out
&status=                     // 状态: pending, completed, failed
&min_amount=                 // 最小金额
&max_amount=                 // 最大金额
&created_from=               // 开始时间
&created_to=                 // 结束时间
&tx_hash=                    // 交易哈希搜索
&sort_by=created_at          // 排序字段
&sort_order=desc             // 排序方向
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "led-20251210-001",
        "type": "deposit",
        "user": {
          "uid": "10001",
          "email": "user@example.com",
          "name": "张三"
        },
        "network": "Ethereum",
        "currency": "USDT",
        "amount": "1000.000000",
        "amount_usd": "1000.00",
        "direction": "in",
        "from_address": "0xabc...def",
        "to_address": "0x123...456",
        "tx_hash": "0x789...012",
        "block_number": 18500000,
        "confirmations": 12,
        "status": "completed",
        "fee": "0.001",
        "fee_currency": "ETH",
        "fee_usd": "2.50",
        "balance_before": "5000.000000",
        "balance_after": "6000.000000",
        "note": "",
        "created_at": "2025-12-10T09:00:00Z",
        "completed_at": "2025-12-10T09:05:00Z"
      }
    ],
    "summary": {
      "total_in_usd": "1500000.00",
      "total_out_usd": "800000.00",
      "net_flow_usd": "700000.00",
      "record_count": 5680
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 5680,
    "total_pages": 284,
    "has_next": true,
    "has_prev": false
  }
}
```

**业务规则**:
- 默认按时间降序排列
- 交易哈希支持模糊搜索
- 金额统一转换为 USD 显示

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-031: 获取交易详情

**描述**: 获取单笔交易的完整详情。

**HTTP 方法**: `GET /api/v1/admin/ledger/{id}`

**路径参数**:
- `id`: 账本记录 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "id": "led-20251210-001",
    "type": "deposit",
    "user": {
      "uid": "10001",
      "email": "user@example.com",
      "name": "张三",
      "status": "active"
    },
    "transaction_info": {
      "network": "Ethereum",
      "chain_id": 1,
      "currency": "USDT",
      "contract_address": "0xdAC17F958D2ee523a2206206994597C13D831ec7",
      "amount": "1000.000000",
      "amount_usd": "1000.00",
      "direction": "in",
      "from_address": "0xabc...def",
      "to_address": "0x123...456",
      "tx_hash": "0x789...012",
      "block_number": 18500000,
      "block_timestamp": "2025-12-10T09:03:00Z",
      "confirmations": 12,
      "required_confirmations": 6
    },
    "fee_info": {
      "gas_used": 65000,
      "gas_price": "25000000000",
      "fee": "0.001625",
      "fee_currency": "ETH",
      "fee_usd": "4.06"
    },
    "balance_change": {
      "currency": "USDT",
      "before": "5000.000000",
      "after": "6000.000000",
      "change": "+1000.000000"
    },
    "status": "completed",
    "status_history": [
      {"status": "pending", "timestamp": "2025-12-10T09:00:00Z", "note": "检测到链上交易"},
      {"status": "confirming", "timestamp": "2025-12-10T09:01:00Z", "note": "等待区块确认 (3/6)"},
      {"status": "completed", "timestamp": "2025-12-10T09:05:00Z", "note": "确认完成，已入账"}
    ],
    "related_records": [
      {
        "id": "led-20251210-002",
        "type": "fee",
        "amount": "-0.001625 ETH",
        "note": "充值手续费"
      }
    ],
    "created_at": "2025-12-10T09:00:00Z",
    "completed_at": "2025-12-10T09:05:00Z"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-032: 导出账本

**描述**: 导出账本记录为 Excel 或 CSV 文件。

**HTTP 方法**: `POST /api/v1/admin/ledger/export`

**请求 Schema**:
```json
{
  "filters": {
    "type": "deposit",
    "network": "Ethereum",
    "currency": "USDT",
    "created_from": "2025-12-01",
    "created_to": "2025-12-10"
  },
  "fields": [
    "id",
    "type",
    "user_id",
    "user_email",
    "network",
    "currency",
    "amount",
    "amount_usd",
    "tx_hash",
    "status",
    "created_at"
  ],
  "format": "xlsx",
  "include_summary": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "导出任务已创建",
  "data": {
    "export_id": "exp-20251210-led-001",
    "status": "processing",
    "estimated_records": 5680,
    "estimated_time": 120
  }
}
```

**业务规则**:
- 大数据量异步导出
- 单次最多导出 50 万条
- 导出文件保留 7 天

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-033: 获取资金流水

**描述**: 获取用户或系统的资金流水记录。

**HTTP 方法**: `GET /api/v1/admin/ledger/flow`

**请求参数**:
```
?page=1
&page_size=20
&user_id=                    // 用户 ID (可选，不填则为系统汇总)
&currency=                   // 币种筛选
&date_from=                  // 开始日期
&date_to=                    // 结束日期
&group_by=day                // 分组: hour, day, week, month
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "flow_records": [
      {
        "date": "2025-12-10",
        "currency": "USDT",
        "opening_balance": "8000000.000000",
        "deposit": "150000.000000",
        "withdrawal": "80000.000000",
        "transfer_in": "25000.000000",
        "transfer_out": "30000.000000",
        "swap_in": "15000.000000",
        "swap_out": "12000.000000",
        "adjustment": "0.000000",
        "fee": "-500.000000",
        "closing_balance": "8067500.000000",
        "net_change": "67500.000000"
      }
    ],
    "summary": {
      "total_deposit": "450000.000000",
      "total_withdrawal": "240000.000000",
      "total_net_change": "202500.000000",
      "period": "2025-12-01 to 2025-12-10"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 10,
    "total_pages": 1
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-035: 获取 Swap 记录

**描述**: 获取兑换交易记录列表。

**HTTP 方法**: `GET /api/v1/admin/ledger/swaps`

**请求参数**:
```
?page=1
&page_size=20
&user_id=
&from_currency=
&to_currency=
&provider=                   // DEX 提供商: uniswap, pancakeswap, sunswap
&status=                     // pending, completed, failed
&min_amount=
&max_amount=
&created_from=
&created_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "swaps": [
      {
        "id": "swap-20251210-001",
        "user": {
          "uid": "10001",
          "email": "user@example.com"
        },
        "from_currency": "ETH",
        "from_amount": "1.000000",
        "from_amount_usd": "2500.00",
        "to_currency": "USDT",
        "to_amount": "2480.000000",
        "to_amount_usd": "2480.00",
        "exchange_rate": "2480.000000",
        "slippage": "0.8%",
        "provider": "uniswap",
        "network": "Ethereum",
        "tx_hash": "0x789...012",
        "fee": "6.20",
        "fee_currency": "USDT",
        "status": "completed",
        "created_at": "2025-12-10T09:00:00Z",
        "completed_at": "2025-12-10T09:01:00Z"
      }
    ],
    "summary": {
      "total_count": 1250,
      "total_volume_usd": "8500000.00",
      "total_fee_usd": "21250.00",
      "avg_slippage": "0.65%"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 1250,
    "total_pages": 63
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-036: 手动对账

**描述**: 对指定日期范围的账本记录进行对账。

**HTTP 方法**: `POST /api/v1/admin/ledger/reconcile`

**请求 Schema**:
```json
{
  "date_from": "2025-12-01",
  "date_to": "2025-12-10",
  "networks": ["Ethereum", "BSC", "Tron"],
  "currencies": ["USDT", "ETH", "BNB", "TRX"]
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "对账任务已创建",
  "data": {
    "task_id": "recon-20251210-001",
    "status": "processing",
    "estimated_time": 300
  }
}
```

**业务规则**:
- 对比链上余额与系统余额
- 对比链上交易与系统记录
- 生成差异报告

**权限要求**:
- 角色: Admin

---

## F-ADMIN-037: 获取对账结果

**描述**: 获取对账任务的结果。

**HTTP 方法**: `GET /api/v1/admin/ledger/reconcile/{task_id}`

**路径参数**:
- `task_id`: 对账任务 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "task_id": "recon-20251210-001",
    "status": "completed",
    "period": {
      "from": "2025-12-01",
      "to": "2025-12-10"
    },
    "results": {
      "networks_checked": 3,
      "currencies_checked": 4,
      "total_transactions_checked": 15680,
      "matched": 15678,
      "discrepancies": 2
    },
    "discrepancy_details": [
      {
        "id": "disc-001",
        "type": "missing_record",
        "network": "Ethereum",
        "currency": "USDT",
        "tx_hash": "0xabc...123",
        "chain_amount": "500.000000",
        "system_amount": "0",
        "difference": "500.000000",
        "detected_at": "2025-12-10T10:00:00Z",
        "status": "pending_review"
      }
    ],
    "summary_by_network": [
      {
        "network": "Ethereum",
        "chain_balance": "2500000.000000",
        "system_balance": "2500000.000000",
        "difference": "0",
        "status": "matched"
      }
    ],
    "completed_at": "2025-12-10T10:05:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## 交易类型枚举

| 类型 | 代码 | 描述 |
|------|------|------|
| 充值 | deposit | 用户充值 |
| 提现 | withdrawal | 用户提现 |
| 转账 | transfer | 内部转账 |
| 兑换 | swap | 币种兑换 |
| 调整 | adjustment | 余额调整 |
| 手续费 | fee | 手续费扣除 |

## 交易状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 待处理 | pending | 等待处理 |
| 确认中 | confirming | 等待区块确认 |
| 已完成 | completed | 交易完成 |
| 失败 | failed | 交易失败 |

---

> 返回 [Admin 服务目录](./README.md)
