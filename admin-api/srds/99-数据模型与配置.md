# 数据模型与配置

> 返回 [Admin 服务目录](./README.md)

---

## 数据库表结构

### 管理员表 (admin_users)

```sql
CREATE TABLE admin_users (
    id              VARCHAR(32)     PRIMARY KEY,
    username        VARCHAR(128)    NOT NULL UNIQUE,
    password_hash   VARCHAR(256)    NOT NULL,
    name            VARCHAR(64)     NOT NULL,
    role            VARCHAR(32)     NOT NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'active',
    two_factor_secret VARCHAR(64)   NULL,
    two_factor_enabled TINYINT(1)   NOT NULL DEFAULT 0,
    last_login_at   DATETIME        NULL,
    last_login_ip   VARCHAR(45)     NULL,
    password_changed_at DATETIME    NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(32)     NULL,
    updated_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_username (username),
    INDEX idx_role (role),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 登录日志表 (admin_login_logs)

```sql
CREATE TABLE admin_login_logs (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    admin_id        VARCHAR(32)     NOT NULL,
    action          VARCHAR(16)     NOT NULL,  -- login, logout, login_failed
    ip              VARCHAR(45)     NOT NULL,
    user_agent      VARCHAR(512)    NULL,
    location        VARCHAR(128)    NULL,
    result          VARCHAR(16)     NOT NULL,  -- success, failed
    reason          VARCHAR(256)    NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_admin_id (admin_id),
    INDEX idx_created_at (created_at),
    INDEX idx_action (action)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 审计日志表 (admin_audit_logs)

```sql
CREATE TABLE admin_audit_logs (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    admin_id        VARCHAR(32)     NOT NULL,
    action          VARCHAR(64)     NOT NULL,
    target_type     VARCHAR(32)     NOT NULL,
    target_id       VARCHAR(64)     NULL,
    description     VARCHAR(512)    NOT NULL,
    details         JSON            NULL,
    ip              VARCHAR(45)     NOT NULL,
    user_agent      VARCHAR(512)    NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_admin_id (admin_id),
    INDEX idx_action (action),
    INDEX idx_target (target_type, target_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 黑名单地址表 (blacklist_addresses)

```sql
CREATE TABLE blacklist_addresses (
    id              VARCHAR(32)     PRIMARY KEY,
    address         VARCHAR(128)    NOT NULL,
    network         VARCHAR(32)     NOT NULL,
    risk_level      VARCHAR(16)     NOT NULL,
    reason          VARCHAR(512)    NOT NULL,
    source          VARCHAR(32)     NOT NULL,
    source_detail   VARCHAR(256)    NULL,
    tags            JSON            NULL,
    is_monitoring   TINYINT(1)      NOT NULL DEFAULT 1,
    match_count     INT             NOT NULL DEFAULT 0,
    last_match_time DATETIME        NULL,
    notes           TEXT            NULL,
    added_by        VARCHAR(32)     NOT NULL,
    added_at        DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(32)     NULL,
    updated_at      DATETIME        NULL,
    deleted_at      DATETIME        NULL,

    UNIQUE INDEX uk_address_network (address, network),
    INDEX idx_network (network),
    INDEX idx_risk_level (risk_level),
    INDEX idx_source (source),
    INDEX idx_monitoring (is_monitoring),
    INDEX idx_added_at (added_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 黑名单匹配记录表 (blacklist_match_logs)

```sql
CREATE TABLE blacklist_match_logs (
    id              BIGINT          PRIMARY KEY AUTO_INCREMENT,
    blacklist_id    VARCHAR(32)     NOT NULL,
    match_type      VARCHAR(32)     NOT NULL,
    user_id         VARCHAR(32)     NULL,
    transaction_id  VARCHAR(64)     NULL,
    amount          DECIMAL(36,18)  NULL,
    currency        VARCHAR(16)     NULL,
    matched_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_blacklist_id (blacklist_id),
    INDEX idx_user_id (user_id),
    INDEX idx_matched_at (matched_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 币种配置表 (currency_configs)

```sql
CREATE TABLE currency_configs (
    id              VARCHAR(32)     PRIMARY KEY,
    symbol          VARCHAR(16)     NOT NULL,
    name            VARCHAR(64)     NOT NULL,
    network         VARCHAR(32)     NOT NULL,
    chain_id        INT             NOT NULL,
    type            VARCHAR(16)     NOT NULL,  -- native, token
    contract_address VARCHAR(128)   NULL,
    decimals        INT             NOT NULL,
    icon_url        VARCHAR(512)    NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'inactive',
    deposit_enabled TINYINT(1)      NOT NULL DEFAULT 1,
    withdraw_enabled TINYINT(1)     NOT NULL DEFAULT 1,
    swap_enabled    TINYINT(1)      NOT NULL DEFAULT 1,
    min_deposit     DECIMAL(36,18)  NOT NULL DEFAULT 0,
    min_withdraw    DECIMAL(36,18)  NOT NULL DEFAULT 0,
    max_withdraw    DECIMAL(36,18)  NOT NULL DEFAULT 0,
    daily_withdraw_limit DECIMAL(36,18) NULL,
    withdraw_fee    DECIMAL(36,18)  NOT NULL DEFAULT 0,
    withdraw_fee_type VARCHAR(16)   NOT NULL DEFAULT 'fixed',
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(32)     NOT NULL,
    updated_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by      VARCHAR(32)     NULL,

    UNIQUE INDEX uk_symbol_network (symbol, network),
    INDEX idx_network (network),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### Vault 调整记录表 (vault_adjustments)

```sql
CREATE TABLE vault_adjustments (
    id              VARCHAR(32)     PRIMARY KEY,
    network         VARCHAR(32)     NOT NULL,
    chain_id        INT             NOT NULL,
    currency        VARCHAR(16)     NOT NULL,
    adjustment_type VARCHAR(16)     NOT NULL,  -- increase, decrease
    amount          DECIMAL(36,18)  NOT NULL,
    reason          VARCHAR(512)    NOT NULL,
    source          VARCHAR(32)     NULL,
    source_address  VARCHAR(128)    NULL,
    tx_hash         VARCHAR(128)    NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'pending_approval',
    submitted_by    VARCHAR(32)     NOT NULL,
    submitted_at    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    approved_by     VARCHAR(32)     NULL,
    approved_at     DATETIME        NULL,
    rejected_by     VARCHAR(32)     NULL,
    rejected_at     DATETIME        NULL,
    reject_reason   VARCHAR(512)    NULL,
    completed_at    DATETIME        NULL,

    INDEX idx_network_currency (network, currency),
    INDEX idx_status (status),
    INDEX idx_submitted_at (submitted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 转账批次表 (payroll_batches)

```sql
CREATE TABLE payroll_batches (
    id              VARCHAR(32)     PRIMARY KEY,
    name            VARCHAR(128)    NOT NULL,
    description     VARCHAR(512)    NULL,
    network         VARCHAR(32)     NOT NULL,
    currency        VARCHAR(16)     NOT NULL,
    total_recipients INT            NOT NULL DEFAULT 0,
    total_amount    DECIMAL(36,18)  NOT NULL DEFAULT 0,
    success_count   INT             NOT NULL DEFAULT 0,
    failed_count    INT             NOT NULL DEFAULT 0,
    status          VARCHAR(16)     NOT NULL DEFAULT 'draft',
    created_by      VARCHAR(32)     NOT NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    submitted_at    DATETIME        NULL,
    approved_by     VARCHAR(32)     NULL,
    approved_at     DATETIME        NULL,
    processed_at    DATETIME        NULL,
    completed_at    DATETIME        NULL,
    cancelled_at    DATETIME        NULL,
    cancelled_by    VARCHAR(32)     NULL,
    cancel_reason   VARCHAR(512)    NULL,

    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 转账记录表 (payroll_transfers)

```sql
CREATE TABLE payroll_transfers (
    id              VARCHAR(32)     PRIMARY KEY,
    batch_id        VARCHAR(32)     NOT NULL,
    to_address      VARCHAR(128)    NOT NULL,
    amount          DECIMAL(36,18)  NOT NULL,
    note            VARCHAR(256)    NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'pending',
    tx_hash         VARCHAR(128)    NULL,
    fee             DECIMAL(36,18)  NULL,
    error_message   VARCHAR(512)    NULL,
    retry_count     INT             NOT NULL DEFAULT 0,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    processed_at    DATETIME        NULL,

    INDEX idx_batch_id (batch_id),
    INDEX idx_status (status),
    INDEX idx_to_address (to_address)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 定时报表任务表 (scheduled_reports)

```sql
CREATE TABLE scheduled_reports (
    id              VARCHAR(32)     PRIMARY KEY,
    name            VARCHAR(128)    NOT NULL,
    report_type     VARCHAR(32)     NOT NULL,
    filters         JSON            NULL,
    schedule        VARCHAR(64)     NOT NULL,  -- Cron expression
    format          VARCHAR(16)     NOT NULL DEFAULT 'xlsx',
    recipients      JSON            NOT NULL,
    include_details TINYINT(1)      NOT NULL DEFAULT 0,
    enabled         TINYINT(1)      NOT NULL DEFAULT 1,
    last_run_at     DATETIME        NULL,
    last_run_status VARCHAR(16)     NULL,
    next_run_at     DATETIME        NULL,
    created_by      VARCHAR(32)     NOT NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_enabled (enabled),
    INDEX idx_next_run_at (next_run_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 导出记录表 (export_records)

```sql
CREATE TABLE export_records (
    id              VARCHAR(32)     PRIMARY KEY,
    name            VARCHAR(256)    NOT NULL,
    type            VARCHAR(32)     NOT NULL,
    format          VARCHAR(16)     NOT NULL,
    filters         JSON            NULL,
    status          VARCHAR(16)     NOT NULL DEFAULT 'processing',
    file_path       VARCHAR(512)    NULL,
    file_size       BIGINT          NULL,
    record_count    INT             NULL,
    error_message   VARCHAR(512)    NULL,
    created_by      VARCHAR(32)     NOT NULL,
    created_at      DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at    DATETIME        NULL,
    expires_at      DATETIME        NULL,

    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_created_by (created_by),
    INDEX idx_created_at (created_at),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 枚举定义汇总

### 管理员角色

| 角色 | 代码 | 描述 |
|------|------|------|
| 超级管理员 | super_admin | 全部权限 |
| 系统管理员 | admin | 管理权限 |
| 财务人员 | finance | 财务相关权限 |

### 管理员状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 正常 | active | 正常可用 |
| 禁用 | disabled | 已禁用 |

### 用户状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 正常 | active | 账户正常可用 |
| 冻结 | frozen | 账户被冻结 |
| 待验证 | pending_kyc | 等待 KYC 验证 |
| 已终止 | terminated | 账户已终止 |

### 提现状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 待审批 | pending | 等待管理员审批 |
| 已通过 | approved | 审批通过 |
| 处理中 | processing | 正在执行链上交易 |
| 已完成 | completed | 提现成功完成 |
| 已拒绝 | rejected | 审批被拒绝 |
| 已取消 | cancelled | 用户取消或系统取消 |
| 失败 | failed | 链上交易失败 |

### 风险等级

| 等级 | 代码 | 分数范围 | 描述 |
|------|------|----------|------|
| 低风险 | low | 0-30 | 可批量审批 |
| 中风险 | medium | 31-60 | 需人工审核 |
| 高风险 | high | 61-100 | 需重点关注 |

### 黑名单来源

| 来源 | 代码 | 描述 |
|------|------|------|
| 手动添加 | manual | 管理员手动添加 |
| 用户举报 | user_report | 用户举报 |
| 第三方数据源 | third_party | Chainalysis 等 |
| 系统自动检测 | auto_detect | 风控系统检测 |
| 关联分析 | association | 关联地址分析 |
| 用户管理标记 | user_management | 用户管理模块标记 |

### 币种类型

| 类型 | 代码 | 描述 |
|------|------|------|
| 原生代币 | native | 链的原生代币 |
| 代币 | token | ERC20/BEP20/TRC20 代币 |

### 币种状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 上架 | active | 正常可用 |
| 下架 | inactive | 已下架 |

### 批次状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 草稿 | draft | 新导入，未提交 |
| 待审批 | pending | 已提交，等待审批 |
| 处理中 | processing | 正在执行转账 |
| 已完成 | completed | 全部转账完成 |
| 部分失败 | partial_failed | 部分转账失败 |
| 已取消 | cancelled | 已取消 |

### 网络状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 健康 | healthy | 正常运行 |
| 降级 | degraded | 部分功能受限 |
| 不可用 | unavailable | 服务不可用 |
| 维护中 | maintenance | 计划维护 |

### 导出状态

| 状态 | 代码 | 描述 |
|------|------|------|
| 处理中 | processing | 正在生成 |
| 已完成 | completed | 生成完成 |
| 失败 | failed | 生成失败 |
| 已过期 | expired | 文件已过期 |

---

## 系统配置项

### 安全配置

| 配置项 | 默认值 | 描述 |
|--------|--------|------|
| session_timeout_minutes | 480 | 会话超时时间（分钟） |
| max_login_attempts | 5 | 最大登录尝试次数 |
| lockout_duration_minutes | 30 | 账户锁定时长（分钟） |
| password_expiry_days | 90 | 密码过期天数 |
| password_min_length | 10 | 密码最小长度 |
| require_2fa | true | 是否强制 2FA |

### 业务限额

| 配置项 | 默认值 | 描述 |
|--------|--------|------|
| user_daily_withdraw_usd | 50000 | 用户每日提现限额 (USD) |
| user_single_withdraw_usd | 10000 | 用户单笔提现限额 (USD) |
| auto_approve_max_usd | 500 | 自动审批最大金额 (USD) |
| batch_max_recipients | 1000 | 批量转账最大收款人数 |
| export_max_records | 500000 | 单次导出最大记录数 |
| export_retention_days | 7 | 导出文件保留天数 |

### 告警阈值

| 配置项 | 默认值 | 描述 |
|--------|--------|------|
| pending_withdrawal_count | 50 | 待审批提现数量告警阈值 |
| pending_withdrawal_amount_usd | 500000 | 待审批提现金额告警阈值 |
| high_withdrawal_volume_usd | 1000000 | 单日提现量告警阈值 |
| rpc_error_rate_threshold | 5% | RPC 错误率告警阈值 |
| sync_delay_seconds | 300 | 同步延迟告警阈值（秒） |

---

## API 限流配置

| 接口类型 | 限流规则 | 说明 |
|----------|----------|------|
| 查询接口 | 60/min | 普通查询 |
| 导出接口 | 10/min | 导出操作 |
| 审批接口 | 30/min | 审批操作 |
| 配置接口 | 20/min | 配置变更 |
| 登录接口 | 10/min/IP | 按 IP 限流 |

---

## 幂等性接口列表

以下接口需要传递 `Idempotency-Key` 请求头：

| 接口 | 方法 | 路径 |
|------|------|------|
| 审批提现 | POST | /api/v1/admin/withdraw/{id}/approve |
| 批量审批提现 | POST | /api/v1/admin/withdraw/batch-approve |
| 申请余额调整 | POST | /api/v1/admin/vault/adjust |
| 审批余额调整 | POST | /api/v1/admin/vault/adjustments/{id}/approve |
| 执行转账批次 | POST | /api/v1/admin/payroll/{batch_id}/process |
| 重试失败转账 | POST | /api/v1/admin/payroll/{batch_id}/retry |

---

## 敏感操作 2FA 要求

以下操作需要 2FA 验证码：

| 操作 | 接口 |
|------|------|
| 审批提现 | /api/v1/admin/withdraw/{id}/approve |
| 批量审批提现 | /api/v1/admin/withdraw/batch-approve |
| 审批余额调整 | /api/v1/admin/vault/adjustments/{id}/approve |
| 执行转账批次 | /api/v1/admin/payroll/{batch_id}/process |
| 手动 RPC 切换 | /api/v1/admin/status/networks/{chain_id}/switch |

---

> 返回 [Admin 服务目录](./README.md)
