# 用户管理

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-016: 获取用户列表

**描述**: 分页获取 Web2 用户列表，支持多条件筛选和排序。

**HTTP 方法**: `GET /api/v1/admin/users`

**请求参数**:
```
?page=1                      // 页码，默认 1
&page_size=20                // 每页条数，默认 20，最大 100
&status=active               // 状态筛选: active, frozen, pending_kyc, terminated
&role=user                   // 角色筛选: user, vip
&keyword=                    // 搜索关键词 (用户ID、邮箱、手机号)
&created_from=2025-01-01     // 注册时间起始
&created_to=2025-12-31       // 注册时间截止
&sort_by=created_at          // 排序字段: created_at, last_login, balance
&sort_order=desc             // 排序方向: asc, desc
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "uid": "10001",
        "email": "user@example.com",
        "phone": "+86138****1234",
        "name": "张三",
        "status": "active",
        "role": "user",
        "kyc_status": "verified",
        "two_factor_enabled": true,
        "total_balance_usd": "15000.00",
        "last_login_at": "2025-12-10T08:30:00Z",
        "last_login_ip": "192.168.1.100",
        "created_at": "2025-01-15T10:00:00Z"
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 12580,
    "total_pages": 629,
    "has_next": true,
    "has_prev": false
  }
}
```

**业务规则**:
- 手机号脱敏显示中间 4 位
- 默认按注册时间降序排列
- 支持导出当前筛选结果

**权限要求**:
- 角色: Admin

---

## F-ADMIN-017: 获取用户详情

**描述**: 获取指定用户的完整信息，包括资产、交易统计等。

**HTTP 方法**: `GET /api/v1/admin/users/{uid}`

**路径参数**:
- `uid`: 用户 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "basic_info": {
      "uid": "10001",
      "email": "user@example.com",
      "phone": "+8613812341234",
      "name": "张三",
      "avatar": "https://cdn.example.com/avatar/10001.jpg",
      "status": "active",
      "role": "user",
      "created_at": "2025-01-15T10:00:00Z"
    },
    "security_info": {
      "two_factor_enabled": true,
      "two_factor_type": "google_authenticator",
      "last_password_change": "2025-06-01T00:00:00Z",
      "login_attempts_today": 2,
      "last_login_at": "2025-12-10T08:30:00Z",
      "last_login_ip": "192.168.1.100",
      "last_login_device": "Chrome/Windows"
    },
    "kyc_info": {
      "status": "verified",
      "level": 2,
      "verified_at": "2025-01-20T14:00:00Z",
      "id_type": "id_card",
      "id_number": "310***********1234"
    },
    "asset_summary": {
      "total_balance_usd": "15000.00",
      "balances": [
        {"currency": "USDT", "balance": "10000.000000", "balance_usd": "10000.00"},
        {"currency": "ETH", "balance": "2.000000", "balance_usd": "5000.00"}
      ]
    },
    "transaction_summary": {
      "total_deposits": 25,
      "total_deposit_amount_usd": "50000.00",
      "total_withdrawals": 10,
      "total_withdrawal_amount_usd": "35000.00",
      "total_swaps": 15,
      "last_transaction_at": "2025-12-09T16:00:00Z"
    },
    "whitelist_addresses": [
      {
        "id": "wl-001",
        "network": "Ethereum",
        "address": "0x1234...5678",
        "label": "个人钱包",
        "created_at": "2025-03-01T10:00:00Z"
      }
    ],
    "admin_notes": [
      {
        "id": "note-001",
        "content": "用户反馈提现延迟问题，已处理",
        "operator": "admin@company.com",
        "created_at": "2025-12-01T10:00:00Z"
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-018: 冻结用户

**描述**: 冻结指定用户账户，禁止登录和所有交易操作。

**HTTP 方法**: `POST /api/v1/admin/users/{uid}/freeze`

**路径参数**:
- `uid`: 用户 ID

**请求 Schema**:
```json
{
  "reason": "可疑交易行为",         // 冻结原因 (必填)
  "freeze_assets": true,            // 是否同时冻结资产 (默认 true)
  "notify_user": true               // 是否通知用户 (默认 true)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "用户已冻结",
  "data": {
    "uid": "10001",
    "status": "frozen",
    "frozen_at": "2025-12-10T10:00:00Z",
    "frozen_by": "admin@company.com",
    "reason": "可疑交易行为"
  }
}
```

**业务规则**:
- 冻结后用户无法登录
- 冻结后所有交易自动取消
- 待审批的提现自动拒绝
- 记录操作日志

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| USER_NOT_FOUND | 404 | 用户不存在 |
| USER_ALREADY_FROZEN | 409 | 用户已处于冻结状态 |
| USER_IS_ADMIN | 403 | 不能冻结管理员账户 |

---

## F-ADMIN-019: 解冻用户

**描述**: 解除用户账户冻结，恢复正常状态。

**HTTP 方法**: `POST /api/v1/admin/users/{uid}/unfreeze`

**路径参数**:
- `uid`: 用户 ID

**请求 Schema**:
```json
{
  "reason": "误判，已核实安全",     // 解冻原因 (必填)
  "unfreeze_assets": true,          // 是否同时解冻资产 (默认 true)
  "notify_user": true               // 是否通知用户 (默认 true)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "用户已解冻",
  "data": {
    "uid": "10001",
    "status": "active",
    "unfrozen_at": "2025-12-10T11:00:00Z",
    "unfrozen_by": "admin@company.com",
    "reason": "误判，已核实安全"
  }
}
```

**业务规则**:
- 解冻后用户可正常登录
- 资产解冻需单独确认
- 记录操作日志

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| USER_NOT_FOUND | 404 | 用户不存在 |
| USER_NOT_FROZEN | 409 | 用户未处于冻结状态 |

---

## F-ADMIN-020: 终止用户

**描述**: 标记用户为离职/终止状态，通常用于企业员工离职处理。

**HTTP 方法**: `POST /api/v1/admin/users/{uid}/terminate`

**路径参数**:
- `uid`: 用户 ID

**请求 Schema**:
```json
{
  "reason": "员工离职",             // 终止原因 (必填)
  "effective_date": "2025-12-15",   // 生效日期
  "handle_balance": "freeze",        // 余额处理: freeze(冻结), withdraw(强制提现到指定地址)
  "withdraw_address": ""             // handle_balance=withdraw 时必填
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "用户已终止",
  "data": {
    "uid": "10001",
    "status": "terminated",
    "terminated_at": "2025-12-10T10:00:00Z",
    "terminated_by": "admin@company.com",
    "reason": "员工离职",
    "balance_handled": "frozen"
  }
}
```

**业务规则**:
- 终止后账户永久禁用
- 可选择冻结余额或强制提现
- 所有待处理交易自动取消
- 记录完整操作日志

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| USER_NOT_FOUND | 404 | 用户不存在 |
| USER_ALREADY_TERMINATED | 409 | 用户已终止 |
| INVALID_WITHDRAW_ADDRESS | 400 | 提现地址无效 |

---

## F-ADMIN-021: 更新用户角色

**描述**: 更新用户的角色级别。

**HTTP 方法**: `PUT /api/v1/admin/users/{uid}/role`

**路径参数**:
- `uid`: 用户 ID

**请求 Schema**:
```json
{
  "role": "vip",                    // 新角色: user, vip
  "reason": "业绩达标升级"          // 变更原因
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "角色已更新",
  "data": {
    "uid": "10001",
    "old_role": "user",
    "new_role": "vip",
    "updated_at": "2025-12-10T10:00:00Z",
    "updated_by": "admin@company.com"
  }
}
```

**业务规则**:
- 角色变更立即生效
- VIP 用户享有更高提现限额
- 记录角色变更历史

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| USER_NOT_FOUND | 404 | 用户不存在 |
| INVALID_ROLE | 400 | 无效的角色 |
| SAME_ROLE | 400 | 新角色与当前角色相同 |

---

## F-ADMIN-022: 添加管理员备注

**描述**: 为用户添加管理员备注，用于记录重要信息。

**HTTP 方法**: `POST /api/v1/admin/users/{uid}/notes`

**路径参数**:
- `uid`: 用户 ID

**请求 Schema**:
```json
{
  "content": "用户反馈提现延迟问题，已处理",   // 备注内容 (必填)
  "is_important": false                        // 是否重要标记
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "备注已添加",
  "data": {
    "id": "note-001",
    "uid": "10001",
    "content": "用户反馈提现延迟问题，已处理",
    "is_important": false,
    "operator": "admin@company.com",
    "created_at": "2025-12-10T10:00:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-023: 导出用户列表

**描述**: 导出用户列表为 Excel 文件。

**HTTP 方法**: `POST /api/v1/admin/users/export`

**请求 Schema**:
```json
{
  "filters": {
    "status": "active",
    "role": "user",
    "created_from": "2025-01-01",
    "created_to": "2025-12-31"
  },
  "fields": [                       // 导出字段选择
    "uid",
    "email",
    "phone",
    "name",
    "status",
    "role",
    "total_balance_usd",
    "created_at"
  ],
  "format": "xlsx"                  // 格式: xlsx, csv
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "导出任务已创建",
  "data": {
    "export_id": "exp-20251210-001",
    "status": "processing",
    "estimated_time": 60,
    "download_url": null
  }
}
```

**业务规则**:
- 大数据量异步导出
- 导出文件保留 7 天
- 单次最多导出 10 万条
- 敏感字段可选脱敏

**权限要求**:
- 角色: Admin

---

## 用户状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 正常 | active | 账户正常可用 |
| 冻结 | frozen | 账户被冻结 |
| 待验证 | pending_kyc | 等待 KYC 验证 |
| 已终止 | terminated | 账户已终止 |

## 用户角色枚举

| 角色 | 代码 | 描述 |
|------|------|------|
| 普通用户 | user | 标准用户权限 |
| VIP 用户 | vip | 更高限额和优先服务 |

---

> 返回 [Admin 服务目录](./README.md)
