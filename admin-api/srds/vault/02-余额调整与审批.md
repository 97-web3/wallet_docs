# Vault 资金管理 - 余额调整与审批

> 返回 [Vault 资金管理索引](../10-Vault资金管理.md)

---

## F-ADMIN-082: 申请余额调整

**描述**: 申请调整 Vault 余额（增加或减少）。

**HTTP 方法**: `POST /api/v1/admin/vault/adjust`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**请求 Schema**:
```json
{
  "network": "Ethereum",
  "chain_id": 1,
  "currency": "USDT",
  "adjustment_type": "increase",    // increase, decrease
  "amount": "100000.000000",
  "reason": "补充提现资金",
  "source": "cold_wallet",           // cold_wallet, exchange, other
  "source_address": "0xCold...1234",
  "tx_hash": "0xPending...5678",     // 可选，已有链上交易
  "attachments": [                   // 可选，附件
    {
      "name": "transfer_proof.pdf",
      "url": "https://storage.example.com/attachments/xxx.pdf"
    }
  ]
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "调整申请已提交",
  "data": {
    "adjustment_id": "adj-20251210-001",
    "status": "pending_approval",
    "amount": "100000.000000",
    "currency": "USDT",
    "network": "Ethereum",
    "submitted_at": "2025-12-10T10:00:00Z",
    "submitted_by": "finance@company.com"
  }
}
```

**业务规则**:
- 调整申请需要审批
- 大额调整需要多级审批
- 记录完整操作日志

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| INVALID_NETWORK | 400 | 无效的网络 |
| INVALID_CURRENCY | 400 | 无效的币种 |
| INSUFFICIENT_BALANCE | 400 | 减少金额超过可用余额 |
| PENDING_ADJUSTMENT_EXISTS | 409 | 存在待审批的调整申请 |

---

## F-ADMIN-083: 获取调整历史

**描述**: 获取 Vault 余额调整历史记录。

**HTTP 方法**: `GET /api/v1/admin/vault/adjustments`

**请求参数**:
```
?page=1
&page_size=20
&status=                     // pending_approval, approved, rejected, completed
&network=
&currency=
&adjustment_type=            // increase, decrease
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "adjustments": [
      {
        "id": "adj-20251210-001",
        "network": "Ethereum",
        "currency": "USDT",
        "adjustment_type": "increase",
        "amount": "100000.000000",
        "amount_usd": "100000.00",
        "reason": "补充提现资金",
        "source": "cold_wallet",
        "status": "pending_approval",
        "submitted_by": "finance@company.com",
        "submitted_at": "2025-12-10T10:00:00Z",
        "approved_by": null,
        "approved_at": null,
        "tx_hash": null,
        "completed_at": null
      },
      {
        "id": "adj-20251209-001",
        "network": "BSC",
        "currency": "USDT",
        "adjustment_type": "increase",
        "amount": "200000.000000",
        "amount_usd": "200000.00",
        "reason": "紧急补充",
        "status": "completed",
        "submitted_by": "finance@company.com",
        "submitted_at": "2025-12-09T15:00:00Z",
        "approved_by": "admin@company.com",
        "approved_at": "2025-12-09T15:30:00Z",
        "tx_hash": "0xCompleted...1234",
        "completed_at": "2025-12-09T16:00:00Z"
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 45,
    "total_pages": 3
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-084: 审批余额调整

**描述**: 审批通过或拒绝余额调整申请。

**HTTP 方法**: `POST /api/v1/admin/vault/adjustments/{id}/approve`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**路径参数**:
- `id`: 调整申请 ID

**请求 Schema**:
```json
{
  "action": "approve",          // approve, reject
  "note": "已核实转账记录",
  "2fa_code": "123456"          // 2FA 验证码 (必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "调整申请已审批通过",
  "data": {
    "id": "adj-20251210-001",
    "status": "approved",
    "approved_at": "2025-12-10T10:30:00Z",
    "approved_by": "admin@company.com",
    "next_step": "等待链上确认"
  }
}
```

**业务规则**:
- SuperAdmin 可单独审批
- 其他角色需要多人审批（Maker-Checker）
- 审批后自动触发链上操作

**权限要求**:
- 角色: SuperAdmin（单独审批）
- 角色: Admin（需要另一个 Admin 或 SuperAdmin 复核）

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| ADJUSTMENT_NOT_FOUND | 404 | 调整申请不存在 |
| ADJUSTMENT_NOT_PENDING | 409 | 申请不是待审批状态 |
| CANNOT_APPROVE_OWN | 400 | 不能审批自己提交的申请 |
| AUTH_2FA_CODE_INVALID | 401 | 2FA 验证码错误 |

---

## 调整状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 待审批 | pending_approval | 等待审批 |
| 已通过 | approved | 审批通过 |
| 已拒绝 | rejected | 审批拒绝 |
| 处理中 | processing | 链上处理中 |
| 已完成 | completed | 调整完成 |
| 失败 | failed | 调整失败 |

## 调整类型枚举

| 类型 | 代码 | 描述 |
|------|------|------|
| 增加 | increase | 增加余额 |
| 减少 | decrease | 减少余额 |

## 资金来源枚举

| 来源 | 代码 | 描述 |
|------|------|------|
| 冷钱包 | cold_wallet | 从冷钱包转入 |
| 交易所 | exchange | 从交易所转入 |
| 其他 | other | 其他来源 |

---

> 返回 [Vault 资金管理索引](../10-Vault资金管理.md)

