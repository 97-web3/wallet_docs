# 转账管理

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-087: 获取转账批次列表

**描述**: 获取批量转账批次列表。

**HTTP 方法**: `GET /api/v1/admin/payroll/batches`

**请求参数**:
```
?page=1
&page_size=20
&status=                     // draft, pending, processing, completed, failed, cancelled
&network=
&currency=
&date_from=
&date_to=
&keyword=                    // 搜索批次名称、ID
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "batches": [
      {
        "batch_id": "batch-20251210-001",
        "name": "12月工资发放",
        "network": "Ethereum",
        "currency": "USDT",
        "total_recipients": 125,
        "total_amount": "625000.000000",
        "total_amount_usd": "625000.00",
        "status": "completed",
        "success_count": 125,
        "failed_count": 0,
        "success_rate": "100%",
        "created_by": "finance@company.com",
        "created_at": "2025-12-10T08:00:00Z",
        "processed_at": "2025-12-10T09:00:00Z",
        "completed_at": "2025-12-10T09:30:00Z"
      },
      {
        "batch_id": "batch-20251209-001",
        "name": "供应商结算",
        "network": "BSC",
        "currency": "USDT",
        "total_recipients": 45,
        "total_amount": "180000.000000",
        "total_amount_usd": "180000.00",
        "status": "processing",
        "success_count": 38,
        "failed_count": 2,
        "pending_count": 5,
        "success_rate": "84.4%",
        "created_by": "finance@company.com",
        "created_at": "2025-12-09T14:00:00Z",
        "processed_at": "2025-12-09T15:00:00Z"
      }
    ],
    "summary": {
      "total_batches": 156,
      "processing_batches": 2,
      "total_transferred_usd": "8500000.00"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 156,
    "total_pages": 8
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-088: 导入转账批次

**描述**: 通过 Excel 文件导入批量转账数据。

**HTTP 方法**: `POST /api/v1/admin/payroll/import`

**请求**: `multipart/form-data`
```
file: <Excel 文件>
name: "12月工资发放"
network: "Ethereum"
currency: "USDT"
description: "2025年12月员工工资"
```

**Excel 模板格式**:
| 收款地址 | 金额 | 备注 |
|----------|------|------|
| 0x1234...5678 | 5000.00 | 张三工资 |
| 0xabcd...efgh | 4500.00 | 李四工资 |

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次导入成功",
  "data": {
    "batch_id": "batch-20251210-002",
    "name": "12月工资发放",
    "network": "Ethereum",
    "currency": "USDT",
    "status": "draft",
    "import_result": {
      "total_rows": 130,
      "valid_rows": 125,
      "invalid_rows": 5,
      "total_amount": "625000.000000",
      "errors": [
        {"row": 15, "error": "地址格式无效"},
        {"row": 28, "error": "金额必须大于 0"},
        {"row": 45, "error": "地址在黑名单中"},
        {"row": 89, "error": "重复的收款地址"},
        {"row": 102, "error": "地址格式无效"}
      ]
    },
    "created_at": "2025-12-10T10:00:00Z"
  }
}
```

**业务规则**:
- 支持 xlsx、xls、csv 格式
- 单批次最多 1000 条记录
- 自动校验地址格式和黑名单
- 自动去除重复地址

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| INVALID_FILE_FORMAT | 400 | 文件格式不支持 |
| FILE_TOO_LARGE | 400 | 文件超过大小限制 |
| EMPTY_FILE | 400 | 文件内容为空 |
| TOO_MANY_ROWS | 400 | 记录数超过限制 |

---

## F-ADMIN-089: 获取批次详情

**描述**: 获取转账批次的详细信息和收款人列表。

**HTTP 方法**: `GET /api/v1/admin/payroll/{batch_id}`

**路径参数**:
- `batch_id`: 批次 ID

**请求参数**:
```
?page=1
&page_size=50
&status=                     // pending, success, failed
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "batch_id": "batch-20251210-001",
    "name": "12月工资发放",
    "description": "2025年12月员工工资",
    "network": "Ethereum",
    "currency": "USDT",
    "status": "completed",
    "summary": {
      "total_recipients": 125,
      "total_amount": "625000.000000",
      "total_amount_usd": "625000.00",
      "total_fee": "15.625000",
      "total_fee_usd": "39.06",
      "success_count": 125,
      "failed_count": 0,
      "pending_count": 0
    },
    "recipients": [
      {
        "id": "rcpt-001",
        "address": "0x1234567890abcdef1234567890abcdef12345678",
        "amount": "5000.000000",
        "note": "张三工资",
        "status": "success",
        "tx_hash": "0xabc...123",
        "fee": "0.125",
        "processed_at": "2025-12-10T09:15:00Z"
      },
      {
        "id": "rcpt-002",
        "address": "0xabcdef1234567890abcdef1234567890abcdef12",
        "amount": "4500.000000",
        "note": "李四工资",
        "status": "success",
        "tx_hash": "0xdef...456",
        "fee": "0.125",
        "processed_at": "2025-12-10T09:16:00Z"
      }
    ],
    "timeline": [
      {"status": "draft", "timestamp": "2025-12-10T08:00:00Z", "operator": "finance@company.com"},
      {"status": "pending", "timestamp": "2025-12-10T08:30:00Z", "operator": "finance@company.com"},
      {"status": "approved", "timestamp": "2025-12-10T08:45:00Z", "operator": "admin@company.com"},
      {"status": "processing", "timestamp": "2025-12-10T09:00:00Z", "operator": "system"},
      {"status": "completed", "timestamp": "2025-12-10T09:30:00Z", "operator": "system"}
    ],
    "created_by": "finance@company.com",
    "created_at": "2025-12-10T08:00:00Z",
    "approved_by": "admin@company.com",
    "approved_at": "2025-12-10T08:45:00Z"
  },
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 125,
    "total_pages": 3
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-090: 提交批次审批

**描述**: 将草稿状态的批次提交审批。

**HTTP 方法**: `POST /api/v1/admin/payroll/{batch_id}/submit`

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "note": "请审批12月工资发放"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已提交审批",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "pending",
    "submitted_at": "2025-12-10T08:30:00Z"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-091: 审批并执行批次

**描述**: 审批通过并开始执行转账批次。

**HTTP 方法**: `POST /api/v1/admin/payroll/{batch_id}/process`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "action": "approve",          // approve, reject
  "note": "已核实，批准执行",
  "2fa_code": "123456"          // 2FA 验证码 (必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已开始执行",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "processing",
    "approved_at": "2025-12-10T08:45:00Z",
    "approved_by": "admin@company.com",
    "estimated_completion": "2025-12-10T09:30:00Z"
  }
}
```

**业务规则**:
- 需要 2FA 验证
- 需要幂等键防止重复执行
- 执行前检查 Vault 余额
- 自动拆分大批次分批执行

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| BATCH_NOT_FOUND | 404 | 批次不存在 |
| BATCH_NOT_PENDING | 409 | 批次不是待审批状态 |
| INSUFFICIENT_VAULT_BALANCE | 422 | Vault 余额不足 |
| AUTH_2FA_CODE_INVALID | 401 | 2FA 验证码错误 |

---

## F-ADMIN-092: 取消批次

**描述**: 取消草稿或待审批状态的批次。

**HTTP 方法**: `POST /api/v1/admin/payroll/{batch_id}/cancel`

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "reason": "数据有误，需重新导入"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已取消",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "cancelled",
    "cancelled_at": "2025-12-10T08:30:00Z",
    "cancelled_by": "finance@company.com"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| BATCH_NOT_FOUND | 404 | 批次不存在 |
| BATCH_CANNOT_CANCEL | 409 | 批次已开始执行，无法取消 |

---

## F-ADMIN-093: 获取转账历史

**描述**: 获取所有转账的历史记录。

**HTTP 方法**: `GET /api/v1/admin/payroll/history`

**请求参数**:
```
?page=1
&page_size=50
&batch_id=                   // 批次 ID 筛选
&network=
&currency=
&address=                    // 收款地址搜索
&status=                     // pending, success, failed
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "transfers": [
      {
        "id": "transfer-001",
        "batch_id": "batch-20251210-001",
        "batch_name": "12月工资发放",
        "network": "Ethereum",
        "currency": "USDT",
        "to_address": "0x1234...5678",
        "amount": "5000.000000",
        "amount_usd": "5000.00",
        "fee": "0.125",
        "fee_usd": "0.31",
        "note": "张三工资",
        "status": "success",
        "tx_hash": "0xabc...123",
        "created_at": "2025-12-10T08:00:00Z",
        "processed_at": "2025-12-10T09:15:00Z"
      }
    ],
    "summary": {
      "total_transfers": 5680,
      "total_amount_usd": "8500000.00",
      "success_rate": "99.8%"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 5680,
    "total_pages": 114
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-094: 导出批次报告

**描述**: 导出指定批次的转账报告。

**HTTP 方法**: `GET /api/v1/admin/payroll/{batch_id}/export`

**路径参数**:
- `batch_id`: 批次 ID

**请求参数**:
```
?format=xlsx                 // xlsx, csv, pdf
```

**响应**: 文件流下载

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-095: 重试失败转账

**描述**: 重试批次中失败的转账记录。

**HTTP 方法**: `POST /api/v1/admin/payroll/{batch_id}/retry`

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "transfer_ids": ["transfer-001", "transfer-002"],  // 可选，不填则重试全部失败
  "2fa_code": "123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "重试任务已启动",
  "data": {
    "batch_id": "batch-20251210-001",
    "retry_count": 5,
    "status": "processing"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## 批次状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 草稿 | draft | 新导入，未提交 |
| 待审批 | pending | 已提交，等待审批 |
| 处理中 | processing | 正在执行转账 |
| 已完成 | completed | 全部转账完成 |
| 部分失败 | partial_failed | 部分转账失败 |
| 已取消 | cancelled | 已取消 |

## 转账状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 待处理 | pending | 等待执行 |
| 成功 | success | 转账成功 |
| 失败 | failed | 转账失败 |
| 重试中 | retrying | 正在重试 |

---

> 返回 [Admin 服务目录](./README.md)
