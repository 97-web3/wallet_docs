# Web3 用户管理

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-073: 获取 Web3 用户列表

**描述**: 获取 Web3 钱包用户（设备）列表。

**HTTP 方法**: `GET /api/v1/admin/web3users`

**请求参数**:
```
?page=1
&page_size=20
&address_status=             // 地址状态: normal, blacklisted
&two_factor_enabled=         // 2FA 状态: true, false
&biometric_enabled=          // 生物识别: true, false
&network=                    // 网络筛选
&keyword=                    // 搜索 (设备ID、钱包地址)
&created_from=
&created_to=
&sort_by=created_at
&sort_order=desc
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "web3-10001",
        "device_id": "device-abc123",
        "device_info": {
          "platform": "iOS",
          "os_version": "17.0",
          "app_version": "2.1.0",
          "device_model": "iPhone 15 Pro"
        },
        "wallet_count": 3,
        "networks": ["Ethereum", "BSC", "Polygon"],
        "primary_address": "0x1234...5678",
        "total_balance_usd": "15000.00",
        "two_factor_enabled": true,
        "biometric_enabled": true,
        "has_blacklisted_address": false,
        "last_active_at": "2025-12-10T09:30:00Z",
        "created_at": "2025-06-15T10:00:00Z"
      }
    ],
    "summary": {
      "total_devices": 8560,
      "total_addresses": 25680,
      "blacklisted_addresses": 45,
      "two_factor_rate": "78.5%"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 8560,
    "total_pages": 428
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-074: 获取 Web3 用户详情

**描述**: 获取指定设备的完整信息，包括所有钱包地址。

**HTTP 方法**: `GET /api/v1/admin/web3users/{device_id}`

**路径参数**:
- `device_id`: 设备 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "id": "web3-10001",
    "device_id": "device-abc123",
    "device_info": {
      "platform": "iOS",
      "os_version": "17.0",
      "app_version": "2.1.0",
      "device_model": "iPhone 15 Pro",
      "device_name": "My iPhone",
      "push_token": "apns-xxx...",
      "locale": "zh_CN"
    },
    "security_info": {
      "two_factor_enabled": true,
      "two_factor_type": "google_authenticator",
      "biometric_enabled": true,
      "biometric_type": "face_id",
      "last_security_update": "2025-11-01T00:00:00Z"
    },
    "wallet_addresses": [
      {
        "network": "Ethereum",
        "chain_id": 1,
        "address": "0x1234567890abcdef1234567890abcdef12345678",
        "is_primary": true,
        "enabled": true,
        "is_blacklisted": false,
        "balance": "2.500000",
        "balance_usd": "6250.00",
        "token_balances": [
          {"currency": "USDT", "balance": "5000.000000", "balance_usd": "5000.00"},
          {"currency": "USDC", "balance": "2000.000000", "balance_usd": "2000.00"}
        ],
        "created_at": "2025-06-15T10:00:00Z",
        "last_transaction_at": "2025-12-09T15:00:00Z"
      },
      {
        "network": "BSC",
        "chain_id": 56,
        "address": "0xabcd...efgh",
        "is_primary": false,
        "enabled": true,
        "is_blacklisted": false,
        "balance": "10.000000",
        "balance_usd": "3000.00"
      },
      {
        "network": "Polygon",
        "chain_id": 137,
        "address": "0xijkl...mnop",
        "is_primary": false,
        "enabled": false,
        "is_blacklisted": true,
        "blacklist_reason": "关联可疑交易",
        "blacklisted_at": "2025-10-15T00:00:00Z",
        "blacklisted_by": "admin@company.com"
      }
    ],
    "activity_summary": {
      "total_transactions": 156,
      "total_deposit_usd": "50000.00",
      "total_withdrawal_usd": "35000.00",
      "total_swap_usd": "15000.00",
      "first_transaction_at": "2025-06-20T00:00:00Z",
      "last_transaction_at": "2025-12-09T15:00:00Z"
    },
    "created_at": "2025-06-15T10:00:00Z",
    "last_active_at": "2025-12-10T09:30:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-075: 将地址加入黑名单

**描述**: 将指定设备的某个钱包地址加入黑名单。

**HTTP 方法**: `POST /api/v1/admin/web3users/{device_id}/addresses/{address}/blacklist`

**路径参数**:
- `device_id`: 设备 ID
- `address`: 钱包地址

**请求 Schema**:
```json
{
  "reason": "关联可疑交易",
  "risk_level": "high",
  "disable_address": true,      // 是否同时禁用该地址
  "notify_user": true           // 是否通知用户
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址已加入黑名单",
  "data": {
    "device_id": "device-abc123",
    "address": "0x1234...5678",
    "network": "Ethereum",
    "is_blacklisted": true,
    "blacklist_reason": "关联可疑交易",
    "risk_level": "high",
    "blacklisted_at": "2025-12-10T10:00:00Z",
    "blacklisted_by": "admin@company.com"
  }
}
```

**业务规则**:
- 黑名单地址禁止接收和发送交易
- 同步添加到全局黑名单
- 记录操作日志

**权限要求**:
- 角色: Admin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| DEVICE_NOT_FOUND | 404 | 设备不存在 |
| ADDRESS_NOT_FOUND | 404 | 地址不属于该设备 |
| ADDRESS_ALREADY_BLACKLISTED | 409 | 地址已在黑名单中 |

---

## F-ADMIN-076: 将地址移出黑名单

**描述**: 将指定地址从黑名单中移除。

**HTTP 方法**: `DELETE /api/v1/admin/web3users/{device_id}/addresses/{address}/blacklist`

**路径参数**:
- `device_id`: 设备 ID
- `address`: 钱包地址

**请求 Schema**:
```json
{
  "reason": "误判，已核实安全",
  "enable_address": true,       // 是否同时启用该地址
  "notify_user": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址已移出黑名单",
  "data": {
    "device_id": "device-abc123",
    "address": "0x1234...5678",
    "is_blacklisted": false,
    "removed_at": "2025-12-10T10:00:00Z",
    "removed_by": "admin@company.com",
    "remove_reason": "误判，已核实安全"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-077: 批量操作地址黑名单

**描述**: 批量将地址加入或移出黑名单。

**HTTP 方法**: `POST /api/v1/admin/web3users/addresses/blacklist/batch`

**请求 Schema**:
```json
{
  "action": "add",              // add, remove
  "addresses": [
    {
      "device_id": "device-abc123",
      "address": "0x1234...5678"
    },
    {
      "device_id": "device-def456",
      "address": "0xabcd...efgh"
    }
  ],
  "reason": "批量风险处理",
  "risk_level": "high",
  "notify_users": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批量操作完成",
  "data": {
    "total": 2,
    "succeeded": 2,
    "failed": 0,
    "results": [
      {"device_id": "device-abc123", "address": "0x1234...5678", "status": "success"},
      {"device_id": "device-def456", "address": "0xabcd...efgh", "status": "success"}
    ]
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-078: 获取 Web3 用户统计

**描述**: 获取 Web3 用户相关统计数据。

**HTTP 方法**: `GET /api/v1/admin/web3users/statistics`

**请求参数**:
```
?period=30d                  // 时间范围: 7d, 30d, 90d
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "total_devices": 8560,
      "active_devices_30d": 5200,
      "total_addresses": 25680,
      "blacklisted_addresses": 45,
      "total_balance_usd": "125000000.00"
    },
    "by_network": [
      {
        "network": "Ethereum",
        "address_count": 8560,
        "balance_usd": "65000000.00",
        "percentage": "52%"
      },
      {
        "network": "BSC",
        "address_count": 8560,
        "balance_usd": "35000000.00",
        "percentage": "28%"
      },
      {
        "network": "Polygon",
        "address_count": 5120,
        "balance_usd": "15000000.00",
        "percentage": "12%"
      },
      {
        "network": "Tron",
        "address_count": 3440,
        "balance_usd": "10000000.00",
        "percentage": "8%"
      }
    ],
    "by_platform": [
      {"platform": "iOS", "device_count": 5200, "percentage": "60.7%"},
      {"platform": "Android", "device_count": 3360, "percentage": "39.3%"}
    ],
    "security_stats": {
      "two_factor_enabled": 6720,
      "two_factor_rate": "78.5%",
      "biometric_enabled": 5980,
      "biometric_rate": "69.9%"
    },
    "growth_trend": [
      {"date": "2025-11-11", "new_devices": 45, "total_devices": 8100}
    ]
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-079: 导出 Web3 用户

**描述**: 导出 Web3 用户数据为 Excel 文件。

**HTTP 方法**: `GET /api/v1/admin/web3users/export`

**请求参数**:
```
?format=xlsx                 // xlsx, csv
&include_addresses=true      // 是否包含地址明细
&filters[network]=Ethereum   // 筛选条件
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "导出任务已创建",
  "data": {
    "export_id": "exp-web3-20251210-001",
    "status": "processing",
    "estimated_records": 8560,
    "estimated_time": 120
  }
}
```

**权限要求**:
- 角色: Admin

---

## 地址状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 正常 | normal | 地址正常可用 |
| 黑名单 | blacklisted | 已加入黑名单 |
| 禁用 | disabled | 已禁用 |

## 风险等级枚举

| 等级 | 代码 | 描述 |
|------|------|------|
| 高风险 | high | 确认风险 |
| 中风险 | medium | 疑似风险 |
| 低风险 | low | 轻微风险 |

## 设备平台枚举

| 平台 | 代码 | 描述 |
|------|------|------|
| iOS | iOS | Apple iOS |
| Android | Android | Google Android |

---

> 返回 [Admin 服务目录](./README.md)
