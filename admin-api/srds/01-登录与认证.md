# 登录与认证

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-001: 管理员登录

**描述**: 管理员使用账号密码登录后台管理系统。

**HTTP 方法**: `POST /api/v1/auth/admin/login`

**请求 Schema**:
```json
{
  "username": "admin@company.com",   // 管理员账号（邮箱）
  "password": "SecurePass123!",       // 登录密码
  "captcha_id": "cap-uuid-xxx",       // 验证码 ID (可选，连续失败后需要)
  "captcha_code": "1234"              // 验证码 (可选)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "admin_id": "admin-10001",
    "username": "admin@company.com",
    "name": "张三",
    "role": "admin",
    "permissions": ["user.read", "user.write", "withdraw.approve"],
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 28800,
    "requires_2fa": true,              // 是否需要 2FA 验证
    "2fa_token": "2fa-temp-token"      // 临时 Token (需要 2FA 时)
  }
}
```

**业务规则**:
- 密码连续错误 5 次，账户锁定 30 分钟
- 连续错误 3 次后需要输入验证码
- 登录成功后 Token 有效期 8 小时
- 记录登录日志（IP、设备、时间、结果）
- 如启用 2FA，登录后需进行二次验证

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_INVALID_CREDENTIALS | 401 | 账号或密码错误 |
| AUTH_ACCOUNT_LOCKED | 423 | 账户已被锁定 |
| AUTH_CAPTCHA_REQUIRED | 400 | 需要输入验证码 |
| AUTH_CAPTCHA_INVALID | 400 | 验证码错误 |
| AUTH_ACCOUNT_DISABLED | 403 | 账户已被禁用 |

---

## F-ADMIN-002: 二次验证 (2FA)

**描述**: 对启用了 2FA 的管理员进行二次身份验证。

**HTTP 方法**: `POST /api/v1/auth/admin/verify-2fa`

**请求 Schema**:
```json
{
  "2fa_token": "2fa-temp-token",    // 登录返回的临时 Token
  "code": "123456"                   // Google Authenticator 验证码
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "验证成功",
  "data": {
    "admin_id": "admin-10001",
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 28800
  }
}
```

**业务规则**:
- 临时 Token 有效期 5 分钟
- 验证码连续错误 5 次，需重新登录
- 验证码基于 TOTP 算法，30 秒更新一次
- 支持前后各 1 个时间窗口的容错

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_2FA_TOKEN_EXPIRED | 401 | 2FA 临时 Token 已过期 |
| AUTH_2FA_CODE_INVALID | 401 | 验证码错误 |
| AUTH_2FA_TOO_MANY_ATTEMPTS | 429 | 尝试次数过多，请重新登录 |

---

## F-ADMIN-003: 刷新 Token

**描述**: 在 Token 即将过期时刷新获取新 Token。

**HTTP 方法**: `POST /api/v1/auth/admin/refresh`

**请求头**:
```
Authorization: Bearer {access_token}
```

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "Token 刷新成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 28800
  }
}
```

**业务规则**:
- Token 剩余有效期少于 2 小时时可刷新
- 刷新后旧 Token 立即失效
- 每个 Token 只能刷新一次

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_TOKEN_INVALID | 401 | Token 无效 |
| AUTH_TOKEN_EXPIRED | 401 | Token 已过期，请重新登录 |
| AUTH_REFRESH_NOT_ALLOWED | 400 | Token 有效期充足，无需刷新 |

---

## F-ADMIN-004: 管理员登出

**描述**: 使当前会话的 Token 失效并记录登出。

**HTTP 方法**: `POST /api/v1/auth/admin/logout`

**请求头**:
```
Authorization: Bearer {access_token}
```

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登出成功"
}
```

**业务规则**:
- Token 加入黑名单，立即失效
- 记录登出日志
- 清除服务端会话缓存

---

## 安全规范

### 密码要求

| 规则 | 要求 |
|------|------|
| 最小长度 | 10 字符 |
| 大写字母 | 至少 1 个 |
| 小写字母 | 至少 1 个 |
| 数字 | 至少 1 个 |
| 特殊字符 | 至少 1 个 (!@#$%^&*) |
| 禁止内容 | 不能包含用户名 |
| 历史密码 | 不能与最近 5 次相同 |

### Token 规范

| 配置项 | 值 | 说明 |
|--------|----|----|
| 算法 | HS256 | HMAC-SHA256 |
| 有效期 | 8 小时 | 28800 秒 |
| 刷新窗口 | 2 小时 | 剩余 2 小时内可刷新 |
| 存储方式 | HttpOnly Cookie | 防 XSS |

### 登录日志

每次登录/登出记录以下信息:

| 字段 | 说明 |
|------|------|
| admin_id | 管理员 ID |
| action | login/logout/login_failed |
| ip | 客户端 IP |
| user_agent | 浏览器 UA |
| location | IP 归属地 |
| timestamp | 操作时间 |
| result | success/failed |
| reason | 失败原因 (如有) |

---

> 返回 [Admin 服务目录](./README.md)
