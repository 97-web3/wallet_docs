# 报表与导出

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-058: 获取交易报表

**描述**: 获取交易统计报表数据。

**HTTP 方法**: `GET /api/v1/admin/reports/transactions`

**请求参数**:
```
?report_type=deposit         // 报表类型: deposit, withdrawal, comprehensive, swap
&date_from=2025-12-01        // 开始日期
&date_to=2025-12-10          // 结束日期
&network=                    // 网络筛选
&currency=                   // 币种筛选
&group_by=day                // 分组: day, week, month
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "report_type": "deposit",
    "period": {
      "from": "2025-12-01",
      "to": "2025-12-10"
    },
    "summary": {
      "total_count": 256,
      "total_amount_usd": "1500000.00",
      "avg_amount_usd": "5859.38",
      "unique_users": 189
    },
    "by_network": [
      {
        "network": "Ethereum",
        "count": 120,
        "amount_usd": "850000.00",
        "percentage": "56.7%"
      },
      {
        "network": "BSC",
        "count": 86,
        "amount_usd": "420000.00",
        "percentage": "28.0%"
      },
      {
        "network": "Tron",
        "count": 50,
        "amount_usd": "230000.00",
        "percentage": "15.3%"
      }
    ],
    "by_currency": [
      {
        "currency": "USDT",
        "count": 180,
        "amount_usd": "1100000.00",
        "percentage": "73.3%"
      },
      {
        "currency": "ETH",
        "count": 45,
        "amount_usd": "280000.00",
        "percentage": "18.7%"
      }
    ],
    "trend": [
      {
        "date": "2025-12-01",
        "count": 28,
        "amount_usd": "165000.00"
      },
      {
        "date": "2025-12-02",
        "count": 32,
        "amount_usd": "180000.00"
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-059: 导出交易报表

**描述**: 导出交易报表为文件。

**HTTP 方法**: `POST /api/v1/admin/reports/transactions/export`

**请求 Schema**:
```json
{
  "report_type": "comprehensive",
  "date_from": "2025-12-01",
  "date_to": "2025-12-10",
  "filters": {
    "network": "Ethereum",
    "currency": "USDT"
  },
  "format": "xlsx",              // xlsx, csv, pdf
  "include_details": true,       // 是否包含明细
  "include_charts": true         // 是否包含图表 (仅 PDF)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "导出任务已创建",
  "data": {
    "export_id": "exp-rpt-20251210-001",
    "status": "processing",
    "estimated_time": 60,
    "format": "xlsx"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-060: 获取对账报表

**描述**: 获取对账结果报表。

**HTTP 方法**: `GET /api/v1/admin/reports/reconciliation`

**请求参数**:
```
?date=2025-12-10             // 对账日期
&network=                    // 网络筛选
&type=daily                  // 类型: daily(日终), vault(Vault)
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "reconciliation_date": "2025-12-10",
    "type": "daily",
    "status": "completed",
    "summary": {
      "networks_checked": 3,
      "total_matched": 15678,
      "total_discrepancies": 2,
      "match_rate": "99.99%"
    },
    "by_network": [
      {
        "network": "Ethereum",
        "chain_balance": "2500000.000000",
        "system_balance": "2500000.000000",
        "difference": "0",
        "status": "matched",
        "transactions_checked": 5200,
        "discrepancies": 0
      },
      {
        "network": "BSC",
        "chain_balance": "3500000.000000",
        "system_balance": "3499500.000000",
        "difference": "500.000000",
        "status": "discrepancy",
        "transactions_checked": 6800,
        "discrepancies": 1
      }
    ],
    "discrepancy_summary": [
      {
        "id": "disc-001",
        "network": "BSC",
        "type": "missing_deposit",
        "amount": "500.000000",
        "currency": "USDT",
        "status": "pending_review"
      }
    ],
    "completed_at": "2025-12-10T23:30:00Z"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-061: 执行对账

**描述**: 执行日终或即时对账。

**HTTP 方法**: `POST /api/v1/admin/reports/reconciliation`

**请求 Schema**:
```json
{
  "type": "daily",              // daily, vault, instant
  "date": "2025-12-10",         // 对账日期 (daily/vault)
  "networks": ["Ethereum", "BSC", "Tron"],
  "currencies": ["USDT", "ETH", "BNB", "TRX"]
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "对账任务已创建",
  "data": {
    "task_id": "recon-20251210-001",
    "type": "daily",
    "status": "processing",
    "estimated_time": 300
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-062: 获取对账差异列表

**描述**: 获取对账差异记录列表。

**HTTP 方法**: `GET /api/v1/admin/reports/reconciliation/diff`

**请求参数**:
```
?page=1
&page_size=20
&status=                     // 状态: pending_review, resolved, ignored
&network=
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "discrepancies": [
      {
        "id": "disc-001",
        "reconciliation_date": "2025-12-10",
        "network": "BSC",
        "currency": "USDT",
        "type": "missing_deposit",
        "tx_hash": "0xabc...123",
        "chain_amount": "500.000000",
        "system_amount": "0",
        "difference": "500.000000",
        "status": "pending_review",
        "detected_at": "2025-12-10T23:30:00Z",
        "resolved_at": null,
        "resolved_by": null,
        "resolution_note": null
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 5,
    "total_pages": 1
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-063: 处理对账差异

**描述**: 处理（解决或忽略）对账差异。

**HTTP 方法**: `POST /api/v1/admin/reports/reconciliation/diff/{diff_id}/resolve`

**路径参数**:
- `diff_id`: 差异记录 ID

**请求 Schema**:
```json
{
  "action": "resolve",           // resolve, ignore
  "resolution_type": "manual_credit",  // 解决方式
  "note": "手动补录充值记录",
  "related_ledger_id": "led-20251210-fix-001"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "差异已处理",
  "data": {
    "id": "disc-001",
    "status": "resolved",
    "resolved_at": "2025-12-11T10:00:00Z",
    "resolved_by": "admin@company.com",
    "resolution_type": "manual_credit"
  }
}
```

**差异解决方式**:
| 方式 | 代码 | 描述 |
|------|------|------|
| 手动入账 | manual_credit | 手动补录入账 |
| 手动扣款 | manual_debit | 手动调整扣款 |
| 链上确认 | chain_confirmed | 链上交易已确认 |
| 忽略 | ignored | 忽略该差异 |

**权限要求**:
- 角色: Admin

---

## F-ADMIN-064: 获取统计分析报表

**描述**: 获取多维度统计分析数据。

**HTTP 方法**: `GET /api/v1/admin/reports/statistics`

**请求参数**:
```
?metrics=volume,users,transactions  // 指标
&period=30d                          // 时间范围
&group_by=day                        // 分组
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "period": "30d",
    "volume": {
      "total_usd": "25000000.00",
      "deposit_usd": "15000000.00",
      "withdrawal_usd": "8500000.00",
      "swap_usd": "1500000.00",
      "trend": [
        {"date": "2025-11-11", "total_usd": "850000.00"}
      ]
    },
    "users": {
      "total_active": 2560,
      "new_users": 350,
      "returning_users": 2210,
      "trend": [
        {"date": "2025-11-11", "active": 280, "new": 15}
      ]
    },
    "transactions": {
      "total_count": 15680,
      "avg_per_day": 522,
      "by_type": {
        "deposit": 5200,
        "withdrawal": 3800,
        "swap": 4200,
        "transfer": 2480
      }
    },
    "top_users": [
      {
        "uid": "10001",
        "email": "user1@example.com",
        "volume_usd": "250000.00",
        "transaction_count": 45
      }
    ],
    "top_currencies": [
      {
        "currency": "USDT",
        "volume_usd": "18500000.00",
        "percentage": "74%"
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-065: 获取定时报表列表

**描述**: 获取已配置的定时报表任务列表。

**HTTP 方法**: `GET /api/v1/admin/reports/scheduled`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "tasks": [
      {
        "id": "sched-001",
        "name": "每日交易汇总",
        "report_type": "comprehensive",
        "schedule": "0 8 * * *",
        "schedule_description": "每天 08:00",
        "format": "xlsx",
        "recipients": ["finance@company.com", "ops@company.com"],
        "enabled": true,
        "last_run_at": "2025-12-10T08:00:00Z",
        "last_run_status": "success",
        "next_run_at": "2025-12-11T08:00:00Z",
        "created_at": "2025-01-01T00:00:00Z",
        "created_by": "admin@company.com"
      },
      {
        "id": "sched-002",
        "name": "每周对账报告",
        "report_type": "reconciliation",
        "schedule": "0 9 * * 1",
        "schedule_description": "每周一 09:00",
        "format": "pdf",
        "recipients": ["finance@company.com"],
        "enabled": true,
        "last_run_at": "2025-12-09T09:00:00Z",
        "last_run_status": "success",
        "next_run_at": "2025-12-16T09:00:00Z"
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-066: 创建定时报表

**描述**: 创建新的定时报表任务。

**HTTP 方法**: `POST /api/v1/admin/reports/scheduled`

**请求 Schema**:
```json
{
  "name": "每日交易汇总",
  "report_type": "comprehensive",
  "filters": {
    "networks": ["Ethereum", "BSC", "Tron"]
  },
  "schedule": "0 8 * * *",       // Cron 表达式
  "format": "xlsx",
  "recipients": ["finance@company.com"],
  "include_details": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "定时报表已创建",
  "data": {
    "id": "sched-003",
    "name": "每日交易汇总",
    "next_run_at": "2025-12-11T08:00:00Z",
    "created_at": "2025-12-10T10:00:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-067: 更新定时报表

**描述**: 更新定时报表任务配置。

**HTTP 方法**: `PUT /api/v1/admin/reports/scheduled/{task_id}`

**路径参数**:
- `task_id`: 任务 ID

**请求 Schema**:
```json
{
  "name": "每日交易汇总（更新）",
  "schedule": "0 9 * * *",
  "recipients": ["finance@company.com", "ops@company.com"],
  "enabled": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "定时报表已更新",
  "data": {
    "id": "sched-003",
    "updated_at": "2025-12-10T10:30:00Z"
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-068: 删除定时报表

**描述**: 删除定时报表任务。

**HTTP 方法**: `DELETE /api/v1/admin/reports/scheduled/{task_id}`

**路径参数**:
- `task_id`: 任务 ID

**响应 Schema**:
```json
{
  "success": true,
  "message": "定时报表已删除"
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-069: 立即执行定时报表

**描述**: 立即执行指定的定时报表任务。

**HTTP 方法**: `POST /api/v1/admin/reports/scheduled/{task_id}/execute`

**路径参数**:
- `task_id`: 任务 ID

**响应 Schema**:
```json
{
  "success": true,
  "message": "报表生成任务已启动",
  "data": {
    "export_id": "exp-sched-20251210-001",
    "status": "processing",
    "estimated_time": 60
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-070: 获取导出历史

**描述**: 获取报表导出历史记录。

**HTTP 方法**: `GET /api/v1/admin/reports/exports`

**请求参数**:
```
?page=1
&page_size=20
&report_type=                // 报表类型筛选
&status=                     // 状态: processing, completed, failed, expired
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "exports": [
      {
        "id": "exp-rpt-20251210-001",
        "name": "交易报表_20251201-20251210",
        "report_type": "comprehensive",
        "format": "xlsx",
        "status": "completed",
        "file_size": "2.5MB",
        "record_count": 5680,
        "created_at": "2025-12-10T10:00:00Z",
        "created_by": "admin@company.com",
        "completed_at": "2025-12-10T10:01:00Z",
        "expires_at": "2025-12-17T10:01:00Z",
        "download_url": "/api/v1/admin/reports/exports/exp-rpt-20251210-001/download"
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 45,
    "total_pages": 3
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-071: 下载导出文件

**描述**: 下载已完成的导出文件。

**HTTP 方法**: `GET /api/v1/admin/reports/exports/{export_id}/download`

**路径参数**:
- `export_id`: 导出记录 ID

**响应**: 文件流下载

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| EXPORT_NOT_FOUND | 404 | 导出记录不存在 |
| EXPORT_NOT_READY | 400 | 导出尚未完成 |
| EXPORT_EXPIRED | 410 | 导出文件已过期 |

---

## F-ADMIN-072: 删除导出文件

**描述**: 删除指定的导出文件。

**HTTP 方法**: `DELETE /api/v1/admin/reports/exports/{export_id}`

**路径参数**:
- `export_id`: 导出记录 ID

**响应 Schema**:
```json
{
  "success": true,
  "message": "导出文件已删除"
}
```

**权限要求**:
- 角色: Admin

---

## 报表类型枚举

| 类型 | 代码 | 描述 |
|------|------|------|
| 充值报表 | deposit | 充值交易统计 |
| 提现报表 | withdrawal | 提现交易统计 |
| 综合报表 | comprehensive | 所有交易类型 |
| Swap 报表 | swap | 兑换交易统计 |
| 对账报表 | reconciliation | 对账结果 |
| 统计分析 | statistics | 多维度统计 |

## 导出状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 处理中 | processing | 正在生成 |
| 已完成 | completed | 生成完成 |
| 失败 | failed | 生成失败 |
| 已过期 | expired | 文件已过期 |

---

> 返回 [Admin 服务目录](./README.md)
