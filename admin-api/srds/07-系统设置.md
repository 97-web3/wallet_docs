# 系统设置

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-046: 获取管理员列表

**描述**: 获取系统管理员列表。

**HTTP 方法**: `GET /api/v1/admin/settings/admins`

**请求参数**:
```
?page=1
&page_size=20
&role=                       // 角色筛选: super_admin, admin, finance
&status=                     // 状态: active, disabled
&keyword=                    // 搜索 (用户名、邮箱)
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "admins": [
      {
        "admin_id": "admin-10001",
        "username": "admin@company.com",
        "name": "张三",
        "role": "admin",
        "status": "active",
        "two_factor_enabled": true,
        "last_login_at": "2025-12-10T08:30:00Z",
        "last_login_ip": "192.168.1.100",
        "created_at": "2025-01-01T00:00:00Z",
        "created_by": "super_admin@company.com"
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 5,
    "total_pages": 1
  }
}
```

**权限要求**:
- 角色: SuperAdmin

---

## F-ADMIN-047: 创建管理员

**描述**: 创建新的管理员账户。

**HTTP 方法**: `POST /api/v1/admin/settings/admins`

**请求 Schema**:
```json
{
  "username": "newadmin@company.com",   // 邮箱作为用户名
  "name": "李四",
  "role": "finance",
  "password": "TempPass123!",           // 临时密码
  "require_password_change": true,      // 首次登录需修改密码
  "two_factor_required": true           // 强制启用 2FA
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "管理员已创建",
  "data": {
    "admin_id": "admin-10006",
    "username": "newadmin@company.com",
    "name": "李四",
    "role": "finance",
    "status": "active",
    "created_at": "2025-12-10T10:00:00Z"
  }
}
```

**业务规则**:
- 用户名必须是有效邮箱
- 临时密码发送到邮箱
- 首次登录强制修改密码
- 记录创建日志

**权限要求**:
- 角色: SuperAdmin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| USERNAME_EXISTS | 409 | 用户名已存在 |
| INVALID_EMAIL | 400 | 邮箱格式无效 |
| INVALID_ROLE | 400 | 无效的角色 |

---

## F-ADMIN-048: 更新管理员

**描述**: 更新管理员信息。

**HTTP 方法**: `PUT /api/v1/admin/settings/admins/{admin_id}`

**路径参数**:
- `admin_id`: 管理员 ID

**请求 Schema**:
```json
{
  "name": "李四（更新）",
  "role": "admin",
  "status": "active"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "管理员已更新",
  "data": {
    "admin_id": "admin-10006",
    "name": "李四（更新）",
    "role": "admin",
    "updated_at": "2025-12-10T10:30:00Z",
    "updated_by": "super_admin@company.com"
  }
}
```

**权限要求**:
- 角色: SuperAdmin

---

## F-ADMIN-049: 禁用管理员

**描述**: 禁用管理员账户。

**HTTP 方法**: `POST /api/v1/admin/settings/admins/{admin_id}/disable`

**路径参数**:
- `admin_id`: 管理员 ID

**请求 Schema**:
```json
{
  "reason": "离职处理"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "管理员已禁用",
  "data": {
    "admin_id": "admin-10006",
    "status": "disabled",
    "disabled_at": "2025-12-10T10:00:00Z",
    "disabled_by": "super_admin@company.com"
  }
}
```

**业务规则**:
- 禁用后立即使所有会话失效
- 不能禁用自己
- 不能禁用最后一个 SuperAdmin

**权限要求**:
- 角色: SuperAdmin

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| CANNOT_DISABLE_SELF | 400 | 不能禁用自己 |
| LAST_SUPER_ADMIN | 400 | 不能禁用最后一个超级管理员 |

---

## F-ADMIN-050: 获取角色列表

**描述**: 获取系统角色及其权限定义。

**HTTP 方法**: `GET /api/v1/admin/roles`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "roles": [
      {
        "code": "super_admin",
        "name": "超级管理员",
        "description": "拥有系统所有权限",
        "permissions": ["*"],
        "is_system": true,
        "admin_count": 1
      },
      {
        "code": "admin",
        "name": "系统管理员",
        "description": "管理用户、配置、审批等",
        "permissions": [
          "dashboard.view",
          "user.read", "user.write",
          "withdraw.approve",
          "ledger.read", "ledger.export",
          "swap.config",
          "settings.read", "settings.write",
          "report.read", "report.export"
        ],
        "is_system": true,
        "admin_count": 2
      },
      {
        "code": "finance",
        "name": "财务人员",
        "description": "处理财务相关审批和报表",
        "permissions": [
          "dashboard.view",
          "withdraw.approve",
          "ledger.read", "ledger.export",
          "vault.read", "vault.adjust",
          "transfer.read", "transfer.execute",
          "report.read", "report.export"
        ],
        "is_system": true,
        "admin_count": 2
      }
    ]
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-051: 分配角色

**描述**: 为管理员分配角色。

**HTTP 方法**: `POST /api/v1/admin/roles/assign`

**请求 Schema**:
```json
{
  "admin_id": "admin-10006",
  "role": "admin",
  "reason": "职位调整"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "角色已分配",
  "data": {
    "admin_id": "admin-10006",
    "old_role": "finance",
    "new_role": "admin",
    "assigned_at": "2025-12-10T10:00:00Z",
    "assigned_by": "super_admin@company.com"
  }
}
```

**权限要求**:
- 角色: SuperAdmin

---

## F-ADMIN-052: 获取权限详情

**描述**: 获取指定管理员的详细权限。

**HTTP 方法**: `GET /api/v1/admin/users/{uid}/permissions`

**路径参数**:
- `uid`: 管理员 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "admin_id": "admin-10002",
    "role": "admin",
    "permissions": {
      "dashboard": {
        "view": true
      },
      "user": {
        "read": true,
        "write": true,
        "freeze": true,
        "terminate": true
      },
      "withdraw": {
        "read": true,
        "approve": true,
        "reject": true
      },
      "ledger": {
        "read": true,
        "export": true
      },
      "vault": {
        "read": true,
        "adjust": false,
        "approve_adjustment": false
      },
      "swap": {
        "read": true,
        "config": true
      },
      "settings": {
        "read": true,
        "write": true,
        "admin_manage": false
      },
      "report": {
        "read": true,
        "export": true
      }
    }
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-053: 获取系统配置

**描述**: 获取系统全局配置项。

**HTTP 方法**: `GET /api/v1/admin/settings/config`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "general": {
      "system_name": "Internal Wallet",
      "timezone": "Asia/Shanghai",
      "currency_display": "USD",
      "maintenance_mode": false
    },
    "security": {
      "session_timeout_minutes": 480,
      "max_login_attempts": 5,
      "lockout_duration_minutes": 30,
      "password_expiry_days": 90,
      "require_2fa": true
    },
    "notification": {
      "email_enabled": true,
      "webhook_enabled": true,
      "webhook_url": "https://hooks.example.com/wallet",
      "alert_recipients": ["ops@company.com", "finance@company.com"]
    },
    "limits": {
      "user_daily_withdraw_usd": "50000.00",
      "user_single_withdraw_usd": "10000.00",
      "auto_approve_max_usd": "500.00"
    }
  }
}
```

**权限要求**:
- 角色: Admin

---

## F-ADMIN-054: 更新系统配置

**描述**: 更新系统全局配置项。

**HTTP 方法**: `PUT /api/v1/admin/settings/config`

**请求 Schema**:
```json
{
  "category": "limits",
  "settings": {
    "user_daily_withdraw_usd": "100000.00",
    "auto_approve_max_usd": "1000.00"
  },
  "reason": "调整提现限额"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "配置已更新",
  "data": {
    "category": "limits",
    "changes": [
      {
        "key": "user_daily_withdraw_usd",
        "old_value": "50000.00",
        "new_value": "100000.00"
      },
      {
        "key": "auto_approve_max_usd",
        "old_value": "500.00",
        "new_value": "1000.00"
      }
    ],
    "updated_at": "2025-12-10T10:00:00Z",
    "updated_by": "admin@company.com"
  }
}
```

**业务规则**:
- 配置变更记录审计日志
- 敏感配置变更可能需要审批
- 部分配置变更需重启服务生效

**权限要求**:
- 角色: Admin

---

## F-ADMIN-055: 获取审计日志

**描述**: 获取系统操作审计日志。

**HTTP 方法**: `GET /api/v1/admin/settings/audit-logs`

**请求参数**:
```
?page=1
&page_size=50
&operator=                   // 操作人
&action=                     // 操作类型
&target_type=                // 目标类型: user, withdraw, config, admin
&target_id=                  // 目标 ID
&date_from=
&date_to=
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": "audit-20251210-001",
        "operator": {
          "admin_id": "admin-10001",
          "username": "admin@company.com",
          "name": "张三"
        },
        "action": "withdraw.approve",
        "target_type": "withdraw",
        "target_id": "W20251210001",
        "description": "审批通过提现申请",
        "details": {
          "amount": "5000.00 USDT",
          "user_id": "10001"
        },
        "ip": "192.168.1.100",
        "user_agent": "Chrome/120.0",
        "created_at": "2025-12-10T10:00:00Z"
      }
    ]
  },
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 1560,
    "total_pages": 32
  }
}
```

**权限要求**:
- 角色: Admin (只读), SuperAdmin (完整)

---

## F-ADMIN-056: 重置管理员密码

**描述**: 重置管理员密码。

**HTTP 方法**: `POST /api/v1/admin/settings/admins/{admin_id}/reset-password`

**路径参数**:
- `admin_id`: 管理员 ID

**请求 Schema**:
```json
{
  "send_email": true,
  "require_change": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "密码已重置，新密码已发送至邮箱",
  "data": {
    "admin_id": "admin-10006",
    "password_reset_at": "2025-12-10T10:00:00Z",
    "email_sent": true
  }
}
```

**权限要求**:
- 角色: SuperAdmin

---

## F-ADMIN-057: 修改自己的密码

**描述**: 管理员修改自己的登录密码。

**HTTP 方法**: `POST /api/v1/admin/settings/change-password`

**请求 Schema**:
```json
{
  "current_password": "OldPass123!",
  "new_password": "NewPass456!",
  "confirm_password": "NewPass456!"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "密码已修改",
  "data": {
    "password_changed_at": "2025-12-10T10:00:00Z",
    "next_expiry": "2026-03-10T10:00:00Z"
  }
}
```

**业务规则**:
- 新密码不能与最近 5 次相同
- 修改后当前会话保持，其他会话失效

**权限要求**:
- 角色: 已登录管理员

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| WRONG_CURRENT_PASSWORD | 401 | 当前密码错误 |
| PASSWORD_TOO_WEAK | 400 | 新密码强度不足 |
| PASSWORD_RECENTLY_USED | 400 | 新密码与近期密码重复 |
| PASSWORD_MISMATCH | 400 | 两次输入密码不一致 |

---

## 管理员角色枚举

| 角色 | 代码 | 描述 |
|------|------|------|
| 超级管理员 | super_admin | 全部权限 |
| 系统管理员 | admin | 管理权限 |
| 财务人员 | finance | 财务相关权限 |

## 审计操作类型枚举

| 操作 | 代码 | 描述 |
|------|------|------|
| 登录 | admin.login | 管理员登录 |
| 登出 | admin.logout | 管理员登出 |
| 用户冻结 | user.freeze | 冻结用户 |
| 用户解冻 | user.unfreeze | 解冻用户 |
| 提现审批 | withdraw.approve | 审批通过提现 |
| 提现拒绝 | withdraw.reject | 拒绝提现 |
| 配置更新 | config.update | 更新系统配置 |
| 管理员创建 | admin.create | 创建管理员 |
| 管理员禁用 | admin.disable | 禁用管理员 |

---

> 返回 [Admin 服务目录](./README.md)
