# 提现审批

> 返回 [Admin 服务目录](./README.md)

---

## F-ADMIN-024: 获取待审批提现列表

**描述**: 获取待审批的提现申请列表，支持筛选和排序。

**HTTP 方法**: `GET /api/v1/admin/withdraw/pending`

**请求参数**:
```
?page=1                      // 页码，默认 1
&page_size=20                // 每页条数，默认 20
&status=pending              // 状态: pending, approved, rejected, processing, completed
&network=                    // 网络筛选: Ethereum, BSC, Tron, Polygon
&currency=                   // 币种筛选: USDT, ETH, BNB, TRX
&min_amount=                 // 最小金额
&max_amount=                 // 最大金额
&risk_level=                 // 风险等级: low, medium, high
&user_id=                    // 用户 ID 筛选
&created_from=               // 申请时间起始
&created_to=                 // 申请时间截止
&sort_by=created_at          // 排序字段: created_at, amount, risk_score
&sort_order=asc              // 排序方向
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "withdrawals": [
      {
        "id": "W20251210001",
        "user": {
          "uid": "10001",
          "email": "user@example.com",
          "name": "张三",
          "status": "active",
          "kyc_level": 2
        },
        "network": "Ethereum",
        "currency": "USDT",
        "amount": "5000.000000",
        "amount_usd": "5000.00",
        "to_address": "0x1234567890abcdef1234567890abcdef12345678",
        "gas_fee_estimate": "0.005",
        "gas_fee_usd": "12.50",
        "status": "pending",
        "risk_assessment": {
          "score": 25,
          "level": "low",
          "factors": [
            {"type": "address_new", "description": "首次提现到此地址", "weight": 15},
            {"type": "amount_normal", "description": "金额在正常范围内", "weight": 10}
          ]
        },
        "created_at": "2025-12-10T09:00:00Z",
        "user_note": "转到个人钱包"
      }
    ],
    "summary": {
      "total_pending": 23,
      "total_pending_amount_usd": "125000.00",
      "high_risk_count": 2,
      "oldest_pending_hours": 4
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 23,
    "total_pages": 2,
    "has_next": true,
    "has_prev": false
  }
}
```

**业务规则**:
- 默认按申请时间升序排列 (先进先审)
- 高风险申请置顶显示
- 超过 24 小时未处理标记为紧急

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-025: 获取提现详情

**描述**: 获取单笔提现申请的完整详情。

**HTTP 方法**: `GET /api/v1/admin/withdraw/{id}`

**路径参数**:
- `id`: 提现申请 ID

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "id": "W20251210001",
    "user": {
      "uid": "10001",
      "email": "user@example.com",
      "name": "张三",
      "phone": "+86138****1234",
      "status": "active",
      "kyc_level": 2,
      "registration_date": "2025-01-15T10:00:00Z",
      "total_withdrawals": 10,
      "total_withdrawal_amount_usd": "35000.00"
    },
    "withdrawal_info": {
      "network": "Ethereum",
      "currency": "USDT",
      "amount": "5000.000000",
      "amount_usd": "5000.00",
      "to_address": "0x1234567890abcdef1234567890abcdef12345678",
      "address_label": "个人钱包",
      "is_whitelisted": true,
      "gas_fee_estimate": "0.005",
      "gas_fee_usd": "12.50"
    },
    "risk_assessment": {
      "score": 25,
      "level": "low",
      "factors": [
        {
          "type": "address_new",
          "description": "首次提现到此地址",
          "weight": 15,
          "detail": "该地址未在历史提现记录中出现"
        },
        {
          "type": "amount_normal",
          "description": "金额在正常范围内",
          "weight": 10,
          "detail": "用户历史平均提现金额: $3500"
        }
      ],
      "address_analysis": {
        "is_contract": false,
        "is_exchange": false,
        "is_blacklisted": false,
        "first_seen": "2025-06-01T00:00:00Z",
        "transaction_count": 150
      }
    },
    "status": "pending",
    "status_history": [
      {
        "status": "created",
        "timestamp": "2025-12-10T09:00:00Z",
        "operator": "user",
        "note": "用户提交申请"
      }
    ],
    "created_at": "2025-12-10T09:00:00Z",
    "user_note": "转到个人钱包",
    "user_balance_after": "10000.000000"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-026: 审批通过提现

**描述**: 审批通过指定的提现申请。

**HTTP 方法**: `POST /api/v1/admin/withdraw/{id}/approve`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**路径参数**:
- `id`: 提现申请 ID

**请求 Schema**:
```json
{
  "note": "已核实，通过审批",      // 审批备注 (可选)
  "2fa_code": "123456"             // 2FA 验证码 (必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现已审批通过",
  "data": {
    "id": "W20251210001",
    "status": "approved",
    "approved_at": "2025-12-10T10:00:00Z",
    "approved_by": "admin@company.com",
    "estimated_completion": "2025-12-10T10:30:00Z"
  }
}
```

**业务规则**:
- 需要幂等键防止重复审批
- 需要 2FA 验证
- 审批后自动进入处理队列
- 大额提现可能需要多级审批

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| WITHDRAW_NOT_FOUND | 404 | 提现申请不存在 |
| WITHDRAW_NOT_PENDING | 409 | 提现申请不是待审批状态 |
| INSUFFICIENT_VAULT_BALANCE | 422 | Vault 余额不足 |
| AUTH_2FA_CODE_INVALID | 401 | 2FA 验证码错误 |
| IDEMPOTENCY_KEY_CONFLICT | 409 | 重复请求 |

---

## F-ADMIN-027: 拒绝提现

**描述**: 拒绝指定的提现申请。

**HTTP 方法**: `POST /api/v1/admin/withdraw/{id}/reject`

**路径参数**:
- `id`: 提现申请 ID

**请求 Schema**:
```json
{
  "reason": "地址风险过高",         // 拒绝原因 (必填)
  "reason_code": "high_risk_address", // 原因代码
  "notify_user": true,              // 是否通知用户 (默认 true)
  "freeze_user": false              // 是否同时冻结用户 (默认 false)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现已拒绝",
  "data": {
    "id": "W20251210001",
    "status": "rejected",
    "rejected_at": "2025-12-10T10:00:00Z",
    "rejected_by": "admin@company.com",
    "reason": "地址风险过高",
    "amount_refunded": true
  }
}
```

**拒绝原因代码**:
| 代码 | 描述 |
|------|------|
| high_risk_address | 目标地址风险过高 |
| suspicious_activity | 可疑交易行为 |
| kyc_insufficient | KYC 等级不足 |
| amount_exceeds_limit | 金额超出限额 |
| user_request | 用户主动取消 |
| other | 其他原因 |

**业务规则**:
- 拒绝后资金自动退回用户余额
- 可选择是否通知用户
- 可选择是否同时冻结用户账户
- 记录完整操作日志

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| WITHDRAW_NOT_FOUND | 404 | 提现申请不存在 |
| WITHDRAW_NOT_PENDING | 409 | 提现申请不是待审批状态 |
| REASON_REQUIRED | 400 | 必须提供拒绝原因 |

---

## F-ADMIN-028: 批量审批提现

**描述**: 批量审批多笔低风险提现申请。

**HTTP 方法**: `POST /api/v1/admin/withdraw/batch-approve`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**请求 Schema**:
```json
{
  "ids": ["W20251210001", "W20251210002", "W20251210003"],  // 提现 ID 列表
  "note": "批量审批低风险提现",                              // 批量备注
  "2fa_code": "123456"                                       // 2FA 验证码 (必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批量审批完成",
  "data": {
    "total": 3,
    "succeeded": 2,
    "failed": 1,
    "results": [
      {"id": "W20251210001", "status": "approved", "message": "审批成功"},
      {"id": "W20251210002", "status": "approved", "message": "审批成功"},
      {"id": "W20251210003", "status": "failed", "message": "Vault 余额不足"}
    ]
  }
}
```

**业务规则**:
- 仅允许批量审批低风险 (risk_level=low) 申请
- 单次最多批量审批 50 笔
- 任一笔失败不影响其他笔审批
- 需要 2FA 验证

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| BATCH_LIMIT_EXCEEDED | 400 | 批量操作超过限制 |
| HIGH_RISK_IN_BATCH | 400 | 批量审批中包含高风险申请 |
| AUTH_2FA_CODE_INVALID | 401 | 2FA 验证码错误 |

---

## F-ADMIN-029: 获取提现审批配置

**描述**: 获取提现审批的配置项，包括限额、风险阈值等。

**HTTP 方法**: `GET /api/v1/admin/withdraw/config`

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "approval_rules": {
      "auto_approve_enabled": true,
      "auto_approve_max_amount_usd": "500.00",
      "auto_approve_max_risk_score": 20,
      "multi_level_approval_threshold_usd": "50000.00"
    },
    "limits": {
      "per_transaction_max_usd": "100000.00",
      "daily_max_usd": "500000.00",
      "user_daily_max_usd": "50000.00"
    },
    "risk_thresholds": {
      "low": {"min": 0, "max": 30},
      "medium": {"min": 31, "max": 60},
      "high": {"min": 61, "max": 100}
    },
    "notifications": {
      "high_risk_alert": true,
      "large_amount_alert": true,
      "large_amount_threshold_usd": "10000.00"
    }
  }
}
```

**权限要求**:
- 角色: Admin

---

## 提现状态枚举

| 状态 | 代码 | 描述 |
|------|------|------|
| 待审批 | pending | 等待管理员审批 |
| 已通过 | approved | 审批通过，等待处理 |
| 处理中 | processing | 正在执行链上交易 |
| 已完成 | completed | 提现成功完成 |
| 已拒绝 | rejected | 审批被拒绝 |
| 已取消 | cancelled | 用户取消或系统取消 |
| 失败 | failed | 链上交易失败 |

## 风险等级枚举

| 等级 | 代码 | 分数范围 | 描述 |
|------|------|----------|------|
| 低风险 | low | 0-30 | 可批量审批 |
| 中风险 | medium | 31-60 | 需人工审核 |
| 高风险 | high | 61-100 | 需重点关注 |

---

> 返回 [Admin 服务目录](./README.md)
