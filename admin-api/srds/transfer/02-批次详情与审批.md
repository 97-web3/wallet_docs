# 转账管理 - 批次详情与审批

> 返回 [转账管理索引](../11-转账管理.md)

---

## F-ADMIN-089: 获取批次详情

**描述**: 获取转账批次的详细信息和收款人列表。

**HTTP 方法**: `GET /api/v1/admin/transfer/batches/{batch_id}`

**路径参数**:
- `batch_id`: 批次 ID

**请求参数**:
```
?page=1
&page_size=50
&status=                     // pending, success, failed
```

**响应 Schema**:
```json
{
  "success": true,
  "data": {
    "batch_id": "batch-20251210-001",
    "name": "12月工资发放",
    "description": "2025年12月员工工资",
    "network": "Ethereum",
    "currency": "USDT",
    "status": "completed",
    "summary": {
      "total_recipients": 125,
      "total_amount": "625000.000000",
      "total_amount_usd": "625000.00",
      "total_fee": "15.625000",
      "total_fee_usd": "39.06",
      "success_count": 125,
      "failed_count": 0,
      "pending_count": 0
    },
    "recipients": [
      {
        "id": "rcpt-001",
        "address": "0x1234567890abcdef1234567890abcdef12345678",
        "amount": "5000.000000",
        "note": "张三工资",
        "status": "success",
        "tx_hash": "0xabc...123",
        "fee": "0.125",
        "processed_at": "2025-12-10T09:15:00Z"
      },
      {
        "id": "rcpt-002",
        "address": "0xabcdef1234567890abcdef1234567890abcdef12",
        "amount": "4500.000000",
        "note": "李四工资",
        "status": "success",
        "tx_hash": "0xdef...456",
        "fee": "0.125",
        "processed_at": "2025-12-10T09:16:00Z"
      }
    ],
    "timeline": [
      {"status": "draft", "timestamp": "2025-12-10T08:00:00Z", "operator": "finance@company.com"},
      {"status": "pending", "timestamp": "2025-12-10T08:30:00Z", "operator": "finance@company.com"},
      {"status": "approved", "timestamp": "2025-12-10T08:45:00Z", "operator": "admin@company.com"},
      {"status": "processing", "timestamp": "2025-12-10T09:00:00Z", "operator": "system"},
      {"status": "completed", "timestamp": "2025-12-10T09:30:00Z", "operator": "system"}
    ],
    "created_by": "finance@company.com",
    "created_at": "2025-12-10T08:00:00Z",
    "approved_by": "admin@company.com",
    "approved_at": "2025-12-10T08:45:00Z"
  },
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total": 125,
    "total_pages": 3
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-090: 提交批次审批

**描述**: 将草稿状态的批次提交审批。

**HTTP 方法**: `POST /api/v1/admin/transfer/batches/{batch_id}/submit`

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "note": "请审批12月工资发放"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已提交审批",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "pending",
    "submitted_at": "2025-12-10T08:30:00Z"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

---

## F-ADMIN-091: 审批批次

**描述**: 审批通过或拒绝转账批次（不包含执行，执行见 `F-ADMIN-126`）。

**HTTP 方法**: `POST /api/v1/admin/transfer/batches/{batch_id}/approve`

**请求头**:
```
Idempotency-Key: <UUID>      // 幂等键 (必填)
```

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "action": "approve",          // approve, reject
  "note": "已核实，批准",
  "2fa_code": "123456"          // 2FA 验证码 (必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已审批通过",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "approved",
    "approved_at": "2025-12-10T08:45:00Z",
    "approved_by": "admin@company.com"
  }
}
```

**业务规则**:
- 需要 2FA 验证
- 需要幂等键防止重复审批
- Maker-Checker：不能审批自己提交的申请（如适用）

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| BATCH_NOT_FOUND | 404 | 批次不存在 |
| BATCH_NOT_PENDING | 409 | 批次不是待审批状态 |
| AUTH_2FA_CODE_INVALID | 401 | 2FA 验证码错误 |
| CANNOT_APPROVE_OWN | 400 | 不能审批自己提交的申请 |

---

## F-ADMIN-092: 取消批次

**描述**: 取消草稿或待审批状态的批次。

**HTTP 方法**: `POST /api/v1/admin/transfer/batches/{batch_id}/cancel`

**路径参数**:
- `batch_id`: 批次 ID

**请求 Schema**:
```json
{
  "reason": "数据有误，需重新导入"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批次已取消",
  "data": {
    "batch_id": "batch-20251210-001",
    "status": "cancelled",
    "cancelled_at": "2025-12-10T08:30:00Z",
    "cancelled_by": "finance@company.com"
  }
}
```

**权限要求**:
- 角色: Admin, Finance

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| BATCH_NOT_FOUND | 404 | 批次不存在 |
| BATCH_CANNOT_CANCEL | 409 | 批次已开始执行，无法取消 |

---

> 返回 [转账管理索引](../11-转账管理.md)

