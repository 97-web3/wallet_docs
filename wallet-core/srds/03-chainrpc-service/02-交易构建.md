# 交易构建

> 返回 [ChainRPC 服务目录](./README.md)

---

## F-CRPC-005: 构建主币转账

**描述**: 构建原生币 (TRX/BNB/ETH/MATIC) 转账的未签名交易。

**gRPC 方法**: `BuildNativeTransfer`

**请求 Schema**:
```json
{
  "chain": 1,
  "from_address": "TKvjY...",
  "to_address": "TAbcD...",
  "amount": "1000000",                  // 最小单位 (wei/sun)
  "gas_price": "",                      // 可选，空则自动获取
  "gas_limit": 0,                       // 可选，空则自动估算
  "nonce": "",                          // 可选，空则自动获取
  "gas_speed": 2,                       // GasSpeed 枚举
  "memo": ""                            // TRON 支持备注
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "raw_transaction": "0a02...",         // hex 编码未签名交易
  "tx_hash_preview": "abc123...",
  "gas_price": "1000000000",
  "gas_limit": 21000,
  "estimated_fee": "21000000000000",
  "nonce": "5",
  "extra_data": {}
}
```

---

## F-CRPC-006: 构建代币转账

**描述**: 构建 ERC20/BEP20/TRC20 代币转账的未签名交易。

**gRPC 方法**: `BuildTokenTransfer`

**请求 Schema**:
```json
{
  "chain": 1,
  "from_address": "TKvjY...",
  "to_address": "TAbcD...",
  "token_contract": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
  "amount": "1000000",                  // 代币最小单位
  "gas_price": "",
  "gas_limit": 0,
  "nonce": "",
  "gas_speed": 2
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "raw_transaction": "0a02...",
  "tx_hash_preview": "def456...",
  "gas_price": "1000000000",
  "gas_limit": 60000,
  "estimated_fee": "60000000000000",
  "nonce": "6",
  "extra_data": {
    "token_contract": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"
  }
}
```

---

## F-CRPC-007: 构建批量转账

**描述**: 构建多笔转账交易，用于归集场景。

**gRPC 方法**: `BuildBatchTransfer`

**请求 Schema**:
```json
{
  "chain": 1,
  "from_address": "TKvjY...",
  "transfers": [
    {
      "to_address": "TAbcD...",
      "amount": "1000000",
      "token_contract": ""              // 空表示主币
    },
    {
      "to_address": "TEfgH...",
      "amount": "2000000",
      "token_contract": "TR7N..."
    }
  ],
  "gas_price": "",
  "gas_speed": 2
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "transactions": [
    {
      "raw_transaction": "...",
      "tx_hash_preview": "...",
      "gas_price": "...",
      "gas_limit": 21000,
      "estimated_fee": "...",
      "nonce": "5"
    }
  ],
  "total": 2,
  "total_estimated_fee": "..."
}
```

---

## Gas 充足性检查

### 交易构建响应增强

所有交易构建接口 (`BuildNativeTransfer`, `BuildTokenTransfer`, `BuildBatchTransfer`) 的响应中包含 Gas 充足性检查:

```json
{
  "success": true,
  "raw_transaction": "...",
  "gas_price": "1000000000",
  "gas_limit": 60000,
  "estimated_fee": "60000000000000",
  "gas_check": {
    "sufficient": true,
    "native_balance": "100000000000000000",    // 账户主币余额
    "required_gas": "60000000000000",          // 需要的 Gas 费
    "remaining_after_tx": "39940000000000000", // 交易后剩余
    "warning": ""                               // Gas 不足时的警告
  }
}
```

### Gas 不足响应

```json
{
  "success": true,
  "raw_transaction": "...",
  "gas_check": {
    "sufficient": false,
    "native_balance": "10000000000000",        // 账户只有 0.00001 ETH
    "required_gas": "60000000000000",          // 需要 0.00006 ETH
    "remaining_after_tx": "-50000000000000",   // 负数表示不足
    "warning": "Gas 不足，需要至少 0.00005 ETH 的 ETH 作为手续费",
    "suggested_deposit": "50000000000000"      // 建议充值金额
  }
}
```

### 错误码

| 错误码 | 说明 |
|--------|------|
| 60010 | Gas 余额不足 |
| 60011 | Gas 估算失败 |
| 60012 | Gas 价格获取失败 |

---

> 返回 [ChainRPC 服务目录](./README.md)
