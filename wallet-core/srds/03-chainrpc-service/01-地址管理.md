# 地址管理

> 返回 [ChainRPC 服务目录](./README.md)

---

## F-CRPC-001: 生成地址

**描述**: 基于 HD 钱包派生路径生成区块链地址。

**gRPC 方法**: `GenerateAddress`

**请求 Schema**:
```json
{
  "chain": 1,                          // ChainRpcType 枚举
  "derivation_path": "m/44'/195'/0'/0/10001",
  "public_key": "04a1b2c3...",         // hex 编码公钥
  "compressed_pubkey": "02a1b2c3..."   // 可选：压缩公钥
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址生成成功",
  "address": "TKvjYxxxxxxxxxxx",
  "chain": 1,
  "derivation_path": "m/44'/195'/0'/0/10001",
  "address_type": 1                     // 1=EOA, 2=合约
}
```

---

## F-CRPC-002: 批量生成地址

**描述**: 批量生成多个连续索引的地址。

**gRPC 方法**: `GenerateAddressBatch`

**请求 Schema**:
```json
{
  "chain": 1,
  "start_index": 0,
  "count": 100,
  "master_public_key": "xpub...",
  "account": 0,                         // BIP44 account
  "change": 0                           // 0=external, 1=internal
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批量生成成功",
  "chain": 1,
  "addresses": [
    {
      "index": 0,
      "derivation_path": "m/44'/195'/0'/0/0",
      "address": "TKvjY...",
      "public_key": "04..."
    }
  ],
  "total": 100
}
```

---

## F-CRPC-003: 验证地址

**描述**: 验证地址格式和校验和是否正确，并检测是否为平台内部地址。

**gRPC 方法**: `ValidateAddress`

**请求 Schema**:
```json
{
  "chain": 1,
  "address": "TKvjYxxxxxxxxxxx",
  "check_internal": true              // 是否检查内部地址
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "valid": true,
  "address_type": 1,                    // 1=EOA, 2=合约
  "checksum_valid": true,
  "detected_chains": [1],               // 检测到兼容的链类型
  "is_internal": false,                 // 是否为平台内部地址
  "internal_user_id": 0,                // 内部用户 ID (内部地址时)
  "warnings": [                         // 验证警告
    {
      "code": "AMBIGUOUS_CHAIN",
      "message": "该地址格式与 ETH 和 BSC 兼容，请确认选择正确的链"
    }
  ]
}
```

**业务规则**:
- ETH (chain=3) 和 BSC (chain=2) 地址格式相同 (0x开头)，需返回警告
- 当地址格式匹配多条链时，`detected_chains` 返回所有兼容链
- 调用方需根据警告提示用户二次确认

**地址格式验证规则**:
| 链 | ChainRpcType | 前缀 | 长度 | 格式 |
|----|--------------|------|------|------|
| TRX | 1 | T | 34 | Base58Check |
| BSC | 2 | 0x | 42 | EIP-55 Checksum |
| ETH | 3 | 0x | 42 | EIP-55 Checksum |

---

## F-CRPC-004: 从公钥生成地址

**描述**: 根据公钥直接生成对应链的地址。

**gRPC 方法**: `GetAddressFromPubkey`

**请求 Schema**:
```json
{
  "chain": 1,
  "public_key": "04a1b2c3d4e5...",      // hex 编码
  "compressed": false
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "address": "TKvjYxxxxxxxxxxx"
}
```

---

## F-CRPC-005: 检测内部地址

**描述**: 检测地址是否为平台内部用户的充值地址。

**gRPC 方法**: `IsInternalAddress`

**请求 Schema**:
```json
{
  "chain": 1,
  "address": "TKvjYxxxxxxxxxxx"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_internal": true,
  "user_id": 10001,                      // 用户 ID
  "address_type": "deposit",             // deposit=充值地址, withdraw=提现地址
  "derivation_index": 10001              // HD 派生索引
}
```

**业务规则**:
- 检查地址是否在 deposit_addresses 表中
- 返回关联的用户信息
- 用于提现时判断是否应转为内部转账

---

## F-CRPC-006: 批量检测内部地址

**描述**: 批量检测多个地址是否为平台内部地址。

**gRPC 方法**: `IsInternalAddressBatch`

**请求 Schema**:
```json
{
  "chain": 1,
  "addresses": [
    "TKvjYxxxxxxxxxxx",
    "TAbcd..."
  ]
}
```

**响应 Schema**:
```json
{
  "success": true,
  "results": [
    {
      "address": "TKvjYxxxxxxxxxxx",
      "is_internal": true,
      "user_id": 10001
    },
    {
      "address": "TAbcd...",
      "is_internal": false,
      "user_id": 0
    }
  ]
}
```

**业务规则**:
- 单次最多检测 100 个地址
- 用于批量交易时快速识别内部地址
