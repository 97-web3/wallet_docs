# 地址管理

> 返回 [ChainRPC 服务目录](./README.md)

---

## F-CRPC-001: 生成地址

**描述**: 基于 HD 钱包派生路径生成区块链地址。

**gRPC 方法**: `GenerateAddress`

**请求 Schema**:
```json
{
  "chain": 1,                          // ChainRpcType 枚举
  "derivation_path": "m/44'/195'/0'/0/10001",
  "public_key": "04a1b2c3...",         // hex 编码公钥
  "compressed_pubkey": "02a1b2c3..."   // 可选：压缩公钥
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址生成成功",
  "address": "TKvjYxxxxxxxxxxx",
  "chain": 1,
  "derivation_path": "m/44'/195'/0'/0/10001",
  "address_type": 1                     // 1=EOA, 2=合约
}
```

---

## F-CRPC-002: 批量生成地址

**描述**: 批量生成多个连续索引的地址。

**gRPC 方法**: `GenerateAddressBatch`

**请求 Schema**:
```json
{
  "chain": 1,
  "start_index": 0,
  "count": 100,
  "master_public_key": "xpub...",
  "account": 0,                         // BIP44 account
  "change": 0                           // 0=external, 1=internal
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "批量生成成功",
  "chain": 1,
  "addresses": [
    {
      "index": 0,
      "derivation_path": "m/44'/195'/0'/0/0",
      "address": "TKvjY...",
      "public_key": "04..."
    }
  ],
  "total": 100
}
```

---

## F-CRPC-003: 验证地址

**描述**: 验证地址格式和校验和是否正确，并检测是否为平台内部地址。

**gRPC 方法**: `ValidateAddress`

**请求 Schema**:
```json
{
  "chain": 1,
  "address": "TKvjYxxxxxxxxxxx",
  "check_internal": true              // 是否检查内部地址
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "valid": true,
  "address_type": 1,                    // 1=EOA, 2=合约
  "checksum_valid": true,
  "detected_chains": [1],               // 检测到兼容的链类型
  "is_internal": false,                 // 是否为平台内部地址
  "internal_user_id": 0,                // 内部用户 ID (内部地址时)
  "warnings": [                         // 验证警告
    {
      "code": "AMBIGUOUS_CHAIN",
      "message": "该地址格式与 ETH 和 BSC 兼容，请确认选择正确的链"
    }
  ]
}
```

**业务规则**:
- ETH (chain=3) 和 BSC (chain=2) 地址格式相同 (0x开头)，需返回警告
- 当地址格式匹配多条链时，`detected_chains` 返回所有兼容链
- 调用方需根据警告提示用户二次确认

**地址格式验证规则**:
| 链 | ChainRpcType | 前缀 | 长度 | 格式 |
|----|--------------|------|------|------|
| TRX | 1 | T | 34 | Base58Check |
| BSC | 2 | 0x | 42 | EIP-55 Checksum |
| ETH | 3 | 0x | 42 | EIP-55 Checksum |

---

## F-CRPC-004: 从公钥生成地址

**描述**: 根据公钥直接生成对应链的地址。

**gRPC 方法**: `GetAddressFromPubkey`

**请求 Schema**:
```json
{
  "chain": 1,
  "public_key": "04a1b2c3d4e5...",      // hex 编码
  "compressed": false
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "",
  "address": "TKvjYxxxxxxxxxxx"
}
```

---

## F-CRPC-005: 检测内部地址

**描述**: 检测地址是否为平台内部用户的充值地址。

**gRPC 方法**: `IsInternalAddress`

**请求 Schema**:
```json
{
  "chain": 1,
  "address": "TKvjYxxxxxxxxxxx"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_internal": true,
  "user_id": 10001,                      // 用户 ID
  "address_type": "deposit",             // deposit=充值地址, withdraw=提现地址
  "derivation_index": 10001              // HD 派生索引
}
```

**业务规则**:
- 检查地址是否在 deposit_addresses 表中
- 返回关联的用户信息
- 用于提现时判断是否应转为内部转账

---

## F-CRPC-006: 批量检测内部地址

**描述**: 批量检测多个地址是否为平台内部地址。

**gRPC 方法**: `IsInternalAddressBatch`

**请求 Schema**:
```json
{
  "chain": 1,
  "addresses": [
    "TKvjYxxxxxxxxxxx",
    "TAbcd..."
  ]
}
```

**响应 Schema**:
```json
{
  "success": true,
  "results": [
    {
      "address": "TKvjYxxxxxxxxxxx",
      "is_internal": true,
      "user_id": 10001
    },
    {
      "address": "TAbcd...",
      "is_internal": false,
      "user_id": 0
    }
  ]
}
```

**业务规则**:
- 单次最多检测 100 个地址
- 用于批量交易时快速识别内部地址

---

## F-CRPC-007: 检查内部地址 (业务层)

**描述**: 检查提现/转账目标地址是否为平台内部地址，并提供建议。用于业务层在用户提交提现前进行检查。

**gRPC 方法**: `CheckInternalAddress`

**请求 Schema**:
```json
{
  "address": "0x1234567890abcdef...",
  "chain": "ETH"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_internal": true,
  "internal_user_uid": "U20251210ABCD",
  "internal_user_nickname": "用户昵称",    // 脱敏
  "suggestion": "建议使用内部划转功能，免手续费且实时到账",
  "action_recommended": "use_internal_transfer"  // use_internal_transfer / proceed_withdraw
}
```

**业务规则**:
- 用于业务层在用户输入提现地址后调用
- 若为内部地址，建议用户使用内部转账功能
- 返回的用户信息需脱敏处理

---

## ETH/BNB 地址歧义处理

### 问题描述

ETH 和 BNB (BSC) 链使用相同的地址格式 (0x 开头的 42 位十六进制)，无法仅通过地址格式判断目标网络。

### 处理策略

1. **地址验证时返回警告**
   ```json
   {
     "valid": true,
     "detected_chains": [2, 3],    // BSC 和 ETH
     "warnings": [{
       "code": "CRPC_AMBIGUOUS_CHAIN",
       "message": "该地址格式与 ETH 和 BNB Smart Chain 兼容，请确认目标网络"
     }]
   }
   ```

2. **前端二次确认**
   - 当检测到歧义地址时，弹窗确认目标网络
   - 用户必须明确选择 ETH 或 BSC

3. **交易构建时校验**
   - 确保用户选择的链与余额资产一致
   - 不允许将 ETH 主网资产发送到标记为 BSC 的地址 (反之亦然)

### 警告码

| 警告码 | 说明 |
|--------|------|
| CRPC_AMBIGUOUS_CHAIN | 地址格式歧义，请确认目标网络 |
| CRPC_CHAIN_MISMATCH | 资产所在链与目标地址不匹配 |

---

> 返回 [ChainRPC 服务目录](./README.md)
