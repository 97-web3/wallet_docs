# 数据模型与配置

> 返回 [Signer 服务目录](./README.md)

---

## 1. 数据模型

### 1.1 主种子表 (master_seeds)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| seed_id | VARCHAR(64) | 种子唯一标识 |
| seed_name | VARCHAR(100) | 种子名称 |
| seed_encrypted | BLOB | AES-256-GCM 加密的种子 |
| seed_hash | VARCHAR(100) | SHA256 校验哈希 |
| encryption_salt | BLOB | PBKDF2 盐 (32 字节) |
| encryption_iv | BLOB | GCM 随机数 (12 字节) |
| key_version | INT | 密钥轮换版本 |
| supported_chains | JSON | 支持的链列表 |
| temperature | TINYINT | 1=热, 2=冷 |
| status | TINYINT | 1=激活, 2=停用, 3=废弃 |
| require_approval | TINYINT | 是否需要审批 |
| max_daily_amount | VARCHAR(78) | 每日限额 |
| total_signatures | BIGINT | 总签名次数 |
| last_signature_at | DATETIME | 最后签名时间 |
| tee_enabled | TINYINT | 是否启用 TEE |
| tee_sealed_seed | BLOB | TEE 密封种子 |
| tee_measurement | VARCHAR(100) | TEE 度量值 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 1.2 充值地址表 (deposit_addresses)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| chain | VARCHAR(10) | 链类型 (TRN/BSC/ETH) |
| address | VARCHAR(100) | 地址 |
| derivation_path | VARCHAR(100) | 派生路径 |
| address_index | INT | 地址索引 |
| public_key | VARCHAR(200) | 公钥 (hex) |
| compressed_pubkey | VARCHAR(100) | 压缩公钥 (hex) |
| status | TINYINT | 1=正常, 2=禁用 |
| total_deposits | BIGINT | 总充值次数 |
| last_deposit_at | DATETIME | 最后充值时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**: `UNIQUE (user_id, chain)`, `UNIQUE (address)`

### 1.3 签名日志表 (signature_logs)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| request_id | VARCHAR(64) | 请求 ID (幂等键) |
| master_seed_id | BIGINT | 种子 ID |
| chain | VARCHAR(20) | 链类型 |
| derivation_path | VARCHAR(100) | 派生路径 |
| operation_type | INT | 操作类型 |
| from_address | VARCHAR(100) | 源地址 |
| to_address | VARCHAR(100) | 目标地址 |
| tx_hash | VARCHAR(100) | 交易哈希 |
| amount | VARCHAR(78) | 金额 |
| asset_symbol | VARCHAR(20) | 资产符号 |
| token_contract | VARCHAR(100) | 代币合约 |
| requester | VARCHAR(100) | 请求者 |
| request_ip | VARCHAR(50) | 请求 IP |
| status | INT | 1=待处理, 2=成功, 3=失败, 4=拒绝 |
| error_msg | TEXT | 错误信息 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**: `UNIQUE (request_id)`, `INDEX (master_seed_id, created_at)`

### 1.4 公钥导出日志表 (pub_key_export_logs)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| seed_id | VARCHAR(64) | 种子 ID |
| chain | VARCHAR(20) | 链类型 |
| derivation_path | VARCHAR(100) | 派生路径 |
| requester | VARCHAR(100) | 请求者 |
| request_ip | VARCHAR(50) | 请求 IP |
| created_at | DATETIME | 创建时间 |

---

## 2. 加密实现

### 2.1 种子加密流程

```
1. 生成随机盐 (32 字节)
2. PBKDF2 密钥派生:
   - 密码: 用户输入的加密密码
   - 盐: 随机盐
   - 迭代次数: 100,000
   - 输出: 32 字节密钥

3. 生成随机 IV (12 字节)
4. AES-256-GCM 加密:
   - 密钥: PBKDF2 派生密钥
   - IV: 随机 IV
   - 明文: BIP39 种子
   - 输出: 密文 + 认证标签

5. 存储:
   - seed_encrypted: 密文
   - encryption_salt: 盐
   - encryption_iv: IV
   - seed_hash: SHA256(种子)
```

### 2.2 HD 派生实现

```
BIP44 路径: m / purpose' / coin_type' / account' / change / address_index

链配置:
┌────────┬───────────┬─────────┬──────────────────────────────┐
│  链    │ Coin Type │ Account │ 派生路径                      │
├────────┼───────────┼─────────┼──────────────────────────────┤
│ TRON   │ 195       │ 0       │ m/44'/195'/0'/0/{user_id}    │
│ BSC    │ 60        │ 0       │ m/44'/60'/0'/0/{user_id}     │
│ ETH    │ 60        │ 1       │ m/44'/60'/1'/0/{user_id}     │
└────────┴───────────┴─────────┴──────────────────────────────┘
```

### 2.3 地址生成算法

**Ethereum/BSC (EVM 链)**:
```
1. 派生公钥 (secp256k1)
2. 取公钥后 64 字节
3. Keccak256 哈希
4. 取最后 20 字节
5. 添加 0x 前缀
```

**TRON**:
```
1. 派生公钥 (secp256k1)
2. 取公钥后 64 字节
3. Keccak256 哈希
4. 取最后 20 字节
5. 添加 0x41 前缀
6. Base58Check 编码
```

---

## 3. 配置

### 3.1 服务配置示例

**文件**: `services/signer/rpc/etc/signer.yaml`

```yaml
Name: signer.rpc
Mode: dev
ListenOn: 0.0.0.0:9004
NodeID: 4                               # Snowflake 节点 ID

Log:
  Mode: file
  Path: ./logs
  Level: info
  KeepDays: 7

MySQL:
  DataSource: "crypto:crypto123456@tcp(localhost:3306)/crypto_wallet?charset=utf8mb4"

Redis:
  Host: localhost:6379
  Pass: redis123456

Security:
  EncryptionPassword: "MyVerySecureEncryptionPassword2024!@#$%"
  KeyStorePath: /secure/keystore
  EnableTEE: false
  EnableHSM: false

Etcd:
  Hosts:
    - localhost:2379
  Key: signer.rpc

Prometheus:
  Host: 0.0.0.0
  Port: 9094
```

---

## 4. 依赖

### 4.1 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/tyler-smith/go-bip32 | 1.0.0 | HD 密钥派生 |
| github.com/tyler-smith/go-bip39 | 1.1.0 | 助记词生成 |
| github.com/ethereum/go-ethereum | 1.15.6 | ECDSA 签名、Keccak256 |
| github.com/btcsuite/btcutil | 1.0.3 | Base58 编码 |
| golang.org/x/crypto | 0.41.0 | PBKDF2、AES-GCM |

---

## 5. 安全考量

### 5.1 已知问题摘要

| 问题 ID | 级别 | 描述 | 参考 |
|---------|------|------|------|
| CRITICAL-01 | 严重 | Signer 服务通过公共 API 网关暴露 | `docs/security-issues/CRITICAL-01-*.md` |
| HIGH-03 | 高危 | 缺少每个种子的每日限制和审批控制 | `docs/security-issues/HIGH-03-*.md` |

### 5.2 安全建议

1. **网络隔离**: Signer 服务不应通过公共 API 网关暴露，应仅允许内部服务访问
2. **密钥轮换**: 定期轮换加密密钥，增加 key_version
3. **审批流程**: 对大额交易实施多签或审批机制
4. **每日限额**: 配置每个种子的每日签名限额
5. **TEE/HSM**: 生产环境考虑使用硬件安全模块
6. **审计日志**: 确保所有签名操作被完整记录
7. **访问控制**: 严格限制可以调用签名 API 的服务

### 5.3 生产环境清单

- [ ] 更换默认加密密码
- [ ] 启用 TEE 或 HSM
- [ ] 配置网络隔离规则
- [ ] 设置每日签名限额
- [ ] 配置审计日志告警
- [ ] 实施多签审批流程
- [ ] 定期备份加密种子
- [ ] 制定密钥轮换计划
