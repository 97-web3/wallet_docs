# 地址生成

> 返回 [Signer 服务目录](./README.md)

---

## F-SIGN-005: 生成用户充值地址

**描述**: 为用户生成多条链的充值地址。

**gRPC 方法**: `GenerateUserDepositAddresses`

**请求 Schema**:
```json
{
  "seed_id": "seed_hot_001",
  "user_id": 10001,                      // 用户 ID (作为派生索引)
  "chains": ["TRN", "BSC", "ETH"],       // 要生成的链
  "requester": "business_service"
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "地址生成成功",
  "user_id": 10001,
  "addresses": [
    {
      "chain": "TRN",
      "address": "TKvjYxxxxxxxxxxx",
      "derivation_path": "m/44'/195'/0'/0/10001",
      "public_key": "04a1b2c3d4...",
      "compressed_pubkey": "02a1b2c3..."
    },
    {
      "chain": "BSC",
      "address": "0x1234567890abcdef...",
      "derivation_path": "m/44'/60'/0'/0/10001",
      "public_key": "04d5e6f7g8...",
      "compressed_pubkey": "03d5e6f7..."
    },
    {
      "chain": "ETH",
      "address": "0xabcdef1234567890...",
      "derivation_path": "m/44'/60'/1'/0/10001",
      "public_key": "04h9i0j1k2...",
      "compressed_pubkey": "02h9i0j1..."
    }
  ],
  "created_at": "2025-12-10T10:00:00Z"
}
```

**BIP44 派生路径规则**:

| 链 | Coin Type | Account | 派生路径模板 |
|----|-----------|---------|--------------|
| TRON | 195 | 0 | m/44'/195'/0'/0/{user_id} |
| BSC | 60 | 0 | m/44'/60'/0'/0/{user_id} |
| ETH | 60 | 1 | m/44'/60'/1'/0/{user_id} |

---

## 三链默认派生路径详解

### BIP44 路径结构

```
m / purpose' / coin_type' / account' / change / address_index
```

| 层级 | 说明 |
|------|------|
| m | 主节点 |
| purpose' | 固定为 44' (BIP44 标准) |
| coin_type' | 币种类型 (由 SLIP44 定义) |
| account' | 账户索引 |
| change | 0=外部地址, 1=内部地址 |
| address_index | 地址索引 (对应 user_id) |

### 各链默认派生路径

#### TRON (TRX)

| 属性 | 值 |
|------|------|
| Coin Type | 195 |
| 默认路径 | `m/44'/195'/0'/0/0` |
| 用户充值地址 | `m/44'/195'/0'/0/{user_id}` |
| 地址前缀 | T |
| 地址长度 | 34 字符 |
| 地址编码 | Base58Check |

**示例**:
```
派生路径: m/44'/195'/0'/0/10001
地址: TKvjYxABCDEF1234567890abcdefghij
```

#### BNB Smart Chain (BSC)

| 属性 | 值 |
|------|------|
| Coin Type | 60 (与 ETH 相同) |
| Account | 0 (区分 ETH) |
| 默认路径 | `m/44'/60'/0'/0/0` |
| 用户充值地址 | `m/44'/60'/0'/0/{user_id}` |
| 地址前缀 | 0x |
| 地址长度 | 42 字符 |
| 地址编码 | EIP-55 Checksum |

**示例**:
```
派生路径: m/44'/60'/0'/0/10001
地址: 0x1234567890AbCdEf1234567890aBcDeF12345678
```

#### Ethereum (ETH)

| 属性 | 值 |
|------|------|
| Coin Type | 60 |
| Account | 1 (区分 BSC) |
| 默认路径 | `m/44'/60'/1'/0/0` |
| 用户充值地址 | `m/44'/60'/1'/0/{user_id}` |
| 地址前缀 | 0x |
| 地址长度 | 42 字符 |
| 地址编码 | EIP-55 Checksum |

**示例**:
```
派生路径: m/44'/60'/1'/0/10001
地址: 0xAbCdEf1234567890abcdef1234567890AbCdEf12
```

### BSC 与 ETH 地址区分

由于 BSC 和 ETH 使用相同的 Coin Type (60)，本系统通过 Account 层级区分:

| 链 | Account | 完整路径 |
|----|---------|----------|
| BSC | 0 | m/44'/60'/0'/0/{index} |
| ETH | 1 | m/44'/60'/1'/0/{index} |

**注意**: 虽然派生路径不同，但同一公钥在 BSC 和 ETH 上生成的地址格式相同。上层业务逻辑需要明确区分用户在哪条链充值。

### 派生索引分配规则

| 索引范围 | 用途 |
|----------|------|
| 0 | 系统热钱包主地址 |
| 1-999 | 预留 (归集地址等) |
| 1000-9999 | 测试/开发用地址 |
| 10000+ | 用户充值地址 (index = user_id) |

---

## F-SIGN-006: 根据路径获取地址

**描述**: 根据指定的派生路径获取地址。

**gRPC 方法**: `GetAddressFromPath`

**请求 Schema**:
```json
{
  "seed_id": "seed_hot_001",
  "chain": "TRN",
  "derivation_path": "m/44'/195'/0'/0/10001"
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "",
  "chain": "TRN",
  "address": "TKvjYxxxxxxxxxxx",
  "derivation_path": "m/44'/195'/0'/0/10001",
  "public_key": "04a1b2c3d4...",
  "compressed_pubkey": "02a1b2c3..."
}
```

---

## F-SIGN-007: 批量生成地址

**描述**: 批量生成连续索引的地址。

**gRPC 方法**: `GenerateAddressBatch`

**请求 Schema**:
```json
{
  "seed_id": "seed_hot_001",
  "chain": "TRN",
  "start_index": 0,
  "count": 100,
  "account": 0,                          // BIP44 account
  "change": 0                            // 0=external, 1=internal
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "",
  "seed_id": "seed_hot_001",
  "chain": "TRN",
  "start_index": 0,
  "count": 100,
  "addresses": [
    {
      "index": 0,
      "derivation_path": "m/44'/195'/0'/0/0",
      "address": "TKvjY...",
      "public_key": "04...",
      "compressed_pubkey": "02..."
    },
    // ... 更多地址
  ]
}
```
