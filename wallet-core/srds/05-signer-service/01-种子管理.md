# 种子管理

> 返回 [Signer 服务目录](./README.md)

---

## F-SIGN-001: 初始化种子

**描述**: 创建并加密存储新的主种子 (Master Seed)。

**gRPC 方法**: `InitSeed`

**请求 Schema**:
```json
{
  "seed_id": "seed_hot_001",            // 种子唯一标识
  "seed_name": "热钱包主种子",
  "supported_chains": ["TRN", "BSC", "ETH"],
  "temperature": 1,                      // 1=热钱包, 2=冷钱包
  "encryption_password": "SecurePassword123!",
  "description": "主热钱包种子",
  "custom_seed": ""                      // 可选：自定义种子 (hex)
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "种子初始化成功",
  "seed_id": "seed_hot_001",
  "seed_hash": "sha256:abc123...",       // 种子哈希 (用于验证)
  "status": 1,
  "created_at": "2025-12-10T10:00:00Z",
  "mnemonic": "abandon abandon ... about"  // 仅首次返回，需立即备份
}
```

**业务规则**:
- 新种子会自动生成 BIP39 助记词
- 助记词仅在创建时返回一次
- 种子使用 AES-256-GCM 加密后存储
- 加密密钥通过 PBKDF2 派生

---

## 助记词规格

### BIP39 助记词生成规则

| 属性 | 规格 |
|------|------|
| 标准 | BIP39 |
| 词表 | 英文 2048 词表 |
| 长度选项 | 12 词 (128位熵) / 24 词 (256位熵) |
| 默认长度 | 12 词 (推荐用户使用) |
| 校验位 | 4位 (12词) / 8位 (24词) |

### 12 词助记词说明

- **熵长度**: 128 位 (16 字节)
- **校验位**: 4 位 (SHA256 前 4 位)
- **总长度**: 132 位 = 12 × 11 位
- **安全强度**: 2^128 种可能，足够安全
- **使用场景**: C端用户钱包创建

### 24 词助记词说明

- **熵长度**: 256 位 (32 字节)
- **校验位**: 8 位 (SHA256 前 8 位)
- **总长度**: 264 位 = 24 × 11 位
- **安全强度**: 2^256 种可能，极高安全
- **使用场景**: 企业级冷钱包、高价值资产

### 助记词验证规则

```
1. 检查词数量 (12 或 24)
2. 检查每个词是否在 BIP39 词表中
3. 验证校验位正确性
4. 可选: 检查是否包含连续重复词
```

---

## 客户端备份说明

### iCloud 备份 (iOS)

**实现方式**: 客户端本地实现，服务端不存储私钥/助记词

| 步骤 | 说明 |
|------|------|
| 1 | 用户输入交易密码作为加密密钥来源 |
| 2 | 通过 PBKDF2 派生 AES-256 密钥 |
| 3 | 使用 AES-256-GCM 加密助记词 |
| 4 | 将加密数据存储到 iCloud Keychain |
| 5 | 恢复时需输入相同交易密码解密 |

**安全性**:
- 助记词明文永不离开设备
- 云端仅存储加密数据
- 密钥派生参数: PBKDF2, 100000 轮, SHA256

### Google Drive 备份 (Android)

**实现方式**: 与 iCloud 类似，使用 Android Keystore + Google Drive

| 步骤 | 说明 |
|------|------|
| 1 | 用户输入交易密码 |
| 2 | 使用 Android Keystore 派生密钥 |
| 3 | AES-256-GCM 加密助记词 |
| 4 | 存储到 Google Drive App Data 文件夹 |
| 5 | 恢复时需相同设备密钥 + 交易密码 |

---

## F-SIGN-002: 从助记词初始化种子

**描述**: 从已有的 BIP39 助记词导入种子。

**gRPC 方法**: `InitSeedFromMnemonic`

**请求 Schema**:
```json
{
  "seed_id": "seed_cold_001",
  "seed_name": "冷钱包主种子",
  "mnemonic": "abandon abandon abandon ... about",  // 12 或 24 个单词
  "passphrase": "",                      // 可选：BIP39 passphrase
  "supported_chains": ["TRN", "BSC", "ETH"],
  "temperature": 2,                      // 冷钱包
  "description": "从助记词恢复的冷钱包"
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "种子导入成功",
  "seed_id": "seed_cold_001",
  "seed_hash": "sha256:def456...",
  "status": 1,
  "created_at": "2025-12-10T10:00:00Z",
  "mnemonic": ""                         // 导入时不返回助记词
}
```

---

## F-SIGN-003: 查询种子列表

**描述**: 获取所有种子的基本信息。

**gRPC 方法**: `ListSeeds`

**请求 Schema**:
```json
{
  "status": 0                            // 可选：筛选状态 (0=全部)
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "",
  "seeds": [
    {
      "seed_id": "seed_hot_001",
      "seed_name": "热钱包主种子",
      "supported_chains": ["TRN", "BSC", "ETH"],
      "temperature": 1,
      "status": 1,                       // 1=激活, 2=停用, 3=废弃
      "total_signatures": 15000,
      "last_signature_at": "2025-12-10T09:00:00Z",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ]
}
```

**种子状态**:

| 值 | 名称 | 描述 |
|----|------|------|
| 1 | 激活 | 正常使用中 |
| 2 | 停用 | 暂停使用 |
| 3 | 废弃 | 永久停用 |

---

## F-SIGN-004: 更新种子状态

**描述**: 更新种子的状态 (激活/停用/废弃)。

**gRPC 方法**: `UpdateSeedStatus`

**请求 Schema**:
```json
{
  "seed_id": "seed_hot_001",
  "status": 2,                           // 停用
  "reason": "密钥轮换"
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "状态更新成功",
  "seed_id": "seed_hot_001",
  "status": 2,
  "updated_at": "2025-12-10T10:00:00Z"
}
```

---

## F-SIGN-010: 获取助记词验证挑战

**描述**: 生成助记词验证挑战，随机选取 3 个位置让用户输入。用于验证用户确实记住了助记词。

**gRPC 方法**: `GetMnemonicChallenge`

**请求 Schema**:
```json
{
  "user_id": 10001,
  "purpose": "verify_backup"            // verify_backup/recovery/security_check
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "",
  "session_id": "challenge_abc123",
  "challenge_indices": [2, 7, 11],       // 需要验证的位置 (0-11 for 12词)
  "expires_at": "2025-12-10T10:05:00Z"   // 5分钟有效期
}
```

**业务规则**:
- 随机选取 3 个不连续的位置
- 挑战会话有效期 5 分钟
- 同一用户每小时最多发起 5 次挑战
- 用于确认用户确实备份了助记词

**PRD 对齐**: 此接口支持 PRD 中描述的 "3-word challenge" 验证流程。

---

## F-SIGN-011: 验证助记词挑战

**描述**: 验证用户输入的助记词挑战答案。

**gRPC 方法**: `VerifyMnemonicChallenge`

**请求 Schema**:
```json
{
  "session_id": "challenge_abc123",
  "answers": [
    { "index": 2, "word": "apple" },
    { "index": 7, "word": "banana" },
    { "index": 11, "word": "cherry" }
  ]
}
```

**响应 Schema**:
```json
{
  "code": 0,
  "message": "验证通过",
  "verified": true,
  "backup_confirmed": true,
  "verified_at": "2025-12-10T10:01:00Z"
}
```

**错误响应**:
```json
{
  "code": 50011,
  "message": "助记词验证失败",
  "verified": false,
  "incorrect_indices": [7],              // 错误的位置
  "remaining_attempts": 2
}
```

**业务规则**:
- 每次挑战最多允许 3 次尝试
- 验证成功后标记用户已确认备份
- 所有验证尝试记入审计日志
- 连续失败 3 次需等待 30 分钟后重新发起挑战

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 50010 | 挑战会话已过期 |
| 50011 | 助记词验证失败 |
| 50012 | 尝试次数过多 |
| 50013 | 挑战会话不存在 |

---

## iCloud 备份格式与恢复流程

### 备份数据格式

```json
{
  "version": 1,
  "format": "encrypted_mnemonic_v1",
  "created_at": "2025-12-10T10:00:00Z",
  "device_id": "device_uuid",
  "encryption": {
    "algorithm": "AES-256-GCM",
    "kdf": "PBKDF2",
    "kdf_iterations": 100000,
    "salt": "base64_encoded_salt",
    "iv": "base64_encoded_iv"
  },
  "payload": "base64_encoded_encrypted_mnemonic"
}
```

### 加密流程

```
用户输入交易密码
        │
        ▼
┌─────────────────────┐
│ 生成随机 salt (32B) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────┐
│ PBKDF2 派生密钥             │
│ - 密码 + salt               │
│ - 100,000 轮迭代            │
│ - 输出 256 位密钥           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ AES-256-GCM 加密助记词      │
│ - 生成随机 IV (12B)         │
│ - 加密助记词字符串          │
│ - 生成认证标签              │
└──────────┬──────────────────┘
           │
           ▼
存储到 iCloud Keychain
```

### 恢复流程

```
从 iCloud 读取加密数据
        │
        ▼
┌─────────────────────────────┐
│ 用户输入交易密码            │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ PBKDF2 派生密钥             │
│ - 使用存储的 salt           │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ AES-256-GCM 解密            │
│ - 使用存储的 IV             │
│ - 验证认证标签              │
└──────────┬──────────────────┘
           │
      ┌────┴────┐
      │ 成功    │ 失败
      ▼         ▼
  返回助记词  返回错误
  重建钱包   (密码错误)
```

### 错误码

| 错误码 | 说明 |
|--------|------|
| 50020 | 备份数据格式错误 |
| 50021 | 密码错误，解密失败 |
| 50022 | 备份数据损坏 |
| 50023 | 不支持的备份版本 |

---

> 返回 [Signer 服务目录](./README.md)
