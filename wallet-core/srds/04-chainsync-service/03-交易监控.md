# 交易监控

> 返回 [ChainSync 服务目录](./README.md)

---

## F-SYNC-008: 获取交易详情

**描述**: 获取链上交易的详细信息。

**gRPC 方法**: `GetTransaction`

**请求 Schema**:
```json
{
  "chain": 1,
  "tx_hash": "abc123def456...",
  "include_trace": true                 // 是否包含调用跟踪
}
```

**响应 Schema**:
```json
{
  "success": true,
  "transaction": {
    "tx_hash": "abc123def456...",
    "chain": 1,
    "block_number": 12345678,
    "block_hash": "def456...",
    "block_timestamp": 1702300800,
    "transaction_index": 5,
    "from_address": "TKvjY...",
    "to_address": "TAbcD...",
    "value": "1000000000",
    "gas_price": "1000",
    "gas_used": 21000,
    "gas_fee": "21000000",
    "status": 2,                        // TransactionStatus 枚举
    "nonce": "5",
    "input_data": "",
    "confirmations": 100,
    "contract_address": "",
    "logs": [
      {
        "log_index": "0",
        "transaction_hash": "abc123...",
        "address": "TR7N...",
        "topics": ["0xddf252ad..."],
        "data": "...",
        "block_number": 12345678,
        "block_timestamp": 1702300800
      }
    ],
    "error_message": ""
  }
}
```

**交易状态枚举 (TransactionStatus)**:

| 值 | 名称 | 描述 |
|----|------|------|
| 1 | TRANSACTION_STATUS_PENDING | 待确认 |
| 2 | TRANSACTION_STATUS_CONFIRMED | 已确认 |
| 3 | TRANSACTION_STATUS_FAILED | 失败 |
| 4 | TRANSACTION_STATUS_REVERTED | 已回滚 |

---

## F-SYNC-009: 获取地址交易历史

**描述**: 获取指定地址的交易历史记录。

**gRPC 方法**: `GetAddressTransactions`

**请求 Schema**:
```json
{
  "chain": 1,
  "address": "TKvjYxxxxxxxxxxx",
  "start_block": 12340000,              // 起始区块
  "end_block": 12350000,                // 结束区块
  "page": 1,
  "page_size": 20,
  "status_filter": 2                    // 可选：状态过滤
}
```

**响应 Schema**:
```json
{
  "success": true,
  "transactions": [...],
  "total": 150,
  "current_block": 12350000
}
```

---

## F-SYNC-010: 获取区块交易

**描述**: 获取指定区块中的所有交易。

**gRPC 方法**: `GetBlockTransactions`

**请求 Schema**:
```json
{
  "chain": 1,
  "block_number": 12345678,             // 二选一
  "block_hash": "",                     // 二选一
  "page": 1,
  "page_size": 50
}
```

**响应 Schema**:
```json
{
  "success": true,
  "block_info": {
    "block_number": 12345678,
    "block_hash": "abc123...",
    "parent_hash": "def456...",
    "timestamp": 1702300800,
    "transaction_count": 150,
    "miner": "TXyz...",
    "difficulty": "1234567",
    "total_difficulty": "9876543210",
    "size": "12345",
    "gas_limit": 30000000,
    "gas_used": 15000000
  },
  "transactions": [...],
  "total_transactions": 150
}
```

---

## 链特定确认数要求

### 确认数配置

不同链需要不同的区块确认数才能认定交易最终确认:

| 链 | ChainRpcType | 确认数要求 | 约等于时间 | 说明 |
|----|--------------|------------|------------|------|
| TRX | 1 | 19 块 | ~60 秒 | TRON 主网标准 |
| BSC | 2 | 15 块 | ~45 秒 | BNB Smart Chain |
| ETH | 3 | 12 块 | ~3 分钟 | Ethereum 主网 |

### 状态判定逻辑

```
交易上链
    │
    ▼
┌─────────────────────────┐
│ confirmations < required │
│ status = PENDING         │
└──────────┬──────────────┘
           │ 继续等待确认
           ▼
┌─────────────────────────┐
│ confirmations >= required│
│ && receipt.status = 1    │
│ status = CONFIRMED       │
└─────────────────────────┘
           │
           ▼
  通知 Business Service
  更新账本余额
```

### 交易详情响应增强

```json
{
  "success": true,
  "transaction": {
    "tx_hash": "abc123...",
    "status": 1,                       // PENDING
    "confirmations": 8,
    "required_confirmations": 12,      // ETH 需要 12 块
    "confirmation_progress": "66.67%", // 确认进度百分比
    "estimated_confirmation_time": "2025-12-10T10:02:00Z"
  }
}
```

### 配置

```yaml
ChainSync:
  Confirmations:
    TRX: 19
    BSC: 15
    ETH: 12
  BlockTime:
    TRX: 3        # 秒
    BSC: 3
    ETH: 12
```

---

> 返回 [ChainSync 服务目录](./README.md)
