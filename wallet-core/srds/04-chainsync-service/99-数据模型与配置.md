# 数据模型与配置

> 返回 [ChainSync 服务目录](./README.md)

---

## 1. 数据模型

### 1.1 区块表 (blocks)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| block_number | BIGINT | 区块号 |
| block_hash | VARCHAR(100) | 区块哈希 |
| parent_hash | VARCHAR(100) | 父区块哈希 |
| timestamp | BIGINT | 区块时间戳 |
| transaction_count | INT | 交易数量 |
| miner | VARCHAR(100) | 矿工地址 |
| difficulty | VARCHAR(50) | 难度 |
| gas_limit | BIGINT | Gas 限制 |
| gas_used | BIGINT | Gas 使用量 |
| size | INT | 区块大小 |
| sync_status | VARCHAR(20) | 同步状态 |
| created_at | DATETIME | 创建时间 |

**索引**: `UNIQUE (chain, block_number)`

### 1.2 交易表 (transactions)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| tx_hash | VARCHAR(100) | 交易哈希 |
| block_number | BIGINT | 区块号 |
| from_address | VARCHAR(100) | 发送地址 |
| to_address | VARCHAR(100) | 接收地址 |
| value | VARCHAR(78) | 交易金额 |
| gas_price | VARCHAR(50) | Gas 价格 |
| gas_used | BIGINT | Gas 使用量 |
| gas_fee | VARCHAR(50) | 手续费 |
| status | VARCHAR(20) | 交易状态 |
| confirmations | INT | 确认数 |
| contract_address | VARCHAR(100) | 合约地址 |
| input_data | TEXT | 输入数据 |
| error_message | TEXT | 错误信息 |
| created_at | DATETIME | 创建时间 |

**索引**: `UNIQUE (chain, tx_hash)`, `INDEX (from_address)`, `INDEX (to_address)`

### 1.3 地址监控表 (address_monitors)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| monitor_id | VARCHAR(64) | 监控 ID |
| chain | VARCHAR(10) | 链类型 |
| address | VARCHAR(100) | 监控地址 |
| monitor_type | TINYINT | 监控类型 |
| priority | TINYINT | 优先级 |
| webhook_url | VARCHAR(255) | 回调 URL |
| tag | VARCHAR(100) | 标签 |
| metadata | JSON | 元数据 |
| active | TINYINT | 是否激活 |
| last_activity | DATETIME | 最后活动时间 |
| created_at | DATETIME | 创建时间 |

### 1.4 余额记录表 (balance_records)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| address | VARCHAR(100) | 地址 |
| token_address | VARCHAR(100) | 代币地址 |
| token_symbol | VARCHAR(20) | 代币符号 |
| token_decimals | TINYINT | 代币精度 |
| balance | VARCHAR(78) | 余额 |
| formatted_balance | VARCHAR(50) | 格式化余额 |
| usd_value | DECIMAL(20,8) | USD 价值 |
| block_number | BIGINT | 区块号 |
| created_at | DATETIME | 创建时间 |

### 1.5 同步任务表 (sync_tasks)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| sync_id | VARCHAR(64) | 同步任务 ID |
| chain | VARCHAR(10) | 链类型 |
| status | VARCHAR(20) | 同步状态 |
| current_block | BIGINT | 当前区块 |
| latest_block | BIGINT | 最新区块 |
| start_block | BIGINT | 起始区块 |
| end_block | BIGINT | 结束区块 |
| blocks_per_second | FLOAT | 同步速度 |
| estimated_remaining_seconds | BIGINT | 预计剩余时间 |
| start_time | DATETIME | 开始时间 |
| end_time | DATETIME | 结束时间 |
| last_update_time | DATETIME | 最后更新时间 |
| last_error | TEXT | 最后错误 |

### 1.6 服务商状态表 (provider_status)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | VARCHAR(64) | 服务商 ID |
| provider_type | VARCHAR(20) | 服务商类型 |
| chain | VARCHAR(10) | 链类型 |
| endpoint | VARCHAR(255) | 端点 URL |
| config | JSON | 配置信息 |
| healthy | TINYINT | 是否健康 |
| response_time_ms | INT | 响应时间 |
| success_rate | FLOAT | 成功率 |
| total_requests | BIGINT | 总请求数 |
| failed_requests | BIGINT | 失败请求数 |
| last_success_time | DATETIME | 最后成功时间 |
| last_error_time | DATETIME | 最后错误时间 |
| last_error | TEXT | 最后错误 |
| is_primary | TINYINT | 是否主要 |
| weight | FLOAT | 权重 |

---

## 2. 配置

### 2.1 服务配置示例

**文件**: `services/chainsync/rpc/etc/chainsync.yaml`

```yaml
Name: chainsync.rpc
ListenOn: 0.0.0.0:9001
NodeID: 3

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: chainsync.rpc

MySQL:
  DataSource: "crypto:crypto123456@tcp(localhost:3306)/chainsync?charset=utf8mb4"

Redis:
  Host: localhost:6379
  Pass: redis123456

Providers:
  ETH:
    - name: publicnode
      endpoint: https://ethereum-sepolia-rpc.publicnode.com
      rateLimit: 5
      maxRetries: 3
      priority: 1
      enabled: true
    - name: infura
      endpoint: https://mainnet.infura.io/v3/YOUR_KEY
      rateLimit: 100
      maxRetries: 3
      priority: 2
      enabled: true

  BSC:
    - name: omniatech
      endpoint: https://endpoints.omniatech.io/v1/bsc/testnet/public
      rateLimit: 10
      maxRetries: 3
      priority: 1
      enabled: true

  TRON:
    - name: trongrid
      endpoint: https://api.trongrid.io
      rateLimit: 15
      maxRetries: 3
      priority: 1
      enabled: true

Sync:
  MaxConcurrentSyncs: 10
  BatchSize: 100
  HealthCheckInterval: 30s
  FailoverThreshold: 3
  ReorgDepth: 12                        # 重组深度检测

Prometheus:
  Host: 0.0.0.0
  Port: 9093
```

---

## 3. 充值确认数配置

### 3.1 各链确认数要求

| 链 | 确认数 | 预计等待时间 | 说明 |
|----|--------|--------------|------|
| TRX | 20 | 1-5 分钟 | TRON 出块约 3 秒 |
| BSC | 15 | 3-10 分钟 | BSC 出块约 3 秒 |
| ETH | 12 | 5-15 分钟 | ETH 出块约 12 秒 |

### 3.2 确认数配置示例

```yaml
Confirmations:
  TRN:
    required: 20           # 所需确认数
    block_time_ms: 3000    # 出块时间 (毫秒)
    safe_confirmations: 30 # 高安全性确认数 (大额交易)
  BSC:
    required: 15
    block_time_ms: 3000
    safe_confirmations: 25
  ETH:
    required: 12
    block_time_ms: 12000
    safe_confirmations: 20
```

### 3.3 大额交易确认数

对于大额交易 (≥10000 USDT)，使用更高的确认数要求:

| 链 | 标准确认数 | 大额确认数 |
|----|------------|------------|
| TRX | 20 | 30 |
| BSC | 15 | 25 |
| ETH | 12 | 20 |

---

## 4. Kafka 事件格式

### 4.1 事件主题

| 主题名称 | 说明 |
|----------|------|
| `chainsync.deposit.detected` | 充值交易检测到 |
| `chainsync.deposit.confirmed` | 充值交易已确认 |
| `chainsync.balance.changed` | 地址余额变化 |
| `chainsync.block.synced` | 区块同步完成 |
| `chainsync.tx.status` | 交易状态变更 |

### 4.2 充值检测事件

**主题**: `chainsync.deposit.detected`

```json
{
  "event_id": "EVT-20251210-ABC123",
  "event_type": "deposit_detected",
  "timestamp": "2025-12-10T10:00:00Z",
  "chain": "TRN",
  "tx_hash": "abc123def456...",
  "block_number": 12345678,
  "from_address": "T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb",
  "to_address": "TKvjYxxxxxxxxxxx",
  "amount": "100000000",
  "amount_decimal": "100.00",
  "token_address": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
  "token_symbol": "USDT",
  "token_decimals": 6,
  "confirmations": 0,
  "required_confirmations": 20,
  "user_id": 10001,
  "metadata": {
    "memo": "",
    "gas_used": "21000",
    "gas_price": "1000000000"
  }
}
```

### 4.3 充值确认事件

**主题**: `chainsync.deposit.confirmed`

```json
{
  "event_id": "EVT-20251210-DEF456",
  "event_type": "deposit_confirmed",
  "timestamp": "2025-12-10T10:05:00Z",
  "chain": "TRN",
  "tx_hash": "abc123def456...",
  "block_number": 12345678,
  "confirmed_block": 12345698,
  "from_address": "T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb",
  "to_address": "TKvjYxxxxxxxxxxx",
  "amount": "100000000",
  "amount_decimal": "100.00",
  "token_address": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
  "token_symbol": "USDT",
  "token_decimals": 6,
  "confirmations": 20,
  "required_confirmations": 20,
  "user_id": 10001,
  "valuation_usdt": "100.00",
  "deposit_id": "D1733836800000ABC"
}
```

### 4.4 余额变化事件

**主题**: `chainsync.balance.changed`

```json
{
  "event_id": "EVT-20251210-GHI789",
  "event_type": "balance_changed",
  "timestamp": "2025-12-10T10:05:00Z",
  "chain": "TRN",
  "address": "TKvjYxxxxxxxxxxx",
  "token_address": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
  "token_symbol": "USDT",
  "previous_balance": "5000000000",
  "new_balance": "5100000000",
  "change_amount": "100000000",
  "change_type": "increase",
  "trigger_tx_hash": "abc123def456...",
  "user_id": 10001
}
```

### 4.5 交易状态变更事件

**主题**: `chainsync.tx.status`

```json
{
  "event_id": "EVT-20251210-JKL012",
  "event_type": "tx_status_changed",
  "timestamp": "2025-12-10T10:10:00Z",
  "chain": "TRN",
  "tx_hash": "xyz789abc012...",
  "tx_type": "withdraw",
  "previous_status": "pending",
  "new_status": "confirmed",
  "block_number": 12345700,
  "confirmations": 20,
  "from_address": "TKvjYxxxxxxxxxxx",
  "to_address": "TAbcDefGhijKlmno...",
  "amount": "50000000",
  "token_symbol": "USDT",
  "tx_id": "W1733836800000XYZ",
  "user_id": 10001,
  "error_message": ""
}
```

### 4.6 事件消费者配置

```yaml
Kafka:
  Brokers:
    - localhost:9092
  GroupID: business-service
  Topics:
    - chainsync.deposit.detected
    - chainsync.deposit.confirmed
    - chainsync.balance.changed
    - chainsync.tx.status
  AutoCommit: false
  MaxRetries: 3
  RetryBackoff: 1s
```

### 4.7 事件处理规则

| 事件类型 | 消费者 | 处理动作 |
|----------|--------|----------|
| deposit_detected | Business Service | 创建待确认充值记录 |
| deposit_confirmed | Business Service | 更新用户余额，发送通知 |
| balance_changed | Business Service | 更新缓存余额 |
| tx_status_changed | Business Service | 更新交易状态，触发回调 |

### 4.8 幂等性保证

- 每个事件携带唯一 `event_id`
- 消费者需记录已处理的 `event_id`
- 重复事件应跳过处理
- 使用 Redis Set 存储近期 event_id (24小时 TTL)

---

## 5. 依赖

### 5.1 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/zeromicro/go-zero | 1.6.0 | 微服务框架 |
| gorm.io/gorm | 1.25.10 | ORM |
| github.com/ethereum/go-ethereum | 1.15.6 | 以太坊客户端 |
| github.com/fbsobreira/gotron-sdk | 0.24.1 | TRON SDK |
| github.com/redis/go-redis/v9 | 9.17.0 | Redis 客户端 |

### 5.2 RPC 服务商

| 提供商 | 支持链 | 特点 |
|--------|--------|------|
| QuickNode | 全链 | 高性能、低延迟 |
| Infura | ETH/Polygon | 稳定可靠 |
| Alchemy | ETH/Polygon | 开发者友好 |
| Ankr | 全链 | 多节点支持 |
| Moralis | 全链 | Web3 API |

---

## 6. 安全考量

### 6.1 安全建议

1. **Webhook 安全**: 对回调 URL 进行签名验证
2. **速率限制**: 控制对 RPC 节点的请求频率
3. **数据验证**: 验证区块和交易数据的完整性
4. **故障转移**: 配置多个 RPC 提供商实现冗余
5. **监控告警**: 设置同步延迟和错误告警
