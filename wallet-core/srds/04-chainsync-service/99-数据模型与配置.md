# 数据模型与配置

> 返回 [ChainSync 服务目录](./README.md)

---

## 1. 数据模型

### 1.1 区块表 (blocks)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| block_number | BIGINT | 区块号 |
| block_hash | VARCHAR(100) | 区块哈希 |
| parent_hash | VARCHAR(100) | 父区块哈希 |
| timestamp | BIGINT | 区块时间戳 |
| transaction_count | INT | 交易数量 |
| miner | VARCHAR(100) | 矿工地址 |
| difficulty | VARCHAR(50) | 难度 |
| gas_limit | BIGINT | Gas 限制 |
| gas_used | BIGINT | Gas 使用量 |
| size | INT | 区块大小 |
| sync_status | VARCHAR(20) | 同步状态 |
| created_at | DATETIME | 创建时间 |

**索引**: `UNIQUE (chain, block_number)`

### 1.2 交易表 (transactions)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| tx_hash | VARCHAR(100) | 交易哈希 |
| block_number | BIGINT | 区块号 |
| from_address | VARCHAR(100) | 发送地址 |
| to_address | VARCHAR(100) | 接收地址 |
| value | VARCHAR(78) | 交易金额 |
| gas_price | VARCHAR(50) | Gas 价格 |
| gas_used | BIGINT | Gas 使用量 |
| gas_fee | VARCHAR(50) | 手续费 |
| status | VARCHAR(20) | 交易状态 |
| confirmations | INT | 确认数 |
| contract_address | VARCHAR(100) | 合约地址 |
| input_data | TEXT | 输入数据 |
| error_message | TEXT | 错误信息 |
| created_at | DATETIME | 创建时间 |

**索引**: `UNIQUE (chain, tx_hash)`, `INDEX (from_address)`, `INDEX (to_address)`

### 1.3 地址监控表 (address_monitors)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| monitor_id | VARCHAR(64) | 监控 ID |
| chain | VARCHAR(10) | 链类型 |
| address | VARCHAR(100) | 监控地址 |
| monitor_type | TINYINT | 监控类型 |
| priority | TINYINT | 优先级 |
| webhook_url | VARCHAR(255) | 回调 URL |
| tag | VARCHAR(100) | 标签 |
| metadata | JSON | 元数据 |
| active | TINYINT | 是否激活 |
| last_activity | DATETIME | 最后活动时间 |
| created_at | DATETIME | 创建时间 |

### 1.4 余额记录表 (balance_records)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| chain | VARCHAR(10) | 链类型 |
| address | VARCHAR(100) | 地址 |
| token_address | VARCHAR(100) | 代币地址 |
| token_symbol | VARCHAR(20) | 代币符号 |
| token_decimals | TINYINT | 代币精度 |
| balance | VARCHAR(78) | 余额 |
| formatted_balance | VARCHAR(50) | 格式化余额 |
| usd_value | DECIMAL(20,8) | USD 价值 |
| block_number | BIGINT | 区块号 |
| created_at | DATETIME | 创建时间 |

### 1.5 同步任务表 (sync_tasks)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| sync_id | VARCHAR(64) | 同步任务 ID |
| chain | VARCHAR(10) | 链类型 |
| status | VARCHAR(20) | 同步状态 |
| current_block | BIGINT | 当前区块 |
| latest_block | BIGINT | 最新区块 |
| start_block | BIGINT | 起始区块 |
| end_block | BIGINT | 结束区块 |
| blocks_per_second | FLOAT | 同步速度 |
| estimated_remaining_seconds | BIGINT | 预计剩余时间 |
| start_time | DATETIME | 开始时间 |
| end_time | DATETIME | 结束时间 |
| last_update_time | DATETIME | 最后更新时间 |
| last_error | TEXT | 最后错误 |

### 1.6 服务商状态表 (provider_status)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| provider_id | VARCHAR(64) | 服务商 ID |
| provider_type | VARCHAR(20) | 服务商类型 |
| chain | VARCHAR(10) | 链类型 |
| endpoint | VARCHAR(255) | 端点 URL |
| config | JSON | 配置信息 |
| healthy | TINYINT | 是否健康 |
| response_time_ms | INT | 响应时间 |
| success_rate | FLOAT | 成功率 |
| total_requests | BIGINT | 总请求数 |
| failed_requests | BIGINT | 失败请求数 |
| last_success_time | DATETIME | 最后成功时间 |
| last_error_time | DATETIME | 最后错误时间 |
| last_error | TEXT | 最后错误 |
| is_primary | TINYINT | 是否主要 |
| weight | FLOAT | 权重 |

---

## 2. 配置

### 2.1 服务配置示例

**文件**: `services/chainsync/rpc/etc/chainsync.yaml`

```yaml
Name: chainsync.rpc
ListenOn: 0.0.0.0:9001
NodeID: 3

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: chainsync.rpc

MySQL:
  DataSource: "crypto:crypto123456@tcp(localhost:3306)/chainsync?charset=utf8mb4"

Redis:
  Host: localhost:6379
  Pass: redis123456

Providers:
  ETH:
    - name: publicnode
      endpoint: https://ethereum-sepolia-rpc.publicnode.com
      rateLimit: 5
      maxRetries: 3
      priority: 1
      enabled: true
    - name: infura
      endpoint: https://mainnet.infura.io/v3/YOUR_KEY
      rateLimit: 100
      maxRetries: 3
      priority: 2
      enabled: true

  BSC:
    - name: omniatech
      endpoint: https://endpoints.omniatech.io/v1/bsc/testnet/public
      rateLimit: 10
      maxRetries: 3
      priority: 1
      enabled: true

  TRON:
    - name: trongrid
      endpoint: https://api.trongrid.io
      rateLimit: 15
      maxRetries: 3
      priority: 1
      enabled: true

Sync:
  MaxConcurrentSyncs: 10
  BatchSize: 100
  HealthCheckInterval: 30s
  FailoverThreshold: 3
  ReorgDepth: 12                        # 重组深度检测

Prometheus:
  Host: 0.0.0.0
  Port: 9093
```

---

## 3. 依赖

### 3.1 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/zeromicro/go-zero | 1.6.0 | 微服务框架 |
| gorm.io/gorm | 1.25.10 | ORM |
| github.com/ethereum/go-ethereum | 1.15.6 | 以太坊客户端 |
| github.com/fbsobreira/gotron-sdk | 0.24.1 | TRON SDK |
| github.com/redis/go-redis/v9 | 9.17.0 | Redis 客户端 |

### 3.2 RPC 服务商

| 提供商 | 支持链 | 特点 |
|--------|--------|------|
| QuickNode | 全链 | 高性能、低延迟 |
| Infura | ETH/Polygon | 稳定可靠 |
| Alchemy | ETH/Polygon | 开发者友好 |
| Ankr | 全链 | 多节点支持 |
| Moralis | 全链 | Web3 API |

---

## 4. 安全考量

### 4.1 安全建议

1. **Webhook 安全**: 对回调 URL 进行签名验证
2. **速率限制**: 控制对 RPC 节点的请求频率
3. **数据验证**: 验证区块和交易数据的完整性
4. **故障转移**: 配置多个 RPC 提供商实现冗余
5. **监控告警**: 设置同步延迟和错误告警
