# 用户认证

> 返回 [业务服务目录](./README.md)

---

## F-BUS-001: 用户登录

**描述**: 支持手机验证码和 Google OAuth 两种登录方式。

**gRPC 方法**: `Login`

**请求 Schema**:
```json
{
  "method": 1,              // LoginMethod: 1=手机验证码, 2=Google OAuth
  "phone": "13800138000",   // 手机号 (method=1 时)
  "country_code": "86",     // 国际区号
  "code": "123456",         // 手机验证码
  "google_id_token": "",    // Google ID Token (method=2 时)
  "google_auth_code": ""    // Google OAuth 授权码
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登录成功",
  "user_id": "10001",
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 86400
}
```

**业务规则**:
- 新用户首次登录自动创建账户
- 登录成功后生成 JWT Token
- 记录登录日志 (IP、设备、时间)
- 失败次数过多触发账户锁定

**账户锁定策略**:
- 连续登录失败 5 次，账户锁定 15 分钟
- 锁定期间所有登录方式均不可用
- 锁定解除后失败计数重置

**生物识别登录前提条件** (适用于 F-BUS-038):
- 用户已开启生物识别功能
- 非首次登录 (设备已信任)
- 账户未被加入黑名单
- 设备支持 FaceID/TouchID

---

## F-BUS-002: 用户登出

**描述**: 使当前会话的 Token 失效。

**gRPC 方法**: `Logout`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登出成功"
}
```

---

## F-BUS-003: 发送验证码

**描述**: 发送 SMS 或邮件验证码，用于登录、注册、找回密码等场景。

**gRPC 方法**: `SendVerificationCode`

**请求 Schema**:
```json
{
  "method": 1,     // LoginMethod: 1=手机, 2=邮箱
  "type": 1        // CodeType: 1=注册, 2=登录, 3=重置密码, 4=绑定邮箱, 5=绑定手机, 6=提现, 7=二次验证
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "验证码已发送",
  "expire_seconds": 300
}
```

**业务规则**:
- 发送间隔限制: 同一手机号/邮箱 60 秒内只能发送一次
- 频率限制: 同一手机号/邮箱每小时最多发送 5 次
- 有效期: 验证码 5 分钟内有效
- 验证码格式: 6 位数字
- 使用后失效: 验证成功后验证码立即失效

**验证码类型枚举**:

| 值 | 名称 | 描述 |
|----|------|------|
| 1 | CODE_TYPE_REGISTER | 注册 |
| 2 | CODE_TYPE_LOGIN | 登录 |
| 3 | CODE_TYPE_RESET_PASSWORD | 重置密码 |
| 4 | CODE_TYPE_BIND_EMAIL | 绑定邮箱 |
| 5 | CODE_TYPE_BIND_PHONE | 绑定手机 |
| 6 | CODE_TYPE_WITHDRAW | 提现 |
| 7 | CODE_TYPE_2FA | 二次验证 |

---

## F-BUS-004: 重置密码

**描述**: 通过验证码重置登录密码。

**gRPC 方法**: `ResetPassword`

**请求 Schema**:
```json
{
  "method": 1,              // 验证方式
  "phone": "13800138000",   // 手机号 (二选一)
  "country_code": "86",
  "email": "",              // 邮箱 (二选一)
  "code": "123456",         // 验证码
  "new_password": "NewPass123!"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "密码重置成功"
}
```

---

## F-BUS-005: 修改密码

**描述**: 已登录用户修改密码。

**gRPC 方法**: `ChangePassword`

**请求 Schema**:
```json
{
  "old_password": "OldPass123!",
  "new_password": "NewPass456!"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "密码修改成功"
}
```

---

## F-BUS-037: 邮箱验证码登录

**描述**: 支持使用邮箱验证码进行登录，与手机验证码登录并行的登录方式。

**gRPC 方法**: `LoginByEmail`

**请求 Schema**:
```json
{
  "email": "user@example.com",   // 用户邮箱
  "code": "123456"               // 邮箱验证码
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登录成功",
  "user_id": "10001",
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 86400,
  "is_new_user": false           // 是否为新注册用户
}
```

**业务规则**:
- 新用户首次登录自动创建账户，生成唯一 UID
- 验证码需在 5 分钟内使用
- 登录成功记录日志 (IP、设备、时间)
- 适用账户锁定策略 (5 次失败锁定 15 分钟)

---

## F-BUS-038: 生物识别登录

**描述**: 支持 FaceID/TouchID 快速登录，仅限已开启生物识别且设备已信任的用户。

**gRPC 方法**: `LoginByBiometric`

**请求 Schema**:
```json
{
  "device_id": "device-uuid-xxx",        // 设备唯一标识
  "biometric_token": "encrypted-token",  // 客户端生物识别验证后的加密凭证
  "device_info": {
    "platform": "iOS",                   // iOS/Android
    "os_version": "17.0",
    "device_model": "iPhone 15 Pro",
    "biometric_type": "face_id"          // face_id/touch_id/fingerprint
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "登录成功",
  "user_id": "10001",
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 86400
}
```

**业务规则**:
- 前提条件检查:
  - 用户已开启生物识别 (biometric_enabled = true)
  - 设备已在信任设备列表中
  - 账户未被加入黑名单
  - 账户未被锁定
- 验证超时: 30 秒
- 连续失败 3 次后降级为其他验证方式
- 记录登录日志

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_BIOMETRIC_NOT_ENABLED | 400 | 用户未开启生物识别功能 |
| AUTH_DEVICE_NOT_TRUSTED | 400 | 设备未在信任列表中 |
| AUTH_BIOMETRIC_VERIFY_FAILED | 401 | 生物识别验证失败 |
| AUTH_BIOMETRIC_TIMEOUT | 408 | 生物识别验证超时 |
| AUTH_BIOMETRIC_FALLBACK | 403 | 连续失败次数过多，请使用其他验证方式 |
| AUTH_BLACKLISTED | 403 | 账户在黑名单中 |
| AUTH_ACCOUNT_LOCKED | 423 | 账户已被锁定 |

---

## F-BUS-039: 检查黑名单状态

**描述**: 检查账户是否在黑名单中，用于登录前置检查和敏感操作前验证。

**gRPC 方法**: `CheckBlacklist`

**请求 Schema**:
```json
{
  "identifier": "13800138000",   // 手机号/邮箱/UID
  "identifier_type": 1           // 1=手机号, 2=邮箱, 3=UID
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_blacklisted": false,
  "reason": "",                  // 如被加入黑名单，返回原因
  "blacklisted_at": "",          // 加入黑名单时间
  "can_appeal": true             // 是否可申诉
}
```

**业务规则**:
- 黑名单账户禁止登录，返回错误码 `AUTH_BLACKLISTED`
- 黑名单账户已登录状态应强制登出
- 黑名单原因分类: 违规操作、风控触发、人工处理
- 部分黑名单支持申诉

---

## F-BUS-040: 用户注册

**描述**: 新用户注册账户，支持手机号或邮箱注册，生成唯一 UID。

**gRPC 方法**: `Register`

**请求 Schema**:
```json
{
  "method": 1,                   // 1=手机号, 2=邮箱
  "phone": "13800138000",        // 手机号 (method=1 时)
  "country_code": "86",          // 国际区号
  "email": "",                   // 邮箱 (method=2 时)
  "code": "123456",              // 验证码
  "invite_code": ""              // 邀请码 (可选)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "注册成功",
  "user_id": "10001",
  "uid": "U20251210ABCD",        // 用户唯一标识
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 86400
}
```

**业务规则**:
- UID 生成规则: 详见 [数据模型与配置 - ID 生成规则](./99-数据模型与配置.md#31-用户-uid-生成规则)
- 手机号/邮箱唯一性检查
- 注册成功后自动登录
- 可选: 跳过注册直接创建/导入钱包 (无 UID 模式)
- 记录注册来源和邀请关系
