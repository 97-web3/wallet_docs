# 提现功能

> 返回 [业务服务目录](./README.md)

---

## F-BUS-014: 获取提现信息

**描述**: 获取提现相关信息，包括可提现资产和网络。

**gRPC 方法**: `GetWithdrawInfo`

**请求 Schema**:
```json
{
  "asset": "USDT",
  "query": ""
}
```

**响应 Schema**:
```json
{
  "success": true,
  "assets": [...],
  "networks": [
    {
      "chain": "TRN",
      "fee": "1 USDT",
      "eta": "1-5分钟",
      "min_amount": "10",
      "per_order_limit": "50000"
    }
  ],
  "security_tip": {
    "has_trade_password": true,
    "has_biometric": true,
    "has_google_auth": false,
    "recommended_action": ""          // 如未设置任何验证方式，提示设置
  }
}
```

**业务规则**:
- 未设置任何验证方式时，返回 `recommended_action: "请先设置资金密码或开启生物识别"`
- 至少需要设置一种验证方式才能提现

---

## F-BUS-015: 创建提现

**描述**: 发起提现请求。

**gRPC 方法**: `CreateWithdraw`

**请求头**:
```
Idempotency-Key: <UUID>
```

**请求 Schema**:
```json
{
  "asset": "USDT",
  "chain": "TRN",
  "amount": "100",
  "address": "TKvjY...",
  "memo_tag": "",              // 如需 Memo/Tag
  "two_fa_code": "123456",     // 2FA 验证码 (可选)
  "email_code": "",            // 邮箱验证码 (可选)
  "sms_code": ""               // 短信验证码 (可选)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现申请已提交",
  "withdraw_id": "W123456",
  "fee": "1",
  "network": "TRC20",
  "status": "pending_audit",           // 提现状态
  "requires_audit": true,              // 是否需要审核
  "estimated_time": "1-5分钟"          // 预计到账时间 (免审批时)
}
```

**业务规则**:
- 最小提现金额: 10 USDT 等值
- 非 USDT 代币按实时汇率换算等值金额
- 验证方式选择按优先级链: FaceID > 2FA > 资金密码 > 验证码
- 提现限额:
  - 单笔限额: 50,000 USDT 等值
  - 单日限额: 100,000 USDT 等值
  - 单月限额: 1,000,000 USDT 等值

**Idempotency 规范**:
- 必须提供 `Idempotency-Key` 请求头，格式为 UUID
- 24 小时内相同 Key 的请求返回相同结果
- Key 重复但请求体不同返回 409 Conflict
- 用于防止网络重试导致的重复提现

**免审批条件**:
- 提现地址为已绑定的 Web3 钱包地址 (`platform_bindings` 表存在对应记录)
- 需先校验关联钱包地址，再校验阈值
- 金额 < 1,000 USDT 等值且非首次提现到该地址

**需审核条件**:
- 提现到非绑定地址
- 金额 ≥ 10,000 USDT 等值 (触发 AML 审核)
- 首次提现到新地址
- 24小时内累计提现 ≥ 50,000 USDT

---

## F-BUS-045: 查询提现审核状态

**描述**: 查询提现申请的审核进度和状态。

**gRPC 方法**: `GetWithdrawAuditStatus`

**请求 Schema**:
```json
{
  "withdraw_id": "W123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "withdraw_id": "W123456",
  "status": "auditing",
  "status_text": "审核中",
  "audit_info": {
    "submitted_at": "2025-12-10T10:00:00Z",
    "audit_started_at": "2025-12-10T10:01:00Z",
    "audit_type": "aml",                    // auto/aml/manual
    "audit_reason": "金额超过阈值",
    "expected_completion": "2025-12-10T12:00:00Z"
  },
  "timeline": [
    {
      "status": "submitted",
      "time": "2025-12-10T10:00:00Z",
      "description": "提现申请已提交"
    },
    {
      "status": "auditing",
      "time": "2025-12-10T10:01:00Z",
      "description": "进入审核流程"
    }
  ]
}
```

**审核类型说明**:
| 类型 | 描述 | 预计时长 |
|------|------|----------|
| auto | 自动审核 (风控系统) | 30 秒内 |
| aml | AML 合规审核 | 24 小时内 |
| manual | 人工审核 | 72 小时内 |

---

## F-BUS-046: 取消提现

**描述**: 取消待审核状态的提现申请。

**gRPC 方法**: `CancelWithdraw`

**请求 Schema**:
```json
{
  "withdraw_id": "W123456",
  "verification": {
    "trade_password": "123456"     // 需要验证身份
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "提现已取消",
  "refund_amount": "100",
  "refund_asset": "USDT"
}
```

**业务规则**:
- 仅 `pending_audit` 和 `auditing` 状态可取消
- `processing` 状态 (已上链) 不可取消
- 取消后金额立即返还到账户余额
- 取消操作记入日志

---

## 提现状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| pending_verification | 1 | 待验证 (等待用户完成身份验证) |
| pending_audit | 2 | 待审核 (已提交，等待审核) |
| auditing | 3 | 审核中 (正在进行风控/AML/人工审核) |
| processing | 4 | 处理中 (审核通过，正在上链) |
| completed | 5 | 已完成 (链上确认) |
| rejected | 6 | 已驳回 (审核未通过) |
| failed | 7 | 已失败 (上链失败) |
| cancelled | 8 | 已取消 (用户主动取消) |

### 状态流转图

```
                    ┌──────────────────┐
                    │ pending_verification │
                    └─────────┬────────┘
                              │ 用户完成验证
                              ▼
                    ┌──────────────────┐
      ┌─────────────│   pending_audit   │─────────────┐
      │             └─────────┬────────┘             │
      │                       │ 进入审核              │ 用户取消
      │                       ▼                       ▼
      │             ┌──────────────────┐     ┌──────────────┐
      │             │     auditing      │     │  cancelled   │
      │             └─────────┬────────┘     └──────────────┘
      │                       │
      │         ┌─────────────┼─────────────┐
      │         │ 审核通过    │ 审核驳回    │
      │         ▼             ▼             │
      │  ┌──────────────┐  ┌──────────────┐│
      │  │  processing   │  │   rejected   ││
      │  └───────┬──────┘  └──────────────┘│
      │          │                          │
      │    ┌─────┴─────┐                   │
      │    │ 上链成功  │ 上链失败          │
      │    ▼           ▼                   │
      │ ┌──────────┐ ┌──────────┐          │
      │ │ completed │ │  failed  │          │
      │ └──────────┘ └──────────┘          │
      └────────────────────────────────────┘
```

---

## 审核超时规则

### 超时配置

| 审核阶段 | 超时时间 | 超时处理 |
|----------|----------|----------|
| 生物识别验证 | 30 秒 | 验证失败，需重新发起 |
| 自动风控审核 | 30 秒 | 转人工审核 |
| AML 合规审核 | 24 小时 | 发送提醒，继续等待 |
| 人工审核 | 72 小时 | 自动升级，通知管理员 |
| 最终超时 | 7 天 | 自动驳回并退款 |

### 超时通知

- 审核超过 4 小时: 发送站内通知
- 审核超过 24 小时: 发送邮件/短信通知
- 审核超过 48 小时: 通知管理员介入

---

## AML 验证规则

### 触发条件

| 条件 | 阈值 | 审核类型 |
|------|------|----------|
| 单笔金额 | ≥ 10,000 USDT | AML 审核 |
| 24小时累计 | ≥ 50,000 USDT | AML 审核 |
| 7天累计 | ≥ 200,000 USDT | 人工审核 |
| 新地址首次提现 | 任意金额 | 风控审核 |
| 高风险地址 | 任意金额 | 人工审核 |

### 审核内容

1. **地址风险评估**: 检查目标地址是否在黑名单/风险名单
2. **交易模式分析**: 检查是否存在异常交易模式
3. **身份核验**: 大额交易可能要求补充身份材料
4. **合规检查**: 符合当地法规要求

### 审核结果

| 结果 | 处理 |
|------|------|
| 通过 | 继续提现流程 |
| 需补充材料 | 通知用户，暂停处理 |
| 驳回 | 退款，记录原因 |
| 冻结 | 锁定资金，通知合规部门 |

---

## AML 提供商集成

> 详细的 AML 配置和管理员审批功能见 [07-admin-service/04-提现审批](../07-admin-service/04-提现审批.md)

### 集成架构

```
用户提交提现
      │
      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  风控规则检查    │────▶│   AML 服务调用   │────▶│  外部 AML API   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │
                               ▼
                        ┌─────────────────┐
                        │   风险评估结果   │
                        │  - 低风险: 通过  │
                        │  - 中风险: 人工  │
                        │  - 高风险: 拒绝  │
                        └─────────────────┘
```

### AML 配置

```yaml
AML:
  Provider: "chainalysis"          # 或 elliptic, coinfirm
  BaseURL: "https://api.chainalysis.com/v2"
  APIKey: "${AML_API_KEY}"
  Timeout: 30s
  RetryCount: 3
  RiskThreshold:
    Auto_Approve: 30               # 风险分 < 30 自动通过
    Manual_Review: 70              # 风险分 30-70 需人工审核
    Auto_Reject: 100               # 风险分 > 70 自动拒绝
```

---

> 返回 [业务服务目录](./README.md)
