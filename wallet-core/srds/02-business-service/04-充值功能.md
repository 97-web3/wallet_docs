# 充值功能

> 返回 [业务服务目录](./README.md)

---

## F-BUS-012: 获取充值信息

**描述**: 获取支持的充值资产和网络信息。

**gRPC 方法**: `GetDepositInfo`

**请求 Schema**:
```json
{
  "asset": "USDT",    // 可选：指定资产
  "query": ""         // 可选：搜索关键词
}
```

**响应 Schema**:
```json
{
  "success": true,
  "assets": [
    {
      "asset": "USDT",
      "asset_name": "Tether USD",
      "icon_url": "https://...",
      "total_balance": "5000.00",
      "available_balance": "4500.00",
      "frozen_balance": "500.00",
      "valuation_usdt": "5000.00"
    }
  ],
  "networks": [
    {
      "chain": "TRN",
      "chain_name": "Tron (TRC20)",
      "fee": "0",                           // 充值无手续费
      "eta": "1-5分钟",
      "min_amount": "10",                   // 最小充值 10 USDT 等值
      "min_amount_usdt": "10",
      "per_order_limit": "100000",
      "confirmations_required": 20          // 需要的确认数
    },
    {
      "chain": "BSC",
      "chain_name": "BNB Smart Chain (BEP20)",
      "fee": "0",
      "eta": "3-10分钟",
      "min_amount": "10",
      "min_amount_usdt": "10",
      "per_order_limit": "100000",
      "confirmations_required": 15
    }
  ]
}
```

**业务规则**:
- 最小充值金额: 10 USDT 等值
- 非 USDT 代币按实时汇率换算等值金额
- 小于最小金额的充值不会入账 (需联系客服处理)

---

## F-BUS-013: 创建充值地址

**描述**: 为用户生成指定资产和网络的充值地址。地址为用户分配的 HD 钱包子地址。

**gRPC 方法**: `CreateDeposit`

**请求 Schema**:
```json
{
  "asset": "USDT",
  "chain": "TRN"       // 网络：TRN/ETH/BSC
}
```

**响应 Schema**:
```json
{
  "success": true,
  "address": "TKvjY...",
  "memo_tag": "",                           // 如需 Memo/Tag
  "qrcode_url": "https://...",              // 二维码地址
  "qrcode_data": "TKvjY...",                // 二维码内容
  "asset": "USDT",
  "chain": "TRC20",
  "chain_name": "Tron (TRC20)",
  "min_deposit": "10",
  "min_deposit_text": "最小充值 10 USDT",
  "confirmations_required": 20,
  "eta": "1-5分钟",
  "tips": [
    "请确认网络正确，否则可能导致资产丢失",
    "最小充值金额为 10 USDT 等值",
    "预计 1-5 分钟到账 (需要 20 次确认)"
  ],
  "address_type": "hd_derived"              // hd_derived=HD派生子地址
}
```

**业务规则**:
- 每个用户每条链分配唯一的充值地址
- 地址为 HD 钱包派生的子地址，归属于平台热钱包
- 首次请求时生成，后续返回已生成的地址
- 充值地址长期有效，不会过期

---

## F-BUS-065: 获取充值记录

**描述**: 获取用户的充值历史记录。

**gRPC 方法**: `ListDepositRecords`

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "asset": "",              // 可选：过滤资产
  "chain": "",              // 可选：过滤链
  "status": "",             // 可选：过滤状态
  "start_time": 0,          // 可选：开始时间戳
  "end_time": 0             // 可选：结束时间戳
}
```

**响应 Schema**:
```json
{
  "success": true,
  "total": 50,
  "items": [
    {
      "id": "D1733836800000ABC",
      "asset": "USDT",
      "chain": "TRN",
      "chain_name": "Tron (TRC20)",
      "amount": "100.0000000",
      "amount_display": "100.00",
      "from_address": "T9yD14...",
      "to_address": "TKvjY...",
      "tx_hash": "abc123...",
      "explorer_url": "https://tronscan.org/#/transaction/abc123...",
      "status": "confirmed",
      "status_text": "已完成",
      "confirmations": 21,
      "required_confirmations": 20,
      "created_at": "2025-12-10T10:00:00Z",
      "confirmed_at": "2025-12-10T10:05:00Z"
    }
  ]
}
```

---

## 充值状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| pending | 1 | 待确认 (链上已检测到交易，等待确认) |
| confirming | 2 | 确认中 (已有部分确认，未达到要求) |
| confirmed | 3 | 已完成 (达到确认数要求，已入账) |
| failed | 4 | 失败 (交易被回滚或其他异常) |

### 状态流转图

```
┌─────────────────────────────┐
│        链上检测到交易        │
└─────────────┬───────────────┘
              │
              ▼
      ┌──────────────┐
      │   pending    │ (确认数: 0)
      └───────┬──────┘
              │ 有新确认
              ▼
      ┌──────────────┐
      │  confirming  │ (确认数: 1~19)
      └───────┬──────┘
              │
      ┌───────┴───────┐
      │ 达到确认数    │ 交易回滚
      ▼               ▼
┌──────────────┐  ┌──────────────┐
│  confirmed   │  │   failed     │
│  (确认数≥20) │  └──────────────┘
└──────────────┘
```

### 各链确认数要求

| 链 | 确认数 | 预计时间 |
|----|--------|----------|
| TRX | 20 | 1-5 分钟 |
| BSC | 15 | 3-10 分钟 |
| ETH | 12 | 5-15 分钟 |

---

## 最小充值规则

### 最小金额

| 资产 | 最小充值 | 等值换算 |
|------|----------|----------|
| USDT | 10 USDT | - |
| TRX | 100 TRX | ≈ 10 USDT |
| ETH | 0.005 ETH | ≈ 10 USDT |
| BNB | 0.03 BNB | ≈ 10 USDT |

### 小额充值处理

- 小于最小金额的充值会被检测到，但不会自动入账
- 用户需联系客服处理
- 客服可手动入账 (扣除处理费)
- 累计小额充值达到最小金额后可合并入账

---

## 等值换算规则

### 非 USDT 代币换算

当用户充值非 USDT 代币时，系统按以下规则验证最小金额:

1. 获取代币实时价格 (Debank API)
2. 计算充值金额的 USDT 等值
3. 判断是否满足最小充值要求 (10 USDT)

**示例**:
- 充值 50 TRX，当前价格 $0.10
- 等值 = 50 × 0.10 = $5 USDT
- 不满足最小充值要求 (< 10 USDT)

### 价格波动处理

- 使用交易检测时刻的价格计算等值
- 价格数据缓存 30 秒
- 边界情况 (等值接近 10 USDT) 给予 5% 的容差
