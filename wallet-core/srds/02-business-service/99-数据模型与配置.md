# 数据模型与配置

> 返回 [业务服务目录](./README.md)

---

## 1. 数据模型

### 1.1 用户表 (users)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 雪花 ID 主键 |
| uuid | VARCHAR(64) | 用户 UUID |
| email | VARCHAR(100) | 邮箱 |
| phone | VARCHAR(20) | 手机号 |
| password_hash | VARCHAR(255) | 密码哈希 |
| salt | VARCHAR(64) | 密码盐 |
| kyc_level | TINYINT | KYC 等级 (0-3) |
| member_level | TINYINT | 会员等级 (1-5) |
| google_auth_secret | VARCHAR(100) | GA 密钥 |
| is_2fa_enabled | TINYINT | 是否启用 2FA |
| trade_password_hash | VARCHAR(255) | 资金密码哈希 |
| anti_phishing_code | VARCHAR(20) | 防钓鱼码 |
| status | TINYINT | 状态: 1=正常, 2=冻结, 3=注销 |
| register_ip | VARCHAR(50) | 注册 IP |
| last_login_time | DATETIME | 最后登录时间 |
| failed_login_count | INT | 登录失败次数 |
| lock_until | DATETIME | 锁定截止时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 1.2 用户会话表 (user_sessions)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| session_token | VARCHAR(255) | 会话 Token |
| refresh_token | VARCHAR(255) | 刷新 Token |
| platform | TINYINT | 平台: 1=Web, 2=iOS, 3=Android, 4=API |
| device_id | VARCHAR(100) | 设备 ID |
| device_type | VARCHAR(50) | 设备类型 |
| ip_address | VARCHAR(50) | IP 地址 |
| ip_location | VARCHAR(100) | IP 地理位置 |
| is_active | TINYINT | 是否活跃 |
| is_remember_me | TINYINT | 是否记住登录 |
| expires_at | DATETIME | 过期时间 |
| created_at | DATETIME | 创建时间 |

### 1.3 验证码表 (verification_codes)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| target | VARCHAR(100) | 目标 (邮箱/手机号) |
| target_type | TINYINT | 类型: 1=邮箱, 2=手机 |
| code_type | TINYINT | 用途类型 |
| code | VARCHAR(10) | 验证码 |
| is_used | TINYINT | 是否已使用 |
| expire_at | DATETIME | 过期时间 |
| created_at | DATETIME | 创建时间 |

### 1.4 登录日志表 (login_logs)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| device_id | VARCHAR(100) | 设备 ID |
| device_type | VARCHAR(50) | 设备类型 |
| os_version | VARCHAR(50) | 系统版本 |
| app_version | VARCHAR(20) | 应用版本 |
| ip_address | VARCHAR(50) | IP 地址 |
| ip_location | VARCHAR(100) | IP 地理位置 |
| user_agent | TEXT | User-Agent |
| is_abnormal | TINYINT | 是否异常 |
| risk_level | TINYINT | 风险等级 (0-3) |
| created_at | DATETIME | 登录时间 |

### 1.5 用户角色表 (user_roles)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| role_type | TINYINT | 角色类型: 1=C端用户, 2=财务, 3=管理员 |
| permissions | JSON | 权限列表 |
| assigned_by | BIGINT | 分配人 ID |
| assigned_at | DATETIME | 分配时间 |
| expires_at | DATETIME | 过期时间 (NULL 表示永久) |
| status | TINYINT | 状态: 1=有效, 2=已禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `idx_user_id` (user_id)
- `idx_role_type` (role_type)
- `uk_user_role` (user_id, role_type) UNIQUE

### 1.6 黑名单表 (blacklists)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| identifier | VARCHAR(100) | 标识符 (手机号/邮箱/UID/地址) |
| identifier_type | TINYINT | 类型: 1=手机号, 2=邮箱, 3=UID, 4=钱包地址 |
| user_id | BIGINT | 关联用户 ID (可为空) |
| reason_type | TINYINT | 原因类型: 1=违规操作, 2=风控触发, 3=人工处理, 4=AML冻结 |
| reason_detail | TEXT | 详细原因 |
| evidence | JSON | 证据材料 |
| blocked_features | JSON | 被限制的功能列表 |
| can_appeal | TINYINT | 是否可申诉: 0=否, 1=是 |
| appeal_count | INT | 申诉次数 |
| operator_id | BIGINT | 操作人 ID |
| expires_at | DATETIME | 过期时间 (NULL 表示永久) |
| status | TINYINT | 状态: 1=生效中, 2=已解除, 3=申诉中 |
| created_at | DATETIME | 加入时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `idx_identifier` (identifier)
- `idx_identifier_type` (identifier_type)
- `idx_user_id` (user_id)
- `idx_status` (status)

### 1.7 平台绑定表 (platform_bindings)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| binding_id | VARCHAR(32) | 绑定 ID (格式: BIND-YYYYMMDD-XXX) |
| user_id | BIGINT | 用户 ID (平台 UID) |
| platform_uid | VARCHAR(32) | 平台用户唯一标识 (U+日期+4位随机) |
| wallet_address | VARCHAR(100) | Web3 钱包地址 |
| chain | VARCHAR(10) | 链类型 (ETH/BSC/TRX) |
| signature | TEXT | 钱包签名 (证明地址所有权) |
| sign_message | TEXT | 签名原文 |
| verification_method | TINYINT | 验证方式: 1=生物识别, 2=GA, 3=资金密码, 4=验证码 |
| status | TINYINT | 状态: 1=已绑定, 2=已解绑 |
| bound_at | DATETIME | 绑定时间 |
| unbound_at | DATETIME | 解绑时间 |
| unbound_reason | VARCHAR(255) | 解绑原因 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_binding_id` (binding_id) UNIQUE
- `uk_user_wallet` (user_id, wallet_address, chain) UNIQUE
- `uk_platform_uid` (platform_uid) UNIQUE
- `idx_wallet_address` (wallet_address)
- `idx_status` (status)

**约束规则**:
- 1:1 绑定: 一个 `platform_uid` 只能绑定一个 `wallet_address`
- 唯一性: 一个 `wallet_address` 只能被一个 `platform_uid` 绑定
- 解绑冷却: 解绑后 24 小时内不能重新绑定同一地址

### 1.8 提现审核表 (withdrawal_audits)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| withdraw_id | VARCHAR(32) | 提现单号 |
| user_id | BIGINT | 用户 ID |
| asset | VARCHAR(20) | 资产类型 |
| chain | VARCHAR(10) | 链类型 |
| amount | DECIMAL(36,18) | 提现金额 |
| amount_usdt | DECIMAL(36,18) | USDT 等值金额 |
| to_address | VARCHAR(100) | 目标地址 |
| audit_type | TINYINT | 审核类型: 1=自动风控, 2=AML合规, 3=人工审核 |
| audit_status | TINYINT | 审核状态: 1=待审核, 2=审核中, 3=已通过, 4=已驳回, 5=已超时 |
| trigger_reason | VARCHAR(255) | 触发审核原因 |
| risk_score | INT | 风险评分 (0-100) |
| risk_factors | JSON | 风险因素详情 |
| auditor_id | BIGINT | 审核人 ID (人工审核时) |
| audit_comment | TEXT | 审核意见 |
| audit_started_at | DATETIME | 开始审核时间 |
| audit_completed_at | DATETIME | 审核完成时间 |
| timeout_at | DATETIME | 超时时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_withdraw_id` (withdraw_id) UNIQUE
- `idx_user_id` (user_id)
- `idx_audit_status` (audit_status)
- `idx_audit_type` (audit_type)
- `idx_timeout` (timeout_at, audit_status)

**审核阈值配置**:
| 条件 | 阈值 | 审核类型 |
|------|------|----------|
| 单笔金额 | ≥ 10,000 USDT | AML 审核 |
| 24小时累计 | ≥ 50,000 USDT | AML 审核 |
| 7天累计 | ≥ 200,000 USDT | 人工审核 |
| 新地址首次提现 | 任意金额 | 风控审核 |
| 高风险地址 | 任意金额 | 人工审核 |

### 1.9 信任设备表 (trusted_devices)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| device_id | VARCHAR(100) | 设备唯一标识 |
| device_name | VARCHAR(100) | 设备名称 |
| device_model | VARCHAR(50) | 设备型号 |
| platform | VARCHAR(20) | 平台: iOS/Android |
| os_version | VARCHAR(20) | 系统版本 |
| biometric_enabled | TINYINT | 是否开启生物识别: 0=否, 1=是 |
| biometric_type | TINYINT | 生物识别类型: 1=FaceID, 2=TouchID, 3=Fingerprint |
| biometric_public_key | TEXT | 生物识别公钥 |
| last_used_at | DATETIME | 最后使用时间 |
| last_ip | VARCHAR(50) | 最后使用 IP |
| status | TINYINT | 状态: 1=信任, 2=已移除 |
| trusted_at | DATETIME | 添加信任时间 |
| removed_at | DATETIME | 移除时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_user_device` (user_id, device_id) UNIQUE
- `idx_user_id` (user_id)
- `idx_status` (status)

### 1.10 内部转账审核表 (transfer_audits)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| transfer_id | VARCHAR(32) | 转账单号 |
| from_user_id | BIGINT | 转出用户 ID |
| to_user_id | BIGINT | 转入用户 ID |
| asset | VARCHAR(20) | 资产类型 |
| amount | DECIMAL(36,18) | 转账金额 |
| amount_usdt | DECIMAL(36,18) | USDT 等值金额 |
| memo | TEXT | 备注 (最高 1000 字符) |
| audit_type | TINYINT | 审核类型: 1=自动风控, 2=AML合规, 3=人工审核 |
| audit_status | TINYINT | 审核状态: 1=待审核, 2=审核中, 3=已通过, 4=已驳回 |
| trigger_reason | VARCHAR(255) | 触发审核原因 |
| risk_score | INT | 风险评分 (0-100) |
| auditor_id | BIGINT | 审核人 ID |
| audit_comment | TEXT | 审核意见 |
| audit_completed_at | DATETIME | 审核完成时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_transfer_id` (transfer_id) UNIQUE
- `idx_from_user` (from_user_id)
- `idx_to_user` (to_user_id)
- `idx_audit_status` (audit_status)

**审核阈值**:
| 条件 | 阈值 | 处理 |
|------|------|------|
| 单笔金额 | < 1,000 USDT | 免审批 (快速通道) |
| 单笔金额 | ≥ 10,000 USDT | AML 审核 |
| 24小时累计 | ≥ 50,000 USDT | 人工审核 |

### 1.11 薪资发放记录表 (payroll_records)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| payroll_id | VARCHAR(32) | 发放批次 ID (格式: PAY-YYYYMMDD-XXX) |
| batch_id | VARCHAR(32) | 批次编号 (多人同批次发放时相同) |
| sender_uid | VARCHAR(32) | 发起人 UID (财务角色) |
| sender_user_id | BIGINT | 发起人用户 ID |
| receiver_uid | VARCHAR(32) | 收款人 UID |
| receiver_user_id | BIGINT | 收款人用户 ID |
| asset | VARCHAR(20) | 资产类型 |
| chain | VARCHAR(10) | 链类型 |
| amount | DECIMAL(36,18) | 发放金额 |
| amount_usdt | DECIMAL(36,18) | USDT 等值金额 |
| memo | VARCHAR(500) | 备注 (用途说明) |
| payroll_type | TINYINT | 发放类型: 1=工资, 2=奖金, 3=报销, 4=其他 |
| status | TINYINT | 状态: 1=待处理, 2=处理中, 3=已发放, 4=已失败, 5=已取消 |
| tx_id | VARCHAR(64) | 关联交易 ID |
| error_message | TEXT | 失败原因 |
| processed_at | DATETIME | 处理时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_payroll_id` (payroll_id) UNIQUE
- `idx_batch_id` (batch_id)
- `idx_sender_uid` (sender_uid)
- `idx_receiver_uid` (receiver_uid)
- `idx_status` (status)
- `idx_created_at` (created_at)

**薪资发放类型 (PayrollType)**:
| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | SALARY | 工资 |
| 2 | BONUS | 奖金 |
| 3 | REIMBURSEMENT | 报销 |
| 4 | OTHER | 其他 |

**薪资发放状态 (PayrollStatus)**:
| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PENDING | 待处理 |
| 2 | PROCESSING | 处理中 |
| 3 | COMPLETED | 已发放 |
| 4 | FAILED | 已失败 |
| 5 | CANCELLED | 已取消 |

### 1.12 闪兑交易表 (swap_transactions)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| swap_id | VARCHAR(32) | 闪兑交易 ID (格式: SWAP-时间戳-随机) |
| user_id | BIGINT | 用户 ID |
| from_asset | VARCHAR(20) | 源资产 |
| from_chain | VARCHAR(10) | 源链 |
| from_amount | DECIMAL(36,18) | 源金额 |
| to_asset | VARCHAR(20) | 目标资产 |
| to_chain | VARCHAR(10) | 目标链 |
| to_amount | DECIMAL(36,18) | 目标金额 (预估) |
| to_amount_actual | DECIMAL(36,18) | 实际到账金额 |
| exchange_rate | DECIMAL(36,18) | 兑换汇率 |
| slippage_tolerance | DECIMAL(5,4) | 滑点容忍度 (如 0.0050 = 0.5%) |
| slippage_actual | DECIMAL(5,4) | 实际滑点 |
| fee_amount | DECIMAL(36,18) | 手续费金额 |
| fee_asset | VARCHAR(20) | 手续费币种 |
| fee_rate | DECIMAL(8,6) | 手续费率 (如 0.003000 = 0.3%) |
| dex_provider | VARCHAR(50) | DEX 提供商 (如 1inch, paraswap) |
| dex_route | JSON | DEX 路由详情 |
| quote_id | VARCHAR(64) | 报价 ID |
| quote_expires_at | DATETIME | 报价过期时间 |
| tx_hash | VARCHAR(100) | 链上交易哈希 |
| tx_status | TINYINT | 链上状态: 1=待确认, 2=已确认, 3=失败 |
| confirmations | INT | 确认数 |
| status | TINYINT | 业务状态 |
| error_code | VARCHAR(20) | 错误码 |
| error_message | TEXT | 错误信息 |
| price_impact | DECIMAL(8,6) | 价格影响 (如 0.010000 = 1%) |
| min_receive_amount | DECIMAL(36,18) | 最低接收金额 |
| created_at | DATETIME | 创建时间 |
| quoted_at | DATETIME | 询价时间 |
| confirmed_at | DATETIME | 确认时间 |
| completed_at | DATETIME | 完成时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `uk_swap_id` (swap_id) UNIQUE
- `idx_user_id` (user_id)
- `idx_status` (status)
- `idx_from_asset` (from_asset)
- `idx_to_asset` (to_asset)
- `idx_tx_hash` (tx_hash)
- `idx_created_at` (created_at)

**闪兑状态 (SwapStatus)**:
| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | QUOTING | 询价中 (获取 DEX 报价) |
| 2 | QUOTED | 已报价 (等待用户确认) |
| 3 | CONFIRMING | 确认中 (用户已确认，等待身份验证) |
| 4 | PENDING | 待处理 (验证通过，准备上链) |
| 5 | PROCESSING | 处理中 (链上交易已广播) |
| 6 | COMPLETED | 已完成 (链上确认成功) |
| 7 | FAILED | 已失败 (交易失败或超时) |
| 8 | CANCELLED | 已取消 (用户取消或报价过期) |
| 9 | PARTIAL_FILLED | 部分成交 (大单分批执行时) |

**链上交易状态 (SwapTxStatus)**:
| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PENDING | 待确认 |
| 2 | CONFIRMED | 已确认 |
| 3 | FAILED | 失败 |

**闪兑配置**:
| 参数 | 默认值 | 描述 |
|------|--------|------|
| 默认滑点 | 0.5% | 用户未设置时的默认滑点 |
| 最大滑点 | 5% | 允许设置的最大滑点 |
| 报价有效期 | 30 秒 | 询价后的有效时间 |
| 最小兑换金额 | 10 USDT | 等值最小兑换金额 |
| 手续费率 | 0.3% | 平台手续费率 |

---

## 2. 枚举定义

### 2.1 用户状态 (UserStatus)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | NORMAL | 正常 |
| 2 | FROZEN | 冻结 |
| 3 | DISABLED | 注销 |

### 2.2 KYC 等级 (KYCLevel)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | L0 | 基础认证 (邮箱/手机) |
| 2 | L1 | 初级认证 (实名) |
| 3 | L2 | 高级认证 (人脸) |
| 4 | L3 | 机构认证 |

### 2.3 登录方式 (LoginMethod)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PHONE_CODE | 手机验证码 |
| 2 | OAUTH_GOOGLE | Google OAuth |
| 3 | EMAIL_CODE | 邮箱验证码 |
| 4 | BIOMETRIC | 生物识别 (FaceID/TouchID) |

### 2.4 平台类型 (PlatformType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | WEB | 网页端 |
| 2 | IOS | iOS 端 |
| 3 | ANDROID | Android 端 |
| 4 | API | API 调用 |

### 2.5 验证码类型 (VerificationCodeType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | CODE_TYPE_REGISTER | 注册 |
| 2 | CODE_TYPE_LOGIN | 登录 |
| 3 | CODE_TYPE_RESET_PASSWORD | 重置密码 |
| 4 | CODE_TYPE_BIND_EMAIL | 绑定邮箱 |
| 5 | CODE_TYPE_BIND_PHONE | 绑定手机 |
| 6 | CODE_TYPE_WITHDRAW | 提现 |
| 7 | CODE_TYPE_2FA | 二次验证 |
| 8 | CODE_TYPE_TRANSFER | 内部转账 |
| 9 | CODE_TYPE_BIND_PLATFORM | 绑定平台账户 |

### 2.6 用户角色类型 (RoleType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | USER | C端用户 |
| 2 | FINANCE | 财务 |
| 3 | ADMIN | 管理员 |

### 2.7 黑名单状态 (BlacklistStatus)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | ACTIVE | 生效中 |
| 2 | RELEASED | 已解除 |
| 3 | APPEALING | 申诉中 |

### 2.8 黑名单原因类型 (BlacklistReasonType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | VIOLATION | 违规操作 |
| 2 | RISK_CONTROL | 风控触发 |
| 3 | MANUAL | 人工处理 |
| 4 | AML_FROZEN | AML 冻结 |

### 2.9 提现状态 (WithdrawStatus)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PENDING_VERIFICATION | 待验证 (等待用户完成身份验证) |
| 2 | PENDING_AUDIT | 待审核 (已提交，等待审核) |
| 3 | AUDITING | 审核中 (正在进行风控/AML/人工审核) |
| 4 | PROCESSING | 处理中 (审核通过，正在上链) |
| 5 | COMPLETED | 已完成 (链上确认) |
| 6 | REJECTED | 已驳回 (审核未通过) |
| 7 | FAILED | 已失败 (上链失败) |
| 8 | CANCELLED | 已取消 (用户主动取消) |

### 2.10 审核类型 (AuditType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | AUTO | 自动风控 (30秒内) |
| 2 | AML | AML 合规审核 (24小时内) |
| 3 | MANUAL | 人工审核 (72小时内) |

### 2.11 审核状态 (AuditStatus)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PENDING | 待审核 |
| 2 | IN_PROGRESS | 审核中 |
| 3 | APPROVED | 已通过 |
| 4 | REJECTED | 已驳回 |
| 5 | TIMEOUT | 已超时 |

### 2.12 生物识别类型 (BiometricType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | NONE | 未开启 |
| 1 | FACE_ID | Face ID (iOS) |
| 2 | TOUCH_ID | Touch ID (iOS) |
| 3 | FINGERPRINT | 指纹识别 (Android) |

### 2.13 验证方式 (VerificationMethod)

| 值 | 名称 | 描述 | 优先级 |
|----|------|------|--------|
| 0 | UNSPECIFIED | 未指定 | - |
| 1 | BIOMETRIC | 生物识别 (FaceID/TouchID) | 1 (最高) |
| 2 | GOOGLE_AUTH | Google Authenticator | 2 |
| 3 | TRADE_PASSWORD | 资金密码 | 3 |
| 4 | SMS_CODE | 短信验证码 | 4 |
| 5 | EMAIL_CODE | 邮箱验证码 | 5 (最低) |

### 2.14 通知类型 (NotificationType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | DEPOSIT | 充值通知 |
| 2 | WITHDRAW | 提现通知 |
| 3 | TRANSFER | 转账通知 |
| 4 | AUDIT | 审核通知 |
| 5 | SECURITY | 安全通知 |
| 6 | SYSTEM | 系统通知 |

### 2.15 通知渠道 (NotificationChannel)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | APP_PUSH | APP 推送 (FCM) |
| 2 | IN_APP | 站内信 |
| 3 | SMS | 短信 |
| 4 | EMAIL | 邮件 |

### 2.16 交易类型 (TransactionType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | DEPOSIT | 充值 |
| 2 | WITHDRAW | 提现 |
| 3 | TRANSFER_IN | 转入 |
| 4 | TRANSFER_OUT | 转出 |

### 2.17 标识符类型 (IdentifierType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PHONE | 手机号 |
| 2 | EMAIL | 邮箱 |
| 3 | UID | 用户 UID |
| 4 | WALLET_ADDRESS | 钱包地址 |

---

## 3. ID 生成规则

### 3.1 用户 UID 生成规则

**格式**: `U` + `YYYYMMDD` + `4位随机字母数字`

**示例**: `U20251210ABCD`, `U20251210X7K2`

**规则**:
- 前缀: 固定 `U`
- 日期部分: 注册日期，格式 `YYYYMMDD`
- 随机部分: 4 位大写字母 + 数字混合
- 总长度: 13 字符
- 唯一性: 数据库 UNIQUE 约束

### 3.2 交易 ID 生成规则

**格式**: `前缀` + `时间戳(毫秒)` + `3位随机`

| 交易类型 | 前缀 | 示例 |
|----------|------|------|
| 充值 | D | D1733836800000ABC |
| 提现 | W | W1733836800000XYZ |
| 转账 | T | T1733836800000123 |

**规则**:
- 前缀: 1 字符，标识交易类型
- 时间戳: 13 位毫秒级 Unix 时间戳
- 随机部分: 3 位大写字母或数字
- 总长度: 17 字符
- 唯一性: 数据库 UNIQUE 约束

### 3.3 绑定 ID 生成规则

**格式**: `BIND-` + `YYYYMMDD` + `-` + `3位序号`

**示例**: `BIND-20251210-001`, `BIND-20251210-002`

**规则**:
- 前缀: 固定 `BIND-`
- 日期部分: 绑定日期
- 序号: 当日递增序号
- 总长度: 18 字符

---

## 4. 精度与格式规则

### 4.1 金额精度规则

| 类型 | 精度 | 描述 |
|------|------|------|
| 代币数量 | 7 位小数 | 如 `100.1234567 USDT` |
| 法币价值 | 2 位小数 | 如 `$100.12` |
| 汇率 | 8 位小数 | 如 `1.00000001` |
| 手续费 | 原币精度 | 与原币保持一致 |

### 4.2 数据库金额存储

| 字段类型 | 精度 | 用途 |
|----------|------|------|
| DECIMAL(36,18) | 18 位小数 | 代币金额 (支持 18 位精度的 ERC20) |
| DECIMAL(20,8) | 8 位小数 | 法币汇率、价值 |

### 4.3 显示格式规则

| 场景 | 格式 | 示例 |
|------|------|------|
| 资产列表 | 最多 4 位有效小数 | `100.1234 USDT` |
| 交易详情 | 完整精度 | `100.1234567 USDT` |
| 法币等值 | 2 位小数 + 货币符号 | `≈ $100.12` |
| 百分比 | 2 位小数 + % | `2.50%` |

### 4.4 时间格式规则

**标准格式**: 所有 API 响应中的时间字段统一使用 **ISO 8601** 格式

| 场景 | 格式 | 示例 |
|------|------|------|
| API 响应时间 | ISO 8601 UTC | `2025-12-10T10:00:00Z` |
| 数据库存储 | DATETIME | `2025-12-10 10:00:00` |
| 请求参数 (可选) | Unix 时间戳 (秒) | `1733836800` |

**字段命名规范**:
| 场景 | 字段名 | 示例 |
|------|--------|------|
| 创建时间 | `created_at` | `"created_at": "2025-12-10T10:00:00Z"` |
| 更新时间 | `updated_at` | `"updated_at": "2025-12-10T10:05:00Z"` |
| 确认时间 | `confirmed_at` | `"confirmed_at": "2025-12-10T10:05:00Z"` |
| 过期时间 | `expires_at` | `"expires_at": "2025-12-11T10:00:00Z"` |
| 最后更新 | `last_updated` | `"last_updated": "2025-12-10T10:00:00Z"` |

**注意**:
- 所有时间均为 UTC 时区
- 客户端应根据用户本地时区进行转换显示
- 请求参数中的时间范围筛选支持 Unix 时间戳格式

---

## 5. 配置

### 5.1 服务配置文件

**文件**: `services/business/rpc/etc/business.yaml`

```yaml
Name: business.rpc
ListenOn: 0.0.0.0:8080
NodeID: 1                      # Snowflake 节点 ID

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: business.rpc

DataSource: crypto:crypto123456@tcp(localhost:3306)/crypto_wallet?charset=utf8mb4&parseTime=True&loc=Local

CacheRedis:
  - Host: localhost:6379
    Pass: redis123456

Prometheus:
  Host: 0.0.0.0
  Port: 9091

Log:
  Mode: file
  Path: ./logs
  Level: info
  KeepDays: 7
```

---

## 4. 依赖

### 4.1 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/zeromicro/go-zero | 1.6.0 | 微服务框架 |
| gorm.io/gorm | 1.25.10 | ORM |
| gorm.io/driver/mysql | 1.5.7 | MySQL 驱动 |
| github.com/redis/go-redis/v9 | 9.17.0 | Redis 客户端 |
| github.com/golang-jwt/jwt/v4 | 4.5.1 | JWT 处理 |
| golang.org/x/crypto | 0.41.0 | 密码哈希 |

### 4.2 内部依赖

| 服务 | 用途 |
|------|------|
| ChainRPC Service | 区块链地址生成 |
| Signer Service | HD 钱包地址派生 |

---

## 5. 安全考量

### 5.1 已知问题摘要

| 问题 ID | 级别 | 描述 |
|---------|------|------|
| HIGH-01 | 高危 | 弱用户密码哈希 |
| MEDIUM-04 | 中危 | 不完整的身份验证流程 |

### 5.2 安全建议

1. **密码哈希**: 建议使用 bcrypt 或 Argon2 替代当前哈希算法
2. **2FA 强制**: 对高风险操作强制要求 2FA 验证
3. **验证码安全**: 增加验证码复杂度，防止暴力破解
4. **会话管理**: 实现会话续期和强制登出功能
