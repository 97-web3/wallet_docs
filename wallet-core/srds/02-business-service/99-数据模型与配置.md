# 数据模型与配置

> 返回 [业务服务目录](./README.md)

---

## 1. 数据模型

### 1.1 用户表 (users)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 雪花 ID 主键 |
| uuid | VARCHAR(64) | 用户 UUID |
| email | VARCHAR(100) | 邮箱 |
| phone | VARCHAR(20) | 手机号 |
| password_hash | VARCHAR(255) | 密码哈希 |
| salt | VARCHAR(64) | 密码盐 |
| kyc_level | TINYINT | KYC 等级 (0-3) |
| member_level | TINYINT | 会员等级 (1-5) |
| google_auth_secret | VARCHAR(100) | GA 密钥 |
| is_2fa_enabled | TINYINT | 是否启用 2FA |
| trade_password_hash | VARCHAR(255) | 资金密码哈希 |
| anti_phishing_code | VARCHAR(20) | 防钓鱼码 |
| status | TINYINT | 状态: 1=正常, 2=冻结, 3=注销 |
| register_ip | VARCHAR(50) | 注册 IP |
| last_login_time | DATETIME | 最后登录时间 |
| failed_login_count | INT | 登录失败次数 |
| lock_until | DATETIME | 锁定截止时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 1.2 用户会话表 (user_sessions)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| session_token | VARCHAR(255) | 会话 Token |
| refresh_token | VARCHAR(255) | 刷新 Token |
| platform | TINYINT | 平台: 1=Web, 2=iOS, 3=Android, 4=API |
| device_id | VARCHAR(100) | 设备 ID |
| device_type | VARCHAR(50) | 设备类型 |
| ip_address | VARCHAR(50) | IP 地址 |
| ip_location | VARCHAR(100) | IP 地理位置 |
| is_active | TINYINT | 是否活跃 |
| is_remember_me | TINYINT | 是否记住登录 |
| expires_at | DATETIME | 过期时间 |
| created_at | DATETIME | 创建时间 |

### 1.3 验证码表 (verification_codes)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| target | VARCHAR(100) | 目标 (邮箱/手机号) |
| target_type | TINYINT | 类型: 1=邮箱, 2=手机 |
| code_type | TINYINT | 用途类型 |
| code | VARCHAR(10) | 验证码 |
| is_used | TINYINT | 是否已使用 |
| expire_at | DATETIME | 过期时间 |
| created_at | DATETIME | 创建时间 |

### 1.4 登录日志表 (login_logs)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| device_id | VARCHAR(100) | 设备 ID |
| device_type | VARCHAR(50) | 设备类型 |
| os_version | VARCHAR(50) | 系统版本 |
| app_version | VARCHAR(20) | 应用版本 |
| ip_address | VARCHAR(50) | IP 地址 |
| ip_location | VARCHAR(100) | IP 地理位置 |
| user_agent | TEXT | User-Agent |
| is_abnormal | TINYINT | 是否异常 |
| risk_level | TINYINT | 风险等级 (0-3) |
| created_at | DATETIME | 登录时间 |

---

## 2. 枚举定义

### 2.1 用户状态 (UserStatus)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | NORMAL | 正常 |
| 2 | FROZEN | 冻结 |
| 3 | DISABLED | 注销 |

### 2.2 KYC 等级 (KYCLevel)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | L0 | 基础认证 (邮箱/手机) |
| 2 | L1 | 初级认证 (实名) |
| 3 | L2 | 高级认证 (人脸) |
| 4 | L3 | 机构认证 |

### 2.3 登录方式 (LoginMethod)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | PHONE_CODE | 手机验证码 |
| 2 | OAUTH_GOOGLE | Google OAuth |

### 2.4 平台类型 (PlatformType)

| 值 | 名称 | 描述 |
|----|------|------|
| 0 | UNSPECIFIED | 未指定 |
| 1 | WEB | 网页端 |
| 2 | IOS | iOS 端 |
| 3 | ANDROID | Android 端 |
| 4 | API | API 调用 |

---

## 3. 配置

### 3.1 服务配置文件

**文件**: `services/business/rpc/etc/business.yaml`

```yaml
Name: business.rpc
ListenOn: 0.0.0.0:8080
NodeID: 1                      # Snowflake 节点 ID

Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: business.rpc

DataSource: crypto:crypto123456@tcp(localhost:3306)/crypto_wallet?charset=utf8mb4&parseTime=True&loc=Local

CacheRedis:
  - Host: localhost:6379
    Pass: redis123456

Prometheus:
  Host: 0.0.0.0
  Port: 9091

Log:
  Mode: file
  Path: ./logs
  Level: info
  KeepDays: 7
```

---

## 4. 依赖

### 4.1 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/zeromicro/go-zero | 1.6.0 | 微服务框架 |
| gorm.io/gorm | 1.25.10 | ORM |
| gorm.io/driver/mysql | 1.5.7 | MySQL 驱动 |
| github.com/redis/go-redis/v9 | 9.17.0 | Redis 客户端 |
| github.com/golang-jwt/jwt/v4 | 4.5.1 | JWT 处理 |
| golang.org/x/crypto | 0.41.0 | 密码哈希 |

### 4.2 内部依赖

| 服务 | 用途 |
|------|------|
| ChainRPC Service | 区块链地址生成 |
| Signer Service | HD 钱包地址派生 |

---

## 5. 安全考量

### 5.1 已知问题摘要

| 问题 ID | 级别 | 描述 |
|---------|------|------|
| HIGH-01 | 高危 | 弱用户密码哈希 |
| MEDIUM-04 | 中危 | 不完整的身份验证流程 |

### 5.2 安全建议

1. **密码哈希**: 建议使用 bcrypt 或 Argon2 替代当前哈希算法
2. **2FA 强制**: 对高风险操作强制要求 2FA 验证
3. **验证码安全**: 增加验证码复杂度，防止暴力破解
4. **会话管理**: 实现会话续期和强制登出功能
