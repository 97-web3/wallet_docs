# 通知中心

> 返回 [业务服务目录](./README.md)

---

## F-BUS-026: 获取通知概览

**描述**: 获取未读消息数量，按类型分组统计。

**gRPC 方法**: `GetNotificationSummary`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "unread_count": 5,
  "by_type": {
    "deposit": 2,
    "withdraw": 1,
    "transfer": 1,
    "audit": 0,
    "security": 1,
    "system": 0
  }
}
```

---

## F-BUS-027: 获取通知列表

**描述**: 分页获取通知消息列表，支持按类型筛选。

**gRPC 方法**: `ListNotifications`

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "only_unread": false,
  "type": ""                  // 可选: deposit/withdraw/transfer/audit/security/system
}
```

**响应 Schema**:
```json
{
  "success": true,
  "total": 50,
  "unread_count": 5,
  "items": [
    {
      "id": "N123456",
      "type": "deposit",
      "type_text": "充值",
      "title": "充值到账",
      "content": "您的 100 USDT 充值已到账",
      "summary": "100 USDT 已入账到您的钱包",
      "timestamp": 1702300800,
      "read": false,
      "action": {
        "type": "navigate",           // navigate/link/none
        "target": "/transactions/D123456"
      },
      "extra_data": {
        "tx_id": "D123456",
        "asset": "USDT",
        "amount": "100"
      }
    }
  ]
}
```

**通知类型说明**:
| 类型 | 枚举值 | 描述 |
|------|--------|------|
| deposit | 1 | 充值通知 |
| withdraw | 2 | 提现通知 |
| transfer | 3 | 转账通知 |
| audit | 4 | 审核通知 |
| security | 5 | 安全通知 |
| system | 6 | 系统通知 |

---

## F-BUS-028: 标记通知已读

**描述**: 标记单条通知为已读。

**gRPC 方法**: `MarkNotificationRead`

**请求 Schema**:
```json
{
  "id": "N123456"
}
```

**响应 Schema**:
```json
{
  "success": true
}
```

---

## F-BUS-029: 标记全部已读

**描述**: 标记所有通知为已读。

**gRPC 方法**: `MarkAllNotificationsRead`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true
}
```

---

## F-BUS-030: 删除通知

**描述**: 删除单条通知。

**gRPC 方法**: `DeleteNotification`

**请求 Schema**:
```json
{
  "id": "N123456"
}
```

**响应 Schema**:
```json
{
  "success": true
}
```

---

## F-BUS-031: 清空通知

**描述**: 清空所有通知。

**gRPC 方法**: `ClearAllNotifications`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "cleared_count": 50
}
```

---

## F-BUS-054: 设置通知偏好

**描述**: 设置用户的通知接收偏好，包括各类型通知的开关和渠道选择。

**gRPC 方法**: `SetNotificationPreferences`

**请求 Schema**:
```json
{
  "preferences": {
    "deposit": {
      "enabled": true,
      "channels": ["app_push", "in_app"]
    },
    "withdraw": {
      "enabled": true,
      "channels": ["app_push", "in_app", "email"]
    },
    "transfer": {
      "enabled": true,
      "channels": ["in_app"]
    },
    "audit": {
      "enabled": true,
      "channels": ["app_push", "in_app", "email"]
    },
    "security": {
      "enabled": true,
      "channels": ["app_push", "email"]
    },
    "system": {
      "enabled": true,
      "channels": ["in_app"]
    }
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "通知偏好设置成功"
}
```

**业务规则**:
- 安全通知 (security) 不可完全关闭，至少保留一个渠道
- 默认所有通知类型开启，渠道为 APP推送 + 站内信

---

## F-BUS-062: 获取通知偏好

**描述**: 获取用户当前的通知偏好设置。

**gRPC 方法**: `GetNotificationPreferences`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "preferences": {
    "deposit": {
      "enabled": true,
      "channels": ["app_push", "in_app"]
    },
    "withdraw": {
      "enabled": true,
      "channels": ["app_push", "in_app", "email"]
    },
    "transfer": {
      "enabled": true,
      "channels": ["in_app"]
    },
    "audit": {
      "enabled": true,
      "channels": ["app_push", "in_app", "email"]
    },
    "security": {
      "enabled": true,
      "channels": ["app_push", "email"]
    },
    "system": {
      "enabled": true,
      "channels": ["in_app"]
    }
  },
  "available_channels": [
    {"id": "app_push", "name": "APP推送"},
    {"id": "in_app", "name": "站内信"},
    {"id": "sms", "name": "短信"},
    {"id": "email", "name": "邮件"}
  ]
}
```

---

## 通知渠道

### 渠道类型

| 渠道 | 枚举值 | 描述 | 技术实现 |
|------|--------|------|----------|
| app_push | 1 | APP 推送 | Firebase Cloud Messaging (FCM) |
| in_app | 2 | 站内信 | 存储于数据库，客户端轮询/WebSocket |
| sms | 3 | 短信 | 第三方短信服务商 |
| email | 4 | 邮件 | SMTP/邮件服务商 |

### 默认渠道配置

| 通知类型 | 默认渠道 |
|----------|----------|
| 充值通知 | APP推送 + 站内信 |
| 提现通知 | APP推送 + 站内信 |
| 转账通知 | 站内信 |
| 审核通知 | APP推送 + 站内信 + 邮件 |
| 安全通知 | APP推送 + 邮件 |
| 系统通知 | 站内信 |

---

## 通知触发规则

### 业务事件触发

| 事件 | 通知类型 | 标题模板 | 内容模板 |
|------|----------|----------|----------|
| 充值到账 | deposit | 充值到账 | 您的 {amount} {asset} 充值已到账 |
| 提现成功 | withdraw | 提现成功 | 您的 {amount} {asset} 已成功提现到 {address_short} |
| 提现驳回 | withdraw | 提现被驳回 | 您的 {amount} {asset} 提现申请已被驳回，原因: {reason} |
| 转账收款 | transfer | 收到转账 | 您收到来自 {sender} 的 {amount} {asset} 转账 |
| 转账成功 | transfer | 转账成功 | 您向 {recipient} 的 {amount} {asset} 转账已完成 |
| 审核通过 | audit | 审核通过 | 您的{operation}申请已审核通过 |
| 审核驳回 | audit | 审核未通过 | 您的{operation}申请未通过审核，原因: {reason} |
| 提现审核提交 | audit | 提现审核中 | 您的提现申请 {withdraw_id} 已提交审核，预计 {estimated_time} 内处理 |
| 提现审核通过 | audit | 提现审核通过 | 您的提现申请 {withdraw_id} 已通过审核，正在处理链上转账 |
| 提现审核驳回 | audit | 提现审核驳回 | 您的提现申请 {withdraw_id} 被驳回: {reason} |
| 转账审核提交 | audit | 转账审核中 | 您的转账申请 {transfer_id} 已提交审核 |
| 转账审核通过 | audit | 转账审核通过 | 您的转账申请 {transfer_id} 已通过审核并完成 |
| 转账审核驳回 | audit | 转账审核驳回 | 您的转账申请 {transfer_id} 被驳回: {reason} |
| 闪兑成功 | swap | 闪兑成功 | 您的 {from_amount} {from_asset} 已成功兑换为 {to_amount} {to_asset} |
| 闪兑失败 | swap | 闪兑失败 | 您的闪兑交易失败，原因: {reason}，资产已退回 |
| 登录提醒 | security | 新设备登录 | 您的账户在新设备上登录，IP: {ip}，位置: {location} |
| 密码修改 | security | 密码已修改 | 您的{password_type}已成功修改 |
| 安全设置变更 | security | 安全设置变更 | 您的{setting_type}已{action} |
| 系统公告 | system | {title} | {content} |

### 模板变量说明

| 变量 | 说明 | 示例 |
|------|------|------|
| {amount} | 金额 | 100.00 |
| {asset} | 资产类型 | USDT |
| {address_short} | 地址脱敏 | 0x1234...abcd |
| {sender} | 发送方昵称/UID | 用户A |
| {recipient} | 接收方昵称/UID | 用户B |
| {operation} | 操作类型 | 提现/转账 |
| {reason} | 原因 | 金额超出限制 |
| {ip} | IP地址 | 192.168.1.1 |
| {location} | 地理位置 | 北京市 |
| {password_type} | 密码类型 | 登录密码/资金密码 |
| {setting_type} | 设置类型 | Google验证器/生物识别 |
| {action} | 操作 | 开启/关闭/绑定/解绑 |

---

## 防重复规则

### 去重策略

| 规则 | 配置 | 描述 |
|------|------|------|
| 时间窗口 | 5 分钟 | 同类型、同内容通知在时间窗口内只发送一次 |
| 批量聚合 | 10 条/5分钟 | 批量操作聚合为一条通知 |
| 静默期 | 夜间 23:00-07:00 | 非紧急通知延迟到白天发送 |

### 紧急通知

以下通知不受静默期限制，立即发送:
- 大额充值 (≥ 10,000 USDT)
- 大额提现 (≥ 10,000 USDT)
- 安全告警 (异常登录、密码修改)
- 审核结果

---

## 管理员告警通知

### 系统告警触发规则

系统级告警通过 Admin Service 配置阈值，触发后通知所有 Admin/Finance 角色用户。

| 告警类型 | 触发条件 | 默认阈值 | 通知渠道 |
|----------|----------|----------|----------|
| Vault 余额不足 | 单链 Vault 余额低于阈值 | 10,000 USDT | 邮件 + APP推送 |
| 热钱包余额告警 | 热钱包余额低于安全线 | 5,000 USDT | 邮件 + APP推送 |
| 大额提现待审 | 单笔提现超过审批阈值 | 10,000 USDT | APP推送 |
| 累计提现告警 | 24小时累计提现超阈值 | 50,000 USDT | 邮件 |
| 异常交易告警 | 触发风控规则的交易 | - | 邮件 + APP推送 |
| 同步延迟告警 | 区块同步延迟超过阈值 | 100 块 | 邮件 |

### 告警通知格式

```json
{
  "type": "admin_alert",
  "alert_type": "vault_low_balance",
  "severity": "warning",
  "title": "Vault 余额告警",
  "content": "TRX 链 Vault 余额已低于阈值，当前余额: 8,500 USDT，阈值: 10,000 USDT",
  "timestamp": 1702300800,
  "data": {
    "chain": "TRX",
    "current_balance": "8500",
    "threshold": "10000",
    "currency": "USDT"
  },
  "action": {
    "type": "navigate",
    "target": "/admin/vault"
  }
}
```

### 告警配置管理

告警阈值配置详见 [07-admin-service/01-Dashboard统计](../07-admin-service/01-Dashboard统计.md#f-admin-004-设置告警阈值)

---

## 推送服务集成

### FCM 配置

```yaml
firebase:
  project_id: "your-project-id"
  credentials_file: "/path/to/service-account.json"
  topic_prefix: "wallet_"
```

### 推送消息格式

```json
{
  "to": "{device_token}",
  "notification": {
    "title": "充值到账",
    "body": "您的 100 USDT 充值已到账"
  },
  "data": {
    "type": "deposit",
    "notification_id": "N123456",
    "action": "navigate",
    "target": "/transactions/D123456"
  },
  "android": {
    "priority": "high"
  },
  "apns": {
    "headers": {
      "apns-priority": "10"
    }
  }
}
```

---

## 通知数据模型

### 通知表 (notifications)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| notification_id | VARCHAR(32) | 通知 ID |
| user_id | BIGINT | 用户 ID |
| type | TINYINT | 通知类型 |
| title | VARCHAR(100) | 标题 |
| content | TEXT | 内容 |
| summary | VARCHAR(255) | 摘要 |
| action_type | TINYINT | 动作类型: 1=跳转, 2=链接, 3=无 |
| action_target | VARCHAR(255) | 动作目标 |
| extra_data | JSON | 额外数据 |
| is_read | TINYINT | 是否已读: 0=否, 1=是 |
| read_at | DATETIME | 阅读时间 |
| channels_sent | JSON | 已发送渠道列表 |
| created_at | DATETIME | 创建时间 |

### 用户通知偏好表 (user_notification_preferences)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户 ID |
| notification_type | TINYINT | 通知类型 |
| enabled | TINYINT | 是否启用: 0=否, 1=是 |
| channels | JSON | 启用的渠道列表 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |
