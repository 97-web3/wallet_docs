# 安全设置

> 返回 [业务服务目录](./README.md)

---

## F-BUS-018: 获取安全设置

**描述**: 获取用户的安全设置状态。

**gRPC 方法**: `GetSecuritySettings`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "settings": {
    "google_auth_enabled": false,
    "has_trade_password": true,
    "anti_phishing_code": "ABC",
    "email_bound": true,
    "phone_bound": true,
    "login_notification": true,
    "email_masked": "a***@gmail.com",
    "phone_masked": "138****0000",
    "biometric_enabled": true,           // 生物识别是否开启
    "biometric_type": "face_id",         // face_id/touch_id/fingerprint/none
    "platform_bound": false,             // 是否已绑定平台账户
    "platform_uid": "",                  // 绑定的平台 UID
    "available_verification_methods": [  // 当前可用的验证方式
      "biometric",
      "google_auth",
      "trade_password"
    ]
  }
}
```

---

## F-BUS-019: 设置资金密码

**描述**: 设置交易/资金密码。

**gRPC 方法**: `SetTradePassword`

**请求 Schema**:
```json
{
  "password": "登录密码",
  "trade_password": "123456"    // 6位数字
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "资金密码设置成功"
}
```

**业务规则**:
- 资金密码格式: 必须为 6 位纯数字
- 不能与登录密码相同
- 不能使用连续数字 (如 123456, 654321)
- 不能使用重复数字 (如 111111, 888888)
- 设置后立即生效

---

## F-BUS-020: 重置资金密码

**描述**: 通过验证码重置资金密码。

**gRPC 方法**: `ResetTradePassword`

**请求 Schema**:
```json
{
  "method": 1,
  "phone": "13800138000",
  "country_code": "86",
  "email": "",
  "code": "123456",
  "code_id": "verify_123",
  "new_trade_password": "654321"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "资金密码重置成功"
}
```

---

## F-BUS-021: 绑定 Google 身份验证器

**描述**: 绑定 Google Authenticator 进行 2FA 验证。

**gRPC 方法**: `BindGoogleAuth`

**请求 Schema**:
```json
{
  "secret": "JBSWY3DPEHPK3PXP",
  "code": "123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "绑定成功",
  "backup_codes": [
    "ABC123",
    "DEF456",
    "GHI789"
  ]
}
```

---

## F-BUS-022: 绑定邮箱

**描述**: 绑定邮箱地址。

**gRPC 方法**: `BindEmail`

**请求 Schema**:
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "邮箱绑定成功"
}
```

---

## F-BUS-023: 换绑邮箱

**描述**: 更换已绑定的邮箱。

**gRPC 方法**: `ChangeEmail`

**请求 Schema**:
```json
{
  "new_email": "new@example.com",
  "code1": "123456",     // 原邮箱验证码
  "code2": "654321"      // 新邮箱验证码
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "邮箱换绑成功"
}
```

---

## F-BUS-024: 绑定手机

**描述**: 绑定手机号。

**gRPC 方法**: `BindPhone`

**请求 Schema**:
```json
{
  "phone": "13800138000",
  "country_code": "86",
  "code": "123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "手机绑定成功"
}
```

---

## F-BUS-025: 换绑手机

**描述**: 更换已绑定的手机号。

**gRPC 方法**: `ChangePhone`

**请求 Schema**:
```json
{
  "new_phone": "13900139000",
  "new_country_code": "86",
  "code1": "123456",     // 原手机验证码
  "code2": "654321"      // 新手机验证码
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "手机换绑成功"
}
```

---

## F-BUS-048: 修改资金密码

**描述**: 已设置资金密码的用户修改资金密码，需要旧密码和 2FA 双重验证。

**gRPC 方法**: `ChangeTradePassword`

**请求 Schema**:
```json
{
  "old_trade_password": "123456",   // 旧资金密码
  "new_trade_password": "654321",   // 新资金密码
  "google_auth_code": "123456"      // GA 验证码 (已开启 2FA 时必填)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "资金密码修改成功"
}
```

**业务规则**:
- 需要验证旧资金密码
- 如已开启 Google Authenticator，需同时验证 GA 码
- 新密码不能与旧密码相同
- 新密码格式要求同 F-BUS-019
- 修改成功后所有已登录设备需重新验证资金密码

---

## F-BUS-049: 绑定平台账户

**描述**: 将 Web3 钱包地址与平台 UID 绑定，实现托管钱包与非托管钱包的关联。

**gRPC 方法**: `BindPlatformAccount`

**请求 Schema**:
```json
{
  "platform_uid": "U20251210ABCD",      // 平台用户 UID
  "wallet_address": "0x1234...abcd",    // Web3 钱包地址
  "chain": "ETH",                        // 链类型
  "verification": {
    "biometric_token": "",               // 生物识别凭证 (优先)
    "google_auth_code": "",              // GA 验证码 (次选)
    "trade_password": "",                // 资金密码 (再次)
    "sms_code": "",                      // 短信验证码 (最后)
    "email_code": ""                     // 邮箱验证码
  },
  "signature": "0x...",                  // 钱包签名证明所有权
  "message": "Bind to platform..."       // 签名原文
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "平台账户绑定成功",
  "binding_id": "BIND-20251210-001"
}
```

**业务规则**:
- 1:1 绑定规则: 一个 UID 只能绑定一个钱包地址
- 一个钱包地址只能绑定一个 UID
- 需要钱包签名证明地址所有权
- 验证流程按优先级: 生物识别 → GA → 资金密码 → 验证码
- 绑定成功后，Web2 → 该地址的提现免审批

---

## F-BUS-050: 解绑平台账户

**描述**: 解除 Web3 钱包地址与平台 UID 的绑定关系。

**gRPC 方法**: `UnbindPlatformAccount`

**请求 Schema**:
```json
{
  "binding_id": "BIND-20251210-001",    // 绑定 ID
  "verification": {
    "biometric_token": "",
    "google_auth_code": "",
    "trade_password": "",
    "sms_code": "",
    "email_code": ""
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "平台账户解绑成功"
}
```

**业务规则**:
- 需要完整验证流程
- 解绑后该地址的提现恢复审核流程
- 解绑后可重新绑定其他账户
- 记录解绑日志

---

## F-BUS-051: 开启生物识别

**描述**: 开启 FaceID/TouchID 快捷验证功能。

**gRPC 方法**: `EnableBiometric`

**请求 Schema**:
```json
{
  "device_id": "device-uuid-xxx",        // 设备唯一标识
  "biometric_type": "face_id",           // face_id/touch_id/fingerprint
  "biometric_public_key": "...",         // 生物识别公钥
  "device_info": {
    "platform": "iOS",
    "os_version": "17.0",
    "device_model": "iPhone 15 Pro"
  },
  "verification": {                      // 开启前需要验证身份
    "trade_password": "123456"
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "生物识别已开启",
  "biometric_id": "BIO-20251210-001"
}
```

**业务规则**:
- 开启前需验证资金密码或其他已有验证方式
- 设备会自动加入信任设备列表
- 同一账户可在多个设备开启生物识别
- 开启后可用于登录和敏感操作验证

---

## F-BUS-052: 关闭生物识别

**描述**: 关闭指定设备的生物识别功能。

**gRPC 方法**: `DisableBiometric`

**请求 Schema**:
```json
{
  "device_id": "device-uuid-xxx",        // 设备唯一标识，为空则关闭所有设备
  "verification": {
    "trade_password": "123456"           // 需要资金密码验证
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "生物识别已关闭"
}
```

**业务规则**:
- 关闭后该设备不能使用生物识别登录/验证
- 可选择关闭单个设备或所有设备
- 关闭不影响其他验证方式

---

## F-BUS-053: 获取验证方式

**描述**: 获取当前用户可用的验证方式及其优先级。

**gRPC 方法**: `GetVerificationMethod`

**请求 Schema**:
```json
{
  "scene": "withdraw"   // 场景: login/withdraw/transfer/bindBind/security_change
}
```

**响应 Schema**:
```json
{
  "success": true,
  "methods": [
    {
      "type": "biometric",
      "enabled": true,
      "priority": 1,
      "display_name": "Face ID",
      "timeout_seconds": 30
    },
    {
      "type": "google_auth",
      "enabled": true,
      "priority": 2,
      "display_name": "Google 验证器",
      "timeout_seconds": 300
    },
    {
      "type": "trade_password",
      "enabled": true,
      "priority": 3,
      "display_name": "资金密码",
      "timeout_seconds": 300
    },
    {
      "type": "sms_code",
      "enabled": true,
      "priority": 4,
      "display_name": "短信验证码",
      "timeout_seconds": 300
    }
  ],
  "recommended_method": "biometric"     // 推荐使用的方式
}
```

---

## 验证方式优先级规则

### 优先级链

敏感操作的验证方式按以下优先级选择:

```
FaceID/TouchID (1) > Google Authenticator (2) > 资金密码 (3) > 验证码 (4)
```

### 优先级选择逻辑

1. 系统返回用户已开启的所有验证方式
2. 前端按优先级展示，默认选中最高优先级方式
3. 用户可选择其他已开启的验证方式
4. 某方式验证失败后，自动降级到下一优先级

### 各场景验证要求

| 场景 | 必需验证 | 可选验证 |
|------|----------|----------|
| 登录 | 任一方式 | - |
| 提现 | 任一方式 | - |
| 内部转账 | 任一方式 | - |
| 绑定平台账户 | 至少两种方式 | - |
| 修改安全设置 | 至少两种方式 | - |
| 大额操作 (≥10000 USDT) | 最高优先级方式 | - |

---

## 验证失败处理规则

### 失败次数限制

| 验证方式 | 最大尝试次数 | 锁定时长 | 锁定后处理 |
|----------|--------------|----------|------------|
| 生物识别 | 3 次 | 不锁定 | 降级到下一验证方式 |
| Google Authenticator | 5 次 | 15 分钟 | 该方式暂时不可用 |
| 资金密码 | 5 次 | 15 分钟 | 该方式暂时不可用 |
| 短信/邮箱验证码 | 5 次 | 15 分钟 | 该方式暂时不可用 |

### 验证超时配置

| 验证方式 | 超时时间 | 超时后处理 |
|----------|----------|------------|
| 生物识别 | 30 秒 | 验证失败，可重试或切换方式 |
| Google Authenticator | 30 秒 (单个码有效期) | 需输入新码 |
| 资金密码 | 5 分钟 | 需重新发起验证 |
| 短信/邮箱验证码 | 5 分钟 | 验证码过期，需重新发送 |

### 全部方式锁定时的处理

当用户所有验证方式均被锁定时:
1. 提示用户等待最短锁定时间解除
2. 提供客服联系方式
3. 记录安全事件日志

---

## 平台绑定规则

### 绑定关系

- **1:1 绑定**: 一个平台 UID 只能绑定一个 Web3 钱包地址
- **唯一性**: 一个 Web3 钱包地址只能被一个 UID 绑定
- **链无关**: 绑定关系以地址为准，同一地址在多链上视为同一绑定

### 绑定验证流程

```
1. 用户发起绑定请求
2. 系统检查 UID 和地址的绑定状态
3. 用户使用钱包签名证明地址所有权
4. 用户完成身份验证 (按优先级链)
5. 系统创建绑定记录
6. 更新用户安全设置
```

### 绑定权益

| 权益 | 未绑定 | 已绑定 |
|------|--------|--------|
| Web2 → Web3 提现 | 需审核 | 免审批 |
| Web3 → Web2 充值 | 正常流程 | 自动关联 |
| 资产聚合展示 | 分开展示 | 统一展示 |

### 解绑限制

- 解绑后 24 小时内不能重新绑定同一地址
- 解绑不影响历史交易记录
- 解绑后进行中的交易按原规则处理

---

## 架构图

### 验证方式优先级选择序列图

```
用户                    APP客户端                  业务服务                   安全服务
 │                         │                         │                         │
 │  发起敏感操作            │                         │                         │
 │───────────────────────>│                         │                         │
 │                         │  获取验证方式             │                         │
 │                         │───────────────────────>│                         │
 │                         │                         │  查询用户安全设置         │
 │                         │                         │───────────────────────>│
 │                         │                         │<───────────────────────│
 │                         │                         │  返回可用方式列表         │
 │                         │<───────────────────────│                         │
 │                         │                         │                         │
 │  [展示验证方式选择]       │                         │                         │
 │<───────────────────────│                         │                         │
 │                         │                         │                         │
 │  选择生物识别 (优先级1)   │                         │                         │
 │───────────────────────>│                         │                         │
 │                         │  生物识别验证请求         │                         │
 │                         │───────────────────────>│                         │
 │                         │                         │                         │
 │  [成功] ─────────────────────────────────────────────────────────────────  │
 │  │                      │<───────────────────────│  验证通过               │
 │  │                      │                         │                         │
 │  └──> 操作完成           │                         │                         │
 │                         │                         │                         │
 │  [失败超过3次] ──────────────────────────────────────────────────────────  │
 │  │                      │<───────────────────────│  降级到下一方式          │
 │  │                      │                         │                         │
 │  │  [展示GA验证界面]     │                         │                         │
 │<─┼──────────────────────│                         │                         │
 │  │                      │                         │                         │
 │  │  输入GA验证码         │                         │                         │
 │──┼─────────────────────>│                         │                         │
 │  │                      │  GA验证请求              │                         │
 │  │                      │───────────────────────>│                         │
 │  │                      │                         │                         │
 │  └──> [成功/继续降级]    │                         │                         │
 │                         │                         │                         │
```

### 平台账户绑定序列图

```
用户                    APP客户端              业务服务           Web3钱包服务        数据库
 │                         │                    │                    │               │
 │  请求绑定平台账户        │                    │                    │               │
 │───────────────────────>│                    │                    │               │
 │                         │  发起绑定请求       │                    │               │
 │                         │──────────────────>│                    │               │
 │                         │                    │  检查UID绑定状态    │               │
 │                         │                    │───────────────────────────────────>│
 │                         │                    │<───────────────────────────────────│
 │                         │                    │                    │               │
 │                         │                    │  检查地址绑定状态   │               │
 │                         │                    │───────────────────────────────────>│
 │                         │                    │<───────────────────────────────────│
 │                         │                    │                    │               │
 │                         │                    │  [均未绑定]         │               │
 │                         │                    │  生成签名消息       │               │
 │                         │<─────────────────│                    │               │
 │                         │                    │                    │               │
 │  [唤起钱包签名]          │                    │                    │               │
 │<───────────────────────│                    │                    │               │
 │                         │                    │                    │               │
 │  钱包签名确认            │                    │                    │               │
 │───────────────────────>│                    │                    │               │
 │                         │  提交签名           │                    │               │
 │                         │──────────────────>│                    │               │
 │                         │                    │  验证签名           │               │
 │                         │                    │──────────────────>│               │
 │                         │                    │<──────────────────│ 签名有效       │
 │                         │                    │                    │               │
 │  [身份验证环节]          │                    │                    │               │
 │<───────────────────────│                    │                    │               │
 │                         │                    │                    │               │
 │  生物识别验证            │                    │                    │               │
 │───────────────────────>│  验证生物识别      │                    │               │
 │                         │──────────────────>│                    │               │
 │                         │<─────────────────│ 验证通过            │               │
 │                         │                    │                    │               │
 │  输入GA验证码            │                    │                    │               │
 │───────────────────────>│  验证GA码          │                    │               │
 │                         │──────────────────>│                    │               │
 │                         │<─────────────────│ 验证通过            │               │
 │                         │                    │                    │               │
 │                         │                    │  创建绑定记录       │               │
 │                         │                    │───────────────────────────────────>│
 │                         │                    │<───────────────────────────────────│
 │                         │                    │                    │               │
 │                         │<─────────────────│ 绑定成功            │               │
 │<───────────────────────│                    │                    │               │
 │  绑定完成                │                    │                    │               │
 │                         │                    │                    │               │
```

### 提现审批流程序列图

```
用户              业务服务           风控服务         AML服务          审核服务         ChainRPC
 │                  │                 │                │                │               │
 │  发起提现请求    │                 │                │                │               │
 │────────────────>│                 │                │                │               │
 │                  │  风控评估       │                │                │               │
 │                  │───────────────>│                │                │               │
 │                  │<───────────────│ 返回风险等级   │                │               │
 │                  │                 │                │                │               │
 │                  │  [风险等级=高]  │                │                │               │
 │                  │  AML检查        │                │                │               │
 │                  │────────────────────────────────>│                │               │
 │                  │<────────────────────────────────│ 返回检查结果   │               │
 │                  │                 │                │                │               │
 │                  │  [需人工审核]   │                │                │               │
 │                  │  创建审核工单   │                │                │               │
 │                  │─────────────────────────────────────────────────>│               │
 │                  │<─────────────────────────────────────────────────│ 工单创建成功  │
 │<─────────────────│  返回"审核中"   │                │                │               │
 │                  │                 │                │                │               │
 │                  │                 │                │   [审核员操作]  │               │
 │                  │<─────────────────────────────────────────────────│ 审核通过通知  │
 │                  │                 │                │                │               │
 │                  │  提交链上交易   │                │                │               │
 │                  │──────────────────────────────────────────────────────────────────>│
 │                  │<──────────────────────────────────────────────────────────────────│
 │                  │                 │                │                │  交易哈希     │
 │<─────────────────│  返回"处理中"   │                │                │               │
 │                  │                 │                │                │               │
 │                  │                 │                │                │  [链上确认]   │
 │                  │<──────────────────────────────────────────────────────────────────│
 │<─────────────────│  提现成功通知   │                │                │               │
 │                  │                 │                │                │               │
```
