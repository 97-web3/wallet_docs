# 钱包地址管理

> 返回 [业务服务目录](./README.md)

---

## F-BUS-034: 获取钱包地址列表

**描述**: 获取用户保存的提现地址列表。

**gRPC 方法**: `ListWalletAddresses`

**请求 Schema**:
```json
{
  "asset": "USDT",     // 可选：按资产筛选
  "chain": "TRN"       // 可选：按链筛选
}
```

**响应 Schema**:
```json
{
  "success": true,
  "items": [
    {
      "id": "ADDR-001",
      "asset": "USDT",
      "chain": "TRN",
      "chain_name": "Tron (TRC20)",
      "address": "TKvjY...",
      "label": "我的波场钱包",
      "is_default": true,
      "is_internal": false,           // 是否为平台内部地址
      "is_bound": false,              // 是否为绑定的 Web3 钱包地址
      "withdraw_count": 5,            // 提现次数
      "last_used_at": 1702300800,     // 最后使用时间
      "created_at": 1702300800
    }
  ]
}
```

---

## F-BUS-035: 添加钱包地址

**描述**: 添加新的提现地址。

**gRPC 方法**: `AddWalletAddress`

**请求 Schema**:
```json
{
  "asset": "USDT",
  "chain": "TRN",
  "address": "TKvjY...",
  "label": "我的波场钱包",
  "set_default": true,
  "memo_tag": ""                  // 可选：Memo/Tag (XRP/EOS等链需要)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址添加成功",
  "address_id": "ADDR-001",
  "is_internal": false,           // 是否为平台内部地址
  "validation_warning": ""        // 验证警告 (如: ETH/BNB地址格式相同，请确认选择正确的链)
}
```

**业务规则**:
- 地址格式必须与选择的链匹配
- 同一资产+链+地址组合不能重复添加
- 标签长度限制: 最多 50 字符
- 每个用户最多保存 100 个地址

---

## F-BUS-055: 编辑钱包地址

**描述**: 修改已保存地址的标签和默认状态。

**gRPC 方法**: `UpdateWalletAddress`

**请求 Schema**:
```json
{
  "address_id": "ADDR-001",
  "label": "新标签名称",
  "set_default": true
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址更新成功"
}
```

**业务规则**:
- 仅可修改标签和默认状态
- 地址本身不可修改 (需删除后重新添加)
- 设置为默认时，同资产+链的其他地址自动取消默认

---

## F-BUS-056: 删除钱包地址

**描述**: 删除已保存的提现地址。

**gRPC 方法**: `DeleteWalletAddress`

**请求 Schema**:
```json
{
  "address_id": "ADDR-001",
  "verification": {
    "trade_password": "123456"    // 需要验证身份
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "地址删除成功"
}
```

**业务规则**:
- 删除需要身份验证
- 绑定的 Web3 钱包地址不可直接删除，需先解绑
- 删除后历史交易记录中的地址信息保留

---

## F-BUS-057: 验证地址格式

**描述**: 验证地址格式是否正确，并检测是否为平台内部地址。

**gRPC 方法**: `ValidateAddress`

**请求 Schema**:
```json
{
  "address": "TKvjY...",
  "chain": "TRN"                  // 可选：指定链类型
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_valid": true,
  "detected_chains": ["TRN"],     // 检测到的可能链类型
  "is_internal": false,           // 是否为平台内部地址
  "internal_user_info": {         // 内部地址时返回
    "uid": "",
    "nickname": ""
  },
  "warnings": [                   // 验证警告
    {
      "type": "ambiguous_chain",
      "message": "该地址格式与 ETH 和 BSC 兼容，请确认选择正确的链"
    }
  ],
  "risk_info": {                  // 风险信息 (可选)
    "risk_level": 0,              // 0=安全, 1=低风险, 2=中风险, 3=高风险
    "risk_tags": []               // 风险标签
  }
}
```

**业务规则**:
- ETH 和 BSC 地址格式相同 (0x开头)，需用户二次确认
- 检测是否为平台内部地址，提示使用内部转账更快捷
- 可选进行地址风险检测

---

## F-BUS-058: 检测内部地址

**描述**: 检测地址是否为平台内部用户的地址。

**gRPC 方法**: `CheckInternalAddress`

**请求 Schema**:
```json
{
  "address": "TKvjY...",
  "chain": "TRN"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "is_internal": true,
  "user_info": {
    "uid": "U20251210ABCD",
    "nickname": "用户昵称",
    "avatar": ""
  },
  "recommendation": {
    "use_internal_transfer": true,
    "reason": "该地址为平台内部用户，建议使用内部转账，免手续费且实时到账"
  }
}
```

**业务规则**:
- 如果是内部地址，建议用户使用内部转账功能
- 用户信息脱敏展示，保护隐私

---

## F-BUS-063: 设置默认地址

**描述**: 设置某个地址为默认提现地址。

**gRPC 方法**: `SetDefaultAddress`

**请求 Schema**:
```json
{
  "address_id": "ADDR-001"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "默认地址设置成功"
}
```

**业务规则**:
- 同一资产+链只能有一个默认地址
- 设置新默认地址时自动取消原默认

---

## 地址格式验证规则

### 各链地址格式

| 链 | 前缀 | 长度 | 格式 | 示例 |
|----|------|------|------|------|
| TRX | T | 34 | Base58 | T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb |
| ETH | 0x | 42 | Hex | 0x1234567890123456789012345678901234567890 |
| BSC | 0x | 42 | Hex | 0x1234567890123456789012345678901234567890 |

### ETH/BSC 地址歧义处理

由于 ETH 和 BSC 地址格式完全相同，系统需要:

1. **添加地址时**:
   - 显示警告: "该地址格式与 ETH 和 BSC 兼容，请确认选择正确的链"
   - 要求用户明确选择链类型

2. **提现时**:
   - 再次确认链类型
   - 提示: "您正在提现到 {chain} 网络，请确认地址网络正确"

---

## 地址数据模型

### 用户地址表 (user_wallet_addresses)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BIGINT | 主键 |
| address_id | VARCHAR(32) | 地址 ID |
| user_id | BIGINT | 用户 ID |
| asset | VARCHAR(20) | 资产类型 |
| chain | VARCHAR(10) | 链类型 |
| address | VARCHAR(100) | 地址 |
| memo_tag | VARCHAR(50) | Memo/Tag |
| label | VARCHAR(50) | 标签 |
| is_default | TINYINT | 是否默认: 0=否, 1=是 |
| is_internal | TINYINT | 是否内部地址: 0=否, 1=是 |
| internal_user_id | BIGINT | 内部用户 ID (内部地址时) |
| is_bound | TINYINT | 是否绑定地址: 0=否, 1=是 |
| binding_id | VARCHAR(32) | 绑定 ID (绑定地址时) |
| withdraw_count | INT | 提现次数 |
| last_used_at | DATETIME | 最后使用时间 |
| status | TINYINT | 状态: 1=正常, 2=已删除 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `idx_user_id` (user_id)
- `uk_user_address` (user_id, asset, chain, address) UNIQUE
- `idx_address` (address)
