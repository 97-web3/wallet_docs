# 内部转账

> 返回 [业务服务目录](./README.md)

---

## F-BUS-016: 获取转账信息

**描述**: 获取内部转账相关信息。

**gRPC 方法**: `GetTransferInfo`

**请求 Schema**:
```json
{
  "asset": "USDT",              // 可选：指定资产
  "recipient": "10002"          // 可选：接收方标识 (UID/邮箱/手机号)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "assets": [...],
  "available": "4500.00",
  "recipient_uid": "10002",
  "recipient_nickname": "接收方昵称",
  "recipient_avatar": "",
  "tips": "内部转账免手续费，实时到账",
  "security_tip": {
    "has_trade_password": true,
    "has_biometric": true,
    "has_google_auth": false,
    "recommended_action": ""
  }
}
```

**业务规则**:
- 未设置任何验证方式时，返回 `recommended_action: "请先设置资金密码或开启生物识别"`
- 至少需要设置一种验证方式才能转账

---

## F-BUS-017: 创建内部转账

**描述**: 执行内部用户间转账。

**gRPC 方法**: `CreateTransfer`

**请求 Schema**:
```json
{
  "recipient_uid": "10002",
  "asset": "USDT",
  "amount": "100",
  "memo": "转账备注",                    // 备注字段，最高 1000 字符
  "verification": {
    "biometric_token": "",              // 生物识别凭证 (优先)
    "google_auth_code": "",             // GA 验证码 (次选)
    "trade_password": "",               // 资金密码 (再次)
    "sms_code": "",                     // 短信验证码 (最后)
    "email_code": ""                    // 邮箱验证码
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "转账成功",
  "transfer_id": "T123456",
  "status": "completed",                // 转账状态
  "requires_audit": false,              // 是否需要审核
  "audit_info": {                       // 需要审核时返回
    "audit_type": "aml",
    "reason": "金额超过阈值",
    "expected_completion": "2025-12-10T12:00:00Z"
  }
}
```

**业务规则**:
- 内部转账免手续费，实时到账
- 验证方式选择按优先级链: FaceID > 2FA > 资金密码 > 验证码
- 备注字段最多 1000 字符

**免审批条件**:
- 单笔金额 < 1,000 USDT 等值 (快速通道)
- 非首次向该收款方转账

**需审核条件**:
- 单笔金额 ≥ 10,000 USDT 等值 (触发 AML 审核)
- 24小时内累计转账 ≥ 50,000 USDT 等值 (触发人工审核)
- 收款方为新用户 (注册不足 7 天)

---

## F-BUS-047: 搜索用户

**描述**: 按 UID、邮箱或手机号搜索收款方用户。

**gRPC 方法**: `SearchUser`

**请求 Schema**:
```json
{
  "query": "U20251210ABCD",     // 搜索关键词
  "query_type": 0               // 0=自动识别, 1=UID, 2=邮箱, 3=手机号
}
```

**响应 Schema**:
```json
{
  "success": true,
  "users": [
    {
      "uid": "U20251210ABCD",
      "nickname": "用户昵称",
      "avatar": "https://...",
      "phone_masked": "138****0000",    // 脱敏手机号
      "email_masked": "a***@gmail.com", // 脱敏邮箱
      "is_verified": true               // 是否已完成 KYC
    }
  ]
}
```

**业务规则**:
- 自动识别搜索类型:
  - 以 `U` 开头且长度 13 字符 → UID
  - 包含 `@` → 邮箱
  - 纯数字 → 手机号
- 搜索结果脱敏处理，保护用户隐私
- 最多返回 10 条匹配结果
- 不能搜索自己
- 黑名单用户不显示在搜索结果中

---

## F-BUS-059: 获取转账详情

**描述**: 获取内部转账的详细信息。

**gRPC 方法**: `GetTransferDetail`

**请求 Schema**:
```json
{
  "transfer_id": "T123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "transfer": {
    "transfer_id": "T123456",
    "from_uid": "U20251210ABCD",
    "to_uid": "U20251210EFGH",
    "to_nickname": "收款方昵称",
    "asset": "USDT",
    "amount": "100",
    "memo": "转账备注",
    "status": "completed",
    "status_text": "已完成",
    "created_at": "2025-12-10T10:00:00Z",
    "completed_at": "2025-12-10T10:00:01Z"
  }
}
```

---

## F-BUS-060: 获取转账审核状态

**描述**: 查询内部转账的审核进度和状态。

**gRPC 方法**: `GetTransferAuditStatus`

**请求 Schema**:
```json
{
  "transfer_id": "T123456"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "transfer_id": "T123456",
  "status": "auditing",
  "status_text": "审核中",
  "audit_info": {
    "submitted_at": "2025-12-10T10:00:00Z",
    "audit_started_at": "2025-12-10T10:01:00Z",
    "audit_type": "aml",
    "audit_reason": "金额超过阈值",
    "expected_completion": "2025-12-10T12:00:00Z"
  },
  "timeline": [
    {
      "status": "submitted",
      "time": "2025-12-10T10:00:00Z",
      "description": "转账申请已提交"
    },
    {
      "status": "auditing",
      "time": "2025-12-10T10:01:00Z",
      "description": "进入审核流程"
    }
  ]
}
```

---

## F-BUS-061: 取消转账

**描述**: 取消待审核状态的转账申请。

**gRPC 方法**: `CancelTransfer`

**请求 Schema**:
```json
{
  "transfer_id": "T123456",
  "verification": {
    "trade_password": "123456"
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "转账已取消",
  "refund_amount": "100",
  "refund_asset": "USDT"
}
```

**业务规则**:
- 仅 `pending_audit` 和 `auditing` 状态可取消
- `completed` 状态不可取消
- 取消后金额立即返还到账户余额
- 取消操作记入日志

---

## 转账状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| pending_verification | 1 | 待验证 (等待用户完成身份验证) |
| pending_audit | 2 | 待审核 (已提交，等待审核) |
| auditing | 3 | 审核中 (正在进行风控/AML/人工审核) |
| completed | 4 | 已完成 (转账成功) |
| rejected | 5 | 已驳回 (审核未通过) |
| cancelled | 6 | 已取消 (用户主动取消) |

### 状态流转图

```
                    ┌──────────────────────┐
                    │ pending_verification │
                    └──────────┬───────────┘
                               │ 用户完成验证
                               ▼
                    ┌──────────────────────┐
                    │    pending_audit     │──────────────────┐
                    └──────────┬───────────┘                  │
                               │                              │ 用户取消
           ┌───────────────────┤ 进入审核                     ▼
           │                   ▼                    ┌──────────────┐
           │        ┌──────────────────────┐       │  cancelled   │
           │        │      auditing        │       └──────────────┘
           │        └──────────┬───────────┘
           │                   │
   免审批通过         ┌────────┴────────┐
           │         │ 审核通过        │ 审核驳回
           │         ▼                 ▼
           │  ┌──────────────┐  ┌──────────────┐
           └──│  completed   │  │   rejected   │
              └──────────────┘  └──────────────┘
```

---

## 审核规则

### 审核阈值

| 条件 | 阈值 | 审核类型 | 预计时长 |
|------|------|----------|----------|
| 单笔金额 | < 1,000 USDT | 免审批 | 实时 |
| 单笔金额 | ≥ 10,000 USDT | AML 审核 | 24 小时内 |
| 24小时累计 | ≥ 50,000 USDT | 人工审核 | 72 小时内 |
| 收款方新用户 | 注册 < 7 天 | 风控审核 | 30 秒内 |

### 审核超时处理

| 审核类型 | 超时时间 | 超时处理 |
|----------|----------|----------|
| 自动风控 | 30 秒 | 转人工审核 |
| AML 审核 | 24 小时 | 发送提醒，继续等待 |
| 人工审核 | 72 小时 | 自动升级，通知管理员 |
| 最终超时 | 7 天 | 自动驳回并退款 |
