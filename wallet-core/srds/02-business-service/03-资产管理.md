# 资产管理

> 返回 [业务服务目录](./README.md)

---

## F-BUS-009: 获取资产概览

**描述**: 获取用户所有资产的汇总信息。

**gRPC 方法**: `GetAssetOverview`

**请求 Schema**:
```json
{
  "symbol": "USDT",         // 可选：指定币种
  "price": "",              // 可选：指定价格
  "hide_balance": false,    // 是否隐藏金额 (用于记录用户偏好)
  "currency": "USD"         // 法币单位: USD/CNY/EUR 等
}
```

**响应 Schema**:
```json
{
  "success": true,
  "total_valuation_usdt": "10000.00",
  "total_valuation_fiat": "10000.00",       // 法币等值
  "fiat_currency": "USD",                   // 法币币种
  "fiat_symbol": "$",                       // 法币符号
  "items": [
    {
      "asset": "USDT",
      "asset_name": "Tether USD",
      "icon_url": "https://...",
      "total_balance": "5000.00",
      "available_balance": "4500.00",
      "frozen_balance": "500.00",
      "valuation_usdt": "5000.00",
      "valuation_fiat": "5000.00",
      "price_usdt": "1.00",                 // 当前价格 (USDT 计价)
      "price_change_24h": "0.00"            // 24小时价格变化 (%)
    },
    {
      "asset": "TRX",
      "asset_name": "TRON",
      "icon_url": "https://...",
      "total_balance": "10000.00",
      "available_balance": "10000.00",
      "frozen_balance": "0",
      "valuation_usdt": "1000.00",
      "valuation_fiat": "1000.00",
      "price_usdt": "0.10",
      "price_change_24h": "-2.50"
    }
  ]
}
```

---

## F-BUS-010: 近期交易列表

**描述**: 获取最近的交易记录，用于首页展示，支持按类型筛选和搜索。

**gRPC 方法**: `ListRecentTransactions`

**请求 Schema**:
```json
{
  "limit": 10,              // 返回条数，默认 3
  "asset": ["USDT"],        // 可选：过滤资产
  "tx_type": "",            // 可选：交易类型 all/deposit/withdraw/transfer
  "search_keyword": ""      // 可选：搜索关键词 (交易ID/币种)
}
```

**响应 Schema**:
```json
{
  "success": true,
  "items": [
    {
      "id": "D1733836800000ABC",
      "type": "deposit",
      "type_text": "充值",
      "asset": "USDT",
      "amount": "100.0000000",              // 7位小数精度
      "amount_display": "100.00",           // 显示格式
      "valuation_usdt": "100.00",
      "created_at": "2025-12-10T10:00:00Z",
      "status": "confirmed",
      "status_text": "已完成",
      "chain": "TRN",
      "chain_name": "Tron (TRC20)",
      "tx_hash": "abc123...",               // 链上交易哈希
      "explorer_url": "https://tronscan.org/#/transaction/abc123...",
      "memo": "充值"
    }
  ]
}
```

**交易类型说明**:
| 类型 | 枚举值 | 描述 |
|------|--------|------|
| deposit | 1 | 充值 |
| withdraw | 2 | 提现 |
| transfer_in | 3 | 转入 (内部转账收款) |
| transfer_out | 4 | 转出 (内部转账付款) |

---

## F-BUS-011: 余额变动记录

**描述**: 获取详细的余额变动历史记录，支持按类型筛选和搜索。

**gRPC 方法**: `ListBalanceRecords`

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "asset": "USDT",          // 可选：过滤资产
  "type": "",               // 可选：记录类型 all/deposit/withdraw/transfer
  "search_keyword": "",     // 可选：搜索关键词
  "start_time": 0,          // 可选：开始时间戳
  "end_time": 0             // 可选：结束时间戳
}
```

**响应 Schema**:
```json
{
  "success": true,
  "total": 100,
  "items": [
    {
      "id": "D1733836800000ABC",
      "type": "deposit",
      "type_text": "充值",
      "asset": "USDT",
      "amount": "100.0000000",
      "amount_display": "100.00",
      "balance_after": "5100.0000000",      // 变动后余额
      "created_at": "2025-12-10T10:00:00Z",
      "status": "confirmed",
      "status_text": "已完成",
      "chain": "TRN",
      "chain_name": "Tron (TRC20)",
      "tx_hash": "abc123...",
      "explorer_url": "https://tronscan.org/#/transaction/abc123...",
      "from_address": "T9yD14...",
      "to_address": "TKvjY...",
      "memo": "TRC20 充值",
      "fee": "0",                           // 手续费
      "fee_asset": ""                       // 手续费币种
    }
  ]
}
```

---

## F-BUS-044: 获取实时汇率

**描述**: 获取代币的实时汇率，数据来源为 Debank 价格源。

**gRPC 方法**: `GetExchangeRates`

**请求 Schema**:
```json
{
  "assets": ["USDT", "TRX", "ETH", "BNB"],  // 要查询的资产列表
  "base_currency": "USD"                    // 计价货币
}
```

**响应 Schema**:
```json
{
  "success": true,
  "base_currency": "USD",
  "rates": [
    {
      "asset": "USDT",
      "price": "1.0001",
      "price_change_24h": "0.01",
      "price_change_7d": "-0.05",
      "market_cap": "83000000000",
      "volume_24h": "50000000000",
      "last_updated": "2025-12-10T10:00:00Z"
    },
    {
      "asset": "TRX",
      "price": "0.1012",
      "price_change_24h": "-2.50",
      "price_change_7d": "5.20",
      "market_cap": "9000000000",
      "volume_24h": "500000000",
      "last_updated": "2025-12-10T10:00:00Z"
    },
    {
      "asset": "ETH",
      "price": "2250.50",
      "price_change_24h": "1.25",
      "price_change_7d": "8.50",
      "market_cap": "270000000000",
      "volume_24h": "15000000000",
      "last_updated": "2025-12-10T10:00:00Z"
    },
    {
      "asset": "BNB",
      "price": "310.20",
      "price_change_24h": "0.80",
      "price_change_7d": "3.20",
      "market_cap": "48000000000",
      "volume_24h": "1000000000",
      "last_updated": "2025-12-10T10:00:00Z"
    }
  ],
  "updated_at": "2025-12-10T10:00:00Z"
}
```

**业务规则**:
- 价格数据每 30 秒更新一次
- 数据来源: Debank API
- 支持的计价货币: USD, CNY, EUR, JPY, KRW, GBP

---

## F-BUS-064: 获取交易详情

**描述**: 获取单笔交易的详细信息。

**gRPC 方法**: `GetTransactionDetail`

**请求 Schema**:
```json
{
  "tx_id": "D1733836800000ABC"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "transaction": {
    "id": "D1733836800000ABC",
    "type": "deposit",
    "type_text": "充值",
    "asset": "USDT",
    "asset_name": "Tether USD",
    "amount": "100.0000000",
    "amount_display": "100.00",
    "valuation_usdt": "100.00",
    "chain": "TRN",
    "chain_name": "Tron (TRC20)",
    "from_address": "T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb",
    "to_address": "TKvjYxxxxxxxxxxx",
    "tx_hash": "abc123def456...",
    "explorer_url": "https://tronscan.org/#/transaction/abc123def456...",
    "status": "confirmed",
    "status_text": "已完成",
    "confirmations": 21,
    "required_confirmations": 20,
    "fee": "0",
    "fee_asset": "",
    "memo": "",
    "created_at": "2025-12-10T10:00:00Z",
    "confirmed_at": "2025-12-10T10:05:00Z",
    "timeline": [
      {
        "status": "pending",
        "time": "2025-12-10T10:00:00Z",
        "description": "交易已发起"
      },
      {
        "status": "confirming",
        "time": "2025-12-10T10:01:00Z",
        "description": "等待链上确认 (5/20)"
      },
      {
        "status": "confirmed",
        "time": "2025-12-10T10:05:00Z",
        "description": "交易已完成"
      }
    ]
  }
}
```

---

## 精度规则

### 金额精度

| 场景 | 精度 | 示例 |
|------|------|------|
| 代币数量 (存储) | 18 位小数 | 100.123456789012345678 |
| 代币数量 (显示-完整) | 7 位小数 | 100.1234567 |
| 代币数量 (显示-简化) | 4 位有效小数 | 100.1234 |
| 法币价值 | 2 位小数 | $100.12 |
| 汇率 | 8 位小数 | 0.10123456 |

### 显示规则

- 资产列表: 简化显示 (4 位有效小数)
- 交易详情: 完整显示 (7 位小数)
- 法币等值: 2 位小数 + 货币符号 (如 ≈ $100.12)
- 小于 0.0001 的金额显示为 "<0.0001"

---

## 交易状态机

### 充值状态

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| pending | 1 | 待确认 (已检测到，等待确认数) |
| confirming | 2 | 确认中 (已有部分确认) |
| confirmed | 3 | 已完成 (达到确认数要求) |
| failed | 4 | 失败 |

### 提现状态

见 [提现功能](./05-提现功能.md) 文档

### 转账状态

见 [内部转账](./06-内部转账.md) 文档

---

## 区块浏览器链接

### 各链区块浏览器

| 链 | 浏览器 | 交易链接格式 |
|----|--------|--------------|
| TRX | Tronscan | `https://tronscan.org/#/transaction/{tx_hash}` |
| BSC | BscScan | `https://bscscan.com/tx/{tx_hash}` |
| ETH | Etherscan | `https://etherscan.io/tx/{tx_hash}` |
