# 闪兑功能

> 返回 [业务服务目录](./README.md)

---

## 模块概述

闪兑功能允许用户在 Web3 钱包中进行代币兑换，通过集成 DEX 聚合器 (如 1inch) 实现最优路由的代币互换。

### 核心能力

- 代币列表查询与支持对查询
- DEX 实时报价 (询价)
- 滑点配置与管理
- 闪兑交易执行
- 交易历史记录

---

## 功能接口

### F-BUS-068: 获取闪兑代币列表

**描述**: 获取当前支持闪兑的代币列表及配置。

**gRPC 方法**: `GetSwapTokens`

**请求 Schema**:
```json
{
  "chain": "ETH",           // 可选：筛选链 (ETH/BSC/TRX)
  "quote_asset": "USDT"     // 可选：报价币种
}
```

**响应 Schema**:
```json
{
  "success": true,
  "tokens": [
    {
      "symbol": "ETH",
      "name": "Ethereum",
      "chain": "ETH",
      "contract_address": "",       // 原生币为空
      "decimals": 18,
      "logo_url": "https://...",
      "is_popular": true,
      "min_swap_amount": "0.01",
      "max_swap_amount": "100"
    }
  ],
  "pairs": [
    {
      "from_symbol": "ETH",
      "to_symbol": "USDT",
      "enabled": true
    }
  ]
}
```

**业务规则**:
- 返回用户钱包地址所在链支持的代币
- 标记热门代币 (`is_popular`) 用于前端排序
- 提供交易对可用性信息
- 未指定链时返回所有链的代币

---

### F-BUS-069: 获取闪兑报价

**描述**: 获取 DEX 实时报价（询价），支持多路由比价。

**gRPC 方法**: `GetSwapQuote`

**请求 Schema**:
```json
{
  "from_asset": "ETH",
  "to_asset": "USDT",
  "from_amount": "1.0",
  "slippage_tolerance": 0.005,  // 滑点容忍度 (0.5%)
  "chain": "ETH"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "quote_id": "QUOTE-1733836800000-ABC",
  "from_asset": "ETH",
  "from_amount": "1.0",
  "to_asset": "USDT",
  "to_amount": "2350.50",           // 预估获得数量
  "exchange_rate": "2350.50",
  "min_receive_amount": "2338.77",  // 最低获得 (含滑点)
  "price_impact": "0.001",          // 价格影响 0.1%
  "fee": {
    "amount": "7.05",
    "asset": "USDT",
    "rate": "0.003"                 // 0.3%
  },
  "dex_provider": "1inch",
  "route": [
    {"from": "ETH", "to": "WETH", "dex": "Uniswap V3", "portion": "100%"},
    {"from": "WETH", "to": "USDT", "dex": "Curve", "portion": "100%"}
  ],
  "expires_at": "2025-12-10T10:00:30Z",
  "gas_estimate": {
    "gas_limit": 250000,
    "gas_price_gwei": "20",
    "native_amount": "0.005"        // 预估 Gas 费
  },
  "warnings": []                    // 价格影响 > 5% 时包含警告
}
```

**业务规则**:
- 报价有效期: 30秒
- 自动选择最优路由
- 价格影响 > 1% 时返回 `low` 级别警告
- 价格影响 > 5% 时返回 `high` 级别警告
- 返回多个 DEX 的比价结果
- 滑点范围: 0.1% ~ 5%

---

### F-BUS-070: 执行闪兑交易

**描述**: 确认并执行闪兑交易。

**gRPC 方法**: `CreateSwap`

**请求 Schema**:
```json
{
  "quote_id": "QUOTE-1733836800000-ABC",
  "verification": {
    "biometric_token": "",
    "google_auth_code": "",
    "trade_password": "123456"
  }
}
```

**响应 Schema**:
```json
{
  "success": true,
  "swap_id": "SWAP-1733836800000-XYZ",
  "status": "processing",
  "status_text": "处理中",
  "from_asset": "ETH",
  "from_amount": "1.0",
  "to_asset": "USDT",
  "to_amount_expected": "2350.50",
  "tx_hash": "0x...",
  "created_at": "2025-12-10T10:00:00Z"
}
```

**业务规则**:
- 需通过身份验证 (按优先级链: FaceID > 2FA > 资金密码)
- 报价过期返回错误码 `SWAP_QUOTE_EXPIRED` (70002)
- 余额不足返回错误码 `SWAP_INSUFFICIENT_BALANCE` (70003)
- 自动扣除 Gas 费和手续费
- 最小兑换金额: 10 USDT 等值
- 创建交易后状态为 `processing`

---

### F-BUS-071: 获取闪兑详情

**描述**: 查询闪兑订单详情。

**gRPC 方法**: `GetSwapDetail`

**请求 Schema**:
```json
{
  "swap_id": "SWAP-1733836800000-XYZ"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "swap": {
    "swap_id": "SWAP-1733836800000-XYZ",
    "status": "completed",
    "status_text": "已完成",
    "from_asset": "ETH",
    "from_chain": "ETH",
    "from_amount": "1.0",
    "to_asset": "USDT",
    "to_chain": "ETH",
    "to_amount_expected": "2350.50",
    "to_amount_actual": "2349.80",
    "exchange_rate": "2349.80",
    "slippage_tolerance": "0.005",
    "slippage_actual": "0.0003",
    "fee": {
      "amount": "7.05",
      "asset": "USDT"
    },
    "gas_fee": {
      "amount": "0.005",
      "asset": "ETH"
    },
    "dex_provider": "1inch",
    "tx_hash": "0x...",
    "confirmations": 12,
    "required_confirmations": 12,
    "created_at": "2025-12-10T10:00:00Z",
    "completed_at": "2025-12-10T10:02:00Z",
    "explorer_url": "https://etherscan.io/tx/0x..."
  }
}
```

**业务规则**:
- 返回订单的完整详情
- 包含实际成交金额与预期的对比
- 包含实际滑点与设置滑点的对比
- 链上确认数需达到要求才标记完成

---

### F-BUS-072: 获取闪兑历史

**描述**: 获取用户的闪兑交易记录列表。

**gRPC 方法**: `ListSwapHistory`

**请求 Schema**:
```json
{
  "page": 1,
  "page_size": 20,
  "status": "",             // 可选: quoting/quoted/processing/completed/failed/cancelled
  "from_asset": "",         // 可选筛选源资产
  "to_asset": "",           // 可选筛选目标资产
  "chain": "",              // 可选筛选链
  "start_time": "",         // 可选时间范围
  "end_time": ""
}
```

**响应 Schema**:
```json
{
  "success": true,
  "swaps": [
    {
      "swap_id": "SWAP-1733836800000-XYZ",
      "status": "completed",
      "status_text": "已完成",
      "from_asset": "ETH",
      "from_amount": "1.0",
      "to_asset": "USDT",
      "to_amount_actual": "2349.80",
      "exchange_rate": "2349.80",
      "created_at": "2025-12-10T10:00:00Z",
      "completed_at": "2025-12-10T10:02:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 50,
    "total_pages": 3,
    "has_next": true,
    "has_prev": false
  }
}
```

**业务规则**:
- 默认按创建时间倒序排列
- 支持多条件筛选
- 列表返回简化信息，详情需调用 GetSwapDetail

---

### F-BUS-073: 取消闪兑

**描述**: 取消未确认的闪兑订单。

**gRPC 方法**: `CancelSwap`

**请求 Schema**:
```json
{
  "swap_id": "SWAP-1733836800000-XYZ"
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "闪兑已取消",
  "swap_id": "SWAP-1733836800000-XYZ",
  "final_status": "cancelled"
}
```

**业务规则**:
- 仅 `quoted` 和 `confirming` 状态可取消
- `pending` 状态已提交验证，不可取消
- `processing` 状态已上链，不可取消
- 取消后资产自动解冻

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 70010 | 闪兑订单不存在 |
| 70011 | 当前状态不可取消 |

---

### F-BUS-074: 获取滑点配置

**描述**: 获取用户的滑点偏好配置。

**gRPC 方法**: `GetSlippageConfig`

**请求 Schema**:
```json
{}
```

**响应 Schema**:
```json
{
  "success": true,
  "slippage_tolerance": 0.005,
  "preset_options": [0.001, 0.005, 0.01, 0.03],
  "min_allowed": 0.001,
  "max_allowed": 0.05,
  "is_custom": false
}
```

**业务规则**:
- 默认滑点: 0.5% (0.005)
- 预设选项: 0.1%, 0.5%, 1%, 3%
- 最小允许: 0.1%
- 最大允许: 5%
- 自定义滑点时 `is_custom` 为 true

---

### F-BUS-075: 设置滑点配置

**描述**: 设置用户的滑点偏好配置。

**gRPC 方法**: `SetSlippageConfig`

**请求 Schema**:
```json
{
  "slippage_tolerance": 0.01    // 设置为 1%
}
```

**响应 Schema**:
```json
{
  "success": true,
  "message": "滑点配置已保存",
  "slippage_tolerance": 0.01
}
```

**业务规则**:
- 滑点值必须在 0.001 (0.1%) 到 0.05 (5%) 之间
- 超出范围返回错误码 `SWAP_INVALID_SLIPPAGE` (70020)
- 配置持久化保存，下次闪兑时自动应用

---

## 闪兑状态机

### 状态定义

| 状态 | 枚举值 | 描述 |
|------|--------|------|
| QUOTING | 1 | 询价中 (获取 DEX 报价) |
| QUOTED | 2 | 已报价 (等待用户确认) |
| CONFIRMING | 3 | 确认中 (用户已确认，等待身份验证) |
| PENDING | 4 | 待处理 (验证通过，准备上链) |
| PROCESSING | 5 | 处理中 (链上交易已广播) |
| COMPLETED | 6 | 已完成 (链上确认成功) |
| FAILED | 7 | 已失败 (交易失败或超时) |
| CANCELLED | 8 | 已取消 (用户取消或报价过期) |
| PARTIAL_FILLED | 9 | 部分成交 (大单分批执行时) |

### 状态流转图

```
                     获取报价
                        │
                        ▼
                 ┌─────────────┐
                 │   QUOTING   │──────────────────┐
                 └──────┬──────┘                  │ 询价失败
                        │ 询价成功                 ▼
                        ▼                   ┌───────────┐
                 ┌─────────────┐            │  FAILED   │
     ┌───────────│   QUOTED    │───────────>└───────────┘
     │           └──────┬──────┘
     │ 报价过期/取消     │ 用户确认
     ▼                   ▼
┌─────────────┐   ┌─────────────┐
│  CANCELLED  │   │ CONFIRMING  │
└─────────────┘   └──────┬──────┘
                         │ 验证通过
                         ▼
                  ┌─────────────┐
                  │   PENDING   │
                  └──────┬──────┘
                         │ 提交上链
                         ▼
                  ┌─────────────┐
                  │ PROCESSING  │
                  └──────┬──────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
          上链成功    链上失败    部分成交
              │          │          │
              ▼          ▼          ▼
       ┌───────────┐ ┌───────────┐ ┌───────────────┐
       │ COMPLETED │ │  FAILED   │ │ PARTIAL_FILLED│
       └───────────┘ └───────────┘ └───────────────┘
```

---

## 错误码定义

| 错误码 | 名称 | 说明 |
|--------|------|------|
| 70001 | SWAP_INVALID_PAIR | 不支持的交易对 |
| 70002 | SWAP_QUOTE_EXPIRED | 报价已过期 |
| 70003 | SWAP_INSUFFICIENT_BALANCE | 余额不足 |
| 70004 | SWAP_AMOUNT_TOO_SMALL | 金额低于最小限制 |
| 70005 | SWAP_AMOUNT_TOO_LARGE | 金额超过最大限制 |
| 70006 | SWAP_HIGH_PRICE_IMPACT | 价格影响过高 |
| 70007 | SWAP_DEX_UNAVAILABLE | DEX 服务不可用 |
| 70008 | SWAP_GAS_INSUFFICIENT | Gas 不足 |
| 70009 | SWAP_VERIFICATION_FAILED | 身份验证失败 |
| 70010 | SWAP_NOT_FOUND | 闪兑订单不存在 |
| 70011 | SWAP_CANNOT_CANCEL | 当前状态不可取消 |
| 70020 | SWAP_INVALID_SLIPPAGE | 滑点设置无效 |
| 70021 | SWAP_ROUTE_NOT_FOUND | 未找到可用路由 |

---

## 闪兑配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 默认滑点 | 0.5% | 用户未设置时的默认值 |
| 最大滑点 | 5% | 允许设置的最大滑点 |
| 报价有效期 | 30秒 | 报价超时时间 |
| 最小兑换金额 | 10 USDT | 等值最小金额 |
| 手续费率 | 0.3% | 平台收取的手续费 |
| 高价格影响阈值 | 5% | 超过此阈值需用户确认 |

---

## DEX 集成

### 支持的 DEX 聚合器

| 提供商 | 支持链 | 说明 |
|--------|--------|------|
| 1inch | ETH, BSC | 主要聚合器 |
| Paraswap | ETH, BSC | 备选聚合器 |
| Jupiter | - | 预留 Solana 支持 |

### 路由选择策略

1. **最优价格优先**: 比较多个 DEX 的报价，选择用户收益最高的路由
2. **Gas 优化**: 在价格相近时，选择 Gas 消耗较低的路由
3. **流动性考虑**: 大额交易自动拆分到多个 DEX 执行

---

## 通知触发

| 事件 | 通知类型 | 渠道 |
|------|----------|------|
| 闪兑成功 | swap | APP推送 + 站内信 |
| 闪兑失败 | swap | APP推送 + 站内信 |
| 部分成交 | swap | APP推送 + 站内信 |

---

> 返回 [业务服务目录](./README.md)
