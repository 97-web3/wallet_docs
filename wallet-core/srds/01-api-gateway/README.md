# API 网关 - 软件需求文档

## 1. 模块概述

### 1.1 用途

API 网关是 Internal-Wallet 系统的统一入口，负责将外部 HTTP 请求路由到内部 gRPC 微服务，同时提供认证、授权、限流、日志等横切关注点的统一处理。

### 1.2 系统架构中的角色

```
客户端 (Web/Mobile/API)
         │
         ▼ HTTP/HTTPS
┌─────────────────────────────────────┐
│           API Gateway               │
│  ┌───────────────────────────────┐  │
│  │        中间件链               │  │
│  │  Recovery → RequestID →       │  │
│  │  Logging → CORS → RateLimit → │  │
│  │  Auth → Router                │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
         │ gRPC
         ▼
┌────────┬────────┬────────┬────────┐
│Business│ChainRPC│ChainSync│ Signer │
│ Service│ Service│ Service │Service │
└────────┴────────┴────────┴────────┘
```

### 1.3 服务依赖

| 依赖 | 类型 | 用途 |
|------|------|------|
| ETCD | 基础设施 | 服务发现 |
| Redis | 基础设施 | 分布式限流 |
| Business Service | gRPC | 业务逻辑 |
| ChainRPC Service | gRPC | 区块链操作 |
| ChainSync Service | gRPC | 区块链同步 |
| Signer Service | gRPC | 交易签名 |

---

## 2. 文档列表

| 文档 | 描述 |
|------|------|
| [01-路由与转发](./01-路由与转发.md) | YAML 路由配置、HTTP 到 gRPC 转换 |
| [02-认证中间件](./02-认证中间件.md) | JWT Token 认证 |
| [03-速率限制](./03-速率限制.md) | 全局/IP/用户/验证码限流、限流响应头 |
| [04-CORS与直接API](./04-CORS与直接API.md) | CORS 配置、验证码服务、健康检查 |
| [05-日志与追踪](./05-日志与追踪.md) | 请求日志、分布式追踪 |
| [06-异常处理](./06-异常处理.md) | 黑名单检查、Panic 恢复、统一错误响应 |
| [07-HTTP规范](./07-HTTP规范.md) | HTTP 状态码、分页、错误响应 Schema |
| [08-Token刷新](./08-Token刷新.md) | Token 刷新机制 |
| [09-路由列表](./09-路由列表.md) | HTTP 路由列表 |
| [99-依赖与配置](./99-依赖与配置.md) | 外部库、基础设施要求、配置文件、安全 |

---

## 3. 中间件链顺序

```
请求进入
    │
    ▼
┌───────────────┐
│   Recovery    │  ← Panic 恢复
└───────────────┘
    │
    ▼
┌───────────────┐
│  Request ID   │  ← 生成/提取请求 ID
└───────────────┘
    │
    ▼
┌───────────────┐
│   Logging     │  ← 请求日志
└───────────────┘
    │
    ▼
┌───────────────┐
│     CORS      │  ← 跨域处理
└───────────────┘
    │
    ▼
┌───────────────┐
│  Rate Limit   │  ← 速率限制
└───────────────┘
    │
    ▼
┌───────────────┐
│     Auth      │  ← JWT 认证 (可选)
└───────────────┘
    │
    ▼
┌───────────────┐
│  Blacklist    │  ← 黑名单检查 (需认证)
└───────────────┘
    │
    ▼
┌───────────────┐
│    Router     │  ← 路由匹配
└───────────────┘
    │
    ▼
┌───────────────┐
│  gRPC Call    │  ← 调用后端服务
└───────────────┘
    │
    ▼
响应返回
```

**说明**: 黑名单检查中间件仅对需要认证的路由生效，位于 Auth 之后、Router 之前。
