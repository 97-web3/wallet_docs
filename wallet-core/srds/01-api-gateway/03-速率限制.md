# 速率限制

## F-GW-004: 全局速率限制

**描述**: 基于令牌桶算法的全局请求限流。

**配置**:
```yaml
RateLimit:
  Enable: true
  GlobalRate: 1000    # 每秒请求数
  GlobalBurst: 2000   # 突发容量
```

---

## F-GW-005: IP 级别限流

**描述**: 按客户端 IP 地址进行独立限流。

**实现**:
- 从 `X-Forwarded-For` 或 `X-Real-IP` 获取真实 IP
- 每个 IP 独立计数器
- 支持 Redis 分布式存储

**路由配置示例**:
```yaml
- path: /api/v1/auth/login
  rate_limit: 5
  rate_limit_type: ip
```

---

## F-GW-006: 用户级别限流

**描述**: 按认证用户进行独立限流，需要开启认证。

**实现**:
- 从 JWT Token 提取用户 ID
- 每个用户独立计数器
- 需要 Redis 支持

**路由配置示例**:
```yaml
- path: /api/v1/transfer/internal
  auth: true
  rate_limit: 20
  rate_limit_type: user
```

---

## F-GW-007: 验证码发送限流

**描述**: 验证码接口的特殊限流规则，防止滥用。

**限流规则**:
| 限制类型 | 限制值 | 说明 |
|----------|--------|------|
| 发送间隔 | 60 秒 | 同一手机号/邮箱 60 秒内只能发送一次 |
| 小时限制 | 5 次/小时 | 同一手机号/邮箱每小时最多 5 次 |
| 日限制 | 20 次/天 | 同一手机号/邮箱每天最多 20 次 |
| IP 限制 | 30 次/小时 | 同一 IP 每小时最多 30 次 |

**实现**:
```yaml
- path: /api/v1/auth/send-code
  rate_limit_rules:
    - type: target          # 目标手机号/邮箱
      interval: 60          # 60秒发送间隔
      max_requests: 1
    - type: target_hourly
      interval: 3600
      max_requests: 5
    - type: target_daily
      interval: 86400
      max_requests: 20
    - type: ip_hourly
      interval: 3600
      max_requests: 30
```

**超限响应**:
```json
{
  "code": 429,
  "message": "发送过于频繁，请60秒后重试",
  "retry_after": 45,
  "request_id": "abc123"
}
```

---

## F-GW-017: 速率限制响应头

**描述**: 所有 API 响应包含限流相关 Header，便于客户端了解当前限流状态。

**响应头字段**:

| Header | 说明 | 示例值 |
|--------|------|--------|
| X-RateLimit-Limit | 时间窗口内允许的最大请求数 | 100 |
| X-RateLimit-Remaining | 剩余可用请求数 | 95 |
| X-RateLimit-Reset | 限流重置时间 (Unix 时间戳) | 1702300860 |
| Retry-After | 需等待的秒数 (仅限流时返回) | 60 |

**正常响应示例**:
```
HTTP/1.1 200 OK
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1702300860
Content-Type: application/json
```

**触发限流时的响应**:
```
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1702300860
Retry-After: 60
Content-Type: application/json

{
  "success": false,
  "code": 1004,
  "message": "请求过于频繁，请稍后重试",
  "retry_after": 60,
  "request_id": "req-20251210-abc123"
}
```
