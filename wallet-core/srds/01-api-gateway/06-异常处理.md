# 异常处理

## F-GW-013: 黑名单检查中间件

**描述**: 检查请求用户是否在黑名单中，黑名单用户禁止访问系统。

**实现位置**: 在 Auth 中间件之后，Router 之前

**检查流程**:
1. 从 JWT Token 提取用户 ID
2. 查询 Redis 黑名单缓存 (key: `blacklist:user:{user_id}`)
3. 缓存未命中时查询数据库
4. 黑名单用户返回 403 并强制 Token 失效

**响应格式**:
```json
{
  "code": 403,
  "message": "账户已被禁用",
  "reason": "违规操作",
  "request_id": "abc123"
}
```

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_BLACKLISTED | 403 | 账户在黑名单中 |
| AUTH_FORCE_LOGOUT | 401 | 强制登出 (Token 已失效) |

**配置**:
```yaml
Blacklist:
  Enable: true
  CacheTTL: 300        # 缓存 5 分钟
  ForceLogout: true    # 黑名单用户强制登出
```

---

## 黑名单场景详细处理

### 黑名单类型

| 类型 | Redis Key | 说明 |
|------|-----------|------|
| UID 黑名单 | `blacklist:user:{uid}` | 用户账户级别黑名单 |
| 钱包地址黑名单 | `blacklist:address:{address}` | 链上地址黑名单 |
| IP 黑名单 | `blacklist:ip:{ip}` | IP 地址黑名单 |

### UID 黑名单处理

**登录时检测**:
```
用户提交登录
    │
    ▼
┌─────────────────┐
│ 查询 UID 黑名单  │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 在黑名单 │ 不在黑名单
    ▼         ▼
 返回 BL001  继续登录流程
 拒绝登录
```

**已登录用户检测**:
- 管理员将用户加入黑名单后，后台发送 Redis 消息
- API Gateway 订阅消息，立即失效该用户所有 Token
- 用户下次请求时返回 401 强制登出

### 钱包地址黑名单处理

**检测时机**:
- 充值地址监控
- 提现目标地址
- 内部转账收款地址
- 平台绑定地址

**处理流程**:
1. 任何操作检测到黑名单地址
2. 立即记录审计日志
3. 强制用户登出
4. 返回 BL002 错误码

### 绑定操作限制

黑名单 UID 尝试绑定/解绑操作时：
- 返回 BL003 错误码
- 提示: "您的账户已被限制，无法执行此操作"
- 记录尝试日志

### 黑名单错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| BL001 | 403 | UID 在黑名单中，拒绝登录 |
| BL002 | 403 | 涉及黑名单地址，强制登出 |
| BL003 | 403 | 黑名单用户尝试绑定操作 |

### 强制登出流程

```
检测到黑名单
    │
    ▼
┌─────────────────────┐
│ 删除用户所有 Token   │
│ (Redis DEL pattern) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 记录审计日志         │
│ - 黑名单类型        │
│ - 触发时间          │
│ - 触发操作          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 返回 401/403 响应    │
│ 客户端跳转登录页     │
└─────────────────────┘
```

---

## F-GW-014: Panic 恢复

**描述**: 捕获处理过程中的 panic，防止服务崩溃。

**行为**:
- 捕获 panic
- 记录堆栈信息
- 返回 500 Internal Server Error

---

## F-GW-015: 统一错误响应

**描述**: 标准化的错误响应格式。

**错误响应格式**:
```json
{
  "code": 401,
  "message": "Unauthorized",
  "request_id": "abc123"
}
```
