# 异常处理

## F-GW-013: 黑名单检查中间件

**描述**: 检查请求用户是否在黑名单中，黑名单用户禁止访问系统。

**实现位置**: 在 Auth 中间件之后，Router 之前

**检查流程**:
1. 从 JWT Token 提取用户 ID
2. 查询 Redis 黑名单缓存 (key: `blacklist:user:{user_id}`)
3. 缓存未命中时查询数据库
4. 黑名单用户返回 403 并强制 Token 失效

**响应格式**:
```json
{
  "code": 403,
  "message": "账户已被禁用",
  "reason": "违规操作",
  "request_id": "abc123"
}
```

**错误码**:
| 错误码 | HTTP 状态 | 描述 |
|--------|-----------|------|
| AUTH_BLACKLISTED | 403 | 账户在黑名单中 |
| AUTH_FORCE_LOGOUT | 401 | 强制登出 (Token 已失效) |

**配置**:
```yaml
Blacklist:
  Enable: true
  CacheTTL: 300        # 缓存 5 分钟
  ForceLogout: true    # 黑名单用户强制登出
```

---

## F-GW-014: Panic 恢复

**描述**: 捕获处理过程中的 panic，防止服务崩溃。

**行为**:
- 捕获 panic
- 记录堆栈信息
- 返回 500 Internal Server Error

---

## F-GW-015: 统一错误响应

**描述**: 标准化的错误响应格式。

**错误响应格式**:
```json
{
  "code": 401,
  "message": "Unauthorized",
  "request_id": "abc123"
}
```
