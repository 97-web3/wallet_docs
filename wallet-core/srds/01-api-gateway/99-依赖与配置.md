# 依赖与配置

## 1. 外部库

| 库 | 版本 | 用途 |
|----|------|------|
| github.com/zeromicro/go-zero | 1.6.0 | 微服务框架 |
| google.golang.org/grpc | 1.75.0 | gRPC 客户端 |
| github.com/golang-jwt/jwt/v4 | 4.5.1 | JWT 处理 |
| github.com/mojocn/base64Captcha | 1.3.8 | 验证码生成 |
| github.com/redis/go-redis/v9 | 9.17.0 | Redis 客户端 |

---

## 2. 基础设施要求

| 组件 | 要求 | 用途 |
|------|------|------|
| ETCD | 3.5+ | 服务发现 |
| Redis | 7.x | 分布式限流 |

---

## 3. 完整配置文件

**文件**: `api-gateway/etc/gateway.yaml`

```yaml
Name: api-gateway
Mode: dev

# HTTP 服务配置
Host: 0.0.0.0
Port: 8080

# 日志配置
Log:
  ServiceName: api-gateway
  Mode: file
  Path: logs/gateway
  Level: info
  Compress: true
  KeepDays: 7
  StackCooldownMillis: 100

# JWT 认证配置
Auth:
  AccessSecret: ${JWT_ACCESS_SECRET}
  AccessExpire: 86400
  RefreshSecret: ${JWT_REFRESH_SECRET}
  RefreshExpire: 604800

# RPC 服务发现
AccountRpc:
  Etcd:
    Hosts:
      - localhost:2379
    Key: account.rpc
  Timeout: 30000

# Redis 配置
Redis:
  Host: localhost
  Port: 6379
  Password: ${REDIS_PASSWORD}
  DB: 0

# 限流配置
RateLimit:
  Enable: true
  UseRedis: true
  GlobalRate: 1000
  GlobalBurst: 2000

# 请求超时
RequestTimeout: 30000

# CORS 配置
Cors:
  AllowOrigins:
    - "*"
  AllowMethods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "PATCH"
    - "OPTIONS"
  AllowHeaders:
    - "Content-Type"
    - "Authorization"
    - "X-Request-ID"
    - "X-Trace-ID"
  ExposeHeaders:
    - "X-Request-ID"
    - "X-Trace-ID"
  AllowCredentials: true
  MaxAge: 86400
```

---

## 4. 环境变量

| 变量 | 描述 | 默认值 |
|------|------|--------|
| JWT_ACCESS_SECRET | JWT 签名密钥 | 配置文件值 |
| REDIS_HOST | Redis 地址 | localhost |
| REDIS_PORT | Redis 端口 | 6379 |
| REDIS_PASSWORD | Redis 密码 | - |

---

## 5. 安全考量

### 5.1 已知问题摘要

| 问题 ID | 级别 | 描述 | 参考 |
|---------|------|------|------|
| CRITICAL-02 | 严重 | 硬编码的加密密码和基础设施密钥 | `docs/security-issues/CRITICAL-02-*.md` |
| HIGH-02 | 高危 | JWT 密钥未强制执行或验证 | `docs/security-issues/HIGH-02-*.md` |
| MEDIUM-01 | 中危 | CORS 通配符配合凭证 | `docs/security-issues/MEDIUM-01-*.md` |
| MEDIUM-02 | 中危 | 基于 IP 的速率限制依赖不受信任的标头 | `docs/security-issues/MEDIUM-02-*.md` |

### 5.2 安全建议

1. **生产环境必须更换 JWT 密钥**: 使用强随机密钥替换默认配置
2. **限制 CORS 源**: 生产环境不应使用 `*`，应配置具体域名
3. **使用 HTTPS**: 生产环境必须启用 TLS
4. **配置反向代理**: 在可信反向代理后获取真实 IP
