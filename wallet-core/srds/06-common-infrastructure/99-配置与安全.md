# 配置与安全

## 1. 配置文件示例

### 1.1 数据库配置

```yaml
MySQL:
  Host: localhost
  Port: 3306
  Username: root
  Password: ${MYSQL_PASSWORD}
  Database: crypto_exchange
  MaxIdleConns: 10
  MaxOpenConns: 100
  ConnMaxLifetime: 3600
  SlowThreshold: 200
  LogLevel: 2
```

### 1.2 Redis 配置

```yaml
Redis:
  Host: localhost:6379
  Password: ${REDIS_PASSWORD}
  DB: 0
```

### 1.3 ETCD 配置

```yaml
Etcd:
  Hosts:
    - localhost:2379
  Key: business.rpc
```

---

## 2. 安全考量

### 2.1 已知安全问题

> 以下安全问题引用自 `docs/SECURITY_ISSUES.md`

#### CRITICAL-02: 硬编码的加密密码

- **位置**: `common/utils/crypto_signer.go` (概念上)
- **描述**: 如果密码在代码或配置中硬编码，种子加密将失去意义
- **影响**: 加密种子可被轻易解密
- **建议**:
  - 使用 HSM 或密钥管理服务存储密码
  - 实施密码轮换机制

#### HIGH-01: 弱用户密码哈希

- **位置**: `common/utils/crypto.go`
- **描述**: 使用 SHA256 + Salt 而非 bcrypt/argon2
- **影响**: 密码哈希易受暴力破解
- **建议**: 迁移到 bcrypt 或 argon2id

**当前实现**:
```go
func HashPassword(password, salt string) string {
    return SHA256Hash(password + salt)
}
```

**建议实现**:
```go
func HashPassword(password string) (string, error) {
    return bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
}
```

#### HIGH-02: JWT 密钥未强制执行

- **位置**: `common/middleware/auth.go`
- **描述**: JWT 密钥依赖配置，可能使用弱密钥
- **影响**: 弱密钥可被暴力破解，导致 Token 伪造
- **建议**:
  - 强制最小密钥长度 (32 字节)
  - 启动时验证密钥强度

#### MEDIUM-03: Docker 暴露弱凭证

- **位置**: `deploy/docker/docker-compose.yml`
- **描述**: 使用弱默认密码
  - MariaDB: root123456
  - Redis: redis123456
  - Grafana: admin123456
- **影响**: 开发环境凭证泄露到生产环境
- **建议**:
  - 使用环境变量或 secrets 管理
  - 强制生产环境密码策略

### 2.2 安全最佳实践

1. **密钥管理**:
   - 种子加密密码应存储在 HSM 或密钥管理服务
   - JWT 密钥应定期轮换
   - 避免在代码或配置文件中硬编码密钥

2. **密码存储**:
   - 迁移到 bcrypt (cost factor >= 10)
   - 或使用 argon2id

3. **速率限制**:
   - 登录接口应有更严格的限制
   - 敏感操作应有独立的限制配置

4. **日志安全**:
   - 不记录敏感信息 (密码、密钥、种子)
   - 实施日志访问控制

---

## 3. Kafka Topic 定义

| Topic | 用途 |
|-------|------|
| trade-events | 交易事件 |
| matching-events | 撮合事件 |
| wallet-events | 钱包事件 |
| market-events | 市场事件 |
| settlement-events | 结算事件 |
| risk-events | 风控事件 |

---

## 4. 环境变量

| 变量 | 说明 | 示例 |
|------|------|------|
| MYSQL_ROOT_PASSWORD | MariaDB root 密码 | (使用强密码) |
| REDIS_PASSWORD | Redis 密码 | (使用强密码) |
| GF_SECURITY_ADMIN_PASSWORD | Grafana 管理员密码 | (使用强密码) |
| JWT_SECRET | JWT 签名密钥 | (至少 32 字节随机字符串) |
| SEED_ENCRYPTION_PASSWORD | 种子加密密码 | (至少 32 字符强密码) |
