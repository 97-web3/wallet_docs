# 数据访问层 (repository/)

## F-REPO-001: 泛型基础 Repository

- **描述**: 基于 GORM 的泛型数据访问层
- **文件**: `common/repository/base_repository.go`
- **功能**:
  - 泛型 CRUD 操作
  - 软删除支持
  - 乐观锁版本控制
  - 分页查询
  - 事务支持

---

## 接口定义

```go
type BaseRepository[T any] interface {
    // 基础 CRUD
    Create(ctx context.Context, entity *T) error
    CreateMultiple(ctx context.Context, entities []*T) error
    FindByID(ctx context.Context, id int64) (*T, error)
    Update(ctx context.Context, entity *T) error
    UpdateFields(ctx context.Context, id int64, fields map[string]interface{}) error
    Delete(ctx context.Context, id int64) error
    SoftDelete(ctx context.Context, id int64) error

    // 查询
    FindAll(ctx context.Context) ([]*T, error)
    FindByCondition(ctx context.Context, condition map[string]interface{}) ([]*T, error)
    Count(ctx context.Context, condition map[string]interface{}) (int64, error)
    Exists(ctx context.Context, id int64) (bool, error)

    // 分页
    FindWithPagination(ctx context.Context, page, pageSize int, condition map[string]interface{}) ([]*T, int64, error)

    // 事务支持
    WithTx(tx *gorm.DB) BaseRepository[T]
    GetDB() *gorm.DB
}
```

---

## 使用方式

```go
// 创建 Repository
userRepo := repository.NewBaseRepository[User](db)

// CRUD 操作
user, err := userRepo.FindByID(ctx, 123)
err := userRepo.Create(ctx, &user)
err := userRepo.SoftDelete(ctx, 123)

// 分页查询
users, total, err := userRepo.FindWithPagination(ctx, 1, 10, map[string]interface{}{
    "status = ?": 1,
})

// 事务
tx := db.Begin()
txRepo := userRepo.WithTx(tx)
// ... 操作
tx.Commit()
```
