# 中间件 (middleware/)

## F-MW-001: JWT 认证中间件

- **描述**: 基于 JWT 的用户身份认证
- **文件**: `common/middleware/auth.go`
- **功能**:
  - 从 Authorization Header 提取 Bearer Token
  - 验证 JWT 签名和有效期
  - 将用户信息 (user_id, email) 注入 Context
  - 支持可选认证模式 (OptionalJWTAuth)

**JWT Claims 结构**:
```go
type JWTClaims struct {
    UserID string `json:"user_id"`
    Email  string `json:"email"`
    jwt.RegisteredClaims
}
```

**使用方式**:
```go
// 必须认证
router.Use(middleware.JWTAuth(jwtSecret))

// 可选认证
router.Use(middleware.OptionalJWTAuth(jwtSecret))

// 从 Context 获取用户信息
userID := middleware.GetUserID(ctx)
email := middleware.GetEmail(ctx)
```

---

## F-MW-002: CORS 跨域中间件

- **描述**: 处理跨域资源共享请求
- **文件**: `common/middleware/cors.go`
- **功能**:
  - 配置允许的 Origin、Methods、Headers
  - 处理 OPTIONS 预检请求
  - 支持通配符域名匹配
  - 可配置凭证和缓存时间

**默认配置**:
```go
CORSConfig{
    AllowOrigins:     []string{"*"},
    AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"},
    AllowHeaders:     []string{"Content-Type", "Authorization", "X-Request-ID", "X-Trace-ID"},
    ExposeHeaders:    []string{"X-Request-ID", "X-Trace-ID"},
    AllowCredentials: true,
    MaxAge:           86400,  // 24小时
}
```

---

## F-MW-003: 全局速率限制

- **描述**: 基于令牌桶算法的全局限流
- **文件**: `common/middleware/ratelimit.go`
- **功能**:
  - 控制系统整体请求速率
  - 可配置每秒请求数和突发容量
  - 返回 429 Too Many Requests

**使用方式**:
```go
// 每秒 1000 个请求，突发 2000
router.Use(middleware.RateLimit(1000, 2000))
```

---

## F-MW-004: IP 级速率限制

- **描述**: 基于客户端 IP 的限流
- **文件**: `common/middleware/ratelimit.go`
- **功能**:
  - 每个 IP 独立的限流器
  - 自动清理不活跃的限流器
  - 支持 X-Forwarded-For 解析

**使用方式**:
```go
ipLimiter := middleware.NewIPRateLimiter(100, 200, time.Hour)
router.Use(ipLimiter.Middleware())
```

---

## F-MW-005: 用户级速率限制

- **描述**: 基于用户 ID 的限流（需在 JWT 中间件之后使用）
- **文件**: `common/middleware/ratelimit.go`
- **功能**:
  - 每个用户独立的限流器
  - 未认证请求跳过限流
  - 防止单用户滥用

**使用方式**:
```go
userLimiter := middleware.NewUserRateLimiter(50, 100)
router.Use(userLimiter.Middleware())
```

---

## F-MW-006: 异常恢复中间件

- **描述**: 捕获 Panic 并返回友好错误
- **文件**: `common/middleware/recovery.go`
- **功能**:
  - 捕获所有 Panic
  - 记录堆栈信息到日志
  - 返回 500 Internal Server Error
  - 支持自定义处理器

**日志记录字段**:
- error: Panic 信息
- stack: 堆栈追踪
- method: HTTP 方法
- path: 请求路径
- ip: 客户端 IP

---

## F-MW-007: 请求日志中间件

- **描述**: 记录 HTTP 请求日志
- **文件**: `common/middleware/logging.go`
- **功能**:
  - 基础日志: 方法、路径、状态码、耗时
  - 详细日志: 包含请求头、User-Agent、Referer
  - 访问日志: Nginx 风格格式

**日志字段**:
```json
{
    "method": "POST",
    "path": "/api/v1/login",
    "query": "redirect=/dashboard",
    "status": 200,
    "duration": 45,
    "size": 1024,
    "ip": "192.168.1.1",
    "user_agent": "Mozilla/5.0...",
    "user_id": "123456789"
}
```
