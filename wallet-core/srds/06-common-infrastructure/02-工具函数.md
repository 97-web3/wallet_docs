# 工具函数 (utils/)

## F-UTIL-001: 通用加密哈希

- **描述**: MD5 和 SHA256 哈希工具
- **文件**: `common/utils/crypto.go`
- **功能**:
  - MD5 哈希
  - SHA256 哈希
  - 密码哈希 (SHA256 + Salt)
  - 密码验证

**函数签名**:
```go
func MD5Hash(data string) string
func SHA256Hash(data string) string
func HashPassword(password, salt string) string
func VerifyPassword(password, salt, hashedPassword string) bool
```

---

## F-UTIL-002: 种子加密工具

- **描述**: HD 钱包种子的安全加密/解密
- **文件**: `common/utils/crypto_signer.go`
- **功能**:
  - AES-256-GCM 加密
  - PBKDF2 密钥派生 (100,000 次迭代)
  - 32 字节随机盐值
  - SHA256 完整性校验

**加密流程**:
1. 生成 32 字节随机盐值
2. 使用 PBKDF2 从密码派生 32 字节密钥
3. 创建 AES-256-GCM 加密器
4. 生成随机 Nonce
5. 加密数据
6. 计算原始种子的 SHA256 哈希

**加密结果结构**:
```go
type EncryptSeedResult struct {
    Encrypted []byte // 加密后的数据
    Salt      []byte // 盐值
    IV        []byte // IV/Nonce
    Hash      string // SHA256哈希
}
```

**函数签名**:
```go
func EncryptSeed(seed []byte, password string) (*EncryptSeedResult, error)
func DecryptSeed(encrypted []byte, salt []byte, password string) ([]byte, error)
func HashSeed(seed []byte) string
func VerifySeedHash(seed []byte, expectedHash string) bool
func GenerateRandomSeed(seedLength int) ([]byte, error)
func GenerateStrongPassword(length int) (string, error)
```

---

## F-UTIL-003: 雪花 ID 生成器

- **描述**: 分布式唯一 ID 生成
- **文件**: `common/utils/snowflake.go`
- **功能**:
  - 41 位时间戳 + 10 位机器 ID + 12 位序列号
  - 支持 1024 台机器
  - 每毫秒最多 4096 个 ID
  - 时钟回拨检测

**ID 结构** (63 位):
```
┌─────────────────────────────────────────────────────────────────┐
│ 1 位符号 │    41 位时间戳     │  10 位机器ID │   12 位序列号    │
└─────────────────────────────────────────────────────────────────┘
```

**使用方式**:
```go
// 服务启动时初始化 (每个服务使用不同的 machineID)
utils.Init(1)  // business-rpc: 1

// 生成 ID
id := utils.GenerateID()           // int64
idStr := utils.GenerateIDString()  // string (推荐，避免 JS 精度问题)
```

**推荐的机器 ID 分配**:
| 服务 | Machine ID |
|------|------------|
| business-rpc | 1 |
| chainrpc-rpc | 2 |
| chainsync-rpc | 3 |
| signer-rpc | 4 |

---

## F-UTIL-004: 验证码生成器

- **描述**: 验证码生成、存储和验证
- **文件**: `common/code/code.go`
- **功能**:
  - 生成随机数字验证码
  - 存储到 Redis 并设置过期时间
  - 验证用户输入
  - 验证后删除（一次性使用）

**Redis Key 格式**:
```
{codeType}:code:{recipient}:{scene}
例如: email:code:user@example.com:register
```

**支持的场景**:
- register: 注册
- login: 登录
- reset_password: 重置密码
- withdraw: 提现
