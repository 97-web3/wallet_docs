# 通用库与基础设施 - 软件需求文档

## 1. 模块概述

### 1.1 用途

通用库与基础设施模块提供系统所有服务共享的基础功能，包括中间件、工具函数、数据模型、缓存封装、常量定义、错误码、数据访问层等。此外，本文档还涵盖系统运行所需的基础设施组件。

### 1.2 系统架构中的角色

```
┌─────────────────────────────────────────────────────────────────┐
│                         服务层                                   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │
│  │ Business  │ │ ChainRPC  │ │ ChainSync │ │  Signer   │        │
│  │  Service  │ │  Service  │ │  Service  │ │  Service  │        │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │
│        │             │             │             │               │
└────────┼─────────────┼─────────────┼─────────────┼───────────────┘
         │             │             │             │
         └─────────────┴──────┬──────┴─────────────┘
                              │
┌─────────────────────────────┼────────────────────────────────────┐
│                        common/ 模块                               │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │                    middleware/                            │   │
│  │  ┌─────────┐ ┌──────┐ ┌───────────┐ ┌──────────┐ ┌─────┐ │   │
│  │  │  Auth   │ │ CORS │ │ RateLimit │ │ Recovery │ │ Log │ │   │
│  │  └─────────┘ └──────┘ └───────────┘ └──────────┘ └─────┘ │   │
│  └───────────────────────────────────────────────────────────┘   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │                      utils/                               │   │
│  │  ┌────────┐ ┌──────────────┐ ┌───────────┐ ┌───────────┐  │   │
│  │  │ Crypto │ │ CryptoSigner │ │ Snowflake │ │ Validator │  │   │
│  │  └────────┘ └──────────────┘ └───────────┘ └───────────┘  │   │
│  └───────────────────────────────────────────────────────────┘   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐    │
│  │  model/   │ │  cache/   │ │ constants/│ │  repository/  │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────────┘    │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐    │
│  │ errcode/  │ │    db/    │ │   code/   │ │ interceptor/  │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────────┘    │
└──────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼────────────────────────────────────┐
│                        基础设施层                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │ MariaDB  │ │  Redis   │ │  Kafka   │ │   ETCD   │ │ Jaeger │ │
│  │  10.11   │ │    7     │ │   7.5    │ │  3.5.9   │ │        │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│  ┌──────────────────────────┐ ┌──────────────────────────────┐   │
│  │       Prometheus         │ │          Grafana             │   │
│  └──────────────────────────┘ └──────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

### 1.3 服务依赖

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| github.com/zeromicro/go-zero | v1.6.0 | 微服务框架 |
| gorm.io/gorm | latest | ORM 框架 |
| github.com/redis/go-redis/v9 | v9 | Redis 客户端 |
| github.com/golang-jwt/jwt/v4 | v4 | JWT 处理 |
| golang.org/x/crypto/pbkdf2 | latest | 密钥派生 |
| golang.org/x/time/rate | latest | 限流 |

---

## 2. 文档列表

| 文档 | 描述 |
|------|------|
| [01-中间件](./01-中间件.md) | JWT、CORS、速率限制、Recovery、日志 |
| [02-工具函数](./02-工具函数.md) | 加密哈希、种子加密、雪花ID、验证码 |
| [03-数据模型](./03-数据模型.md) | BaseModel、BaseModelWithUser |
| [04-缓存封装](./04-缓存封装.md) | Redis 缓存、分布式锁 |
| [05-常量定义](./05-常量定义.md) | 业务状态、Redis Key |
| [06-错误码](./06-错误码.md) | 全系统错误码规范 |
| [07-数据访问层](./07-数据访问层.md) | 泛型 Repository |
| [08-数据库连接](./08-数据库连接.md) | GORM 初始化 |
| [09-基础设施](./09-基础设施.md) | Docker Compose、各组件配置 |
| [99-配置与安全](./99-配置与安全.md) | 配置示例、安全考量、环境变量 |

---

## 3. 目录结构

```
common/
├── cache/
│   └── redis_cache.go        # Redis 缓存封装
├── captcha/
│   └── captcha.go            # 图形验证码
├── code/
│   └── code.go               # 验证码生成器
├── constants/
│   ├── constants.go          # 业务常量
│   ├── redis.go              # Redis Key 常量
│   └── signer.go             # 签名服务常量
├── db/
│   ├── config.go             # 数据库配置
│   └── gorm.go               # GORM 初始化
├── enum/
│   └── accountType.go        # 账户类型枚举
├── errcode/
│   └── signer.go             # 签名服务错误码
├── interceptor/
│   ├── example_usage.go      # 拦截器示例
│   └── metadata.go           # gRPC 元数据拦截器
├── middleware/
│   ├── auth.go               # JWT 认证
│   ├── common.go             # 通用工具函数
│   ├── cors.go               # CORS 中间件
│   ├── logging.go            # 日志中间件
│   ├── metadata.go           # 元数据中间件
│   ├── ratelimit.go          # 限流中间件
│   ├── recovery.go           # 异常恢复
│   └── redis_ratelimit.go    # Redis 限流
├── model/
│   └── base_model.go         # 基础模型
├── models/
│   └── wallet.go             # 钱包模型
├── repository/
│   └── base_repository.go    # 泛型 Repository
└── utils/
    ├── config_finder.go      # 配置文件查找
    ├── crypto.go             # 通用加密
    ├── crypto_signer.go      # 种子加密
    ├── response.go           # HTTP 响应工具
    ├── snowflake.go          # 雪花 ID
    ├── tracing.go            # 链路追踪
    └── validator.go          # 输入验证
```
