# Qinglan Internal-Wallet 代码审查报告（2025-12-14）

## 一、审查范围

- 仓库：Internal-Wallet
- 分支：main
- 时间范围：2025-12-07 ~ 2025-12-14 期间 Qinglan（Git Author）相关提交
- 主要模块：
  - 助记词验证挑战与备份记录
  - Token 启动验证与 JWT 校验
  - 签名服务 IP 白名单与安全拦截
  - 网关/签名服务相关安全增强

---

## 二、主要工作概览

### 2.1 助记词验证挑战功能

- 代表性提交：`8775334` 等
- 代码变化量：
  - 新增约 1,287 行，删除约 190 行，净增约 1,100+ 行
- 完成内容：
  - 实现“获取助记词验证挑战”的 RPC 接口逻辑；
  - 新增 `mnemonic_backup` 表对应的 model 与 repository：
    - `services/signer/rpc/internal/models/mnemonic_backup.go`
    - `services/signer/rpc/internal/repository/mnemonic_backup_repo.go`
  - 结合签名服务，对用户助记词备份/验证流程提供后端支撑。

### 2.2 Token 启动验证与 IP 白名单

- 代表性提交：`561dca7` 等
- 完成内容：
  - 增加网关 token 初始化验证拦截器；
  - 增加签名服务 IP 白名单拦截器；
  - 引入更安全的 JWT 验证逻辑（解决“token 过于简单”的问题）。
- 新增/关键文件：
  - `common/interceptor/ip_whitelist.go`
  - `common/utils/jwt_validator.go`

### 2.3 签名服务与充值地址查询优化

- 其他工作：
  - 优化签名服务中 seed 初始化与地址生成接口的解密逻辑；
  - 增加对外用户充值地址查询接口；
  - 进一步完善 signer 服务与业务服务之间的边界与调用方式。

---

## 三、安全设计与代码质量评价

### 3.1 安全性

- 优点：
  - 使用 IP 白名单对 signer 服务进行保护，有效减少外部直接攻击面；
  - 引入统一的 JWT 校验工具，避免在各处手写验证逻辑导致的不一致；
  - 助记词挑战与备份记录逻辑，将“助记词展示/验证”收敛在 signer 服务内部，有利于安全边界控制。
- 风险与建议：
  - 建议确保 IP 白名单配置来源为环境/配置中心，而非硬编码；
  - 建议对 JWT 校验失败的原因进行分类统计（签名错误、过期、黑名单等），便于安全审计。

### 3.2 业务契合度

- 与原计划任务对比：
  - 原计划中“继续开发并测试 TRON 交易逻辑、自建节点对接”等工作，实际主要由 King 完成；
  - Qinglan 则集中完成了“助记词挑战、token 启动验证、IP 白名单”等安全相关任务；
- 评价：
  - 虽与原分配有所交叉，但从项目角度看，安全防护能力得到显著增强，价值较高；
  - 助记词 challenge / backup 逻辑为后续“安全检查清单”中的高优先级功能之一。

---

## 四、风险与待办

1. **配置与环境管理**
   - 问题：IP 白名单、JWT 秘钥、助记词相关加密参数对环境依赖较强；
   - 建议：
     - 将相关敏感配置全部下沉到配置文件或环境变量；
     - 敏感参数避免写死在代码中，配合配置管理与密钥管理系统使用。

2. **审计与监控**
   - 建议：
     - 对挑战接口、token 校验失败、IP 拦截等事件统一打点、记录日志；
     - 后续可在监控平台中增加相应告警规则（例如短时间内失败次数异常升高）。

3. **文档完善**
   - 建议：
     - 为助记词挑战流程输出一份端到端时序图和状态机说明；
     - 为 IP 白名单与 JWT 校验配置编写运维文档（如何新增 IP、如何滚动更换密钥等）。

---

## 五、总体评价

- 完成度：
  - 助记词验证挑战、JWT 校验、IP 白名单等关键安全模块已落地，实现度高；
  - 与原计划的 TRON 工作发生任务互换，但从项目整体视角看分工合理。
- 质量：
  - 安全边界设计清晰，抽象合理；
  - 后续主要工作为加强配置管理与监控告警，提升可运维性。

> 综上，Qinglan 本阶段工作的重点在于“把关入口安全与密钥相关流程”，为后续在生产环境安全运行打下了重要基础。