# 发送代币_3(交易确认) - 软件需求规格说明书

## 1. 页面标识
- **页面名称**: 发送代币-交易确认页
- **页面ID**: SEND_TRANSACTION_CONFIRM_001
- **页面描述/用途**: 显示交易详情供用户最终确认,包括发送金额、接收地址、Gas费等信息

## 2. UI组件
### 2.1 布局概述
页面采用垂直布局,顶部显示发送图标和金额,中部显示交易详情卡片,底部为操作按钮。使用深色网格背景。

### 2.2 组件详情
| 组件名称 | 组件类型 | 位置 | 描述 |
|---------|---------|------|------|
| 状态栏 | 系统组件 | 顶部 | 显示时间(9:41)、信号、WiFi和电池状态 |
| 返回按钮 | 图标按钮 | 左上角 | 左箭头,返回上一页 |
| 网格背景 | 背景装饰 | 全屏 | 深色网格线背景 |
| 发送图标 | 图标 | 上部中心 | 向上箭头,绿色渐变 |
| 发送文字 | 标题文本 | 图标下方 | "发送" |
| 发送金额 | 大文本 | 中上部 | "-0.0001 ETH",白色大号字体 |
| 法币等值 | 文本标签 | 金额下方 | "¥ 213",灰色小字 |
| 详情卡片 | 容器 | 中部 | 深色背景卡片 |
| Gas费标签 | 文本标签 | 卡片内 | "Ethereum网络费用" |
| Gas费金额 | 文本标签 | 标签右侧 | "0.00001 ETH(VO.23)" |
| 右箭头 | 图标 | Gas费行右侧 | 可能点击调整Gas |
| 发送地址标签 | 文本标签 | 卡片内 | "发送地址" |
| 发送地址值 | 文本标签 | 标签下方 | 完整地址,分两行显示 |
| 地址别名 | 标签 | 地址下方 | "钱包C-账户01"灰色小字 |
| 复制按钮 | 图标按钮 | 地址行右侧 | 复制图标 |
| 收款地址标签 | 文本标签 | 卡片内 | "收款地址" |
| 收款地址值 | 文本标签 | 标签下方 | 完整地址 |
| 拒绝按钮 | 次要按钮 | 底部左侧 | 深色按钮,"拒绝" |
| 确认按钮 | 主要按钮 | 底部右侧 | 亮绿色按钮,"确认" |

## 3. 功能需求
### 3.1 主要功能
- 显示完整的交易详情
- 展示发送金额和法币等值
- 显示网络手续费(Gas费)
- 显示发送地址(来源)和收款地址(目标)
- 支持复制地址
- 提供Gas费调整选项(点击右箭头)
- 最终确认或拒绝交易
- 交易前的最后一次检查和确认

### 3.2 业务逻辑
- 交易详情汇总:整合前几步输入的信息
- Gas费计算:显示预估的网络费用
- 地址验证:再次确认发送和接收地址
- 余额最终检查:确保余额充足
- 交易签名准备:用户确认后进行签名
- 拒绝后返回:可返回上一步修改

## 4. 用户交互
### 4.1 用户操作
| 操作 | 触发条件 | 响应 |
|-----|---------|------|
| 点击返回按钮 | 单击 | 返回输入金额页面 |
| 点击Gas费行 | 单击 | 打开Gas费调整页面 |
| 点击复制按钮(发送地址) | 单击 | 复制发送地址到剪贴板 |
| 点击复制按钮(收款地址) | 单击 | 复制收款地址到剪贴板 |
| 点击拒绝按钮 | 单击 | 取消交易,返回首页或上一页 |
| 点击确认按钮 | 单击 | 签名并广播交易,进入发送中页面 |

### 4.2 导航流程
- 输入金额页 → 此页面(交易确认)
- 交易确认页 → Gas费调整页面(可选)
- 交易确认页 → 交易发送中页面
- 交易确认页 → 拒绝 → 返回首页

### 4.3 手势操作
- 单击:选择和操作
- **禁止滑动确认/拒绝**：为防止误操作导致不可逆的资产损失，本页面**禁止**使用滑动手势进行交易确认或拒绝。所有确认操作必须通过明确的按钮点击完成。

## 5. 数据需求
### 5.1 数据展示
| 数据字段 | 数据类型 | 描述 |
|---------|---------|------|
| 发送金额 | Decimal | 要发送的代币数量 |
| 代币符号 | String | 代币符号(ETH) |
| 法币等值 | Decimal | 发送金额的法币价值 |
| Gas费(代币) | Decimal | 手续费的代币数量 |
| Gas费(法币) | Decimal | 手续费的法币价值 |
| Gas价格 | Integer | Gas Price (Gwei) |
| Gas限制 | Integer | Gas Limit |
| 发送地址 | String | 交易发起地址 |
| 收款地址 | String | 交易接收地址 |
| 地址别名 | String | 地址的自定义名称 |
| 网络名称 | String | 区块链网络名称 |
| Nonce | Integer | 交易序号 |

### 5.2 数据输入
- 用户确认/拒绝决定
- Gas费调整(可选)

### 5.3 数据来源
- 前序步骤:代币类型、金额、收款地址
- 区块链节点:Gas费估算、Nonce
- 本地钱包:发送地址、私钥(签名用)
- 价格API:法币换算

## 6. 验证规则
### 6.1 交易前验证
- 余额充足:金额+Gas费<=余额
- 地址有效:发送和接收地址格式正确
- Gas费合理:在合理范围内
- Nonce正确:防止交易顺序错误
- 网络状态:确保节点连接正常

### 6.2 错误处理
- 余额不足:禁用确认按钮,显示提示
- Gas费过高:警告用户当前网络拥堵
- Gas费过低:警告可能导致交易失败
- 网络连接失败:显示"网络连接失败,请检查"
- 签名失败:显示"交易签名失败"
- Nonce错误:自动重新获取或提示用户

## 7. 技术考量
### 7.1 状态管理
- 交易详情状态(金额、地址、Gas等)
- 确认状态(pending/confirmed/rejected)
- Gas费调整状态
- 签名状态
- 广播状态
- 错误状态

### 7.2 API集成
- 区块链RPC节点
  - eth_estimateGas:估算Gas
  - eth_getTransactionCount:获取Nonce
  - eth_gasPrice:获取Gas价格
  - eth_sendRawTransaction:广播交易
- 价格API:法币换算
- 交易历史服务:记录交易

### 7.3 安全考量
- 私钥保护:签名时确保私钥安全
- 交易验证:二次确认所有参数
- 防重放攻击:正确使用Nonce
- **大额交易额外确认**（必须实现）:
  - 交易金额 > $500 USD等值：显示额外确认对话框"您即将发送大额资产，请再次确认"
  - 交易金额 > $5000 USD等值：**必须**进行生物识别验证（FaceID/TouchID/密码）
  - 交易金额 > $50000 USD等值：显示24小时冷却期选项，或要求输入完整密码
- 地址确认:显示完整地址供核对
- **地址对比验证**：如收款地址与最近使用的地址不同，高亮显示差异部分（防止剪贴板劫持攻击）
- 网络确认:确保在正确的网络上交易
- 签名安全:使用安全的签名方法
- **禁止滑动确认**：交易确认必须通过明确的按钮点击，禁止滑动手势

## 8. Gas费说明
### 8.1 Gas费组成
- Gas Price (Gwei):单位Gas的价格
- Gas Limit:交易消耗的Gas数量
- 总Gas费 = Gas Price × Gas Limit

### 8.2 费用显示
- 代币单位:如"0.00001 ETH"
- 法币单位:如"(¥0.23)"
- 双重显示便于用户理解

### 8.3 调整选项
- 点击Gas费行可调整:
  - 慢速(低费用)
  - 标准(推荐)
  - 快速(高费用)
  - 自定义

## 9. 交易签名
### 9.1 签名流程
- 构造交易对象
- 使用私钥签名交易
- 生成签名后的原始交易数据
- 准备广播到网络

### 9.2 签名方式
- 软件签名:直接使用私钥
- 硬件钱包:通过硬件设备签名
- 多签钱包:需要多方签名

## 10. 验收标准
- [ ] 所有交易详情正确显示
- [ ] 发送金额准确无误
- [ ] Gas费计算正确
- [ ] 发送地址和收款地址完整显示
- [ ] 法币等值准确
- [ ] 复制按钮功能正常
- [ ] Gas费行可点击调整
- [ ] 拒绝按钮功能正常
- [ ] 确认按钮功能正常
- [ ] 余额不足时禁用确认按钮
- [ ] 确认后能成功签名交易
- [ ] 网络错误有适当提示
- [ ] **大额交易(>$500)显示额外确认对话框**
- [ ] **大额交易(>$5000)要求生物识别验证**
- [ ] **收款地址与历史地址不同时高亮显示差异**
- [ ] **禁止滑动手势确认交易**
- [ ] 返回按钮功能正常
- [ ] 地址别名正确显示
- [ ] 网络名称正确显示
- [ ] 在不同屏幕尺寸下正常显示
- [ ] 暗黑主题和网格背景正确渲染
- [ ] 所有文字清晰可读

## 11. 无障碍访问要求
- [ ] 所有文本颜色对比度符合WCAG 2.1 AA标准（最低4.5:1）
- [ ] 按钮和可交互元素最小触摸目标为44x44pt
- [ ] 支持屏幕阅读器，所有UI元素有适当的无障碍标签
- [ ] 金额和地址信息可被屏幕阅读器正确朗读
- [ ] 确认对话框出现时焦点自动移至对话框内
- [ ] 支持键盘导航（适用于平板/桌面设备）
