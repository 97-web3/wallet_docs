# 闪兑确认页面 - 软件需求规格说明书

## 1. 页面标识

| 属性 | 值 |
|------|-----|
| 页面ID | 38 |
| 页面名称 | 闪兑确认页面 |
| 版本 | 1.0 |
| 更新日期 | 2025-12-09 |
| 状态 | 草稿 |

### 功能描述

用户确认闪兑交易详情，使用本地私钥签名后提交交易。展示完整的交易信息供用户最终确认。

> 相关规格: [COMMON-002 验证方式规则](../common/verification-method-rules.md) | [COMMON-006 术语表](../common/glossary.md)

### 交易签名（非托管模式）

闪兑交易使用本地私钥进行签名，流程如下：
1. **FaceID 验证**：用于解锁本地安全存储的私钥（若设备支持且用户开启）
2. **私钥签名**：使用本地私钥对交易进行签名
3. **广播交易**：将签名后的交易广播到区块链网络

> 注：与托管钱包不同，非托管钱包的交易签名完全在本地完成，无需服务端验证。

---

## 2. UI组件

### 2.1 布局概述

页面采用垂直布局，顶部导航栏，中部为交易详情卡片，底部为确认按钮。采用深色主题。

### 2.2 组件详情

| 组件 | 类型 | 描述 | 位置 |
|------|------|------|------|
| 返回按钮 | 图标按钮 | 左箭头 | 左上角 |
| 页面标题 | 文本标签 | "确认兑换" | 标题栏中央 |
| 交易详情卡片 | 卡片组件 | 展示完整交易信息 | 中部 |
| 支付金额 | 文本标签 | 支付的源代币数量 | 卡片内 |
| 源代币图标 | 图片 | 源代币 Logo | 支付金额左侧 |
| 箭头图标 | 图标 | 向下箭头表示兑换方向 | 卡片中部 |
| 获得金额 | 文本标签 | 预估获得的目标代币数量 | 卡片内 |
| 目标代币图标 | 图片 | 目标代币 Logo | 获得金额左侧 |
| 分隔线 | 线条 | 分隔主要信息和详情 | 卡片内 |
| 汇率信息 | 文本标签 | "汇率: 1 XXX ≈ x.xx YYY" | 详情区 |
| 滑点信息 | 文本标签 | "滑点容差: x%" | 详情区 |
| 最小获得 | 文本标签 | "最小获得: x.xxxxxxx YYY" | 详情区 |
| Gas费信息 | 文本标签 | "网络费用: x.xxxx ETH (≈$x.xx)" | 详情区 |
| 网络信息 | 文本标签 | "网络: Ethereum" | 详情区 |
| 提示卡片 | 提示组件 | 交易提示信息，带警告图标 | 卡片下方 |
| 确认并支付按钮 | 主按钮 | "确认并支付"，荧光绿色 | 底部 |

---

## 3. 功能需求

### FR-38-01: 显示交易详情

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-01 |
| **描述** | 展示完整的闪兑交易信息 |
| **验收标准** | 1. **假设** 进入确认页, **当** 加载完成, **则** 显示支付金额、获得金额、汇率、滑点、Gas费等完整信息<br>2. **假设** 金额显示, **当** 渲染, **则** 遵循代币精度规则（7位小数）<br>3. **假设** Gas费显示, **当** 渲染, **则** 同时显示原生代币单位和法币等值 |
| **优先级** | 必须 |

### FR-38-02: 汇率有效期验证

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-02 |
| **描述** | 验证汇率报价是否仍然有效 |
| **验收标准** | 1. **假设** 汇率报价过期, **当** 点击确认, **则** 提示"汇率已过期，请重新获取"并返回上一页<br>2. **假设** 页面停留时间, **当** 超过报价有效期（默认60秒）, **则** 自动提示汇率过期 |
| **优先级** | 必须 |

### FR-38-03: FaceID 解锁私钥

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-03 |
| **描述** | 使用 FaceID 解锁本地安全存储的私钥 |
| **验收标准** | 1. **假设** 用户点击"确认并支付", **当** 设备支持 FaceID 且用户已开启, **则** 弹出 FaceID 验证<br>2. **假设** FaceID 验证成功, **当** 完成, **则** 解锁私钥并进入签名流程<br>3. **假设** 设备不支持 FaceID, **当** 点击确认, **则** 直接使用本地 PIN 或钱包密码解锁私钥 |
| **优先级** | 必须 |

### FR-38-04: 本地私钥签名

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-04 |
| **描述** | 使用本地私钥对交易进行签名 |
| **验收标准** | 1. **假设** 私钥解锁成功, **当** 签名, **则** 使用对应网络的签名算法签署交易<br>2. **假设** 签名过程中, **当** 等待, **则** 显示加载状态"签名中..."<br>3. **假设** 签名完成, **当** 成功, **则** 自动广播交易到区块链网络 |
| **优先级** | 必须 |

### FR-38-05: 交易广播

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-05 |
| **描述** | 将签名后的交易广播到区块链 |
| **验收标准** | 1. **假设** 交易签名成功, **当** 广播, **则** 将交易发送到区块链节点<br>2. **假设** 广播成功, **当** 完成, **则** 跳转至闪兑结果页 (39)<br>3. **假设** 广播过程中, **当** 等待, **则** 显示加载状态，禁用按钮防止重复提交 |
| **优先级** | 必须 |

### FR-38-06: 签名/广播失败处理

| 字段 | 内容 |
|------|------|
| **ID** | FR-38-06 |
| **描述** | 处理签名或广播失败情况 |
| **验收标准** | 1. **假设** FaceID 验证失败, **当** 连续3次, **则** 提示使用备用解锁方式（PIN/密码）<br>2. **假设** 签名失败, **当** 发生, **则** 提示"交易签名失败，请重试"<br>3. **假设** 广播失败, **当** 发生, **则** 提示具体错误（如网络拥堵、Gas 不足等） |
| **优先级** | 必须 |

---

## 4. 用户交互

### 4.1 用户工作流

1. 查看交易详情（支付金额、获得金额、费用）
2. 确认信息无误
3. 点击"确认并支付"
4. 完成 FaceID 验证（解锁私钥）
5. 等待交易签名
6. 等待交易广播
7. 跳转至结果页

### 4.2 导航流程

```
闪兑详情 (37) → 闪兑确认 (38) → FaceID验证 → 签名 → 广播 → 闪兑结果 (39)
                     ↓
               点击返回 → 37
```

### 4.3 私钥签名流程

```
点击确认
    ↓
检查私钥保护设置
    ↓
┌─ FaceID 已开启 → 弹出 FaceID 验证
│        ↓ 成功
├─ 解锁安全存储的私钥
│        ↓
└─ 使用私钥签名交易
         ↓
    广播交易到区块链
         ↓
    跳转结果页
```

---

## 5. 数据需求

### 5.1 显示数据

| 数据项 | 数据类型 | 说明 |
|--------|---------|------|
| 支付金额 | Decimal | 源代币数量 |
| 获得金额 | Decimal | 目标代币数量 |
| 汇率 | String | 格式: "1 XXX ≈ x.xxxxxxx YYY" |
| 滑点 | String | 格式: "x%" |
| 最小获得 | Decimal | 考虑滑点后的最小获得量 |
| Gas费 | String | 原生代币 + 法币等值 |
| 网络名称 | String | 区块链网络名称 |

### 5.2 传入数据

从上一页 (37) 传入：
- 源代币信息
- 目标代币信息
- 支付金额
- 汇率报价
- 滑点设置
- Gas 估算
- 报价有效期

---

## 6. 验证规则

### 6.1 业务规则

| 规则 | 说明 |
|------|------|
| 汇率有效期 | 报价超过 60 秒后失效 |
| 私钥访问 | FaceID / PIN / 钱包密码解锁 |
| 防重复提交 | 签名/广播中禁用确认按钮 |

### 6.2 错误处理

| 场景 | 提示 |
|------|------|
| 汇率过期 | "汇率已过期，请重新获取" |
| FaceID 失败 | "验证失败，请重试或使用其他方式" |
| 签名失败 | "交易签名失败，请重试" |
| Gas 不足 | "Gas 余额不足，请确保有足够的 [原生代币]" |
| 广播失败 | "交易广播失败，请重试" |
| 网络拥堵 | "网络繁忙，请稍后重试或提高 Gas 费" |

---

## 7. 技术考虑

### 7.1 安全要求

- 私钥存储在本地安全区域（Keychain/Keystore）
- 私钥解密使用硬件安全模块
- 签名过程完全在本地完成
- 私钥永不离开设备

### 7.2 签名算法

| 网络 | 签名算法 |
|------|---------|
| ETH | secp256k1 + Keccak256 |
| BNB | secp256k1 + Keccak256 |
| TRX | secp256k1 + SHA256 |

### 7.3 API 集成

| 接口 | 说明 |
|------|------|
| RPC 广播接口 | 发送签名交易到区块链节点 |
| 交易状态查询 | 查询交易确认状态 |

### 7.4 状态管理

- 按钮状态（正常 / 验证中 / 签名中 / 广播中 / 禁用）
- FaceID 验证弹窗状态
- 错误信息状态

---

## 8. 验收标准汇总

1. ✅ 正确显示完整的交易详情
2. ✅ 汇率过期时正确提示
3. ✅ FaceID 验证流程正常
4. ✅ 私钥签名流程正常
5. ✅ 交易广播功能正常
6. ✅ 签名/广播过程显示加载状态
7. ✅ 防止重复提交
8. ✅ 错误处理完善（Gas 不足、网络拥堵等）
9. ✅ 交易成功后正确跳转
10. ✅ UI 符合设计稿

---

## 9. 无障碍访问要求

- [ ] 交易详情可被屏幕阅读器完整朗读
- [ ] FaceID 验证有语音提示
- [ ] 错误提示有足够的颜色对比度
- [ ] 按钮状态变化有视觉反馈

---

*文档创建日期: 2025-12-09*
