# 发送代币_5(发送失败或处理中) - 软件需求规格说明书

## 1. 页面标识
- **页面名称**: 发送代币-交易处理/失败页
- **页面ID**: SEND_PROCESSING_FAILED_001
- **页面描述/用途**: 处理交易发送过程中的各种状态,包括发送中、失败等情况(基于原型图推断)

## 2. 页面说明
**注意**: 根据提供的原型图"发送代币_5.png",此页面与"发送代币_4.png"(发送成功页)视觉上非常相似。以下基于常见钱包应用的设计模式,推断可能的差异状态。

## 3. 可能的状态页面

### 3.1 状态一:交易发送中
#### UI组件
| 组件名称 | 组件类型 | 描述 |
|---------|---------|------|
| 加载图标 | 动画图标 | 旋转的加载动画或进度图标 |
| 状态标题 | 标题文本 | "交易发送中..." 或 "处理中..." |
| 状态描述 | 文本标签 | "正在将交易提交到区块链网络" |
| 交易哈希 | 文本标签 | 显示交易哈希(如已获得) |
| 等待提示 | 文本标签 | "这可能需要几秒钟到几分钟" |
| 取消按钮 | 次要按钮 | "取消"(某些情况下可能支持) |

#### 功能需求
- 显示交易正在广播到网络
- 显示加载动画
- 可能显示预估等待时间
- 防止用户重复提交
- 后台持续监控交易状态

### 3.2 状态二:交易失败
#### UI组件
| 组件名称 | 组件类型 | 描述 |
|---------|---------|------|
| 失败图标 | 图标 | 红色X或错误图标 |
| 失败标题 | 标题文本 | "交易失败" |
| 失败原因 | 文本标签 | 具体的失败原因描述 |
| 错误代码 | 文本标签 | 技术错误信息(可折叠) |
| 重试按钮 | 主要按钮 | "重试" |
| 返回按钮 | 次要按钮 | "返回主页" |

#### 功能需求
- 显示失败原因
- 提供重试选项
- 记录失败交易
- 不扣除余额
- 提供技术支持信息

## 4. 常见失败原因
### 4.1 用户侧原因
- Gas费过低
- 余额不足(Gas费)
- Nonce错误
- 交易被用户取消
- 网络连接中断

### 4.2 网络侧原因
- 网络拥堵
- RPC节点故障
- 智能合约执行失败
- Gas limit过低
- 交易被网络拒绝

### 4.3 其他原因
- 收款地址无效
- 代币合约问题
- 交易已被替换
- 交易超时

## 5. 用户交互
### 5.1 发送中状态操作
| 操作 | 触发条件 | 响应 |
|-----|---------|------|
| 等待 | 自动 | 显示加载动画,等待交易广播 |
| 点击取消 | 单击(如支持) | 尝试取消交易(仅在未广播时) |
| 后台切换 | 切换应用 | 继续监控,返回时显示最新状态 |

### 5.2 失败状态操作
| 操作 | 触发条件 | 响应 |
|-----|---------|------|
| 点击重试 | 单击 | 返回交易确认页,可调整参数重试 |
| 点击返回 | 单击 | 返回钱包主页 |
| 查看详情 | 单击 | 展开完整错误信息 |
| 联系支持 | 单击 | 打开客服或反馈渠道 |

## 6. 数据需求
### 6.1 发送中状态数据
| 数据字段 | 数据类型 | 描述 |
|---------|---------|------|
| 交易哈希 | String | 交易ID(如已获得) |
| 发送时间 | DateTime | 交易提交时间 |
| 预估等待时间 | Integer | 预估的确认时间(秒) |
| 当前状态 | Enum | processing/pending |
| Gas价格 | Integer | 使用的Gas价格 |

### 6.2 失败状态数据
| 数据字段 | 数据类型 | 描述 |
|---------|---------|------|
| 失败原因 | String | 用户友好的失败描述 |
| 错误代码 | String | 技术错误代码 |
| 错误详情 | String | 完整的错误信息 |
| 失败时间 | DateTime | 失败发生时间 |
| 可重试 | Boolean | 是否可以重试 |

## 7. 技术考量
### 7.1 状态管理
- 交易发送状态(processing/pending/failed)
- 重试次数限制
- 错误信息状态
- 超时处理
- 页面保活(防止息屏导致状态丢失)

### 7.2 错误处理机制
- 捕获并分类错误
- 用户友好的错误提示
- 技术错误日志记录
- 自动重试策略(某些错误)
- 错误上报(用于改进)

### 7.3 API集成
- 区块链RPC节点
  - 广播交易:eth_sendRawTransaction
  - 查询交易:eth_getTransactionByHash
  - 查询回执:eth_getTransactionReceipt
- 错误分析服务
- 日志上报服务

## 8. 超时处理
### 8.1 超时策略
- 广播超时:30秒
- 确认超时:10分钟(可配置)
- 超时后状态:标记为pending或failed
- 后台持续监控:即使超时也继续跟踪

### 8.2 超时提示
- "交易提交时间较长,请稍候"
- "可以先返回,交易会在后台继续"
- 提供查看交易状态的入口

## 9. 重试机制
### 9.1 重试条件
- 网络错误:可重试
- Gas费不足:需调整后重试
- Nonce错误:自动修正后重试
- 合约错误:不可重试,需修改参数

### 9.2 重试流程
- 分析失败原因
- 提供调整建议
- 返回确认页面
- 允许修改参数
- 重新提交交易

## 10. 用户体验优化
### 10.1 加载状态
- 使用动画减少等待感
- 显示进度提示
- 提供背景处理选项
- 避免界面冻结

### 10.2 失败处理
- 友好的错误提示
- 明确的解决方案
- 快速重试选项
- 技术支持入口

### 10.3 通知机制
- 发送中:前台显示进度
- 后台时:推送通知
- 成功/失败:通知用户

## 11. 安全考量
- 私钥保护:交易失败后私钥仍需保护
- 重试验证:重试时重新验证余额
- 防重放:使用正确的Nonce
- 超时保护:超时后不泄露敏感信息

## 12. 验收标准
### 12.1 发送中状态
- [ ] 正确显示加载状态
- [ ] 加载动画流畅
- [ ] 状态描述清晰
- [ ] 可以后台处理
- [ ] 超时有适当提示
- [ ] 交易哈希正确显示(如有)

### 12.2 失败状态
- [ ] 失败原因清晰易懂
- [ ] 失败图标正确显示
- [ ] 重试按钮功能正常
- [ ] 返回按钮功能正常
- [ ] 错误详情可查看
- [ ] 技术错误信息准确
- [ ] 不可重试的情况有明确说明
- [ ] 失败不扣除用户余额

### 12.3 通用标准
- [ ] 状态切换流畅
- [ ] 在不同屏幕尺寸下正常显示
- [ ] 暗黑主题样式正确
- [ ] 所有文字清晰可读
- [ ] 后台切换后状态保持正确
