# 验证方式规则 - 公共规格文档

## 1. 文档标识

| 属性 | 值 |
|------|-----|
| 文档ID | COMMON-002 |
| 文档名称 | 验证方式规则 |
| 版本 | 1.0 |
| 更新日期 | 2025-12-08 |
| 适用范围 | 中心化钱包、去中心化钱包 |

---

## 2. 验证方式概述

### 2.1 支持的验证方式

| 优先级 | 验证方式 | 说明 |
|--------|----------|------|
| **A (最高)** | 生物识别 (FaceID/TouchID) | 设备原生生物识别 |
| **B** | Google Authenticator (2FA) | 6位TOTP动态码 |
| **C (最低)** | 资金密码 | 6位数字密码 |

### 2.2 验证模式

**替代验证模式**：任意一种验证方式通过即可继续操作，不要求顺序验证或多重验证。

---

## 3. 自动选择逻辑

### 3.1 优先级选择规则

当用户触发需要验证的操作时，系统按以下优先级自动选择验证方式：

```
┌─────────────────────────────────────────────────────────────┐
│                    触发验证操作                               │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
            ┌─────────────────────────────┐
            │ 用户已开启生物识别 &&         │
            │ 设备支持生物识别?             │
            └──────────────┬──────────────┘
                   是 │          │ 否
                      ▼          ▼
            ┌──────────────┐   ┌─────────────────────────────┐
            │ 调起生物识别   │   │ 用户已绑定 Google 2FA?      │
            │ (优先级 A)    │   └──────────────┬──────────────┘
            └──────────────┘          是 │          │ 否
                                         ▼          ▼
                               ┌──────────────┐   ┌──────────────┐
                               │ 显示2FA输入框 │   │ 显示资金密码  │
                               │ (优先级 B)    │   │ 输入框        │
                               └──────────────┘   │ (优先级 C)    │
                                                  └──────────────┘
```

### 3.2 选择逻辑代码

```javascript
/**
 * 获取当前可用的最高优先级验证方式
 * @param {Object} userSettings - 用户设置
 * @param {Object} deviceCapabilities - 设备能力
 * @returns {string} 验证方式: 'biometric' | '2fa' | 'password'
 */
function getPreferredVerificationMethod(userSettings, deviceCapabilities) {
  // 优先级 A: 生物识别
  if (userSettings.biometricEnabled && deviceCapabilities.supportsBiometric) {
    return 'biometric';
  }

  // 优先级 B: Google 2FA
  if (userSettings.google2FAEnabled) {
    return '2fa';
  }

  // 优先级 C: 资金密码
  return 'password';
}
```

---

## 4. 各验证方式规格

### 4.1 生物识别 (FaceID/TouchID)

| 规格项 | 说明 |
|--------|------|
| 前提条件 | 用户已在设置中开启生物识别 |
| 设备要求 | iOS: FaceID 或 TouchID; Android: 指纹或面部识别 |
| 超时时间 | 30秒 |
| 失败处理 | 失败3次后自动降级到下一优先级 |
| 取消操作 | 用户可手动选择其他验证方式 |

### 4.2 Google Authenticator (2FA)

| 规格项 | 说明 |
|--------|------|
| 前提条件 | 用户已绑定 Google Authenticator |
| 码长度 | 6位数字 |
| 有效期 | 30秒（标准TOTP） |
| 输入错误限制 | 5次错误后锁定15分钟 |
| 时间容差 | 允许前后1个时间窗口 |

### 4.3 资金密码

| 规格项 | 说明 |
|--------|------|
| 前提条件 | 用户已设置资金密码 |
| 格式要求 | 6位数字 |
| 输入错误限制 | 5次错误后锁定15分钟 |
| 重置方式 | 需通过身份验证重置 |

---

## 5. 降级与切换流程

### 5.1 自动降级

| 触发条件 | 降级行为 |
|----------|----------|
| 生物识别连续失败3次 | 自动切换到 2FA（若已绑定）或资金密码 |
| 2FA 输入错误5次 | 锁定15分钟，显示倒计时 |
| 资金密码输入错误5次 | 锁定15分钟，显示倒计时 |

### 5.2 手动切换

用户可在验证界面手动选择其他可用的验证方式：
- 生物识别界面：显示"使用其他方式验证"链接
- 2FA界面：显示"使用资金密码验证"链接
- 资金密码界面：显示"使用其他方式验证"链接（若有可用）

---

## 6. 需要验证的业务场景

### 6.1 中心化钱包

| 业务操作 | 验证要求 |
|----------|----------|
| 提现到链上地址 | 必须验证 |
| 内部划转 | 必须验证 |
| 修改资金密码 | 必须验证 + 原密码验证 |
| 绑定/解绑平台账户 | 必须验证 |
| 修改手机号/邮箱 | 必须验证 |

### 6.2 去中心化钱包

| 业务操作 | 验证要求 |
|----------|----------|
| 发送代币 | 必须验证 |
| 查看助记词/私钥 | 必须验证 |
| 删除钱包账户 | 必须验证 |
| 导出私钥 | 必须验证 |

---

## 7. UI 交互规范

### 7.1 验证弹窗设计

```
┌────────────────────────────────────────┐
│              安全验证                    │
├────────────────────────────────────────┤
│                                        │
│            [FaceID 图标]                │
│                                        │
│         请使用面容 ID 验证               │
│                                        │
│    ─────────────────────────────       │
│                                        │
│         使用其他方式验证 >               │
│                                        │
├────────────────────────────────────────┤
│            [ 取消 ]                     │
└────────────────────────────────────────┘
```

### 7.2 错误状态提示

| 场景 | 提示文案 |
|------|----------|
| 生物识别失败 | "验证失败，请重试" |
| 生物识别3次失败 | "验证失败次数过多，请使用其他方式" |
| 2FA 错误 | "验证码错误，请重新输入" |
| 2FA 5次错误 | "错误次数过多，请15分钟后重试" |
| 资金密码错误 | "资金密码错误，请重新输入" |
| 资金密码5次错误 | "错误次数过多，请15分钟后重试" |

---

## 8. 验收标准

- [ ] 系统按 FaceID > 2FA > 资金密码 优先级自动选择验证方式
- [ ] 任意一种验证方式通过即可继续操作
- [ ] 生物识别失败3次后自动降级
- [ ] 2FA/资金密码错误5次后锁定15分钟
- [ ] 用户可手动切换到其他可用验证方式
- [ ] 所有需要验证的业务场景均正确触发验证流程
- [ ] 验证失败时显示明确的错误提示

---

*文档创建日期: 2025-12-08*
