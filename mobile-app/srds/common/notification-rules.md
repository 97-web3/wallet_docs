# 推送通知规则 - 通用规格文档

## 文档标识

| 属性 | 值 |
|------|-----|
| 文档ID | COMMON-007 |
| 文档名称 | 推送通知规则 |
| 版本 | 1.0 |
| 创建日期 | 2025-12-09 |
| 状态 | 草稿 |

### 概述

本文档定义了钱包应用中所有推送通知的触发规则、通知内容和渠道配置。

> 相关规格: [COMMON-006 术语表](./glossary.md)

---

## 1. 通知渠道

| 渠道 | 说明 | 适用场景 |
|------|------|---------|
| APP 推送 | 移动端推送通知 | 即时通知、交易状态 |
| 站内信 | 应用内消息中心 | 详细信息、记录保存 |
| 短信 | SMS 短信 | 安全验证、重要提醒 |
| 邮件 | 电子邮件 | 账单、安全警告 |

---

## 2. 通知分类

### 2.1 交易类通知

| 通知ID | 事件 | 触发条件 | 渠道 | 优先级 |
|--------|------|---------|------|--------|
| TX-001 | 充值到账 | 链上确认完成 | APP推送 + 站内信 | 高 |
| TX-002 | 提现成功 | 链上交易完成 | APP推送 + 站内信 | 高 |
| TX-003 | 提现失败 | 交易回滚或超时 | APP推送 + 站内信 | 高 |
| TX-004 | 划转成功 | 内部划转完成 | APP推送 | 中 |
| TX-005 | 闪兑成功 | Swap 交易完成 | APP推送 + 站内信 | 高 |
| TX-006 | 闪兑失败 | Swap 交易失败 | APP推送 + 站内信 | 高 |

### 2.2 审核类通知

| 通知ID | 事件 | 触发条件 | 渠道 | 优先级 |
|--------|------|---------|------|--------|
| AUD-001 | 提现审核通过 | 审核人员批准 | APP推送 | 高 |
| AUD-002 | 提现审核驳回 | 审核人员驳回 | APP推送 + 站内信 | 高 |
| AUD-003 | 审核进行中 | 提交审核申请 | APP推送 | 中 |

### 2.3 安全类通知

| 通知ID | 事件 | 触发条件 | 渠道 | 优先级 |
|--------|------|---------|------|--------|
| SEC-001 | 登录成功 | 新设备/新IP登录 | APP推送 + 邮件 | 高 |
| SEC-002 | 密码修改 | 用户修改密码 | APP推送 + 邮件 + 短信 | 紧急 |
| SEC-003 | GA 绑定成功 | 绑定 Google Authenticator | APP推送 + 站内信 | 高 |
| SEC-004 | GA 解绑成功 | 解绑 Google Authenticator | APP推送 + 邮件 | 紧急 |
| SEC-005 | 异常登录警告 | 检测到可疑登录行为 | APP推送 + 短信 + 邮件 | 紧急 |

### 2.4 钱包类通知

| 通知ID | 事件 | 触发条件 | 渠道 | 优先级 |
|--------|------|---------|------|--------|
| WAL-001 | 钱包创建成功 | 完成钱包创建流程 | APP推送 | 中 |
| WAL-002 | 钱包导入成功 | 完成钱包导入 | APP推送 | 中 |
| WAL-003 | 助记词备份提醒 | 用户未备份助记词（创建后24小时） | APP推送 | 高 |

### 2.5 系统类通知

| 通知ID | 事件 | 触发条件 | 渠道 | 优先级 |
|--------|------|---------|------|--------|
| SYS-001 | 版本更新 | 新版本发布 | APP推送 | 低 |
| SYS-002 | 系统维护 | 计划维护前2小时 | APP推送 + 站内信 | 高 |
| SYS-003 | 余额预警 | Vault余额低于阈值 | APP推送（仅配置角色） | 紧急 |

---

## 3. 通知内容模板

### 3.1 交易类模板

#### TX-001 充值到账

```
标题: 充值到账通知
内容: 您的 {network} 网络充值已到账
      金额: {amount} {token}
      到账时间: {datetime}
跳转: 充值记录详情页
```

#### TX-002 提现成功

```
标题: 提现成功
内容: 您的提现已完成
      金额: {amount} {token}
      收款地址: {address_masked}
      交易哈希: {tx_hash_short}
跳转: 提现记录详情页
```

#### TX-003 提现失败

```
标题: 提现失败
内容: 您的提现未成功
      金额: {amount} {token}
      失败原因: {reason}
      资金已退回余额
跳转: 提现记录详情页
```

#### TX-005 闪兑成功

```
标题: 闪兑成功
内容: 您的闪兑交易已完成
      支付: {from_amount} {from_token}
      获得: {to_amount} {to_token}
跳转: 闪兑记录详情页
```

### 3.2 审核类模板

#### AUD-001 提现审核通过

```
标题: 提现审核通过
内容: 您的提现申请已通过审核
      金额: {amount} {token}
      预计到账时间: {estimated_time}
跳转: 提现记录详情页
```

#### AUD-002 提现审核驳回

```
标题: 提现审核未通过
内容: 您的提现申请未通过审核
      金额: {amount} {token}
      驳回原因: {reason}
      资金已退回可用余额
跳转: 提现记录详情页
```

### 3.3 安全类模板

#### SEC-001 登录成功

```
标题: 登录提醒
内容: 您的账户在新设备上登录成功
      登录时间: {datetime}
      设备信息: {device_info}
      IP地址: {ip_location}
      如非本人操作，请立即修改密码
跳转: 安全设置页
```

#### SEC-005 异常登录警告

```
标题: [紧急] 账户安全警告
内容: 检测到您的账户存在异常登录尝试
      时间: {datetime}
      IP地址: {ip_location}
      尝试次数: {attempt_count}
      建议立即修改密码并开启双重验证
跳转: 安全设置页
```

---

## 4. 通知触发规则

### 4.1 防重复规则

| 规则 | 说明 |
|------|------|
| 时间窗口去重 | 同类型通知在 5 分钟内不重复发送 |
| 批量聚合 | 多笔充值在 10 分钟内聚合为一条通知 |
| 勿扰时段 | 23:00-07:00 低优先级通知延迟发送（紧急除外） |

### 4.2 失败重试

| 渠道 | 重试次数 | 重试间隔 |
|------|---------|---------|
| APP推送 | 3次 | 1分钟、5分钟、15分钟 |
| 短信 | 2次 | 5分钟、30分钟 |
| 邮件 | 3次 | 5分钟、30分钟、2小时 |

### 4.3 用户偏好

| 设置项 | 选项 | 默认值 |
|--------|------|-------|
| 交易通知 | 开/关 | 开 |
| 安全通知 | 开/关 | 开（强制） |
| 营销通知 | 开/关 | 关 |
| 勿扰时段 | 自定义时间 | 关闭 |

---

## 5. 通知数据结构

### 5.1 通知消息格式

```json
{
  "notification_id": "string",
  "type": "TX|AUD|SEC|WAL|SYS",
  "event_code": "TX-001",
  "user_id": "string",
  "title": "string",
  "content": "string",
  "channels": ["app_push", "in_app", "sms", "email"],
  "priority": "low|medium|high|urgent",
  "data": {
    "jump_url": "string",
    "params": {}
  },
  "created_at": "datetime",
  "expire_at": "datetime"
}
```

### 5.2 通知状态

| 状态 | 说明 |
|------|------|
| PENDING | 待发送 |
| SENT | 已发送 |
| DELIVERED | 已送达 |
| READ | 已读 |
| FAILED | 发送失败 |
| EXPIRED | 已过期 |

---

## 6. 验收标准

1. [ ] 所有通知类型正确触发
2. [ ] 通知内容模板变量正确替换
3. [ ] 多渠道发送功能正常
4. [ ] 防重复规则生效
5. [ ] 失败重试机制正常
6. [ ] 用户偏好设置生效
7. [ ] 紧急通知不受勿扰时段限制
8. [ ] 通知跳转链接正确
9. [ ] 通知已读状态正确更新
10. [ ] 站内信历史记录完整

---

*文档创建日期: 2025-12-09*
