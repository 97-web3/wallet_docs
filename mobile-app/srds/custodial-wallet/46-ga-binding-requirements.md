# Google Authenticator 绑定页面 - 软件需求规格说明书

## 1. 页面标识

| 属性 | 值 |
|------|-----|
| 页面ID | CW-046 |
| 页面名称 | Google Authenticator 绑定页面 |
| 版本 | 1.0 |
| 更新日期 | 2025-12-08 |
| 状态 | 草稿 |

### 功能描述
用户绑定 Google Authenticator (GA) 作为二次验证方式，增强账户安全性。绑定后可用于替代验证（参考 COMMON-002）。

> 相关规格: [COMMON-002 验证方式规则](../common/verification-method-rules.md)

### 验证优先级
绑定 GA 后，用户在安全验证时可选择使用：
- **优先级 A**: FaceID/TouchID（若设备支持且用户开启）
- **优先级 B**: Google Authenticator 6 位动态码 ← 本页面绑定
- **优先级 C**: 资金密码

---

## 2. UI组件

### 2.1 组件详情

| 组件 | 类型 | 描述 | 位置 |
|------|------|------|------|
| 返回按钮 | 图标按钮 | 左箭头 | 左上角 |
| 页面标题 | 文本标签 | "绑定谷歌验证器" | 标题栏中央 |
| 步骤指示器 | 步骤条 | 显示当前步骤 (1/3, 2/3, 3/3) | 顶部 |
| 二维码卡片 | 卡片 | 显示 TOTP 二维码 | 中上部 |
| 二维码图片 | 图片 | 供 GA 扫描的二维码 | 卡片中央 |
| 密钥显示 | 文本标签 | 16 位 Base32 密钥（可手动输入） | 二维码下方 |
| 复制按钮 | 图标按钮 | 复制密钥到剪贴板 | 密钥右侧 |
| 操作说明 | 文本标签 | 扫码或手动输入说明 | 密钥下方 |
| OTP 输入框 | 数字输入框 | 6 位验证码输入 | 中下部 |
| 验证按钮 | 主按钮 | "验证并绑定" | 底部 |

---

## 3. 功能需求

### FR-CW-046-01: 生成 TOTP 密钥

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-046-01 |
| **描述** | 系统生成 TOTP 密钥和对应二维码 |
| **验收标准** | 1. **假设** 用户进入绑定页面, **当** 加载完成, **则** 后台生成新的 TOTP Secret<br>2. **假设** 生成密钥, **当** 渲染二维码, **则** 二维码包含正确的 otpauth:// URI<br>3. **假设** 显示密钥, **当** 渲染, **则** 显示 16 位 Base32 编码的密钥 |
| **优先级** | 必须 |

### FR-CW-046-02: 扫描二维码

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-046-02 |
| **描述** | 用户使用 Google Authenticator 扫描二维码 |
| **验收标准** | 1. **假设** 用户扫描二维码, **当** 扫描成功, **则** GA 应用添加新的验证器条目<br>2. **假设** 二维码格式, **当** 生成, **则** 符合 TOTP 标准 (RFC 6238) |
| **优先级** | 必须 |

### FR-CW-046-03: 手动输入密钥

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-046-03 |
| **描述** | 用户可手动在 GA 中输入密钥 |
| **验收标准** | 1. **假设** 用户无法扫码, **当** 点击复制密钥, **则** 密钥复制到剪贴板<br>2. **假设** 复制成功, **当** 完成, **则** 显示"已复制"提示 |
| **优先级** | 应该 |

### FR-CW-046-04: 验证 OTP 码

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-046-04 |
| **描述** | 验证用户输入的 6 位动态码 |
| **验收标准** | 1. **假设** 用户输入 6 位码, **当** 点击验证, **则** 服务端验证 OTP 是否正确<br>2. **假设** OTP 验证通过, **当** 成功, **则** 完成绑定并显示成功提示<br>3. **假设** OTP 验证失败, **当** 失败, **则** 显示"验证码错误，请重新输入"<br>4. **假设** 验证时间容差, **当** 验证, **则** 允许前后 1 个时间窗口（30秒） |
| **优先级** | 必须 |

### FR-CW-046-05: 绑定完成

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-046-05 |
| **描述** | 绑定成功后更新用户安全设置 |
| **验收标准** | 1. **假设** 绑定成功, **当** 完成, **则** 用户安全设置中标记 GA 已绑定<br>2. **假设** 绑定成功, **当** 后续操作需验证, **则** GA 验证作为可选验证方式 |
| **优先级** | 必须 |

---

## 4. 用户交互

### 4.1 用户工作流
1. 用户从安全设置进入 GA 绑定页面
2. 查看二维码和密钥
3. 使用 Google Authenticator 扫描二维码（或手动输入密钥）
4. 在输入框输入 GA 显示的 6 位动态码
5. 点击"验证并绑定"
6. 绑定成功，返回安全设置

### 4.2 导航流程
- 安全设置 → GA 绑定页面
- GA 绑定页面 → 绑定成功 → 安全设置

---

## 5. 数据需求

### 5.1 输入数据

| 字段名称 | 数据类型 | 必填 | 验证规则 |
|---------|---------|------|---------|
| OTP 验证码 | String | 是 | 6 位纯数字 |

### 5.2 显示数据

| 数据项 | 数据类型 | 说明 |
|--------|---------|------|
| 二维码图片 | Image | otpauth:// URI 编码的二维码 |
| TOTP 密钥 | String | 16 位 Base32 编码 |
| 绑定状态 | Boolean | 是否已绑定 |

---

## 6. 验证规则

### 6.1 OTP 验证
- 6 位纯数字
- 基于 TOTP 算法 (RFC 6238)
- 有效期：30 秒
- 时间容差：允许前后 1 个窗口

### 6.2 错误处理
| 场景 | 提示 |
|------|------|
| OTP 为空 | "请输入 6 位验证码" |
| OTP 格式错误 | "验证码必须为 6 位数字" |
| OTP 验证失败 | "验证码错误，请重新输入" |
| 连续失败 5 次 | "错误次数过多，请 15 分钟后重试" |

---

## 7. 技术考虑

### 7.1 TOTP 规格
```
算法: HMAC-SHA1
密钥长度: 160 bits (20 bytes)
编码: Base32
时间步长: 30 秒
码长度: 6 位
```

### 7.2 二维码 URI 格式
```
otpauth://totp/AppName:username?secret=BASE32SECRET&issuer=AppName
```

---

## 8. 验收标准汇总

1. ✅ 正确生成 TOTP 密钥和二维码
2. ✅ 二维码可被 Google Authenticator 识别
3. ✅ 密钥可复制
4. ✅ OTP 验证功能正常
5. ✅ 时间容差验证正确
6. ✅ 绑定成功后状态更新
7. ✅ 错误次数限制生效
8. ✅ UI 符合设计稿

---

## 9. 相关文档

- [COMMON-002 验证方式规则](../common/verification-method-rules.md)
- [RFC 6238 - TOTP](https://tools.ietf.org/html/rfc6238)

---

*文档创建日期: 2025-12-08*
