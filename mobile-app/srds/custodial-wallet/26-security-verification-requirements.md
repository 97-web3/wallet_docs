# 安全验证(2FA) - 软件需求规格说明书

## 1. 页面标识

| 属性 | 值 |
|------|-----|
| 页面ID | CW-026 |
| 页面名称 | 安全验证(2FA) |
| 版本 | 1.1 |
| 更新日期 | 2025-12-08 |
| 状态 | 草稿 |

### 功能描述
安全验证页面用于在执行敏感操作时进行双因素认证(2FA)。用户需要输入Google Authenticator或其他验证器应用生成的6位动态验证码。页面提供验证码输入框和提交按钮。

---

## 2. UI组件

### 2.1 布局概述
页面采用底部弹出抽屉设计，深色背景主题。顶部显示标题和关闭按钮，中间是6位验证码输入区域，底部为确认按钮。显示验证器应用的图标和说明。

### 2.2 组件详情

| 组件 | 类型 | 描述 | 位置 |
|------|------|------|------|
| 拖动指示条 | 视图 | 灰色横条，表示可拖动关闭 | 弹窗顶部 |
| 页面标题 | 标签 | "安全验证" | 拖动条下方 |
| 关闭按钮 | 图标按钮 | X图标，关闭弹窗 | 标题右侧 |
| 验证器图标 | 图片 | Google Authenticator图标 | 内容区顶部 |
| 说明文字 | 标签 | "请输入Google Authenticator验证码" | 图标下方 |
| 验证码输入框 | 输入组 | 6个独立数字输入框 | 说明下方 |
| 确认按钮 | 主按钮 | 绿色圆角按钮，"确认" | 底部 |

---

## 3. 功能需求

### FR-026-01: 显示2FA验证界面

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-01 |
| **描述** | 系统应在需要2FA验证时显示验证码输入界面 |
| **验收标准** | 1. **假设** 用户执行需要2FA的操作，**当** 系统要求验证，**则** 弹出2FA验证界面<br>2. **假设** 验证界面显示，**当** 用户查看，**则** 显示Google Authenticator图标和输入说明 |
| **优先级** | 必须 |

### FR-026-02: 输入验证码

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-02 |
| **描述** | 用户可以在6位输入框中输入验证码 |
| **验收标准** | 1. **假设** 用户点击输入框，**当** 开始输入，**则** 数字键盘弹出<br>2. **假设** 用户输入数字，**当** 每输入一位，**则** 自动跳转到下一个输入框<br>3. **假设** 用户输入完6位，**当** 最后一位输入，**则** 光标停留，等待提交 |
| **优先级** | 必须 |

### FR-026-03: 提交验证码

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-03 |
| **描述** | 用户点击确认按钮后，系统验证输入的验证码 |
| **验收标准** | 1. **假设** 用户输入完整验证码，**当** 点击确认按钮，**则** 系统向服务器提交验证请求<br>2. **假设** 验证码正确，**当** 服务器确认，**则** 关闭弹窗并继续操作<br>3. **假设** 验证码错误，**当** 服务器拒绝，**则** 显示错误提示 |
| **优先级** | 必须 |

### FR-026-04: 关闭验证弹窗

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-04 |
| **描述** | 用户可以关闭2FA验证弹窗取消操作 |
| **验收标准** | 1. **假设** 用户在验证界面，**当** 点击关闭按钮或下拉拖动，**则** 关闭弹窗<br>2. **假设** 弹窗关闭，**当** 返回原页面，**则** 敏感操作取消不执行 |
| **优先级** | 必须 |

### FR-026-05: 验证码自动清除

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-05 |
| **描述** | 验证失败后应自动清除已输入的验证码 |
| **验收标准** | 1. **假设** 验证码验证失败，**当** 显示错误提示，**则** 清空所有输入框<br>2. **假设** 输入框清空，**当** 用户重新输入，**则** 光标定位到第一个输入框 |
| **优先级** | 应该 |

### FR-026-06: 验证失败次数限制与显示（安全关键）

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-06 |
| **描述** | 系统应限制验证失败次数并明确显示剩余尝试机会 |
| **验收标准** | 1. **假设** 验证码验证失败，**当** 显示错误，**则** 同时显示剩余尝试次数（如"验证码错误，剩余4次尝试"）<br>2. **假设** 连续失败4次，**当** 再次失败，**则** 显示警告"这是最后一次尝试机会"<br>3. **假设** 连续失败5次，**当** 达到限制，**则** 锁定验证功能并显示倒计时（如"请10分钟后再试"）<br>4. **假设** 账户被锁定，**当** 显示锁定状态，**则** 显示明确的倒计时器（mm:ss格式）实时更新 |
| **优先级** | **必须（安全关键）** |

> **安全说明**：显示剩余尝试次数可帮助合法用户了解状态，同时限制暴力破解攻击。

### FR-026-07: 备份验证码恢复机制

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-07 |
| **描述** | 提供验证器丢失时的账户恢复机制 |
| **验收标准** | 1. **假设** 2FA验证界面显示，**当** 用户查看，**则** 显示"无法使用验证器？"帮助链接<br>2. **假设** 用户点击帮助链接，**当** 触发，**则** 显示恢复选项：使用备份码、联系客服<br>3. **假设** 用户选择备份码恢复，**当** 进入流程，**则** 跳转到备份码输入页面<br>4. **假设** 备份码验证成功，**当** 确认身份，**则** 允许重置2FA设置 |
| **优先级** | **必须** |

> **用户体验说明**：如果用户丢失手机或卸载验证器应用，没有恢复机制将导致账户永久无法访问。

### FR-026-08: 2FA设置时生成备份码

| 字段 | 内容 |
|------|------|
| **ID** | FR-026-08 |
| **描述** | 在用户首次设置2FA时，**必须**生成并展示备份码 |
| **验收标准** | 1. **假设** 用户完成2FA绑定，**当** 设置成功，**则** 自动生成8-10个一次性备份码<br>2. **假设** 备份码生成，**当** 显示，**则** 提供"下载备份码"和"复制备份码"选项<br>3. **假设** 用户未保存备份码，**当** 尝试关闭页面，**则** 显示警告"请确保已保存备份码，否则丢失验证器将无法恢复账户"<br>4. **假设** 用户确认已保存，**当** 勾选确认框，**则** 允许关闭页面完成设置 |
| **优先级** | **必须（安全关键）** |

> **安全说明**：备份码是2FA丢失后恢复账户的唯一途径。强制用户在设置时保存备份码可防止账户永久锁定。

---

## 4. 用户交互

### 4.1 用户工作流
1. 用户触发需要2FA验证的操作
2. 系统弹出2FA验证界面
3. 用户打开Google Authenticator应用获取验证码
4. 用户在输入框中输入6位验证码
5. 用户点击确认按钮
6. 系统验证并反馈结果

### 4.2 导航流程
- **来源页面**: 提现确认、修改安全设置等敏感操作页面
- **目标页面**:
  - 验证成功: 继续原操作流程
  - 验证取消: 返回原页面
  - 验证失败: 保持在验证界面，允许重试

### 4.3 手势与交互
| 手势 | 行为 |
|------|------|
| 点击输入框 | 激活输入，弹出数字键盘 |
| 输入数字 | 自动填入并跳转下一位 |
| 点击确认 | 提交验证码 |
| 点击关闭 | 关闭弹窗 |
| 下拉拖动 | 关闭弹窗 |

---

## 5. 数据需求

### 5.1 显示数据
| 数据字段 | 类型 | 来源 | 格式 |
|----------|------|------|------|
| 验证器图标 | Image | 系统资源 | PNG/SVG |
| 说明文字 | String | 系统配置 | 本地化文本 |
| 操作描述 | String | 调用方传入 | 本地化文本 |

### 5.2 输入数据
| 输入字段 | 类型 | 验证规则 | 必填 |
|----------|------|----------|------|
| 验证码 | String | 6位纯数字 | 是 |

---

## 6. 验证规则

### 6.1 输入验证
- 仅接受数字输入（0-9）
- 必须输入完整6位
- 不接受空格或其他字符

### 6.2 业务规则
- 验证码有效期通常为30秒
- 允许前后各一个时间窗口的验证码
- 连续错误次数限制（如5次后锁定）

### 6.3 错误处理
| 错误场景 | 处理方式 |
|----------|----------|
| 验证码错误 | 显示"验证码错误，请重试" |
| 验证码过期 | 显示"验证码已过期，请重新获取" |
| 网络错误 | 显示"网络错误，请重试" |
| 多次错误 | 显示"错误次数过多，请稍后再试" |

---

## 7. 技术考虑

### 7.1 API集成
- 调用后端2FA验证接口
- 传递用户ID和验证码
- 处理验证结果回调

### 7.2 TOTP算法
- 服务端使用标准TOTP算法验证
- 支持30秒时间窗口
- 允许一定的时间偏差容忍

### 7.3 安全要求
- 验证码输入不可复制粘贴（可选）
- 防止暴力破解的频率限制
- 验证请求使用HTTPS加密

### 7.4 输入体验
- 自动聚焦到下一个输入框
- 支持退格键删除
- 数字键盘优化

---

## 8. 验收标准汇总

- [ ] 敏感操作正确触发2FA验证
- [ ] 显示Google Authenticator图标和说明
- [ ] 6位验证码输入框正常工作
- [ ] 输入时自动跳转下一位
- [ ] 确认按钮提交验证码
- [ ] 验证成功后继续操作
- [ ] 验证失败显示错误提示
- [ ] 失败后清空输入框
- [ ] 关闭按钮正常工作
- [ ] 下拉可关闭弹窗
- [ ] **验证失败时显示剩余尝试次数**
- [ ] **5次失败后显示锁定倒计时（mm:ss格式）**
- [ ] **显示"无法使用验证器？"帮助链接**
- [ ] **支持备份码恢复流程**
- [ ] **2FA设置时强制生成并保存备份码**
- [ ] **未保存备份码时警告用户**

---

## 9. 无障碍访问要求

- [ ] 所有文本颜色对比度符合WCAG 2.1 AA标准（最低4.5:1）
- [ ] 按钮和可交互元素最小触摸目标为44x44pt
- [ ] 支持屏幕阅读器，所有UI元素有适当的无障碍标签
- [ ] 验证码输入框有明确的aria-label（如"第1位验证码"）
- [ ] 验证结果通过无障碍公告通知用户（aria-live="polite"）
- [ ] 剩余尝试次数变化通过VoiceOver朗读
- [ ] 倒计时状态变化有音频或触觉反馈
- [ ] 支持键盘导航和退格键删除
- [ ] 支持从剪贴板粘贴完整验证码
