# 闪兑确认页面 - 软件需求规格说明书

## 1. 页面标识

| 属性 | 值 |
|------|-----|
| 页面ID | CW-049 |
| 页面名称 | 闪兑确认页面 |
| 版本 | 1.0 |
| 更新日期 | 2025-12-09 |
| 状态 | 草稿 |

### 功能描述

用户确认闪兑交易详情，完成安全验证后提交交易。展示完整的交易信息供用户最终确认。

> 相关规格: [COMMON-002 验证方式规则](../common/verification-method-rules.md) | [COMMON-006 术语表](../common/glossary.md)

### 安全验证

闪兑交易需要进行安全验证，采用替代验证模式：
- **优先级 A**: FaceID（若设备支持且用户开启）
- **优先级 B**: Google Authenticator 6位动态码
- **优先级 C**: 资金密码

---

## 2. UI组件

### 2.1 布局概述

页面采用垂直布局，顶部导航栏，中部为交易详情卡片，底部为确认按钮。采用深色主题。

### 2.2 组件详情

| 组件 | 类型 | 描述 | 位置 |
|------|------|------|------|
| 返回按钮 | 图标按钮 | 左箭头 | 左上角 |
| 页面标题 | 文本标签 | "确认兑换" | 标题栏中央 |
| 交易详情卡片 | 卡片组件 | 展示完整交易信息 | 中部 |
| 支付金额 | 文本标签 | 支付的源代币数量 | 卡片内 |
| 源代币图标 | 图片 | 源代币 Logo | 支付金额左侧 |
| 箭头图标 | 图标 | 向下箭头表示兑换方向 | 卡片中部 |
| 获得金额 | 文本标签 | 预估获得的目标代币数量 | 卡片内 |
| 目标代币图标 | 图片 | 目标代币 Logo | 获得金额左侧 |
| 分隔线 | 线条 | 分隔主要信息和详情 | 卡片内 |
| 汇率信息 | 文本标签 | "汇率: 1 XXX ≈ x.xx YYY" | 详情区 |
| 滑点信息 | 文本标签 | "滑点容差: x%" | 详情区 |
| 最小获得 | 文本标签 | "最小获得: x.xxxxxxx YYY" | 详情区 |
| Gas费信息 | 文本标签 | "网络费用: x.xxxx ETH (≈$x.xx)" | 详情区 |
| 网络信息 | 文本标签 | "网络: Ethereum" | 详情区 |
| 提示卡片 | 提示组件 | 交易提示信息，带警告图标 | 卡片下方 |
| 确认并支付按钮 | 主按钮 | "确认并支付"，荧光绿色 | 底部 |

---

## 3. 功能需求

### FR-CW-049-01: 显示交易详情

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-049-01 |
| **描述** | 展示完整的闪兑交易信息 |
| **验收标准** | 1. **假设** 进入确认页, **当** 加载完成, **则** 显示支付金额、获得金额、汇率、滑点、Gas费等完整信息<br>2. **假设** 金额显示, **当** 渲染, **则** 遵循代币精度规则（7位小数）<br>3. **假设** Gas费显示, **当** 渲染, **则** 同时显示原生代币单位和法币等值 |
| **优先级** | 必须 |

### FR-CW-049-02: 汇率有效期验证

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-049-02 |
| **描述** | 验证汇率报价是否仍然有效 |
| **验收标准** | 1. **假设** 汇率报价过期, **当** 点击确认, **则** 提示"汇率已过期，请重新获取"并返回上一页<br>2. **假设** 页面停留时间, **当** 超过 Admin 配置的过期时间, **则** 自动提示汇率过期 |
| **优先级** | 必须 |

### FR-CW-049-03: 确认并触发安全验证

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-049-03 |
| **描述** | 用户确认后进行安全验证 |
| **验收标准** | 1. **假设** 用户点击"确认并支付", **当** 触发, **则** 根据用户安全设置弹出对应验证方式<br>2. **假设** 用户已开启 FaceID, **当** 验证, **则** 优先使用 FaceID 验证<br>3. **假设** FaceID 不可用, **当** 验证, **则** 使用 Google Authenticator 或资金密码 |
| **优先级** | 必须 |

### FR-CW-049-04: 安全验证通过

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-049-04 |
| **描述** | 验证通过后提交交易 |
| **验收标准** | 1. **假设** 安全验证通过, **当** 成功, **则** 提交交易到区块链<br>2. **假设** 交易提交成功, **当** 完成, **则** 跳转至闪兑结果页 (CW-050)<br>3. **假设** 提交过程中, **当** 等待, **则** 显示加载状态，禁用按钮防止重复提交 |
| **优先级** | 必须 |

### FR-CW-049-05: 安全验证失败

| 字段 | 内容 |
|------|------|
| **ID** | FR-CW-049-05 |
| **描述** | 处理验证失败情况 |
| **验收标准** | 1. **假设** FaceID 验证失败, **当** 连续3次, **则** 自动切换到 Google Authenticator 验证<br>2. **假设** GA 验证失败, **当** 输入错误, **则** 提示"验证码错误，请重新输入"<br>3. **假设** 资金密码错误, **当** 连续5次, **则** 锁定15分钟 |
| **优先级** | 必须 |

---

## 4. 用户交互

### 4.1 用户工作流

1. 查看交易详情（支付金额、获得金额、费用）
2. 确认信息无误
3. 点击"确认并支付"
4. 完成安全验证（FaceID / GA / 资金密码）
5. 等待交易提交
6. 跳转至结果页

### 4.2 导航流程

```
闪兑详情 (CW-048) → 闪兑确认 (CW-049) → 安全验证 → 闪兑结果 (CW-050)
                          ↓
                    点击返回 → CW-048
```

### 4.3 安全验证弹窗流程

```
点击确认
    ↓
检查用户安全设置
    ↓
┌─ FaceID 已开启 → 弹出 FaceID 验证
│        ↓ 失败3次
├─ GA 已绑定 → 弹出 GA 验证码输入
│        ↓ 失败
└─ 资金密码 → 弹出资金密码输入
         ↓ 验证通过
    提交交易
```

---

## 5. 数据需求

### 5.1 显示数据

| 数据项 | 数据类型 | 说明 |
|--------|---------|------|
| 支付金额 | Decimal | 源代币数量 |
| 获得金额 | Decimal | 目标代币数量 |
| 汇率 | String | 格式: "1 XXX ≈ x.xxxxxxx YYY" |
| 滑点 | String | 格式: "x%" |
| 最小获得 | Decimal | 考虑滑点后的最小获得量 |
| Gas费 | String | 原生代币 + 法币等值 |
| 网络名称 | String | 区块链网络名称 |

### 5.2 传入数据

从上一页 (CW-048) 传入：
- 源代币信息
- 目标代币信息
- 支付金额
- 汇率报价
- 滑点设置
- Gas 估算
- 报价有效期

---

## 6. 验证规则

### 6.1 业务规则

| 规则 | 说明 |
|------|------|
| 汇率有效期 | 报价超过 Admin 配置的过期时间后失效 |
| 验证方式 | 替代模式：任一验证方式通过即可 |
| 防重复提交 | 提交中禁用确认按钮 |

### 6.2 错误处理

| 场景 | 提示 |
|------|------|
| 汇率过期 | "汇率已过期，请重新获取" |
| FaceID 失败 | "验证失败，请重试或使用其他方式" |
| GA 验证码错误 | "验证码错误，请重新输入" |
| 资金密码错误 | "密码错误，还剩 x 次机会" |
| 资金密码锁定 | "错误次数过多，请 15 分钟后重试" |
| 交易提交失败 | "交易提交失败，请重试" |

---

## 7. 技术考虑

### 7.1 安全要求

- 验证过程加密传输
- 资金密码本地不存储明文
- 验证失败次数服务端记录

### 7.2 API 集成

| 接口 | 说明 |
|------|------|
| 安全验证接口 | 验证 FaceID / GA / 资金密码 |
| 交易提交接口 | 提交闪兑交易到区块链 |

### 7.3 状态管理

- 按钮状态（正常 / 加载中 / 禁用）
- 验证弹窗状态
- 错误信息状态

---

## 8. 验收标准汇总

1. ✅ 正确显示完整的交易详情
2. ✅ 汇率过期时正确提示
3. ✅ 安全验证流程正常（FaceID/GA/资金密码）
4. ✅ 验证失败时正确降级到其他验证方式
5. ✅ 验证错误次数限制正常
6. ✅ 交易提交时显示加载状态
7. ✅ 防止重复提交
8. ✅ 交易成功后正确跳转
9. ✅ UI 符合设计稿

---

## 9. 无障碍访问要求

- [ ] 交易详情可被屏幕阅读器完整朗读
- [ ] 验证弹窗支持键盘操作
- [ ] 错误提示有足够的颜色对比度
- [ ] 按钮状态变化有视觉反馈

---

*文档创建日期: 2025-12-09*
