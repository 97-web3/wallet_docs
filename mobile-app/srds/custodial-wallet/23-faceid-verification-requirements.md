# FaceID验证 - 软件需求规格说明书

## 1. 页面标识

| 属性 | 值 |
|------|-----|
| 页面ID | CW-023 |
| 页面名称 | FaceID验证 |
| 版本 | 1.2 |
| 更新日期 | 2025-12-08 |
| 状态 | 草稿 |

### 功能描述
FaceID验证页面是iOS系统级生物识别验证界面，用于在执行敏感操作（如提现确认、内部划转等）时验证用户身份。页面显示应用图标和验证提示，使用系统原生Face ID功能进行面部识别验证。

> **重要**: 本页面是安全验证流程的一部分。验证方式采用**替代验证模式**（任选其一即可通过），详见 [COMMON-002 验证方式规则](../common/verification-method-rules.md)

### 验证优先级
本页面对应验证优先级 **A（最高）- 生物识别**：
- 若用户已开启生物识别且设备支持，系统自动调起此验证方式
- 用户可随时选择其他验证方式（2FA 或资金密码）

---

## 2. UI组件

### 2.1 布局概述
页面采用iOS系统原生FaceID验证弹窗设计，半透明深色背景覆盖整个屏幕。中央显示FaceID图标和验证信息卡片，包含应用图标、验证提示文字和取消按钮。

### 2.2 组件详情

| 组件 | 类型 | 描述 | 位置 |
|------|------|------|------|
| 背景遮罩 | 视图 | 半透明深色背景，模糊效果 | 全屏 |
| 验证卡片 | 容器 | 圆角白色/深色卡片 | 屏幕中央 |
| 应用图标 | 图片 | 应用Logo图标 | 卡片顶部 |
| FaceID图标 | 图标 | 系统Face ID标识图标 | 应用图标下方 |
| 验证标题 | 标签 | "Face ID" | 图标下方 |
| 验证描述 | 标签 | "使用面容ID进行验证"或类似提示 | 标题下方 |
| 取消按钮 | 按钮 | "取消"文字按钮 | 卡片底部 |

---

## 3. 功能需求

### FR-023-01: 触发FaceID验证

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-01 |
| **描述** | 系统应在需要身份验证时自动触发FaceID验证流程 |
| **验收标准** | 1. **假设** 用户执行敏感操作，**当** 系统需要身份验证，**则** 自动弹出FaceID验证界面<br>2. **假设** 设备支持FaceID，**当** 验证界面显示，**则** 自动激活前置摄像头进行面部扫描 |
| **优先级** | 必须 |

### FR-023-02: 验证成功处理

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-02 |
| **描述** | FaceID验证成功后，系统应继续执行被中断的敏感操作 |
| **验收标准** | 1. **假设** 用户面部识别成功，**当** 系统确认身份，**则** 关闭验证弹窗并继续执行操作<br>2. **假设** 验证成功，**当** 返回原页面，**则** 显示操作成功反馈 |
| **优先级** | 必须 |

### FR-023-03: 验证失败处理（增强）

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-03 |
| **描述** | FaceID验证失败时，系统应明确显示重试次数并提供备选验证方式 |
| **验收标准** | 1. **假设** 用户面部识别失败，**当** 系统检测到失败，**则** 显示"再试一次"选项和**当前尝试次数**（如"第1/3次尝试失败"）<br>2. **假设** 第一次验证失败，**当** 显示重试选项，**则** 明确提示"剩余2次尝试机会"<br>3. **假设** 第二次验证失败，**当** 显示重试选项，**则** 明确提示"剩余1次尝试机会，之后将使用密码验证"<br>4. **假设** 第三次验证失败，**当** 达到失败次数限制，**则** 自动跳转密码验证页面并显示"Face ID验证失败次数过多，请使用密码验证" |
| **优先级** | **必须** |

> **用户体验说明**：明确显示剩余尝试次数可减少用户焦虑，让用户清楚了解验证状态和下一步操作。

### FR-023-04: 取消验证

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-04 |
| **描述** | 用户可以取消FaceID验证流程 |
| **验收标准** | 1. **假设** 用户在验证界面，**当** 点击"取消"按钮，**则** 关闭验证弹窗<br>2. **假设** 用户取消验证，**当** 返回原页面，**则** 敏感操作不执行 |
| **优先级** | 必须 |

### FR-023-05: 主动选择其他验证方式

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-05 |
| **描述** | 用户可以在任何时候主动选择使用其他验证方式代替FaceID（替代验证模式） |
| **验收标准** | 1. **假设** FaceID验证界面显示，**当** 用户查看，**则** 显示"使用其他方式验证"链接按钮<br>2. **假设** 用户点击"使用其他方式验证"，**当** 用户已绑定 2FA，**则** 跳转到 2FA 验证页面<br>3. **假设** 用户点击"使用其他方式验证"，**当** 用户未绑定 2FA，**则** 跳转到资金密码验证页面<br>4. **假设** 用户选择其他验证方式，**当** 验证成功，**则** 继续执行原敏感操作（任一验证方式通过即可） |
| **优先级** | **必须** |

> **替代验证说明**：验证采用替代模式，FaceID/2FA/资金密码任选其一通过即可，无需多重验证。详见 [COMMON-002](../common/verification-method-rules.md)。

### FR-023-06: 相机权限处理

| 字段 | 内容 |
|------|------|
| **ID** | FR-023-06 |
| **描述** | 在触发FaceID前检查并请求相机权限 |
| **验收标准** | 1. **假设** 应用首次使用FaceID，**当** 触发验证，**则** 先显示相机权限请求说明"需要使用相机进行面容识别验证"<br>2. **假设** 用户拒绝相机权限，**当** 权限被拒，**则** 显示提示"无法使用Face ID，请在设置中开启相机权限"并提供"使用密码验证"选项<br>3. **假设** 相机权限已授予，**当** 触发验证，**则** 直接显示FaceID验证界面 |
| **优先级** | **必须** |

---

## 4. 用户交互

### 4.1 用户工作流
1. 用户触发需要身份验证的敏感操作
2. 系统自动弹出FaceID验证界面
3. 用户面向设备进行面部识别
4. 系统验证面部信息
5. 验证成功则继续操作，失败则提供重试或备选方案

### 4.2 导航流程
- **来源页面**: 任何需要身份验证的操作页面（提现确认、查看私钥等）
- **目标页面**:
  - 验证成功: 继续原操作流程
  - 验证取消: 返回原页面
  - 多次失败: 跳转密码验证页面

### 4.3 手势与交互
| 手势 | 行为 |
|------|------|
| 面向设备 | 自动进行面部扫描 |
| 点击取消 | 取消验证流程 |
| 点击重试 | 重新进行面部识别 |

---

## 5. 数据需求

### 5.1 显示数据
| 数据字段 | 类型 | 来源 | 格式 |
|----------|------|------|------|
| 应用图标 | Image | 系统资源 | PNG/SVG |
| 验证提示 | String | 系统配置 | 本地化文本 |
| 操作描述 | String | 调用方传入 | 本地化文本 |

### 5.2 输入数据
| 输入字段 | 类型 | 验证规则 | 必填 |
|----------|------|----------|------|
| 面部特征 | Biometric | 系统FaceID验证 | 是 |

---

## 6. 验证规则

### 6.1 生物识别验证
- 使用iOS系统原生LocalAuthentication框架
- 面部特征与设备注册的FaceID数据匹配
- 验证超时时间由系统控制

### 6.2 错误处理
| 错误场景 | 处理方式 |
|----------|----------|
| 面部识别失败 | 显示"再试一次"选项 |
| 连续失败3次 | 提供密码验证备选 |
| FaceID不可用 | 直接使用密码验证 |
| 设备不支持 | 降级到密码验证 |

---

## 7. 技术考虑

### 7.1 系统API集成
- 使用iOS LocalAuthentication框架
- 调用LAContext进行生物识别验证
- 支持LAPolicy.deviceOwnerAuthenticationWithBiometrics策略

### 7.2 安全要求
- 生物识别数据不离开设备安全区
- 验证结果通过安全通道传递
- 不存储面部特征原始数据

### 7.3 降级策略
- FaceID不可用时自动降级到密码验证
- 支持用户主动选择密码验证

### 7.4 状态管理
- 记录验证发起的操作类型
- 验证成功后恢复操作上下文
- 处理验证中断和超时情况

---

## 8. 验收标准汇总

- [ ] 敏感操作正确触发FaceID验证
- [ ] 显示应用图标和验证提示
- [ ] 面部识别自动激活
- [ ] 验证成功后继续执行操作
- [ ] 验证失败提供重试选项
- [ ] **验证失败时显示当前尝试次数（如"第1/3次"）**
- [ ] **显示剩余尝试机会提示**
- [ ] 多次失败后提供密码备选
- [ ] **第3次失败后自动跳转密码验证**
- [ ] 取消按钮正常工作
- [ ] **显示"使用密码验证"主动切换选项**
- [ ] **首次使用时请求相机权限并说明原因**
- [ ] **权限被拒时提供替代验证方式**
- [ ] 不支持FaceID时自动降级
- [ ] 验证流程符合iOS系统规范

---

## 9. 无障碍访问要求

- [ ] 所有文本颜色对比度符合WCAG 2.1 AA标准（最低4.5:1）
- [ ] 按钮和可交互元素最小触摸目标为44x44pt
- [ ] 支持屏幕阅读器，所有UI元素有适当的无障碍标签
- [ ] 验证状态变化通过无障碍公告通知用户（aria-live="polite"）
- [ ] 失败提示和剩余次数通过VoiceOver朗读
- [ ] "使用密码验证"按钮有明确的无障碍描述
- [ ] 支持键盘导航（适用于平板/桌面设备）
