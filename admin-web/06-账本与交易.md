# 账本与交易

> 返回 [后台管理前端目录](./README.md)

---

## 页面概述

- **页面路径**: `/admin/ledger`
- **权限要求**: Admin 或 Finance 角色
- **主要功能**: 交易历史查询、账本记录管理、Vault 余额调整、对账工具

---

## 页面布局

### 账本与交易主页面结构

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Header                                                                   │
├──────────┬───────────────────────────────────────────────────────────────┤
│          │  Breadcrumb: 首页 / 账本与交易                                 │
│  Sidebar ├───────────────────────────────────────────────────────────────┤
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ Tab 切换                                                  │ │
│          │  │ [交易历史] [账本查询] [Vault 管理] [对账工具]             │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ════════════════════════════════════════════════════════════ │
│          │                                                                │
│          │  [交易历史] Tab 内容:                                         │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ 筛选区域                                                  │ │
│          │  │ [类型▼] [链▼] [状态▼] [日期范围] [UID搜索] [🔍] [重置]   │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │                                              [导出]       │ │
│          │  ├──────────────────────────────────────────────────────────┤ │
│          │  │ │交易ID │类型   │用户UID│金额      │链  │状态  │时间  │  │ │
│          │  │ ├───────┼───────┼───────┼──────────┼────┼──────┼──────┤  │ │
│          │  │ │TX001  │充值   │10001  │5,000 USDT│TRX │已完成│12-10 │  │ │
│          │  │ │TX002  │提现   │10002  │3,000 USDT│ETH │处理中│12-10 │  │ │
│          │  │ │TX003  │划转   │10003  │1,000 USDT│-   │已完成│12-10 │  │ │
│          │  │ ...                                                       │ │
│          │  ├──────────────────────────────────────────────────────────┤ │
│          │  │                    < 1 2 3 4 5 ... 10 >                   │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
└──────────┴───────────────────────────────────────────────────────────────┘
```

---

## 功能模块

### 1. 交易历史

**功能描述**: 统一展示所有类型的交易记录

**用户角色**: Admin / Finance

#### 1.1 交易列表筛选

**UI 组件**:
- **Select**: 类型、链、状态筛选
- **DatePicker.RangePicker**: 日期范围
- **Input**: 用户 UID / 交易 ID 搜索
- **Button**: 搜索、重置、导出

**筛选条件**:
| 字段 | 组件 | 选项 |
|------|------|------|
| 交易类型 | Select | 全部、充值、提现、划转、薪资、调整 |
| 链 | Select | 全部、TRX、ETH、BSC |
| 币种 | Select | 全部、USDT、TRX、ETH、BNB |
| 状态 | Select | 全部、处理中、已完成、失败 |
| 日期范围 | RangePicker | 交易时间范围 |
| 金额范围 | InputNumber | 最小/最大金额 |
| 关键词 | Input | 交易 ID 或用户 UID |

#### 1.2 交易列表展示

**表格列**:
| 列名 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 交易ID | tx_id | 120px | 交易唯一标识 |
| 类型 | type | 80px | 交易类型标签 |
| 用户UID | user_id | 80px | 关联用户 |
| 金额 | amount | 120px | 交易金额和币种 |
| 链 | chain | 60px | 区块链（划转为 -） |
| 状态 | status | 80px | 状态标签 |
| 时间 | created_at | 160px | 交易时间 |
| 操作 | - | 100px | 查看详情 |

**交易类型标签**:
| 类型 | 颜色 | 说明 |
|------|------|------|
| deposit | 绿色 | 充值 |
| withdraw | 蓝色 | 提现 |
| transfer | 紫色 | 划转 |
| payroll | 橙色 | 薪资 |
| adjustment | 灰色 | 调整 |

#### 1.3 交易详情抽屉

**UI 组件**:
- **Drawer**: 抽屉容器
- **Descriptions**: 详情列表
- **Timeline**: 状态变更记录

**详情内容**:
```
┌────────────────────────────────────────┐
│  交易详情                         [×]  │
├────────────────────────────────────────┤
│                                        │
│  基本信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 交易ID:     TX001                │  │
│  │ 交易类型:   充值                  │  │
│  │ 交易金额:   5,000.00 USDT        │  │
│  │ 链:         TRX                  │  │
│  │ 状态:       已完成               │  │
│  │ 创建时间:   2025-12-10 10:30:00  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  用户信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 用户UID:    10001                │  │
│  │ 手机号:     138****1234          │  │
│  └──────────────────────────────────┘  │
│                                        │
│  链上信息 (充值/提现)                  │
│  ┌──────────────────────────────────┐  │
│  │ 交易哈希:   3a7b2c...   [复制]   │  │
│  │ From:       T9yD14...            │  │
│  │ To:         TAbc12...            │  │
│  │ 区块高度:   12345678             │  │
│  │ 确认数:     20                   │  │
│  │ [在浏览器中查看 ↗]               │  │
│  └──────────────────────────────────┘  │
│                                        │
│  状态变更记录                          │
│  ┌──────────────────────────────────┐  │
│  │ ● 2025-12-10 10:35 已完成        │  │
│  │ │                                │  │
│  │ ○ 2025-12-10 10:32 确认中 (15/20)│  │
│  │ │                                │  │
│  │ ○ 2025-12-10 10:30 待确认        │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

**区块链浏览器链接**:
| 链 | 浏览器 | URL 模板 |
|-----|--------|----------|
| TRX | Tronscan | `https://tronscan.org/#/transaction/{hash}` |
| ETH | Etherscan | `https://etherscan.io/tx/{hash}` |
| BSC | BscScan | `https://bscscan.com/tx/{hash}` |

---

### 2. 账本查询

**功能描述**: 查询 Web2 钱包的账本记录（双重记账）

**用户角色**: Admin / Finance

**页面路径**: `/admin/ledger` → 账本查询 Tab

#### 2.1 账本筛选

**筛选条件**:
| 字段 | 组件 | 说明 |
|------|------|------|
| 记录类型 | Select | 全部、借方、贷方 |
| 账户类型 | Select | 全部、用户账户、Vault 账户、手续费账户 |
| 币种 | Select | USDT、TRX、ETH、BNB |
| 日期范围 | RangePicker | 记录时间 |
| 用户UID | Input | 搜索指定用户 |

#### 2.2 账本列表

**表格列**:
| 列名 | 字段 | 说明 |
|------|------|------|
| 记录ID | entry_id | 账本条目 ID |
| 时间 | created_at | 记录时间 |
| 账户 | account | 账户标识 |
| 类型 | type | 借方/贷方 |
| 金额 | amount | 金额 |
| 币种 | asset | 币种 |
| 关联交易 | tx_ref | 关联的交易 ID |
| 余额 | balance_after | 操作后余额 |
| 备注 | memo | 备注说明 |

**账本条目示例**:
```
┌────────────────────────────────────────────────────────────────────┐
│ 账本记录 - 充值入账示例                                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 交易: 用户 10001 充值 5,000 USDT                                   │
│                                                                    │
│ │ 账户           │ 类型 │ 金额         │ 余额         │           │
│ │ Vault-TRX-USDT │ 借方 │ +5,000 USDT  │ 105,000 USDT │           │
│ │ User-10001-USDT│ 贷方 │ +5,000 USDT  │ 15,000 USDT  │           │
│                                                                    │
│ 借方合计: 5,000 USDT = 贷方合计: 5,000 USDT ✓                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3. Vault 管理

**功能描述**: 查看和调整企业 Vault 余额

**用户角色**: Admin / Finance

**页面路径**: `/admin/ledger/vault`

#### 3.1 Vault 余额概览

**UI 组件**:
- **Card**: 各链 Vault 卡片
- **Statistic**: 余额统计
- **Progress**: 使用率进度条

**布局结构**:
```
┌──────────────────────────────────────────────────────────────────┐
│ Vault 余额概览                                     [刷新]        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 总余额: $1,200,000 USDT                                         │
│                                                                  │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐     │
│ │ 🔷 TRX          │ │ 💎 ETH          │ │ 🟡 BSC          │     │
│ │                 │ │                 │ │                 │     │
│ │ 热钱包          │ │ 热钱包          │ │ 热钱包          │     │
│ │ 80,000 USDT    │ │ 60,000 USDT    │ │ 40,000 USDT    │     │
│ │ ████████░░ 80% │ │ ██████░░░░ 60% │ │ ████░░░░░░ 40% │     │
│ │                 │ │                 │ │                 │     │
│ │ 冷钱包          │ │ 冷钱包          │ │ 冷钱包          │     │
│ │ 400,000 USDT   │ │ 350,000 USDT   │ │ 250,000 USDT   │     │
│ │                 │ │                 │ │                 │     │
│ │ [管理]          │ │ [管理]          │ │ [管理]          │     │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 3.2 Vault 详情页

**UI 组件**:
- **Descriptions**: Vault 信息
- **Table**: 操作记录
- **Button**: 调整按钮

**Vault 详情结构**:
```
┌──────────────────────────────────────────────────────────────────┐
│ TRX Vault 详情                                      [调整余额]   │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ Vault 信息                                                       │
│ ┌──────────────────────────────────────────────────────────────┐ │
│ │ 链:           TRX                                            │ │
│ │ 热钱包地址:   T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb             │ │
│ │ 余额:                                                        │ │
│ │   - TRX:      100,000.00 ($10,000)                          │ │
│ │   - USDT:     80,000.00 ($80,000)                           │ │
│ │ 告警阈值:     USDT < 10,000 (紧急) / < 20,000 (警告)         │ │
│ │ 最后同步:     2025-12-10 14:30:00                           │ │
│ └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
│ 操作记录                                                        │
│ ┌──────────────────────────────────────────────────────────────┐ │
│ │ │时间        │类型    │金额        │操作人  │备注           │ │
│ │ ├────────────┼────────┼────────────┼────────┼───────────────┤ │
│ │ │12-10 14:00 │调整(+) │+10,000USDT │admin01 │补充热钱包     │ │
│ │ │12-09 16:30 │提现    │-5,000 USDT │system  │用户提现TX002  │ │
│ │ │12-09 10:00 │充值    │+3,000 USDT │system  │用户充值TX001  │ │
│ │ ...                                                          │ │
│ └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 3.3 余额调整

**功能描述**: 手动调整 Vault 余额（需审批）

**触发方式**: 点击「调整余额」按钮

**调整对话框**:
```
┌────────────────────────────────────────┐
│  调整 Vault 余额                  [×]  │
├────────────────────────────────────────┤
│                                        │
│  链: TRX                               │
│                                        │
│  调整类型 *                            │
│  [○ 增加 (+)]  [○ 减少 (-)]           │
│                                        │
│  币种 *                                │
│  [USDT           ▼]                   │
│                                        │
│  调整金额 *                            │
│  [________________] USDT               │
│                                        │
│  调整原因 *                            │
│  [○ 冷热钱包调拨                      ]│
│  [○ 手续费充值                        ]│
│  [○ 对账调整                          ]│
│  [○ 其他                              ]│
│                                        │
│  备注说明 *                            │
│  [________________________]            │
│  [________________________]            │
│                                        │
│  ⚠️ 大额调整（>$10,000）需要双重审批   │
│                                        │
│         [取消]    [提交调整]           │
│                                        │
└────────────────────────────────────────┘
```

**调整规则**:
| 金额范围 | 审批要求 |
|----------|----------|
| < $1,000 | 无需审批，直接生效 |
| $1,000 - $10,000 | 单人审批 |
| > $10,000 | 双重审批 |

---

### 4. 对账工具

**功能描述**: 账本余额与链上余额对账

**用户角色**: Finance

**页面路径**: `/admin/ledger` → 对账工具 Tab

#### 4.1 对账概览

**UI 组件**:
- **Card**: 对账状态卡片
- **Table**: 对账明细
- **Alert**: 差异提醒

**对账结果展示**:
```
┌──────────────────────────────────────────────────────────────────┐
│ 对账结果 - 2025-12-10                              [执行对账]    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 最后对账时间: 2025-12-10 06:00:00                               │
│ 对账结果: ✓ 账实相符                                            │
│                                                                  │
│ 对账明细                                                        │
│ ┌──────────────────────────────────────────────────────────────┐ │
│ │ │账户类型     │币种│账本余额      │链上余额      │差异│状态  │ │
│ │ ├─────────────┼────┼──────────────┼──────────────┼────┼──────┤ │
│ │ │Vault-TRX-Hot│USDT│80,000.00    │80,000.00    │0   │✓ 相符│ │
│ │ │Vault-ETH-Hot│USDT│60,000.00    │60,000.00    │0   │✓ 相符│ │
│ │ │Vault-BSC-Hot│USDT│40,000.00    │40,005.00    │+5  │⚠ 待查│ │
│ │ │用户托管合计 │USDT│500,000.00   │500,000.00   │0   │✓ 相符│ │
│ └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
│ ⚠️ 发现 1 处差异，请核查                                        │
│ [查看差异详情]  [下载对账报告]                                   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 4.2 差异处理

**差异详情对话框**:
```
┌────────────────────────────────────────┐
│  对账差异详情                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  账户: Vault-BSC-Hot-USDT              │
│                                        │
│  账本余额:   40,000.00 USDT           │
│  链上余额:   40,005.00 USDT           │
│  差异金额:   +5.00 USDT (链上多)       │
│                                        │
│  可能原因:                             │
│  • 未入账的充值交易                    │
│  • 手续费返还                          │
│  • 系统未记录的转入                    │
│                                        │
│  近期相关交易:                         │
│  [查看最近 24h BSC 链交易]             │
│                                        │
│  处理方式:                             │
│  [○ 创建调整记录（账本 +5）           ]│
│  [○ 标记为待查                        ]│
│  [○ 忽略（记录原因）                  ]│
│                                        │
│         [取消]    [提交处理]           │
│                                        │
└────────────────────────────────────────┘
```

---

## UI 组件列表

| 组件名称 | 类型 | 功能说明 |
|----------|------|----------|
| TransactionFilter | Form | 交易筛选表单 |
| TransactionTable | Table | 交易列表表格 |
| TransactionDrawer | Drawer | 交易详情抽屉 |
| LedgerTable | Table | 账本记录表格 |
| VaultCard | Card | Vault 余额卡片 |
| VaultDetail | Page | Vault 详情页面 |
| AdjustmentModal | Modal | 余额调整对话框 |
| ReconcileResult | Card | 对账结果展示 |
| DiscrepancyModal | Modal | 差异处理对话框 |
| ExplorerLink | Link | 区块链浏览器链接 |

---

## 状态与交互

### 页面状态

| 状态 | 描述 | UI 表现 |
|------|------|---------|
| Loading | 数据加载中 | 显示骨架屏 |
| Empty | 无数据 | 显示空状态 |
| Error | 加载失败 | 显示错误提示 |
| Reconciling | 对账执行中 | 显示进度条 |

### 用户操作响应

| 操作 | 成功响应 | 失败响应 |
|------|----------|----------|
| 导出交易 | 开始下载文件 | Toast 显示错误 |
| 调整余额 | Toast "调整已提交" | Alert 显示错误 |
| 执行对账 | 显示对账结果 | Alert 显示错误 |

---

## 权限控制

| 功能 | Admin | Finance |
|------|-------|---------|
| 查看交易历史 | ✓ | ✓ |
| 导出交易记录 | ✓ | ✓ |
| 查看账本记录 | ✓ | ✓ |
| 查看 Vault 余额 | ✓ | ✓ |
| 调整 Vault 余额 | ✓ | ✓ |
| 执行对账 | ✓ | ✓ |
| 处理对账差异 | ✓ | ✓ |

---

## 数据导出

### 支持的导出格式

| 格式 | 说明 |
|------|------|
| Excel (.xlsx) | 完整数据，支持筛选 |
| CSV (.csv) | 纯文本格式 |

### 导出字段

交易历史导出字段：
- 交易ID、类型、用户UID、金额、币种、链
- 状态、创建时间、完成时间
- 交易哈希（链上交易）、手续费

账本记录导出字段：
- 记录ID、时间、账户、类型
- 金额、币种、操作后余额
- 关联交易、备注

---

> 返回 [后台管理前端目录](./README.md)
