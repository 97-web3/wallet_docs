# Vault / 告警与通知

> 返回 [Vault 资金管理索引](../10-Vault资金管理.md)

---

## 目标

- 将“阈值配置（low/critical）”与“告警治理（事件、Ack、升级、降噪、通知集成）”拆分，避免把复杂运维逻辑挤在余额表文档里。
- 支持企业资金管理的告警闭环：**触发 → 通知 → 认领(Ack) → 处理 → 恢复 → 复盘**。

---

## 1. 告警对象与触发来源（建议口径）

### 1.1 余额阈值告警（已有 SRD 对齐能力）

- 触发条件：资产可用余额（推荐用 `available_balance`）低于阈值
- 阈值分级：`low` / `critical`
- 配置入口：见 `vault/04-余额监控与阈值告警.md`
- 配置接口（SRD）：`PUT /api/v1/admin/vault/thresholds`

### 1.2 同步/数据新鲜度告警（SRD 已体现雏形）

- 触发条件：`blocks_behind` 或 `last_sync_at` 超过容忍范围
- UI 表现：网络卡片/详情页展示 `sync_status` + “数据陈旧/同步异常”
- SRD 示例：`GET /api/v1/admin/vault/overview` 中的 `alert: { type, message }`

### 1.3 规划扩展（避免误解为已实现）

以下属于企业级增强项，建议在产品/接口具备后再“从规划转为实现”：

- pending 队列异常（长时间 pending、nonce gap、替换失败）
- 大额异常流出（单笔/短窗累计）
- 手续费币不足（Gas 余额不足导致交易无法发出）
- 流动性池健康指标告警（见 `vault/08-扩展-多Vault与流动性池监控.md`）

---

## 2. 告警分级与状态机（企业级建议）

### 2.1 分级（Severity）

| 分级 | 典型场景 | 建议响应 |
|------|----------|----------|
| info | 同步开始/恢复、非关键提示 | 仅站内/低优先级通知 |
| warning | `low` 阈值触发、轻度同步延迟 | 通知 + 关注，必要时安排补充资金 |
| critical | `critical` 阈值触发、同步严重失败 | 立即升级通知 + 触发应急预案 |

> 备注：SRD 当前阈值为 `low/critical`，可直接映射为 `warning/critical`。

### 2.2 告警事件状态机（Lifecycle）

| 状态 | 说明 | 谁可操作 |
|------|------|----------|
| open | 告警触发且未处理 | 系统自动产生 |
| acknowledged | 已认领/已确认正在处理（Ack） | Ops/Finance/Admin |
| resolved | 告警条件恢复（自动或人工确认） | 系统自动/管理员 |
| closed | 关闭归档（可选：与 resolved 合并） | 系统/管理员 |

建议为每条告警记录以下字段（用于合规与复盘）：

- `alert_id`、`type`、`severity`
- `scope`：`chain_id` / `network` / `currency` / `vault_address`（或未来 `vault_id`）
- `triggered_at`、`last_seen_at`、`resolved_at`
- `trigger_value`、`threshold_value`、`gap_amount`（缺口）
- `ack_by`、`ack_at`、`ack_note`
- `owner`（当前责任人/处理人）
- `links`：详情页链接、链上浏览器链接、工单链接

---

## 3. Ack（认领/确认）与协作机制（建议）

### 3.1 Ack 入口（建议）

- 在 `/admin/vault` 的网络卡片上：当存在告警时显示「Ack / 认领」按钮
- 在详情页的告警面板：显示告警列表 + Ack/指派/备注

### 3.2 Ack 规则（建议）

- critical 告警必须 Ack（避免“都以为别人会处理”）
- Ack 需要填写备注（例如：计划从冷钱包补充、预计完成时间）
- Ack 与后续动作（手动同步、发起调整）应能关联同一事件/工单号（如有）

### 3.3 Ack 审计要求

- Ack 也属于“资金运维关键动作”，建议写入审计日志（见 `vault/07-审计、权限与合规.md`）

---

## 4. 降噪与告警风暴控制（必须写清的运维规则）

> 企业场景最容易出问题的是“告警太多没人看”，因此文档需要明确降噪策略。

### 4.1 去重（Dedup）

建议 dedup key：

- `type + chain_id + currency`（余额阈值）
- `type + chain_id`（同步类）

### 4.2 冷却（Cooldown）

- 同一 dedup key 在 `cooldown_seconds` 内重复触发，仅更新 `last_seen_at`，不重复发送高频通知

### 4.3 维护窗口/静默（Mute）

- 支持按范围静默：
  - 全局 / 按网络 / 按币种
  - 静默到某个时间 `mute_until`
- 静默期间仍记录事件，但不发送外部通知（可选：站内仍展示）

### 4.4 升级（Escalation）

- warning 超时未 Ack → 自动升级为 critical 或升级通知渠道（例如 PagerDuty）
- critical 超时未恢复 → 追加升级通知到更高层级负责人

---

## 5. 通知渠道集成（建议）

### 5.1 基础渠道

| 渠道 | 适用场景 | 注意事项 |
|------|----------|----------|
| 站内消息 | 全量，低成本 | 需要已登录才能看到，不可作为唯一渠道 |
| Email | warning/critical | 收件人治理：组邮箱优先，避免个人邮箱漂移 |
| SMS | critical | 成本高、需合规（手机号管理与审计） |
| Webhook | 对接企业 IM/告警平台 | 需要签名/密钥，避免泄露与伪造 |

> SRD 当前阈值配置支持 Email + Webhook：`notifications.email_*`、`notifications.webhook_*`。

### 5.2 企业集成（推荐扩展）

- Slack / 飞书 / 企业微信：用于运营团队高频协作
- PagerDuty / OpsGenie：用于 on-call 值班体系（强烈建议用于 critical）

### 5.3 路由与模板（建议）

- 路由维度：
  - `severity`（warning/critical）
  - `chain_id/network`
  - `currency`
  - （未来）`vault_id` / `vault_group` / `owner_team`
- 消息模板建议包含：
  - 告警类型 + 严重级别
  - 触发值/阈值/缺口
  - 网络/币种/地址
  - 最近更新时间与同步状态
  - 一键链接（跳转到详情页/工单）

### 5.4 Webhook 安全（建议写入文档）

- 支持 `HMAC-SHA256` 签名（header 中带 `X-Signature`、`X-Timestamp`）
- 支持重放保护（时间窗校验）
- webhooks 的 secret 不应明文展示（可用 `secret_ref` 形式存储/引用）

---

## 6. 与其他模块的联动（建议）

- “最近操作动态”：当发生余额调整/同步等关键事件时，可在动态中展示并跳转 `/admin/vault`
- “系统状态监控”：同步失败告警需要能快速跳转排查节点/索引器状态（见 `wallet_docs/admin-web/14-系统状态监控.md`）

