# Vault / 余额监控与阈值告警

> 返回 [Vault 资金管理索引](../10-Vault资金管理.md)

---

## 目标

- 实时/准实时展示多链 Vault 余额（含可用/锁定/待处理）
- 支持多级阈值（`low`/`critical`）并提供清晰的告警状态
- 在余额风险发生时，能快速定位：哪条链、哪个资产、缺口多少、建议动作是什么

---

## 1. 余额表（建议字段）

| 列名 | 字段（推荐） | 说明 |
|------|--------------|------|
| 币种 | `currency` | ETH/USDT/USDC… |
| 合约 | `contract_address` | ERC20/TRC20 等（原生币为 null） |
| 总余额 | `balance` | 链上总额 |
| 可用余额 | `available_balance` | 可用于新交易/新提现 |
| 锁定/预留 | `locked_balance` | 预留、冻结、待处理等 |
| USD 价值 | `balance_usd` | 计价结果（需标注价格源） |
| 阈值（Low/Critical） | `threshold_low` / `threshold_critical` | 多级阈值 |
| 状态 | `status` | normal/low/critical |
| 操作 | - | 配置阈值、查看详情、发起调整等 |

---

## 2. 状态规则（建议）

| 状态 | 触发条件（示例） | 标签颜色（建议） |
|------|------------------|------------------|
| normal | `available_balance >= low` | 绿色 |
| low | `critical <= available_balance < low` | 橙色 |
| critical | `available_balance < critical` | 红色 |

> 建议阈值判断以 `available_balance` 为准（更贴近可用流动性），并在 UI 显示“缺口金额”。

---

## 3. 阈值与通知配置

> SRD 对齐：`PUT /api/v1/admin/vault/thresholds`（见 `wallet_docs/admin-api/srds/10-Vault资金管理.md`）

### 3.1 配置内容（必须写清）

- 阈值：`thresholds.low`、`thresholds.critical`
- 通知：
  - `notifications.email_enabled`
  - `notifications.email_recipients[]`
  - `notifications.webhook_enabled`
  - `notifications.webhook_url`

### 3.2 配置弹窗（参考）

```
┌──────────────────────────────────────────────┐
│  阈值配置 - ETH (Ethereum)               [×]  │
├──────────────────────────────────────────────┤
│ 当前余额: 500.00 ETH                         │
│ 可用余额: 490.00 ETH   锁定: 10.00 ETH       │
│                                              │
│ Low 阈值 *                                   │
│ [_____________] ETH                          │
│ Critical 阈值 *                              │
│ [_____________] ETH                          │
│                                              │
│ 通知方式                                     │
│ [✓] Email  收件人: [ops@.., finance@..]      │
│ [✓] Webhook URL: https://hooks...            │
│                                              │
│         [取消]    [保存]                     │
└──────────────────────────────────────────────┘
```

---

## 4. 告警治理（企业级建议）

当前 SRD 提供了“阈值+通知开关”，但企业运营通常还需要以下“告警治理”能力（建议作为文档扩展项，避免误解为已实现）：

- 告警事件历史：触发时间、恢复时间、持续时长、触发值、缺口
- 确认/认领（Ack）：谁在处理、备注、下一步
- 降噪：去重键、冷却时间、维护窗口（mute）
- 升级策略：warning → critical、超时未处理升级到更高级别通知（PagerDuty/飞书/Slack）

