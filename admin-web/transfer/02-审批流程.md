# 转账管理 / 审批流程

> 返回 [转账管理索引](../11-转账管理.md)

---

## 概述

本文档定义薪资发放批次的多级审批流程，包括审批节点、角色权限、审批界面和驳回处理机制。

> **适用范围**：仅薪资发放（payroll）类型批次需要多级审批。普通转账（transfer）类型采用单级确认流程。

---

## 1. 审批流程设计

### 1.1 多级审批节点

| 审批级别 | 审批角色 | 角色标识 | 触发条件 | 审批内容 |
|----------|----------|----------|----------|----------|
| 一级审批 | HR 经理 | hr_manager | 所有薪资批次 | 核对员工信息、薪资数据准确性 |
| 二级审批 | 财务经理 | finance_manager | 一级通过后 | 核对资金来源、预算合规性 |
| 三级审批 | CFO | cfo | 批次金额 > 500,000 USDT | 大额审批、风险控制 |

### 1.2 审批金额阈值

| 批次总金额 | 所需审批级别 | 说明 |
|------------|--------------|------|
| ≤ 100,000 USDT | 一级审批 | 仅 HR 经理审批 |
| 100,000 - 500,000 USDT | 二级审批 | HR + 财务经理 |
| > 500,000 USDT | 三级审批 | HR + 财务 + CFO |

### 1.3 审批状态流转

```
┌────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌────────┐
│  草稿  │ →  │ 待一级审批│ →  │ 待二级审批│ →  │ 待三级审批│ →  │ 待执行  │
└────────┘    └──────────┘    └──────────┘    └──────────┘    └────────┘
   │↑               │               │               │
   │└───────────────┴───────────────┴───────────────┘
   │                      (驳回，返回草稿)
   │
   └→ [删除] (仅草稿状态可删除)
```

**状态说明**：

| 状态 | 状态码 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 草稿 | draft | 新建或被驳回的批次 | 编辑、删除、提交审批 |
| 待一级审批 | pending_l1 | 等待 HR 经理审批 | 一级审批、撤回 |
| 待二级审批 | pending_l2 | 等待财务经理审批 | 二级审批 |
| 待三级审批 | pending_l3 | 等待 CFO 审批（大额） | 三级审批 |
| 待执行 | pending_exec | 审批完成，等待执行 | 执行 |
| 执行中 | executing | 正在发放 | 查看进度 |
| 已完成 | completed | 全部发放完成 | 查看详情、导出 |

---

## 2. 角色权限定义

### 2.1 角色矩阵

| 角色 | 角色标识 | 权限范围 |
|------|----------|----------|
| HR 专员 | hr_staff | 创建、编辑、导入、提交批次 |
| HR 经理 | hr_manager | HR专员权限 + 一级审批 |
| 财务专员 | finance_staff | 查看批次、执行已审批批次 |
| 财务经理 | finance_manager | 财务专员权限 + 二级审批 |
| CFO | cfo | 三级审批（大额） |
| 系统管理员 | admin | 全部权限 |

### 2.2 功能权限矩阵

| 功能 | hr_staff | hr_manager | finance_staff | finance_manager | cfo | admin |
|------|----------|------------|---------------|-----------------|-----|-------|
| 查看批次列表 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 创建批次 | ✓ | ✓ | - | - | - | ✓ |
| 编辑批次 | ✓ | ✓ | - | - | - | ✓ |
| 删除批次 | - | ✓ | - | - | - | ✓ |
| 导入 Excel | ✓ | ✓ | - | - | - | ✓ |
| 提交审批 | ✓ | ✓ | - | - | - | ✓ |
| 一级审批 | - | ✓ | - | - | - | ✓ |
| 二级审批 | - | - | - | ✓ | - | ✓ |
| 三级审批 | - | - | - | - | ✓ | ✓ |
| 执行批次 | - | - | ✓ | ✓ | - | ✓ |
| 导出明细 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 查看审计日志 | - | ✓ | - | ✓ | ✓ | ✓ |

---

## 3. 审批界面

### 3.1 待审批列表

```
┌──────────────────────────────────────────────────────────────────────────┐
│  待审批批次                                                    [刷新]    │
├──────────────────────────────────────────────────────────────────────────┤
│  筛选: [审批级别▼] [薪资周期▼] [金额范围]     [搜索批次名称...]        │
├──────────────────────────────────────────────────────────────────────────┤
│ │批次ID     │批次名称        │员工数│总金额        │提交人│等待时间│操作│
│ ├───────────┼────────────────┼──────┼──────────────┼──────┼────────┼────┤
│ │P202512001 │2025年12月工资  │1,256 │2,500,000 USDT│张三  │2小时   │[审]│
│ │P202512002 │技术部奖金      │45    │180,000 USDT  │李四  │30分钟  │[审]│
│ │P202512003 │销售提成        │28    │95,000 USDT   │王五  │15分钟  │[审]│
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.2 审批详情对话框

```
┌────────────────────────────────────────────────────────────────┐
│  审批薪资批次                                              [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  批次信息                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 批次ID:       P202512001                                 │  │
│  │ 批次名称:     2025年12月工资                             │  │
│  │ 薪资周期:     2025-12                                    │  │
│  │ 员工数:       1,256                                      │  │
│  │ 总金额:       2,500,000 USDT                             │  │
│  │ 创建人:       张三 (HR专员)                              │  │
│  │ 创建时间:     2025-12-10 10:00:00                        │  │
│  │ 当前审批:     二级审批 (财务经理)                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  部门汇总                                          [展开明细]  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ │部门      │人数  │金额          │占比   │平均        │  │  │
│  │ ├──────────┼──────┼──────────────┼───────┼────────────┤  │  │
│  │ │技术部    │450   │1,200,000 USDT│48%    │2,667 USDT  │  │  │
│  │ │销售部    │320   │800,000 USDT  │32%    │2,500 USDT  │  │  │
│  │ │运营部    │280   │350,000 USDT  │14%    │1,250 USDT  │  │  │
│  │ │其他      │206   │150,000 USDT  │6%     │728 USDT    │  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  审批历史                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ● 2025-12-10 14:30 - 一级审批通过 - 赵六 (HR经理)        │  │
│  │   "薪资数据已与HR系统核对，无异常"                        │  │
│  │ ○ 2025-12-10 11:00 - 提交审批 - 张三 (HR专员)            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  审批意见 *                                                    │
│  [________________________________________________]           │


---

## 4. 驳回处理

### 4.1 驳回流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐
│ 审批驳回  │ →  │ 返回草稿  │ →  │ 重新编辑  │ → [重新提交审批]
└──────────┘    └──────────┘    └──────────┘
                     ↓
              [记录驳回原因]
```

### 4.2 驳回原因选项

| 驳回原因类别 | 具体原因 | 处理建议 |
|--------------|----------|----------|
| 数据错误 | 员工信息不准确 | 核对HR系统后修正 |
| 数据错误 | 薪资金额有误 | 重新计算后修正 |
| 数据错误 | 重复发放风险 | 检查发放记录 |
| 合规问题 | 超出预算限额 | 申请预算调整 |
| 合规问题 | 缺少必要审批 | 补充审批材料 |
| 资金问题 | Vault 余额不足 | 等待资金到位 |
| 其他 | 自定义原因 | 按备注处理 |

### 4.3 驳回对话框

```
┌────────────────────────────────────────┐
│  驳回批次                          [×]  │
├────────────────────────────────────────┤
│                                        │
│  批次: P202512001 - 2025年12月工资     │
│                                        │
│  驳回原因类别 *                        │
│  [数据错误          ▼]                 │
│                                        │
│  具体原因 *                            │
│  [员工信息不准确    ▼]                 │
│                                        │
│  驳回说明 *                            │
│  [发现第15行员工工号与姓名不匹配，     │
│   请核对后重新提交___________________] │
│                                        │
│  ⚠️ 驳回后批次将返回草稿状态，         │
│  创建人可修改后重新提交审批            │
│                                        │
│         [取消]    [确认驳回]           │
│                                        │
└────────────────────────────────────────┘
```

---

## 5. 审批通知

### 5.1 通知触发点

| 事件 | 通知对象 | 通知方式 | 通知内容 |
|------|----------|----------|----------|
| 提交审批 | 下一级审批人 | 系统消息/邮件 | 有新的薪资批次待审批 |
| 审批通过 | 创建人、下一级审批人 | 系统消息 | 批次已通过X级审批 |
| 审批驳回 | 创建人 | 系统消息/邮件 | 批次被驳回，附驳回原因 |
| 全部通过 | 创建人、财务执行人 | 系统消息 | 批次已可执行 |
| 执行完成 | 创建人、审批人 | 系统消息 | 批次执行完成，附成功/失败数 |

### 5.2 审批提醒

| 超时阈值 | 提醒对象 | 提醒内容 |
|----------|----------|----------|
| 4 小时 | 当前审批人 | 有待审批批次超过4小时未处理 |
| 8 小时 | 当前审批人 + 上级 | 批次审批紧急提醒 |
| 24 小时 | 系统管理员 | 批次审批超时告警 |

---

## 6. 审批委托

### 6.1 委托规则

- 审批人可设置委托人，在请假/出差期间代为审批
- 委托需指定有效期（开始日期、结束日期）
- 委托人须具备相同或更高审批权限
- 委托审批记录会注明"代审批人"信息

### 6.2 委托设置界面

```
┌────────────────────────────────────────┐
│  设置审批委托                      [×]  │
├────────────────────────────────────────┤
│                                        │
│  委托人 *                              │
│  [选择用户...                  ▼]      │
│                                        │
│  委托期间 *                            │
│  [2025-12-15] 至 [2025-12-20]          │
│                                        │
│  委托原因                              │
│  [年假外出________________________]    │
│                                        │
│         [取消]    [确认设置]           │
│                                        │
└────────────────────────────────────────┘
```

---

## 7. 对应后端接口（参考）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/admin/transfer/approvals` | GET | 获取待审批列表 |
| `/api/v1/admin/transfer/batches/{id}/submit` | POST | 提交审批 |
| `/api/v1/admin/transfer/batches/{id}/approve` | POST | 审批通过 |
| `/api/v1/admin/transfer/batches/{id}/reject` | POST | 审批驳回 |
| `/api/v1/admin/transfer/batches/{id}/withdraw` | POST | 撤回审批 |
| `/api/v1/admin/transfer/delegation` | GET/POST | 审批委托管理 |

---

> 返回 [转账管理索引](../11-转账管理.md) | 上一篇：[数据模型与字段](./01-数据模型与字段.md) | 下一篇：[导入模板与验证](./03-导入模板与验证.md)
