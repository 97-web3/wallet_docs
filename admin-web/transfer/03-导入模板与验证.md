# 转账管理 / 导入模板与验证

> 返回 [转账管理索引](../11-转账管理.md)

---

## 概述

本文档定义薪资发放的 Excel 批量导入功能，包括模板规范、字段验证规则、错误处理和导入预览界面。

---

## 1. 导入模板规范

### 1.1 模板类型

| 模板类型 | 文件名 | 适用场景 | 字段数量 |
|----------|--------|----------|----------|
| 普通转账模板 | transfer_template.xlsx | 活动奖励、返利、退款 | 5 个基础字段 |
| 薪资发放模板 | payroll_template.xlsx | 月度工资、奖金、补贴 | 11 个完整字段 |
| 薪资简化模板 | payroll_simple_template.xlsx | 仅需实发金额 | 7 个核心字段 |

### 1.2 薪资发放模板字段定义

| 列号 | 列名 | 字段标识 | 必填 | 数据类型 | 示例值 | 说明 |
|------|------|----------|------|----------|--------|------|
| A | 员工工号 | employeeId | 是 | 文本 | EMP001 | HR系统员工ID |
| B | 员工姓名 | employeeName | 是 | 文本 | 张三 | 员工真实姓名 |
| C | 职位 | position | 否 | 文本 | 高级工程师 | 岗位名称 |
| D | 用户UID | uid | 是 | 文本 | 10001 | 钱包系统用户ID |
| E | 基本工资 | baseSalary | 否 | 数字 | 20000.00 | 固定薪资 |
| F | 奖金 | bonuses | 否 | 数字 | 5000.00 | 绩效/项目奖金 |
| G | 补贴 | allowances | 否 | 数字 | 2000.00 | 各类补贴合计 |
| H | 扣款 | deductions | 否 | 数字 | 3500.00 | 各类扣款合计 |
| I | 实发金额 | netPay | 是 | 数字 | 23500.00 | 最终发放金额 |
| J | 币种 | currency | 是 | 文本 | USDT | 发放币种 |
| K | 备注 | remark | 否 | 文本 | 全勤奖励 | 可选备注 |

### 1.3 模板示例

```
┌─────────┬────────┬──────────┬───────┬────────┬──────┬──────┬──────┬────────┬──────┬──────┐
│员工工号 │员工姓名│ 职位     │用户UID│基本工资│ 奖金 │ 补贴 │ 扣款 │实发金额│ 币种 │ 备注 │
├─────────┼────────┼──────────┼───────┼────────┼──────┼──────┼──────┼────────┼──────┼──────┤
│EMP001   │张三    │高级工程师│10001  │20000.00│5000  │2000  │3500  │23500.00│USDT  │      │
│EMP002   │李四    │销售经理  │10002  │18000.00│8000  │1500  │2800  │24700.00│USDT  │超额  │
│EMP003   │王五    │运营专员  │10003  │12000.00│2000  │1000  │1800  │13200.00│USDT  │      │
└─────────┴────────┴──────────┴───────┴────────┴──────┴──────┴──────┴────────┴──────┴──────┘
```

---

## 2. 验证规则

### 2.1 字段级验证

| 字段 | 验证规则 | 错误代码 | 错误提示 |
|------|----------|----------|----------|
| employeeId | 非空，长度 1-50，无特殊字符 | E001 | 员工工号不能为空或格式错误 |
| employeeName | 非空，长度 1-100 | E002 | 员工姓名不能为空 |
| uid | 非空，系统内用户存在 | E004 | 用户UID不存在 |
| baseSalary | ≥ 0（若填写） | E005 | 基本工资必须≥0 |
| bonuses | ≥ 0（若填写） | E006 | 奖金必须≥0 |
| allowances | ≥ 0（若填写） | E007 | 补贴必须≥0 |
| deductions | ≥ 0（若填写） | E008 | 扣款必须≥0 |
| netPay | > 0，≤ 单笔限额 | E009 | 实发金额无效或超限 |
| currency | 系统支持的币种 | E010 | 不支持的币种 |

### 2.2 行级验证

| 验证规则 | 错误代码 | 错误提示 |
|----------|----------|----------|
| 计算校验：netPay = baseSalary + bonuses + allowances - deductions | E011 | 实发金额计算不符 |
| 同行号同 UID 不重复 | E012 | 同一用户在导入文件中重复 |

### 2.3 批次级验证

| 验证规则 | 错误代码 | 错误提示 |
|----------|----------|----------|
| 批次总金额 ≤ Vault 可用余额 | E020 | 资金余额不足 |
| 批次总金额 ≤ 单批次限额 | E021 | 超出单批次金额限额 |
| 记录数 ≤ 单批次最大行数 | E022 | 超出单批次最大记录数 |
| 同周期同员工不重复发放 | E023 | 该员工在本周期已有发放记录 |
| 员工工号存在且状态可发放（启用员工目录时） | E024 | 员工不存在/状态不可发放 |
| 员工工号与 UID 映射一致（启用员工目录时） | E025 | 员工工号与用户UID不匹配 |

### 2.4 单笔与批次限额

| 限额类型 | 默认值 | 可配置 | 说明 |
|----------|--------|--------|------|
| 单笔最大金额 | 100,000 USDT | 是 | 超过需特殊审批 |
| 单笔最小金额 | 1 USDT | 是 | 过小金额预警 |
| 单批次最大金额 | 10,000,000 USDT | 是 | 超过需拆分批次 |
| 单批次最大记录数 | 5,000 条 | 是 | 超过需拆分文件 |

---

## 3. 导入流程

### 3.1 导入步骤

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 1.选择文件│ →  │ 2.上传解析│ →  │ 3.验证校验│ →  │ 4.预览确认│ →  │ 5.创建批次│
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                     │               │               │
                     ▼               ▼               ▼
               [显示进度]      [显示错误]      [可编辑修正]
```

### 3.2 导入对话框

```
┌────────────────────────────────────────────────────────────────┐
│  Excel 导入薪资                                            [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  批次名称 *                                                    │
│  [2025年12月工资____________________]                          │
│                                                                │
│  薪资周期 *                                                    │
│  [2025-12            ▼]                                        │
│                                                                │
│  上传文件                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                                                          │  │
│  │        📄 点击或拖拽 Excel 文件到此处上传                 │  │
│  │                                                          │  │
│  │        支持 .xlsx, .xls 格式，最大 10MB                  │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │


### 3.3 导入预览

```
┌────────────────────────────────────────────────────────────────┐
│  导入预览                                                  [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  文件: 2025年12月工资.xlsx                                     │
│  解析结果: 1,256 条记录，1,250 条有效，6 条错误                │
│                                                                │
│  [全部] [有效 1,250] [错误 6]                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ │行号│状态│员工工号│姓名  │实发金额  │错误原因  │      │ │  │
│  │ ├────┼────┼────────┼──────┼──────────┼──────────┤      │ │  │
│  │ │ 1  │ ✓  │EMP001  │张三  │23,500.00 │-         │      │ │  │
│  │ │ 2  │ ✓  │EMP002  │李四  │24,700.00 │-         │      │ │  │
│  │ │ 15 │ ✗  │EMP015  │-     │18,000.00 │姓名为空  │      │ │  │
│  │ │ 28 │ ✗  │EMP028  │赵六  │-         │金额为空  │      │ │  │
│  │ │ 45 │ ✗  │99999   │孙七  │15,000.00 │UID不存在│      │ │  │
│  │ │ ...                                                   │ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  汇总信息                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 有效记录:    1,250 条                                    │  │
│  │ 总金额:      2,500,000.00 USDT                           │  │
│  │ 平均金额:    2,000.00 USDT                               │  │
│  │ 最大单笔:    85,000.00 USDT                              │  │
│  │ 最小单笔:    500.00 USDT                                 │  │
│  │ Vault余额:   5,000,000.00 USDT ✓                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  [✓] 忽略错误记录，仅导入有效数据 (1,250 条)                  │
│                                                                │
│  [导出错误记录]    [取消]    [确认导入]                        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 错误处理

### 4.1 错误分类

| 错误级别 | 描述 | 处理方式 | 示例 |
|----------|------|----------|------|
| 致命错误 | 文件无法解析 | 阻止导入，提示重新上传 | 文件损坏、格式不支持 |
| 行级错误 | 单条记录验证失败 | 可选择跳过 | 字段为空、格式错误 |
| 警告 | 数据可能有问题 | 允许继续但提示 | 金额异常高/低 |

### 4.2 错误代码表

| 错误代码 | 错误类型 | 错误描述 | 修正建议 |
|----------|----------|----------|----------|
| E001 | 字段错误 | 员工工号为空或格式错误 | 检查A列，确保非空且无特殊字符 |
| E002 | 字段错误 | 员工姓名为空 | 检查B列，填写员工姓名 |
| E004 | 存在性错误 | 用户UID在系统中不存在 | 核对D列UID是否正确 |
| E005-E008 | 数值错误 | 金额字段格式错误或为负 | 确保为非负数字 |
| E009 | 范围错误 | 实发金额超出限额 | 检查I列金额是否合理 |
| E010 | 枚举错误 | 币种不支持 | 使用系统支持的币种(USDT等) |
| E011 | 计算错误 | 实发金额与明细计算不符 | 检查公式: 基本+奖金+补贴-扣款=实发 |
| E012 | 重复错误 | 同一用户在文件中出现多次 | 删除重复行 |
| E020 | 资金错误 | Vault余额不足 | 等待资金到账或减少批次金额 |
| E021 | 限额错误 | 超出单批次金额限制 | 拆分为多个批次 |
| E022 | 限额错误 | 超出单批次记录数限制 | 拆分为多个文件 |
| E023 | 业务错误 | 同周期重复发放 | 核实是否已发放过该员工 |
| E024 | 主数据错误 | 员工不存在/状态不可发放 | 到“员工目录与映射”补齐员工或更新状态 |
| E025 | 主数据错误 | 员工工号与UID映射不一致 | 到“员工目录与映射”完成绑定或修正导入UID |

### 4.3 导出错误记录

- 点击「导出错误记录」可下载包含错误行的 Excel 文件
- 导出文件包含原始数据 + 错误原因列
- 用户可在原文件中修正后重新导入

---

## 5. 模板下载与管理

### 5.1 模板下载接口

| 模板 | 接口 | 说明 |
|------|------|------|
| 普通转账模板 | `GET /api/v1/admin/transfer/template?type=transfer` | 5 字段简化版 |
| 薪资发放模板 | `GET /api/v1/admin/transfer/template?type=payroll` | 11 字段完整版 |
| 薪资简化模板 | `GET /api/v1/admin/transfer/template?type=payroll_simple` | 7 字段核心版 |

### 5.2 模板特性

- 所有模板包含表头说明行（第1行）
- 模板包含示例数据行（第2行，可删除）
- 关键列有数据验证（下拉选择币种等）
- 金额列预设数字格式，保留2位小数

---

## 6. 对应后端接口（参考）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/admin/transfer/template` | GET | 下载导入模板 |
| `/api/v1/admin/transfer/import` | POST | 上传并解析 Excel |
| `/api/v1/admin/transfer/import/validate` | POST | 验证导入数据 |
| `/api/v1/admin/transfer/import/confirm` | POST | 确认导入，创建批次 |
| `/api/v1/admin/transfer/import/errors` | GET | 导出错误记录 |

---

> 返回 [转账管理索引](../11-转账管理.md) | 上一篇：[审批流程](./02-审批流程.md) | 下一篇：[异常处理与重试](./04-异常处理与重试.md)
