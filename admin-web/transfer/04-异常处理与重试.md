# 转账管理 / 异常处理与重试

> 返回 [转账管理索引](../11-转账管理.md)

---

## 概述

本文档定义批次执行过程中的异常处理机制，包括错误分类、自动重试策略、部分失败处理和手动干预流程。

---

## 1. 错误分类

### 1.1 错误级别定义

| 错误级别 | 影响范围 | 处理策略 | 是否可重试 |
|----------|----------|----------|------------|
| 致命错误 | 整个批次 | 暂停批次，通知管理员 | 需人工干预 |
| 严重错误 | 整个批次 | 暂停批次，等待资源恢复 | 资源恢复后可重试 |
| 普通错误 | 单条记录 | 标记失败，继续处理其他记录 | 可单条重试 |
| 可恢复错误 | 单条记录 | 自动重试 | 自动重试 |

### 1.2 错误类型详表

| 错误代码 | 错误类型 | 级别 | 描述 | 自动重试 | 处理方式 |
|----------|----------|------|------|----------|----------|
| F001 | 系统不可用 | 致命 | 区块链节点无响应 | 否 | 暂停批次，告警 |
| F002 | 配置错误 | 致命 | 热钱包配置异常 | 否 | 暂停批次，检查配置 |
| S001 | 资金不足 | 严重 | Vault 余额不足 | 否 | 暂停批次，等待充值 |
| S002 | Gas 不足 | 严重 | 热钱包 Gas 不足 | 否 | 暂停批次，补充 Gas |
| E001 | 地址无效 | 普通 | 用户钱包地址格式错误 | 否 | 标记失败，需修正 |
| E002 | 用户状态异常 | 普通 | 用户已禁用/注销 | 否 | 标记失败，跳过 |
| E003 | 金额异常 | 普通 | 金额超出单笔限额 | 否 | 标记失败，需修正 |
| R001 | 网络超时 | 可恢复 | 请求超时 | 是 (3次) | 自动重试 |
| R002 | 节点繁忙 | 可恢复 | 节点返回限流错误 | 是 (5次) | 自动重试，退避 |
| R003 | 交易 Pending | 可恢复 | 交易未确认 | 是 | 等待确认 |

---

## 2. 自动重试机制

### 2.1 重试策略

| 错误类型 | 重试次数 | 重试间隔 | 退避策略 |
|----------|----------|----------|----------|
| 网络超时 (R001) | 3 次 | 30 秒 | 固定间隔 |
| 节点繁忙 (R002) | 5 次 | 60 秒起 | 指数退避 (60s → 120s → 240s) |
| 交易 Pending (R003) | 持续 | 30 秒 | 固定间隔，最长等待 30 分钟 |

### 2.2 重试流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 执行转账  │ →  │ 发生错误  │ →  │ 判断类型  │ →  │ 可重试？  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                   │是    │否
                                                   ▼      ▼
                                            ┌──────────┐ ┌──────────┐
                                            │ 等待间隔  │ │ 标记失败  │
                                            └──────────┘ └──────────┘
                                                   │
                                                   ▼
                                            ┌──────────┐
                                            │ 重试执行  │ ─→ [重试次数未超限则继续]
                                            └──────────┘
```

### 2.3 重试状态显示

```
┌────────────────────────────────────────────────────────────────┐
│  批次执行中 - P202512001                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  进度: 892/1,256  成功: 880  失败: 2  重试中: 10              │
│  ████████████████████████████████████░░░░░░░░░░  71%          │
│                                                                │
│  重试队列 (10)                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ │员工工号│姓名  │金额      │错误类型│重试次数│下次重试│  │  │
│  │ ├────────┼──────┼──────────┼────────┼────────┼─────────┤  │  │
│  │ │EMP156  │陈小华│22,500    │网络超时│2/3     │30秒后   │  │  │
│  │ │EMP234  │周小明│18,000    │节点繁忙│3/5     │2分钟后  │  │  │
│  │ │...                                                    │  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 3. 部分失败处理

### 3.1 批次完成状态

| 完成状态 | 条件 | UI 显示 |
|----------|------|---------|
| 已完成 | 100% 成功 | ✓ 绿色 |
| 部分完成 | 成功 > 0，失败 > 0 | ⚠️ 橙色 |
| 失败 | 100% 失败 或 致命错误 | ✗ 红色 |

### 3.2 失败记录处理界面

```
┌────────────────────────────────────────────────────────────────┐
│  失败记录处理 - P202512001                                 [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  批次执行完成，存在失败记录需要处理                            │
│                                                                │
│  执行统计                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 成功: 1,250 (99.5%)  ████████████████████████████████░  │  │
│  │ 失败: 6 (0.5%)                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  失败明细                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ │☐│员工工号│姓名  │金额      │失败原因      │操作      │  │  │
│  │ ├──┼────────┼──────┼──────────┼──────────────┼──────────┤  │  │
│  │ │☐│EMP234  │王小明│15,000    │地址格式错误  │[修正地址]│  │  │
│  │ │☐│EMP567  │李小红│18,000    │超过重试次数  │[重试]    │  │  │
│  │ │☐│EMP789  │张小军│12,000    │用户已禁用    │[跳过]    │  │  │
│  │ │☐│EMP891  │赵小丽│25,000    │余额不足      │[等待]    │  │  │
│  │ │...                                                    │  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  [☐ 全选]  [批量重试]  [导出失败记录]  [标记批次完成]         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```




### 3.3 失败处理操作

| 操作 | 适用场景 | 说明 |
|------|----------|------|
| 修正地址 | 地址格式错误 | 修正后可重试 |
| 重试 | 网络/节点临时故障 | 立即重新执行 |
| 跳过 | 用户状态异常 | 标记跳过，不再处理 |
| 等待 | 余额不足 | 等待资源恢复后重试 |
| 批量重试 | 多条可重试记录 | 批量执行重试 |

### 3.4 修正地址流程

```
┌────────────────────────────────────────┐
│  修正用户地址                      [×]  │
├────────────────────────────────────────┤
│                                        │
│  员工工号: EMP234                      │
│  员工姓名: 王小明                      │
│  当前地址: 0x123...（格式错误）        │
│                                        │
│  新地址 *                              │
│  [0x1234567890abcdef...]               │
│                                        │
│  ⚠️ 请确认新地址正确，修正后将重试转账  │
│                                        │
│         [取消]    [保存并重试]         │
│                                        │
└────────────────────────────────────────┘
```

---

## 4. 批次暂停与恢复

### 4.1 暂停触发条件

| 条件 | 自动暂停 | 需人工恢复 |
|------|----------|------------|
| Vault 余额不足 | 是 | 是（充值后） |
| 热钱包 Gas 不足 | 是 | 是（补充后） |
| 区块链节点不可用 | 是 | 是（恢复后） |
| 连续失败超过阈值 | 是 | 是（确认后） |
| 手动暂停 | - | 是 |

### 4.2 暂停状态界面

```
┌────────────────────────────────────────────────────────────────┐
│  批次已暂停 - P202512001                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ⚠️ 批次执行已暂停                                             │
│                                                                │
│  暂停原因: Vault USDT 余额不足                                 │
│  暂停时间: 2025-12-15 14:30:00                                 │
│                                                                │
│  执行进度                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 已处理: 892/1,256                                        │  │
│  │ 成功: 890                                                │  │
│  │ 失败: 2                                                  │  │
│  │ 待处理: 364                                              │  │
│  │ 已使用金额: 1,780,000 USDT                               │  │
│  │ 剩余所需: 720,000 USDT                                   │  │
│  │ 当前Vault余额: 500,000 USDT ✗                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  [取消批次]    [资金已到位，继续执行]                          │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 5. 告警与通知

### 5.1 告警触发条件

| 事件 | 告警级别 | 通知对象 | 通知方式 |
|------|----------|----------|----------|
| 批次执行失败 | 严重 | 创建人 + 管理员 | 系统消息 + 邮件 |
| 批次暂停 | 严重 | 创建人 + 财务 | 系统消息 + 邮件 |
| 失败率超过 5% | 警告 | 创建人 | 系统消息 |
| 单条重试超过 3 次 | 警告 | 创建人 | 系统消息 |
| Vault 余额低于阈值 | 严重 | 财务 + 管理员 | 系统消息 + 邮件 |

### 5.2 告警消息示例

```
┌────────────────────────────────────────┐
│  ⚠️ 批次执行异常告警                   │
├────────────────────────────────────────┤
│                                        │
│  批次: P202512001 - 2025年12月工资     │
│  时间: 2025-12-15 14:30:00             │
│  状态: 已暂停                          │
│  原因: Vault USDT 余额不足             │
│                                        │
│  已处理: 892/1,256 (70.9%)             │
│  剩余所需: 720,000 USDT                │
│                                        │
│  [查看详情]    [处理]                  │
│                                        │
└────────────────────────────────────────┘
```

---

## 6. 对应后端接口（参考）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/admin/transfer/batches/{id}/retry` | POST | 重试失败记录 |
| `/api/v1/admin/transfer/batches/{id}/retry-all` | POST | 批量重试所有失败 |
| `/api/v1/admin/transfer/batches/{id}/pause` | POST | 暂停批次执行 |
| `/api/v1/admin/transfer/batches/{id}/resume` | POST | 恢复批次执行 |
| `/api/v1/admin/transfer/batches/{id}/cancel` | POST | 取消批次 |
| `/api/v1/admin/transfer/batches/{id}/users/{uid}/fix` | PUT | 修正用户信息 |
| `/api/v1/admin/transfer/batches/{id}/users/{uid}/skip` | POST | 跳过用户 |

---

> 返回 [转账管理索引](../11-转账管理.md) | 上一篇：[导入模板与验证](./03-导入模板与验证.md) | 下一篇：[审计日志](./05-审计日志.md)