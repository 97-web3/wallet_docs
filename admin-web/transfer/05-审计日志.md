# 转账管理 / 审计日志

> 返回 [转账管理索引](../11-转账管理.md)

---

## 概述

本文档定义薪资发放模块的审计日志功能，包括日志记录范围、日志字段、查询界面和合规报表导出。审计日志是企业薪资发放合规性的核心保障。

---

## 1. 审计日志范围

### 1.1 记录的操作类型

| 操作类别 | 操作类型 | 操作代码 | 记录详情 |
|----------|----------|----------|----------|
| 批次管理 | 创建批次 | BATCH_CREATE | 批次名称、类型、记录数、总金额 |
| 批次管理 | 修改批次 | BATCH_UPDATE | 修改前后对比 |
| 批次管理 | 删除批次 | BATCH_DELETE | 批次信息快照 |
| 批次管理 | 提交审批 | BATCH_SUBMIT | 提交人、提交时间 |
| 审批流程 | 审批通过 | APPROVAL_APPROVE | 审批人、审批级别、备注 |
| 审批流程 | 审批拒绝 | APPROVAL_REJECT | 审批人、拒绝原因 |
| 审批流程 | 审批撤回 | APPROVAL_WITHDRAW | 撤回人、撤回原因 |
| 执行操作 | 开始执行 | EXEC_START | 执行人、执行时间 |
| 执行操作 | 暂停执行 | EXEC_PAUSE | 暂停原因 |
| 执行操作 | 恢复执行 | EXEC_RESUME | 恢复人 |
| 执行操作 | 取消执行 | EXEC_CANCEL | 取消原因、已执行数量 |
| 执行操作 | 执行完成 | EXEC_COMPLETE | 成功/失败统计 |
| 记录操作 | 单条重试 | RECORD_RETRY | 重试原因 |
| 记录操作 | 修正地址 | RECORD_FIX | 修改前后地址 |
| 记录操作 | 跳过记录 | RECORD_SKIP | 跳过原因 |
| 数据导入 | 导入文件 | IMPORT_FILE | 文件名、记录数、验证结果 |
| 数据导出 | 导出报表 | EXPORT_REPORT | 导出类型、时间范围 |

### 1.2 审计日志字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 日志唯一ID |
| timestamp | datetime | 是 | 操作时间（精确到毫秒） |
| operatorId | string | 是 | 操作人ID |
| operatorName | string | 是 | 操作人姓名 |
| operatorRole | string | 是 | 操作人角色 |
| operatorIp | string | 是 | 操作人IP地址 |
| actionCode | string | 是 | 操作代码 |
| actionName | string | 是 | 操作名称 |
| targetType | string | 是 | 目标类型（batch/record） |
| targetId | string | 是 | 目标ID |
| targetName | string | 否 | 目标名称 |
| beforeData | json | 否 | 操作前数据快照 |
| afterData | json | 否 | 操作后数据快照 |
| remark | string | 否 | 操作备注 |
| result | string | 是 | 操作结果（success/fail） |
| errorMessage | string | 否 | 错误信息（失败时） |

---

## 2. 审计日志界面

### 2.1 日志列表

```
┌────────────────────────────────────────────────────────────────┐
│  审计日志                                                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  筛选条件                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 时间范围: [2025-12-01] 至 [2025-12-15]                   │  │
│  │ 操作类型: [全部        ▼]  操作人: [全部        ▼]       │  │
│  │ 批次ID:   [______________]  关键词: [______________]     │  │
│  │                                                          │  │
│  │ [重置]  [查询]                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  查询结果: 共 1,256 条记录                    [导出日志]       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ │时间              │操作人│操作类型│目标      │结果│详情│ │  │
│  │ ├──────────────────┼──────┼────────┼──────────┼────┼────┤ │  │
│  │ │12-15 14:30:00    │张三  │审批通过│P202512001│成功│[>] │ │  │
│  │ │12-15 14:25:00    │李四  │提交审批│P202512001│成功│[>] │ │  │
│  │ │12-15 14:20:00    │李四  │创建批次│P202512001│成功│[>] │ │  │
│  │ │12-15 10:00:00    │王五  │执行完成│P202511001│成功│[>] │ │  │
│  │ │12-14 16:30:00    │王五  │单条重试│R20251101 │成功│[>] │ │  │
│  │ │...                                                    │ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  [< 上一页]  第 1 页 / 共 126 页  [下一页 >]                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 2.2 日志详情

```
┌────────────────────────────────────────────────────────────────┐
│  审计日志详情                                              [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  基本信息                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 日志ID:     LOG-20251215-143000-001                      │  │
│  │ 操作时间:   2025-12-15 14:30:00.123                      │  │
│  │ 操作人:     张三 (finance_manager)                       │  │
│  │ IP地址:     192.168.1.100                                │  │
│  │ 操作类型:   审批通过 (APPROVAL_APPROVE)                  │  │
│  │ 操作结果:   成功                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  目标信息                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 目标类型:   批次 (batch)                                 │  │
│  │ 目标ID:     P202512001                                   │  │
│  │ 目标名称:   2025年12月工资                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  操作详情                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 审批级别:   L2 (财务经理)                                │  │
│  │ 审批意见:   金额核对无误，同意发放                       │  │
│  │ 批次金额:   2,500,000.00 USDT                            │  │
│  │ 批次人数:   1,256 人                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│                                              [关闭]            │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```


---

## 3. 合规报表

### 3.1 报表类型

| 报表名称 | 报表代码 | 周期 | 内容 |
|----------|----------|------|------|
| 薪资发放汇总表 | RPT_PAYROLL_SUMMARY | 月度 | 发放金额、人数统计 |
| 审批流程记录表 | RPT_APPROVAL_FLOW | 月度 | 所有审批操作记录 |
| 异常处理记录表 | RPT_EXCEPTION | 月度 | 失败、重试、跳过记录 |
| 操作员活动报表 | RPT_OPERATOR_ACTIVITY | 月度 | 各操作员操作统计 |
| 资金流向报表 | RPT_FUND_FLOW | 月度 | 资金来源与去向 |

### 3.2 薪资发放汇总表示例

```
┌────────────────────────────────────────────────────────────────┐
│  薪资发放汇总表 - 2025年12月                                   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  报表期间: 2025-12-01 至 2025-12-31                            │
│  生成时间: 2025-12-31 18:00:00                                 │
│  生成人:   系统自动                                            │
│                                                                │
│  汇总统计                                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 发放批次数:     3 批                                     │  │
│  │ 发放总人数:     3,768 人                                 │  │
│  │ 发放总金额:     7,536,000.00 USDT                        │  │
│  │ 成功笔数:       3,760 笔 (99.8%)                         │  │
│  │ 失败笔数:       8 笔 (0.2%)                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.3 报表导出

| 导出格式 | 适用场景 | 说明 |
|----------|----------|------|
| Excel (.xlsx) | 财务存档 | 包含多个工作表，可编辑 |
| PDF | 审计提交 | 带水印，不可编辑 |
| CSV | 数据分析 | 纯数据，便于导入其他系统 |

---

## 4. 数据保留策略

### 4.1 保留期限

| 数据类型 | 保留期限 | 说明 |
|----------|----------|------|
| 审计日志 | 7 年 | 符合财务合规要求 |
| 批次数据 | 7 年 | 包含完整发放记录 |
| 操作快照 | 3 年 | beforeData/afterData |
| 导入文件 | 1 年 | 原始 Excel 文件 |

### 4.2 数据归档

- 超过 1 年的数据自动归档到冷存储
- 归档数据仍可查询，但响应时间较长
- 归档数据不可修改或删除

---

## 5. 权限控制

### 5.1 审计日志访问权限

| 角色 | 查看日志 | 导出日志 | 查看敏感信息 |
|------|----------|----------|--------------|
| hr_staff | 本人操作 | 否 | 否 |
| hr_manager | 全部 | 是 | 否 |
| finance_staff | 本人操作 | 否 | 否 |
| finance_manager | 全部 | 是 | 是 |
| cfo | 全部 | 是 | 是 |
| admin | 全部 | 是 | 是 |
| auditor | 全部 | 是 | 是 |

### 5.2 敏感信息脱敏

- 普通角色查看时，员工姓名显示为 `张*`
- 普通角色查看时，金额显示为 `***,***.00`
- 具有敏感信息权限的角色可查看完整信息

---

## 6. 对应后端接口（参考）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/admin/audit/logs` | GET | 查询审计日志列表 |
| `/api/v1/admin/audit/logs/{id}` | GET | 获取日志详情 |
| `/api/v1/admin/audit/logs/export` | POST | 导出审计日志 |
| `/api/v1/admin/audit/reports` | GET | 获取合规报表列表 |
| `/api/v1/admin/audit/reports/{code}` | GET | 获取指定报表 |
| `/api/v1/admin/audit/reports/{code}/export` | POST | 导出报表 |

---

> 返回 [转账管理索引](../11-转账管理.md) | 上一篇：[异常处理与重试](./04-异常处理与重试.md) | 下一篇：[性能与限制](./06-性能与限制.md)
