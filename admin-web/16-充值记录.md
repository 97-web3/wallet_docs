# 充值记录

> 返回 [后台管理前端目录](./README.md)
>
> 关联页面：[05-账本与交易](./05-账本与交易.md)

---

## 页面概述

- **页面路径**: `/admin/ledger` → 充值记录 Tab
- **权限要求**: Admin 或 Finance 角色
- **主要功能**: 查看和管理用户充值记录，处理充值异常

---

## 1. 充值记录筛选

**UI 组件**:
- **Select**: 链、状态、币种筛选
- **DatePicker.RangePicker**: 日期范围
- **Input**: 用户 UID / 交易哈希搜索
- **Button**: 搜索、重置、导出

**筛选条件**:
| 字段 | 组件 | 选项 |
|------|------|------|
| 链 | Select | 全部、TRX、ETH、BSC、Polygon |
| 币种 | Select | 全部、USDT、USDC、TRX、ETH、BNB、MATIC |
| 状态 | Select | 全部、待确认、确认中、已到账、失败 |
| 金额级别 | Select | 全部、普通（<$1,000）、大额（≥$1,000）、超大额（≥$10,000） |
| 日期范围 | RangePicker | 充值时间范围 |
| 关键词 | Input | 用户 UID / 交易哈希 |

---

## 2. 充值记录列表

**表格列**:
| 列名 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 交易哈希 | tx_hash | 150px | 链上交易哈希（缩略+复制） |
| 用户UID | user_id | 80px | 关联用户 |
| 金额 | amount | 120px | 充值金额和币种 |
| 入账USDT | amount_usdt | 120px | 入账时的USDT等值金额 |
| 当前价值 | current_value_usdt | 120px | 当前USDT价值（非USDT币种） |
| 价值变化 | value_change | 100px | 价值变化百分比和金额 |
| 链 | chain | 60px | 区块链网络 |
| 确认数 | confirmations | 80px | 当前/需要确认数 |
| 状态 | status | 100px | 充值状态标签 |
| 时间 | created_at | 160px | 检测到时间 |
| 操作 | - | 120px | 查看/手动确认 |

**充值状态标签**:
| 状态 | 颜色 | 说明 |
|------|------|------|
| pending | 灰色 | 待确认（刚检测到） |
| confirming | 蓝色 | 确认中（等待区块确认） |
| completed | 绿色 | 已到账 |
| failed | 红色 | 失败（链上失败/超时） |

**大额标记**:
| 金额级别 | 标记 | 说明 |
|----------|------|------|
| < $1,000 | - | 普通充值 |
| ≥ $1,000 | 🔶 | 大额充值 |
| ≥ $10,000 | 🔴 | 超大额充值（自动通知） |

**列表展示示意**:
```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│ 充值记录                                                               [导出]          │
├────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                        │
│ 统计卡片                                                                              │
│ [今日充值: 125 笔]  [待确认: 8]  [大额充值: 3]  [异常: 1]                             │
│                                                                                        │
│ ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ │交易哈希  │用户  │金额       │入账USDT │当前价值 │变化   │链 │确认│状态│时间│操作│ │
│ │ ├──────────┼──────┼───────────┼─────────┼─────────┼───────┼───┼────┼────┼────┼────┤ │
│ │ │0x1a2b... │10001 │🔴50,000   │50,000   │50,000   │0%     │ETH│20/20│完成│14:30│[详]│ │
│ │ │          │      │USDT       │         │         │       │   │    │    │    │    │ │
│ │ │T9yD14... │10002 │🔶100 ETH  │200,000  │215,000  │+7.5%  │ETH│20/20│完成│14:25│[详]│ │
│ │ │          │      │           │         │         │+15,000│   │    │    │    │    │ │
│ │ │0xabc1... │10003 │500 USDT   │500      │500      │0%     │BSC│0/15│待确│14:20│[详]│ │
│ │ │0xdef2... │10004 │1,000 USDT │1,000    │-        │-      │ETH│-   │失败│14:15│[处]│ │
│ │ ...                                                                                │ │
│ └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 充值详情

**详情内容示意**:
```
┌────────────────────────────────────────┐
│  充值详情                         [×]  │
├────────────────────────────────────────┤
│                                        │
│  基本信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 交易哈希:   0x1a2b3c...  [复制]  │  │
│  │ 链:         ETH                  │  │
│  │ 代币合约:   0xdac17... [复制]    │  │
│  │ 金额:       100.00 ETH           │  │
│  │ 状态:       已到账               │  │
│  │ 检测时间:   2025-12-10 14:30:00  │  │
│  │ 到账时间:   2025-12-10 14:35:00  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  价值追踪                              │
│  ┌──────────────────────────────────┐  │
│  │ 入账汇率:   $2,000/ETH           │  │
│  │ 入账价值:   $200,000 USDT        │  │
│  │ 当前汇率:   $2,150/ETH           │  │
│  │ 当前价值:   $215,000 USDT        │  │
│  │ 价值变化:   +$15,000 (+7.5%) 📈  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  用户信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 用户UID:    10001                │  │
│  │ 手机号:     138****1234          │  │
│  │ 充值地址:   0xUser...   [复制]   │  │
│  └──────────────────────────────────┘  │
│                                        │
│  链上信息                              │
│  ┌──────────────────────────────────┐  │
│  │ From:       0xSender... [复制]   │  │
│  │ To:         0xUser...   [复制]   │  │
│  │ 区块高度:   18456789             │  │
│  │ 确认数:     20/20 ✓              │  │
│  │ Gas Fee:    0.003 ETH ($6.45)    │  │
│  │ [在Etherscan查看 ↗]              │  │
│  └──────────────────────────────────┘  │
│                                        │
│  状态变更记录                          │
│  ┌──────────────────────────────────┐  │
│  │ ● 14:35 已到账                   │  │
│  │ │                                │  │
│  │ ○ 14:32 确认中 (15/20)           │  │
│  │ │                                │  │
│  │ ○ 14:30 待确认 (检测到充值)       │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

**价值追踪说明**:
- **入账汇率**: 充值检测到时的代币/USDT汇率
- **入账价值**: 按入账汇率折算的USDT等值金额
- **当前汇率**: 实时代币/USDT汇率
- **当前价值**: 按当前汇率折算的USDT等值金额
- **价值变化**: 当前价值与入账价值的差额和百分比
- 注: USDT充值不显示价值追踪（汇率恒为1:1）

**代币合约地址说明**:
- 原生代币（ETH、TRX、BNB等）: 不显示合约地址
- ERC20/TRC20/BEP20代币: 显示代币合约地址
- 可点击复制，便于在区块链浏览器中查询

---

## 4. 异常处理

**功能描述**: 处理充值异常情况

**异常类型**:
| 异常类型 | 说明 | 处理方式 |
|----------|------|----------|
| 超时未确认 | 超过预期时间未达到确认数 | 手动确认/标记失败 |
| 金额异常 | 到账金额与预期不符 | 人工核查 |
| 地址不匹配 | 充值地址未关联用户 | 手动关联 |

**异常处理对话框示意**:
```
┌────────────────────────────────────────┐
│  处理充值异常                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  交易: 0xdef2...                       │
│  异常: 链上确认失败                    │
│                                        │
│  处理方式 *                            │
│  [○ 手动确认到账                      ]│
│  [○ 标记为失败                        ]│
│  [○ 待进一步核查                      ]│
│                                        │
│  处理说明 *                            │
│  [________________________]            │
│                                        │
│  ⚠️ 手动确认将直接入账，请确认已核实   │
│                                        │
│         [取消]    [提交处理]           │
│                                        │
└────────────────────────────────────────┘
```

---

## 5. 账本中的充值入账示例（双重记账）

**说明**: 下方示例展示了用户充值在 Web2 账本中的借贷记账方式，对应“充值记录”中状态为成功且已入账的场景。

**账本条目示例**:
```
┌────────────────────────────────────────────────────────────────────┐
│ 账本记录 - 充值入账示例                                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 交易: 用户 10001 充值 5,000 USDT                                   │
│                                                                    │
│ │ 账户           │ 类型 │ 金额         │ 余额         │           │
│ │ Vault-TRX-USDT │ 借方 │ +5,000 USDT  │ 105,000 USDT │           │
│ │ User-10001-USDT│ 贷方 │ +5,000 USDT  │ 15,000 USDT  │           │
│                                                                    │
│ 借方合计: 5,000 USDT = 贷方合计: 5,000 USDT ✓                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```


---

## 6. 数据字段说明

### 6.1 核心字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| tx_hash | string | 链上交易哈希 | 0x1a2b3c4d... |
| user_id | number | 用户UID | 10001 |
| token_symbol | string | 代币符号 | ETH, USDT, TRX |
| chain | string | 区块链网络 | ETH, TRX, BSC |
| token_contract_address | string | 代币合约地址（原生币为空） | 0xdac17f958d2ee523a2206206994597c13d831ec7 |
| amount | decimal | 充值金额 | 100.00 |
| amount_usdt | decimal | 入账时USDT等值 | 200000.00 |
| credited_rate | decimal | 入账时汇率 | 2000.00 |
| from_address | string | 发送方地址 | 0xSender... |
| to_address | string | 充值地址 | 0xUser... |
| block_number | number | 区块高度 | 18456789 |
| confirmations | number | 当前确认数 | 20 |
| required_confirmations | number | 需要确认数 | 20 |
| status | enum | 状态 | pending, confirming, completed, failed |
| gas_fee | decimal | Gas费用 | 0.003 |
| gas_fee_currency | string | Gas费币种 | ETH |
| error_message | string | 错误信息（失败时） | Transaction reverted |
| created_at | timestamp | 检测时间 | 2025-12-10 14:30:00 |
| completed_at | timestamp | 完成时间 | 2025-12-10 14:35:00 |

### 6.2 计算字段（实时）

| 字段名 | 计算方式 | 说明 |
|--------|----------|------|
| current_rate | 实时API | 当前代币/USDT汇率 |
| current_value_usdt | amount × current_rate | 当前USDT价值 |
| value_change_amount | current_value_usdt - amount_usdt | 价值变化金额 |
| value_change_percentage | (value_change_amount / amount_usdt) × 100 | 价值变化百分比 |

**注**: USDT充值的汇率恒为1.0，不显示价值变化

---

## 7. 汇率折算规则

### 7.1 入账汇率获取

充值检测到时，系统自动获取并记录当时的汇率：

| 代币类型 | 汇率来源 | 更新频率 | 缓存时间 |
|----------|----------|----------|----------|
| USDT | 固定 1.0 | - | - |
| ETH, TRX, BNB等 | Debank API | 实时 | 30秒 |
| ERC20/TRC20代币 | Debank API | 实时 | 30秒 |

### 7.2 价值折算示例

**示例1: ETH充值**
```
充值金额: 100 ETH
入账汇率: $2,000/ETH
入账价值: 100 × 2,000 = $200,000 USDT

当前汇率: $2,150/ETH
当前价值: 100 × 2,150 = $215,000 USDT

价值变化: +$15,000 (+7.5%)
```

**示例2: USDT充值**
```
充值金额: 50,000 USDT
入账汇率: $1.0/USDT
入账价值: 50,000 × 1.0 = $50,000 USDT

当前汇率: $1.0/USDT
当前价值: 50,000 × 1.0 = $50,000 USDT

价值变化: $0 (0%)
```

### 7.3 汇率容差处理

对于接近最小充值金额的充值，系统给予5%的汇率容差：

```
最小充值要求: 10 USDT等值
容差范围: 9.5 - 10.5 USDT

示例:
充值 50 TRX，汇率 $0.19/TRX
等值 = 50 × 0.19 = $9.5 USDT
判定: 在容差范围内，允许入账
```

> 返回 [后台管理前端目录](./README.md)
