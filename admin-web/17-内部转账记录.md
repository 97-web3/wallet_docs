# 内部转账记录

> 返回 [后台管理前端目录](./README.md)
>
> 关联页面：[05-账本与交易](./05-账本与交易.md)

---

## 页面概述

- **页面路径**: `/admin/ledger` → 内部转账记录 Tab
- **权限要求**: Admin 或 Finance 角色
- **主要功能**: 查看用户之间的**内部转账**记录，追踪状态、过期机制、通知发送与关联账本交易

---

## 1. 内部转账记录筛选

**UI 组件**:
- **Select**: 状态、币种筛选
- **DatePicker.RangePicker**: 日期范围（转账发起时间）
- **Input**: 用户搜索（发送方/接收方 UID 或用户名）、转账 ID
- **InputNumber / Input**: 转账金额范围（最小/最大）
- **Button**: 搜索、重置、导出

**筛选条件**:
| 字段 | 组件 | 选项/说明 |
|------|------|----------|
| 状态 | Select | 全部、待输入密码、已完成 |
| 币种 | Select | 全部、USDT、USDC、TRX、ETH、BNB、MATIC |
| 日期范围 | RangePicker | 转账发起时间范围（`created_at`） |
| 用户 | Input | 支持搜索：发送方 UID/用户名 或 接收方 UID/用户名 |
| 金额范围 | Input | 最小金额 ~ 最大金额（按币种展示，范围筛选不做汇率换算） |
| 转账ID | Input | 精确/模糊搜索内部转账记录 ID（`transfer_id`） |

**筛选区布局示意**:
```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│ 内部转账记录                                                                            │
├────────────────────────────────────────────────────────────────────────────────────────┤
│ 状态: [全部▼]   币种: [全部▼]   日期: [2025-12-01] ~ [2025-12-14]                      │
│ 用户: [发送方/接收方 UID 或 用户名____________________]   转账ID: [___________]         │
│ 金额: [最小____] ~ [最大____]                                      [搜索] [重置] [导出] │
└────────────────────────────────────────────────────────────────────────────────────────┘
```

**状态映射（后端枚举 → 中文）**:
| status | 中文显示 | 说明 |
|--------|----------|------|
| pending_pass | 待输入密码 | 等待发送方输入支付密码后继续 |
| completed | 已完成 | 转账成功完成（发送方扣款、接收方入账） |

**说明**:
- 本页面不包含“领取/确认”流程：发送方验证通过后，转账**立即到账**，状态直接进入 `已完成`。

---

## 2. 内部转账记录列表

**表格列**:
| 列名 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 转账ID | transfer_id | 100px | 内部转账记录 ID（可复制） |
| 发送方 | sender | 160px | 发送方 UID + 用户名 |
| 接收方 | receiver | 160px | 接收方 UID + 用户名 |
| 转账金额 | amount | 140px | 金额 + 币种（`amount` + `symbol`） |
| 状态 | status | 110px | 状态标签 |
| 发起时间 | created_at | 160px | 转账发起时间 |
| 操作 | - | 120px | 查看详情 |

**状态标签（建议展示样式）**:
| 中文状态 | 建议颜色 | 说明 |
|----------|----------|------|
| 待输入密码 | 黄色 | 等待发送方输入支付密码 |
| 已完成 | 绿色 | 已完成 |

**列表展示示意**:
```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│ 内部转账记录                                                               [导出]      │
├────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                            
│ ┌──────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ │转账ID│发送方           │接收方           │转账金额      │状态      │发起时间        │操作│ │
│ │ ├──────┼─────────────────┼─────────────────┼──────────────┼────────┼───────────────┼───────────────┼────┤ │
│ │ │90001 │10001 / alice    │10002 / bob      │50.00 USDT    │已完成    │2025-12-14 10:20│[详]│ │
│ │ │90002 │10003 / carol    │10004 / dave     │2.50 ETH      │已完成    │2025-12-14 09:10│[详]│ │
│ │ │90003 │10005 / erin     │10006 / frank    │100.00 USDC   │待输入密码│2025-12-14 08:55│[详]│ │
│ │ ...                                                                                  │ │
│ └──────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                            
└────────────────────────────────────────────────────────────────────────────────────────┘
```

**字段展示规则**:
- **发送方/接收方**: 统一展示 `UID / username`，用于快速核对双方身份。
- **转账金额**: 仅展示内部转账的原始金额与币种，不展示任何折算/等值金额。

---

## 3. 内部转账详情

**详情信息分区**:
- **基本信息**: 转账 ID、币种、转账金额、状态、发起时间、最后更新时间
- **发送方信息**: 发送方 UID、用户名
- **接收方信息**: 接收方 UID、用户名
- **转账信息**: 转账备注（memo/message）、是否需要支付密码、冻结/hold ID
- **关联账本交易**: 发送方扣款交易 ID、接收方入账交易 ID（可点击跳转到账本交易详情）
- **通知状态**: 是否已发送通知、通知发送时间

**详情内容示意**:
```
┌──────────────────────────────────────────────┐
│  内部转账详情                           [×]  │
├──────────────────────────────────────────────┤
│                                              │
│  基本信息                                    │
│  ┌────────────────────────────────────────┐  │
│  │ 转账ID:       90002              [复制]│  │
│  │ 币种:         ETH                       │  │
│  │ 转账金额:     2.50 ETH                  │  │
│  │ 状态:         已完成                    │  │
│  │ 发起时间:     2025-12-14 09:10:00       │  │
│  │ 最后更新时间: 2025-12-14 09:10:05       │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  发送方信息                                  │
│  ┌────────────────────────────────────────┐  │
│  │ UID:        10003                       │  │
│  │ 用户名:     carol                       │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  接收方信息                                  │
│  ┌────────────────────────────────────────┐  │
│  │ UID:        10004                       │  │
│  │ 用户名:     dave                        │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  转账信息                                    │
│  ┌────────────────────────────────────────┐  │
│  │ 转账备注:    午餐AA                      │  │
│  │             (支持多行展示)               │  │
│  │ 支付密码:    需要                         │  │
│  │ 冻结ID:      hold_8f31c2...       [复制]│  │
│  └────────────────────────────────────────┘  │
│                                              │
│  关联账本交易                                │
│  ┌────────────────────────────────────────┐  │
│  │ 发送方扣款交易ID:  781230   [查看账本]  │  │
│  │ 接收方入账交易ID:  781231   [查看账本]  │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  通知状态                                    │
│  ┌────────────────────────────────────────┐  │
│  │ 是否已通知接收方:  是                    │  │
│  │ 通知时间:          2025-12-14 09:10:10  │  │
│  └────────────────────────────────────────┘  │
│                                              │
└──────────────────────────────────────────────┘
```

**关键机制说明**:
- **支付密码要求**: `need_pass` 用于提示该笔内部转账是否要求发送方输入支付密码；若状态停留在 `待输入密码`，通常表示未完成验证。
- **账本关联**: `sender_transaction_id` 与 `receiver_transaction_id` 用于关联 Web2 账本的扣款/入账流水；在详情中建议以“可点击链接”跳转到账本交易详情。
- **通知追踪**: `notification_sent` 与 `notification_sent_at` 用于反映是否已向接收方发送通知（仅做追踪展示，不影响资金入账结果）。

---

## 4. 异常处理

**功能描述**: 覆盖内部转账在不同状态下可能出现的异常与边界情况，便于运营/财务人员定位问题。

**常见异常与处理建议**:
| 异常类型 | 表现 | 建议处理 |
|----------|------|----------|
| 长时间停留待输入密码 | 状态一直为 `待输入密码` | 核对发送方是否完成支付密码验证；必要时让用户重新发起或取消（如产品支持） |
| 关联账本交易缺失 | 详情中某一侧交易 ID 为空/不可跳转 | 以转账 ID 核对账本流水；如出现单边入账/扣款需人工对账处理 |
| 冻结ID异常 | `hold_id` 为空或不符合预期 | 可能为钱包服务返回异常或流程未走完；建议联系后端核查冻结/解冻流程日志 |
| 通知未发送 | `notification_sent = 0` | 核对通知通道是否异常；可由运维/后端排查通知服务，并根据业务策略补发 |

**边界说明**:
- 本页面仅描述**内部转账（off-chain）**记录，不涉及任何链上信息（如交易哈希、区块高度、确认数、Gas 等）。
- 本页面不展示汇率折算与等值金额；内部转账以原始币种与金额为准。
