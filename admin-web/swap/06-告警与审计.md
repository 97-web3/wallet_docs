# Swap / 告警与审计（Ops, Risk & Compliance）

> 返回 [Swap 配置索引](../06-Swap配置.md)

---

## 定位

面向运维、风控、合规的后台能力：
- Provider/价格来源异常告警
- 风控阈值（限额、敏感操作校验）
- 审计日志与变更追踪

---

## 1. 告警（Alerting）

### 1.1 告警类型（建议）

- Provider 不可用/降级（成功率下降、超时激增）
- 配额耗尽/触发限流（429）
- 折算价格来源异常（更新失败、偏差超阈值）
- Swap 失败率异常、平均滑点异常
- 单日/单小时成交量异常（可疑行为信号）

### 1.2 告警渠道（联动系统设置）

- Email
- Webhook
- IM/机器人（如企业微信/钉钉/Telegram Bot，按公司规范）

> 文档映射：告警通知渠道通常在系统设置中配置；Swap 文档中需要明确“哪些告警会触发、触发阈值、接收人配置位置”。

### 1.3 告警阈值、责任人、处置动作（建议默认值）

> 说明：以下为“建议默认值”，上线前需结合真实 Provider SLA、配额与业务量校准。
| 告警 | 建议触发条件（示例） | 默认责任人 | 处置动作（SOP） |
|---|---|---|---|
| Provider 调用失败率升高 | 5min 失败率 > X% 或错误码集中 | 值班/后端 | 先看 trace_id 采样 → 对照 Provider 错误码 → 触发降级/切换 |
| 折算价源异常 | deviation_threshold 超阈、价格过期 | 风控/后端 | 查看折算价源 → 切 fallback_behavior → 暂停相关交易对 |
| Provider 不可用 | 连续失败次数达到阈值或成功率显著下降 | Ops | 立即降级/切换备用 Provider；若无备用则暂停相关 Pair |
| Provider 限流/配额耗尽 | 出现大量 429 或用量达到上限阈值 | Ops | 降低该 Provider 权重/优先级；切换备用；申请提额或调整限流 |
| Provider 延迟飙升 | P95 延迟超过阈值持续一段时间 | Ops | 降级该 Provider；检查网络连通与超时/重试策略 |
| 折算价格来源异常 | 连续更新失败或数据陈旧超过有效期 | Ops + Finance | 切换备用价格来源；必要时启用缓存；若影响限额则临时收紧风控 |
| 折算价格偏差超阈值 | 多来源偏差超过 `deviation_threshold` | Finance + Risk | 冻结异常来源；使用可信来源；复核统计与对账口径 |
| Swap 失败率异常 | 某链/某 Pair/某 Provider 失败率异常上升 | Ops + Risk | 定位失败原因分类；必要时暂停 Pair 或 Provider |
| 平均滑点异常 | 平均滑点或价格影响异常上升 | Risk | 收紧滑点上限/暂停高风险 Pair；排查流动性与路由 |
| 成交量异常 | 单小时/单日成交量异常波动 | Risk + Finance | 触发额外验证/限额；检查可疑地址与异常交易对 |

### 1.4 处置 SOP（最小步骤）

1. 确认范围：链/Provider/Pair/时间窗口。
2. 定位原因：配额/超时/错误码/链上失败/价格源异常。
3. 采取动作：降级/切换/暂停，并记录原因（reason）。
4. 复盘：在审计日志中记录变更 diff；输出一条事件总结给相关团队。

---

## 2. 风控与敏感操作

### 2.1 建议纳入 Swap 全局风控项

- `min_swap_amount_usd` / `max_swap_amount_usd`
- `daily_limit_usd`（全局或分层：按链/按用户）
- `high_value_threshold_usd`
- `require_2fa_above_usd`

#### 2.1.1 SRD 字段对齐（来源：`GET/PUT /api/v1/admin/swap/config`）

| UI/文档字段 | SRD 路径 | 备注 |
|---|---|---|
| 单笔最小额（USD） | global_settings.min_swap_amount_usd | 折算口径 |
| 单笔最大额（USD） | global_settings.max_swap_amount_usd | 折算口径 |
| 每日限额（USD） | global_settings.daily_limit_usd | 折算口径 |
| 高额阈值（USD） | risk_settings.high_value_threshold_usd | 与 SRD 一致 |
| 超阈 2FA（USD） | risk_settings.require_2fa_above_usd | 与 SRD 一致 |

### 2.2 紧急开关（Emergency Pause）

- 全局暂停 Swap
- 按 Provider 暂停
- 按 Token / Pair 暂停

---

## 3. 审计日志（Audit Log）

### 3.1 必记录事件（建议）

- Provider 启用/禁用、优先级调整、限流/超时参数修改
- Token 上下架、swap_enabled 切换、合约地址变更
- 费率/折算配置变更
- 风控阈值与紧急开关变更

### 3.2 日志字段（建议）

- 操作人、角色、IP、时间
- 变更前/变更后（diff）
- 变更原因（reason）
- 审批流信息（如敏感变更需审批）

---

## 4. 权限控制（建议）

- Admin：可配置 Provider/Token/费率/风控
- Finance：只读统计与导出（如需要）
- SuperAdmin：敏感配置审批与紧急开关（如适用）

> 具体权限矩阵以系统设置的 RBAC 文档为准。

---

> 返回 [Swap 配置索引](../06-Swap配置.md)
