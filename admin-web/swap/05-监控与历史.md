# Swap / 监控与历史（Transaction Monitoring & Records）

> 返回 [Swap 配置索引](../06-Swap配置.md)

---

## 定位

本部分用于运营、风控、财务进行：
- Swap 订单查询与定位问题
- 状态追踪与失败分析
- 数据导出与对账支持

---

## 1. Swap 历史列表

### 1.1 筛选条件（迁移自原 06 文档并增强）

- 链/网络：TRX、ETH、BSC、Polygon…
- Provider：全部 / 1inch / 0x / …
- 状态：成功/失败/处理中（建议扩展为 quoting/quoted/processing/completed/failed/cancelled）
- 日期范围：交易时间
- 用户 UID：支持精确搜索
- 交易对：From/To token

### 1.2 表格列（建议最小集）

| 列 | 说明 |
|---|---|
| swap_id | Swap 记录 ID |
| user_id | 用户 UID |
| From / To | 卖出/买入代币与数量 |
| Provider | 使用的 Provider/Channel |
| 折算金额 | 按计价币种折算后的金额（用于限额/对账） |
| fee | 平台费（展示币种与折算） |
| slippage | 实际滑点 |
| status | 订单状态 |
| created_at | 创建时间 |
| 操作 | 查看详情 |

> 注意：这里的“折算金额”属于价值展示与对账口径，请使用“折算”术语。

---

## 2. Swap 详情抽屉

### 2.1 详情内容（迁移自原 06 文档，并补充排障字段）

- 交易信息：swap_id、user_id、时间、状态
- 兑换详情：卖出/买入、成交价、滑点设置/实际滑点、价格影响
- Provider 信息：provider、请求 trace_id、耗时、Provider 错误码（失败时）
- 路由路径：Provider 返回的底层 DEX 路由
- 链上信息：tx_hash、gas/手续费、区块高度、浏览器链接

### 2.2 排障与对账必备字段（建议在详情中强制展示）

| 字段 | 目的 |
|---|---|
| quote_id（如后端提供） | 关联一次报价与后续执行，用于复现与审计 |
| trace_id（推荐；request_id 可作为同义字段） | 贯穿网关/服务/Provider 调用链路 |
| Provider 响应耗时 | 判断是网络问题还是链上问题 |
| Provider 错误码/错误信息 | 快速定位限流、签名、参数校验等问题 |
| 折算金额（USD/USDT） | 限额判断与财务对账口径 |
| 平台费（币种 + 折算） | 收入核对与异常排查 |
| 预期 vs 实际成交对比 | 识别滑点/价格影响问题 |
| required_confirmations / confirmations | 多链确认策略是否满足 |

---

## 3. 失败分析（建议）

建议在文档中定义“失败原因分类”，以便前后端与运维统一口径：
- QUOTE_EXPIRED（报价过期）
- INSUFFICIENT_BALANCE（余额不足）
- PROVIDER_ERROR（渠道错误：限流/超时/返回异常）
- ONCHAIN_REVERT（链上执行失败）
- NETWORK_UNAVAILABLE（网络/RPC 不可用）

---

## 4. 统计与报表（建议）

- 统计入口：按周期查看 swap 数、成交量、手续费、成功率、平均滑点
- 按网络/按交易对聚合

### 4.1 SRD 字段对齐（来源：`GET /api/v1/admin/swap/statistics`）

| UI/文档字段 | SRD 路径 | 备注 |
|---|---|---|
| 总笔数 | summary.total_swaps | 与 SRD 一致 |
| 总成交量（USD） | summary.total_volume_usd | 折算口径 |
| 总手续费（USD） | summary.total_fee_usd | 折算口径 |
| 平均单笔（USD） | summary.avg_swap_amount_usd | 折算口径 |
| 成功率 | summary.success_rate | 与 SRD 一致 |
| 独立用户数 | summary.unique_users | 与 SRD 一致 |
| 按网络聚合 | by_network[] | 字段见 SRD：`network/swap_count/volume_usd/fee_usd` |
| 按交易对聚合 | by_pair[] | 字段见 SRD：`pair/swap_count/volume_usd` |
| 趋势 | trend[] | 字段见 SRD：`date/swap_count/volume_usd/avg_slippage` |

### 4.2 导出与对账（建议）

- 历史列表支持导出：按时间范围、链、Provider、状态筛选后导出
- 导出字段建议至少包含：swap_id、user_id、from/to、折算金额、fee（折算）、Provider、状态、tx_hash、创建/完成时间

---

## 5. 对应后端接口（参考）

- `GET /api/v1/admin/swap/statistics`
- （历史列表/详情接口如归属“账本与交易”模块，也需在文档中明确映射关系）

> 说明：本文件中“历史列表/详情”的字段（如 swap_id、tx_hash、trace_id 等）属于订单/交易记录域；当前 Swap 配置 SRD 未给出对应接口 Schema，落地时请以“账本与交易”相关 SRD/实现为准。

（详见 `wallet_docs/admin-api/srds/06-Swap配置.md` 与账本相关 SRD）

---

> 返回 [Swap 配置索引](../06-Swap配置.md)
