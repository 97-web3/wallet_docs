# Swap / 费率与折算（Rate & Pricing）

> 返回 [Swap 配置索引](../06-Swap配置.md)

---

## 定位与术语

- **费率（Fee）**：平台服务费、渠道费等，属于结算与对账范畴。
- **折算（Conversion/Calculation）**：用于价值展示与限额判断的计价/换算逻辑（例如折算为 USD/USDT）。

> 约定：在“价值追踪、限额、统计、对账”的语境下，统一使用 **折算**，避免与“兑换（Swap 执行）”混用。

---

## 1. 平台费率配置

### 1.1 配置项（建议）

- 费率结构：
  - 无服务费
  - 固定比例（例如 0.25%）
  - 阶梯费率（按金额/用户等级/时间段）
- 费率下限：`fee_min_usd`（避免小额交易费率过低）
- 收费币种与扣费方式（需要在文档明确）：
  - 从卖出币种扣除 / 从买入币种扣除 / 单独收取
  - 以折算 USD 进行阈值判断

### 1.2 示例（折算口径）

- 单笔折算金额：$A$（USD）
- 平台费率：$r$（例如 0.25%）
- 最小费用：$f_{min}$（USD）

平台费用（USD）：

$$
fee_{usd} = \max(A \cdot r, f_{min})
$$

---

### 1.3 SRD 字段对齐（来源：`GET/PUT /api/v1/admin/swap/config`）

| UI/文档字段 | SRD 路径 | 备注 |
|---|---|---|
| Swap 总开关 | global_settings.swap_enabled | 与 SRD 一致 |
| 单笔最小额（USD） | global_settings.min_swap_amount_usd | 折算口径：USD/USDT（按系统约定） |
| 单笔最大额（USD） | global_settings.max_swap_amount_usd | 同上 |
| 每日限额（USD） | global_settings.daily_limit_usd | 同上 |
| 平台费率 | global_settings.fee_rate | 例如 0.25% |
| 最小费用（USD） | global_settings.fee_min_usd | 与 SRD 一致 |

## 2. 折算与价格来源配置

### 2.1 价格有效期与刷新

- `price_settings.price_validity_seconds`：报价/折算价格的有效期（`/api/v1/admin/swap/config`）
- `update_interval_seconds`：折算价格的更新间隔（`/api/v1/admin/swap/rates/config`，用于展示/统计/限额）

### 2.2 价格来源与降级

- `price_settings.price_source`: aggregated / dex / coingecko / coinmarketcap / binance（示例；`/api/v1/admin/swap/config`）
- `price_settings.fallback_sources`: 当主来源不可用时的备用来源列表（`/api/v1/admin/swap/config`）
- `fallback_behavior`: 例如 use_cache（使用缓存）/ fail_closed（失败拒绝）（`/api/v1/admin/swap/rates/config`）

#### 2.2.1 SRD 字段对齐（来源：`GET /api/v1/admin/swap/rates/config`）

| UI/文档字段 | SRD 路径 | 备注 |
|---|---|---|
| 主折算来源 | primary_source | 与 SRD 一致（aggregated/coingecko/...） |
| 来源列表 | sources[] | 每个来源含 `enabled/priority/weight/api_status/rate_limit/last_update` |
| 更新间隔 | update_interval_seconds | 影响展示/统计/限额的折算数据刷新 |
| 偏差阈值 | deviation_threshold | 触发告警/降级策略 |
| 回退行为 | fallback_behavior | 例如 use_cache / fail_closed |

### 2.3 偏差阈值（Deviation）

- `deviation_threshold`: 多来源折算价格偏差超过阈值时触发告警或降级（`/api/v1/admin/swap/rates/config`）
- 建议在文档中写明：
  - 偏差阈值的作用范围（展示/限额/风控）
  - 触发后的行为（仅告警 / 自动切换来源 / 暂停特定 Provider）

---

## 3. 第三方 API 状态（沿用既有面板，但语义升级）

原文档中的“1inch API / Uniswap API / PancakeSwap API 状态”，建议调整为：
- **Provider API**（聚合通道）状态
- **Price Source API**（折算价格来源）状态

并补充展示：
- 最近一次成功时间
- 错误码摘要
- 当前配额用量

---

## 4. 对应后端接口（参考）

- `GET /api/v1/admin/swap/config`（包含 fee 与折算相关配置）
- `PUT /api/v1/admin/swap/config`
- `GET /api/v1/admin/swap/rates/config`

（详见 `wallet_docs/admin-api/srds/06-Swap配置.md`）

---

> 返回 [Swap 配置索引](../06-Swap配置.md)
