# 人员管理

> 返回 [Admin Web 文档](./README.md) · 上至 [系统设置索引](./07-系统设置.md)

---

## 此处“人员”的含义

此模块管理可以访问 **Admin Web** 的**内部员工身份**（操作员、财务、审计员、租户管理员、平台超级管理员）。

它与以下身份不同：

- Web2 终端用户：`wallet_docs/admin-web/03-用户管理.md`
- Web3 钱包用户：`wallet_docs/admin-web/09-Web3用户管理.md`

---

## 企业目标状态（IAM 基线）

为支持具有严格安全/合规要求的​​多租户组织，人员管理应被指定为一种**身份治理**能力：

- 多租户范围限定（组织/租户隔离 + 可选的平台级超级管理员）
- 基于角色的访问控制 (RBAC) + 数据级范围（保险库、钱包、账户）
- 强大的身份验证策略（MFA、密码策略、会话控制）
- 生命周期工作流（入职/调动/离职）及审批和审计跟踪
- 职责分离 (SoD) 和特权监控

本文档包括：

1) **当前记录的行为**（摘自旧版 `07-系统设置.md` 和 Admin API SRD），以及
2) **建议的企业增强功能**，以弥补差距。

---

## 页面概览（当前）

- **路由 (UI)**: `/admin/settings/admins`
- **当前 SRD 端点**: `wallet_docs/admin-api/srds/07-系统设置.md`
  - `GET /api/v1/admin/settings/admins`
  - `POST /api/v1/admin/settings/admins`
  - `PUT /api/v1/admin/settings/admins/{admin_id}`
  - `POST /api/v1/admin/settings/admins/{admin_id}/disable`
  - `POST /api/v1/admin/settings/admins/{admin_id}/reset-password`
  - `POST /api/v1/admin/settings/change-password`
- **权限（当前 SRD）**:
  - 管理员管理操作需要 `SuperAdmin`（超级管理员）
  - 某些读取操作允许 `Admin`（管理员）

---

## 当前行为摘要（按今日记录）

本节记录了 Admin API SRD 和旧版 Admin Web 文档中已定义的内容。

### 支持的管理员账户生命周期（当前）

- 创建管理员时设置临时密码 + 可选的强制更改密码
- 更新管理员资料字段（姓名、角色、状态）
- 禁用管理员（立即使会话失效）
- 重置管理员密码（SRD 支持通过电子邮件发送）
- 管理员可以更改自己的密码

### 关键防护栏（当前 SRD）

- 不能禁用自己 (`CANNOT_DISABLE_SELF`)
- 不能禁用最后一个超级管理员 (`LAST_SUPER_ADMIN`)
- 用户名必须是有效电子邮件；重复项将被拒绝 (`USERNAME_EXISTS`, `INVALID_EMAIL`)

### 需要解决的已知文档不一致之处

- **单一角色 vs 多个角色**：
  - 旧版 UI 文档暗示 `roles`（多选）
  - SRD 使用 `role`（单个值）
- **谁可以管理管理员**：
  - 旧版 UI 文档称“Admin”（管理员）
  - SRD 要求 `SuperAdmin`（超级管理员）才能创建/禁用/分配

这些不一致被视为**文档/需求差距**，而不是实施假设。

---

## API 参考（当前 SRD，精简版）

权威详情：`wallet_docs/admin-api/srds/07-系统设置.md`。

### 列出管理员

- `GET /api/v1/admin/settings/admins`
- 查询参数（示例）：`page`, `page_size`, `role`, `status`, `keyword`
- 响应包括：`admin_id`, `username`, `name`, `role`, `status`, `two_factor_enabled`, `last_login_at`, `last_login_ip`, `created_at`, `created_by`

### 创建管理员

- `POST /api/v1/admin/settings/admins`
- 请求（关键字段）：`username`, `name`, `role`, `password`, `require_password_change`, `two_factor_required`
- 权限：`SuperAdmin`
- 错误代码：`USERNAME_EXISTS`, `INVALID_EMAIL`, `INVALID_ROLE`

### 更新管理员

- `PUT /api/v1/admin/settings/admins/{admin_id}`
- 请求（关键字段）：`name`, `role`, `status`
- 权限：`SuperAdmin`

### 禁用管理员

- `POST /api/v1/admin/settings/admins/{admin_id}/disable`
- 请求：`reason`
- 权限：`SuperAdmin`
- 错误代码：`CANNOT_DISABLE_SELF`, `LAST_SUPER_ADMIN`

### 重置管理员密码

- `POST /api/v1/admin/settings/admins/{admin_id}/reset-password`
- 请求：`send_email`, `require_change`
- 权限：`SuperAdmin`

### 更改自己的密码

- `POST /api/v1/admin/settings/change-password`
- 请求：`current_password`, `new_password`, `confirm_password`
- 错误代码：`WRONG_CURRENT_PASSWORD`, `PASSWORD_TOO_WEAK`, `PASSWORD_RECENTLY_USED`, `PASSWORD_MISMATCH`

---

## 数据模型（文档规范）

### 1) 租户和组织结构（多租户要求）

> 如果平台当前是单租户，请将本节视为前瞻性模型；不要阻止与租户无关的文档改进。

**租户 / 组织**

| 字段 | 类型 | 约束/备注 |
|---|---|---|
| `tenant_id` | string | 不可变主键 |
| `tenant_name` | string | 显示名称 |
| `status` | enum | `active`（激活）, `suspended`（暂停）, `deactivated`（停用） |
| `created_at/by` | datetime/string | 审计 |

**部门（组织单元）**

| 字段 | 类型 | 约束/备注 |
|---|---|---|
| `department_id` | string | 主键 |
| `tenant_id` | string | 外键 |
| `name` | string | 在同一父级下对租户唯一 |
| `parent_department_id` | string? | 用于层级结构 |
| `path` | string | 用于快速查询的物化路径（推荐） |
| `status` | enum | `active`（激活）, `archived`（归档） |

**汇报关系/审批链（推荐）**

| 字段 | 类型 | 备注 |
|---|---|---|
| `manager_admin_id` | string | 直属经理 |
| `approval_chain` | array | 访问请求的审批人列表 |

### 2) 管理员身份（内部用户）

**AdminUser**

| 字段 | 类型 | 约束/备注 |
|---|---|---|
| `admin_id` | string | 主键；例如 `admin-10001` (SRD) |
| `username` | string | 当前 SRD 使用 email 作为 username；唯一 |
| `display_name` | string | 人名 |
| `email` | string | 必需；在租户内唯一（或绝对唯一） |
| `phone` | string? | 可选；E.164 格式 |
| `employee_id` | string? | 可选；在租户内唯一（推荐） |
| `department_id` | string? | 外键（推荐） |
| `position_title` | string? | 可选 |
| `status` | enum | `active`（激活）, `disabled`（禁用）, `locked`（锁定）, `pending_activation`（待激活） |
| `two_factor_enabled` | boolean | 在 SRD 中 |
| `two_factor_required` | boolean | 在 SRD 创建请求中 |
| `last_login_at` | datetime? | 在 SRD 中 |
| `last_login_ip` | string? | 在 SRD 中 |
| `created_at/by` | datetime/string | 在 SRD 中 |
| `updated_at/by` | datetime/string | 推荐 |
| `disabled_at/by` | datetime/string? | 在 SRD 禁用响应中 |

### 3) 角色分配和范围

**AdminRoleAssignment**

| 字段 | 类型 | 约束/备注 |
|---|---|---|
| `admin_id` | string | 外键 |
| `role_code` | string | 例如 `super_admin`, `admin`, `finance` (SRD) |
| `tenant_id` | string? | 多租户范围限定所需 |
| `status` | enum | `active`（激活）, `expired`（过期）, `revoked`（撤销） |
| `effective_from/to` | datetime? | 用于临时角色 |
| `reason` | string | 审计必需 |
| `approved_by` | string? | 用于工作流限制的变更 |

**DataScope（范围）（推荐）**

使用范围来避免“角色爆炸”（按团队划分的角色）。示例：

- `vault_ids[]`: 可以查看/操作哪些保险库
- `chain_ids[]`: 可以配置哪些链
- `business_units[]`: 用于报告和审批的业务分区

### 4) 身份验证和会话

**MFA 设备**

| 字段 | 类型 | 备注 |
|---|---|---|
| `mfa_device_id` | string | 主键 |
| `admin_id` | string | 外键 |
| `type` | enum | `totp`, `webauthn`, `sms` (不推荐), `backup_codes`（备用码） |
| `added_at` | datetime | - |
| `last_used_at` | datetime? | - |

**AdminSession（管理员会话）（推荐）**

| 字段 | 类型 | 备注 |
|---|---|---|
| `session_id` | string | 主键 |
| `admin_id` | string | 外键 |
| `created_at` | datetime | - |
| `expires_at` | datetime | - |
| `ip` | string | - |
| `user_agent` | string | - |
| `revoked_at/by` | datetime/string? | 用于强制登出 |

**LoginAttempt（登录尝试）（推荐）**

| 字段 | 类型 | 备注 |
|---|---|---|
| `admin_id` | string | 外键 |
| `attempted_at` | datetime | - |
| `ip` | string | - |
| `result` | enum | `success`（成功）, `failure`（失败） |
| `failure_reason` | string? | 例如 密码错误、MFA 失败 |

**PasswordHistory（密码历史）（推荐）**

| 字段 | 类型 | 备注 |
|---|---|---|
| `admin_id` | string | 外键 |
| `password_hash` | string | 存储哈希；绝不存储明文 |
| `set_at` | datetime | - |
| `set_by` | string | `self` 或管理员 ID（重置） |

---

## UI / UX 规范

### 管理员列表（当前“管理员列表”）

**主要操作**：

- 创建管理员
- 编辑管理员
- 禁用/启用管理员
- 重置密码

**表格列**（按旧文件记录）：

| 列 | 字段 | 备注 |
|---|---|---|
| 用户名 | `username` | 登录标识符 |
| 姓名 | `name` | 显示名称 |
| 角色(s) | `roles` | 旧文档暗示多角色；SRD 当前使用单个 `role` |
| 状态 | `status` | 激活/禁用 |
| 上次登录 | `last_login_at` | - |
| 上次 IP | `last_login_ip` | - |
| 操作 | - | 编辑、禁用、重置密码 |

### 创建管理员（当前）

创建表单字段（与 SRD 对齐）：

- `username` (电子邮件)
- `name`
- `role`
- `password` (临时)
- `require_password_change` (要求更改密码)
- `two_factor_required` (需要双因素认证)

推荐的 UI 附加项（企业基线）：

- 租户选择（如果是多租户）
- 部门/职位/员工 ID
- “在访问前要求 MFA 注册”复选框
- IP 白名单绑定（可选）

### 编辑管理员（当前）

旧文档：可编辑字段包括姓名、角色、电子邮件、状态；用户名不可编辑。

推荐的防护栏：

- 阻止禁用自己
- 阻止禁用最后一个 `super_admin`
- 对敏感操作强制重新身份验证（密码/MFA）

---

## 推荐的企业规模 UI 附加项

### 管理员详情视图（推荐）

添加一个详情抽屉/页面，以减少不安全的内联编辑并集中审计能力。

**部分**：

- 资料：身份、租户、部门、员工 ID
- 访问：角色(s)、范围、SoD 警告、上次访问审查日期
- 身份验证：MFA 状态、已注册因素、上次凭证更改
- 会话：活动会话和“撤销”操作
- 活动：过滤到此管理员的最后 N 个审计事件

### 组织结构（部门）（推荐）

提供一个部门管理屏幕，以支持汇报线和审批：

- 创建/编辑/归档部门
- 拖放层级结构（带循环预防）
- 将管理员分配给部门

### 批量操作（推荐）

- 批量导入（CSV）：创建/更新管理员；可选的邀请模式
- 批量角色分配/范围分配
- 批量禁用（离职事件）

批量功能的文档要求：

- CSV 模板和严格的验证规则
- 行级错误报告和安全的重新运行语义
- 每个记录的审计日志 + 批次摘要事件

### 访问请求 UI（推荐）

- IP 白名单管理（按管理员和/或按租户）
- 基于时间的访问窗口（工作时间）
- 地理限制（如果由风险引擎支持）

---

## 访问请求和审批（推荐）

为了在没有操作瓶颈的情况下支持最小权限原则，记录（并理想情况下提供）一个访问请求流程：

1. **请求者**选择目标访问权限（角色和/或范围），提供业务理由，并提供可选的工单 ID。
2. **审批人**审查请求（根据策略，可能是经理 + 安全/租户管理员）。
3. **配置**应用角色/范围，并设置有效窗口；高风险请求可能需要二次验证。
4. **端到端**记录审计证据（请求、审批、配置、过期/撤销）。
5. **过期**自动撤销临时访问并记录更改。

边缘规则：

- SoD 冲突请求应被阻止或需要特殊批准。
- 对特权角色的请求应需要更强的身份验证和更严格的网络策略。

---

## 生命周期工作流（入职/调动/离职）

### 1) 入职（推荐）

1. 通过邀请（电子邮件链接）或直接创建来创建管理员。
2. 分配初始角色(s) + 数据范围。
3. 在首次登录时要求 MFA 注册。
4. 如果使用了临时密码，则要求更改密码。
5. 记录创建 + 分配 + 激活的审计事件。

推荐的变体：

- **邀请流程**：管理员收到电子邮件链接；设置密码 + 注册 MFA；账户变为 `active`（激活）。
- **即时 (SSO) 配置**：首次 SSO 登录创建账户；应用默认角色；由 IdP 强制执行 MFA。

### 2) 变更/调动 (Mover)

常见变更：

- 部门/职位变更
- 角色/范围变更
- 临时提升（例如，事件响应窗口）

推荐的治理：

- 要求“理由”
- 针对特权角色的审批工作流
- 有效日期/时间支持

### 3) 离职 (Leaver)

1. 立即禁用账户（强制会话撤销）。
2. 撤销特权范围。
3. 如果适用，转移所有权/审批权（交接）。
4. 保持审计记录不可变；出于合规性，请勿删除身份。

---

## 访问控制和安全控制（企业基线）

### 状态模型

| 状态 | 含义 | 典型触发因素 |
|---|---|---|
| `pending_activation` (待激活) | 已创建但尚未完全注册 | 邀请未接受 / MFA 未注册 |
| `active` (激活) | 可以登录 | 正常 |
| `locked` (锁定) | 暂时阻止 | 登录尝试次数过多 |
| `disabled` (禁用) | 已取消配置 | 离职 / 安全事件 |

### 密码策略（推荐）

- 最低长度：12+
- 复杂性：避免“仅组合”；要求熵并阻止被泄露的密码
- 轮换：仅适用于高风险或受监管环境；首选基于风险的轮换
- 密码历史：禁止最近的 N 个（例如 5 个）

### MFA 策略（必需）

- 对所有管理员强制执行 MFA；对特权角色要求更强的因素。
- 支持至少 TOTP；推荐为超级管理员使用 WebAuthn。

### 会话和并发登录控制（推荐）

- 会话超时（空闲时间 + 绝对时间）
- 每个管理员的最大并发会话数
- 管理员可以撤销自己的会话；超级管理员可以撤销任何会话

### 特权访问和二次验证（推荐）

对于高风险操作（例如，更改费用/限制、编辑 RPC 端点、禁用管理员）：

- 即使会话有效，也要求最近的 MFA（二次验证）
- 要求提供理由，并可选地提供工单/参考 ID
- 应用更严格的 IP/地理/时间策略

### 网络/地理/时间限制（推荐）

- 按管理员、按角色和/或按租户的 IP 白名单/黑名单
- 基于时间的策略（工作时间）
- 高风险操作的地理围栏

---

## 审计和合规性要求

人员管理必须为以下内容生成高质量的审计事件：

- 管理员创建/更新/禁用/重新激活
- 角色/范围分配变更（之前/之后 + 理由 + 审批人）
- 密码重置和凭证更改
- MFA 注册和因素更改
- 会话撤销和特权提升窗口

审计日志应可被 SIEM 消费（推荐：Webhook 导出或计划导出）。

---

## 特权管理员监控（推荐）

对于 `super_admin`（或具有 `settings.write`、密钥管理、费用/限制编辑的任何角色）等角色：

- 专用审计视图（“特权操作”过滤器）
- 对高风险操作（例如，禁用管理员、更改限制、更改 RPC 端点）发出警报
- 定期访问审查及证据导出（谁拥有特权角色以及原因）

---

## 集成点（推荐）

### SSO (SAML/OIDC)

- 支持 IdP（身份提供商）驱动的身份验证，并在 IdP 处强制执行 MFA 策略
- 将 IdP 组映射到角色（以及范围，如果支持）
- 保留本地“紧急出口”账户，用于事件恢复（严格限制）

### 自动化配置（SCIM / HRIS / LDAP）

- 通过 SCIM 实现入职/调动/离职自动化
- 属性同步：部门、经理、员工 ID
- 在终止事件时立即取消配置

### 跨模块依赖

- 角色和权限：`wallet_docs/admin-web/07-02-角色权限管理.md`
- 审计证据：`wallet_docs/admin-web/07-05-审计日志.md`
- 全局安全默认设置（超时/锁定/MFA 要求）：`wallet_docs/admin-web/07-03-系统配置.md`

---

## 自助服务功能（推荐）

为管理员添加“我的资料”区域：

- 更新联系信息（需验证）
- 注册/管理 MFA
- 查看活动会话并撤销
- 查看“我的权限”（有效权限）
- 请求额外访问权限（工作流）

---

## 文档完整性清单（按功能使用）

对于文档中添加/更新的每个人员管理功能，请包括：

- 功能描述 + 威胁模型背景（它减少了什么风险）
- 数据模型（字段、约束、关系、保留期）
- UI/UX（列表、详情、表单、操作、确认、理由字段）
- 业务规则（验证、审批、SoD 检查、幂等性）
- API 映射（端点、请求/响应、错误代码）
- 工作流（正常路径 + 回滚路径）
- 边缘情况（自我禁用、最后一个超级管理员、冲突、部分失败）
- 安全注意事项（MFA、会话、IP/地理/时间、日志完整性）

---

## 行业最佳实践基准（IAM）

### Okta / Azure AD / Auth0 对齐（应借鉴的内容）

- 强大的因素强制执行（按组/角色划分的 MFA 策略）
- 中央生命周期：邀请、激活、暂停、停用
- 用于自动化入职/调动/离职的 SCIM 配置（推荐）
- 持续访问评估信号（基于风险的锁定）

### NIST / OWASP 对齐（应要求的内容）

- 特权账户的 MFA
- 敏感操作的重新身份验证
- 暴力破解保护和账户锁定策略
- 安全的会话管理和令牌撤销

### 合规性（SOC 2 / ISO 27001 / GDPR）

- 定义的访问审查流程（定期认证）
- 记录并执行最小权限原则
- 审计保留策略和完整性控制
- 个人数据最小化（仅存储所需的人员数据）

---

## 差距分析报告（当前文档 vs 企业基线）

### 执行摘要

**当前完整性估计（仅限人员管理）**：约 25%（存在基本 CRUD + 禁用/重置；治理、多租户、范围、生命周期自动化和合规性工作流基本未记录）。

### 覆盖率记分卡（文档完整性）

| 领域 | 当前覆盖率 | 备注 |
|---|---:|---|
| 账户 CRUD + 禁用/重置 | 高 | SRD 对核心端点很清晰 |
| 组织结构（部门、经理） | 低 | 未记录 |
| MFA 设置、恢复、强制执行 | 低 | 只存在标志；流程缺失 |
| 会话和并发登录控制 | 低 | 未记录 |
| 数据级授权（范围） | 低 | 未记录 |
| 审批工作流（管理员变更、角色变更） | 低 | 未记录 |
| SoD 控制 | 低 | 未记录 |
| 访问审查/认证 | 低 | 未记录 |
| 集成（SSO/SCIM/LDAP） | 低 | 未记录 |

### 差距表

| 优先级 | 能力差距 | 重要性（加密管理员背景） | 推荐的文档新增内容 |
|---|---|---|---|
| 关键 | 多租户身份模型（租户范围限定、隔离） | 防止跨租户数据泄露 | 定义面向租户的管理员身份 + 角色分配模型；添加范围规则 |
| 关键 | 数据级权限（保险库/钱包/账户范围） | 防止对资金和敏感操作的广泛访问 | 添加范围定义、UI 过滤器、分配工作流 |
| 关键 | MFA 策略和注册流程 | 降低特权账户被接管的风险 | 记录 MFA 类型、注册、恢复、强制执行规则 |
| 关键 | 会话管理 + 强制登出 | 事件响应和离职的正确性 | 记录会话列表/撤销、并发限制、超时设置 |
| 关键 | 特权变更的审批工作流 | 双重控制是常见要求 | 记录提议者/审批者步骤、理由字段、审计差异 |
| 关键 | SoD 冲突矩阵 | 防止欺诈/滥用 | 记录冲突的角色/权限以及强制执行行为 |
| 重要 | 批量操作（导入/导出、批量禁用） | 规模化管理效率 | 记录 CSV 模板、验证、回滚和审计日志 |
| 重要 | 访问审查/认证 | 持续风险管理 | 记录定期审查流程、证据导出 |
| 重要 | IP/地理/时间访问策略 | 减少攻击面 | 记录策略、例外情况和监控 |
| 良好 | 自定义用户属性、头像 | UX / 人力资源集成 | 记录可选字段和显示行为 |
| 良好 | 管理员活动仪表板 | 加快调查速度 | 记录“我的最近操作”、“我的访问权限”、异常情况 |

### 最佳实践比较（高层次）

| 标准/平台 | 预期能力 | 当前文档状态 |
|---|---|---|
| Okta / Azure AD | MFA 策略和条件访问 | 部分（仅标志） |
| Okta / Azure AD | 自动化配置 (SCIM) | 缺失 |
| NIST 800-63 / OWASP ASVS | 二次验证以进行敏感操作 | 缺失 |
| SOC 2 / ISO 27001 | 定期访问审查证据 | 缺失 |
| 财务控制 | 双重控制 / SoD | 缺失 |

---

## 文档增强路线图（推荐顺序）

1. **锁定“现状” SRD 对齐**：角色（单选 vs 多选）、权限名称，以及管理员管理权限（超级管理员 vs 管理员）。
2. **添加企业安全基线**：MFA 策略、密码策略、会话控制、强制登出、锁定行为。
3. **添加多租户模型**：管理员、角色和数据访问的租户范围限定；明确租户管理员 vs 平台管理员。
4. **添加数据级范围**：保险库/钱包/账户范围限定、分配 UI 和强制执行规则。
5. **添加生命周期工作流**：入职/邀请、调动流程、离职手册。
6. **添加治理工作流**：特权变更的审批链、SoD 规则、访问请求。
7. **添加合规性操作**：访问审查流程、报告和 SIEM 集成模式。

依赖项：

- 范围和 SoD 依赖于稳定的权限分类法（参见 `wallet_docs/admin-web/07-02-角色权限管理.md`）。
- 审批工作流应重用审计日志架构和理由字段（参见 `wallet_docs/admin-web/07-05-审计日志.md`）。

建议的分阶段（仅文档工作）：

- **阶段 1（第 1-2 周）**：使当前 SRD 与 UI 文档保持一致；明确标记权限和约束；添加端点摘要和错误案例。
- **阶段 2（第 3-4 周）**：记录 MFA + 密码 + 会话策略和生命周期工作流（邀请/离职）。
- **阶段 3（第 2 个月）**：记录多租户模型 + 范围 + 访问策略 UI（IP/时间/地理）并添加 SoD 指南。
- **阶段 4（第 3 个月）**：记录访问审查流程、报告和 SIEM 集成模式。

---

> 返回 [Admin Web 文档](./README.md)