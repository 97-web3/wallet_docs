# 薪资发放

> 返回 [后台管理前端目录](./README.md)

---

## 页面概述

- **页面路径**: `/admin/payroll`
- **权限要求**: Admin 或 Finance 角色
- **主要功能**: 批量薪资导入、数据校验、审批流程、发放执行、日志查询

---

## 页面布局

### 薪资发放主页面结构

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Header                                                                   │
├──────────┬───────────────────────────────────────────────────────────────┤
│          │  Breadcrumb: 首页 / 薪资发放                                   │
│  Sidebar ├───────────────────────────────────────────────────────────────┤
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ Tab 切换                                                  │ │
│          │  │ [新建发放] [待审批] [发放中] [已完成] [发放日志]          │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ════════════════════════════════════════════════════════════ │
│          │                                                                │
│          │  [新建发放] Tab 内容:                                         │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ 步骤指示器                                                │ │
│          │  │ ● 上传文件 → ○ 数据校验 → ○ 预览确认 → ○ 提交审批        │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │                                                          │ │
│          │  │                   📄                                      │ │
│          │  │           拖拽 Excel 文件到此处                           │ │
│          │  │              或 [点击上传]                                │ │
│          │  │                                                          │ │
│          │  │           支持 .xlsx, .xls 格式                          │ │
│          │  │           [下载模板]                                      │ │
│          │  │                                                          │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
└──────────┴───────────────────────────────────────────────────────────────┘
```

### 批次详情页面结构

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Header                                                                   │
├──────────┬───────────────────────────────────────────────────────────────┤
│          │  Breadcrumb: 首页 / 薪资发放 / 批次 #B20251210001             │
│  Sidebar ├───────────────────────────────────────────────────────────────┤
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ 批次信息                                   状态: 待审批   │ │
│          │  │                                                          │ │
│          │  │ 批次号: B20251210001      创建人: admin@company.com      │ │
│          │  │ 创建时间: 2025-12-10 14:30    有效期至: 2025-12-11 14:30│ │
│          │  │ 发放人数: 100 人              发放总额: 500,000 USDT     │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ 发放明细                                [搜索] [导出]     │ │
│          │  ├──────────────────────────────────────────────────────────┤ │
│          │  │ │UID    │姓名  │金额      │币种│状态    │失败原因       │ │
│          │  │ ├───────┼──────┼──────────┼────┼────────┼───────────────┤ │
│          │  │ │10001  │张三  │5,000.00  │USDT│待发放  │-             │ │
│          │  │ │10002  │李四  │3,000.00  │USDT│待发放  │-             │ │
│          │  │ │10003  │王五  │8,000.00  │USDT│校验失败│用户不存在    │ │
│          │  │ ...                                                      │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │               [驳回]                    [审批通过]        │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
└──────────┴───────────────────────────────────────────────────────────────┘
```

---

## 功能模块

### 1. 新建薪资发放

**功能描述**: 通过上传 Excel 文件创建薪资发放批次

**用户角色**: Finance

**流程步骤**:
```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 上传文件 │ → │ 数据校验 │ → │ 预览确认 │ → │ 提交审批 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

#### 1.1 上传文件

**UI 组件**:
- **Upload.Dragger**: 拖拽上传区域
- **Button**: 下载模板按钮

**文件要求**:
| 项目 | 要求 |
|------|------|
| 格式 | .xlsx, .xls |
| 大小 | 最大 10MB |
| 行数 | 最大 10,000 行 |

**Excel 模板格式**:
| 列名 | 字段 | 必填 | 说明 |
|------|------|------|------|
| A | uid | 是 | 用户唯一标识 |
| B | asset | 是 | 币种（USDT/TRX/ETH/BNB） |
| C | amount | 是 | 发放金额 |
| D | memo | 否 | 备注说明 |

**交互说明**:
- 拖拽文件或点击上传
- 上传后自动进入校验步骤
- 文件格式错误显示错误提示

#### 1.2 数据校验

**UI 组件**:
- **Progress**: 校验进度条
- **Table**: 校验结果表格
- **Alert**: 错误汇总提示

**校验规则**:
| 校验项 | 规则 | 错误提示 |
|--------|------|----------|
| UID 存在 | UID 必须为有效用户 | 用户不存在 |
| UID 非重复 | 同批次 UID 不重复 | UID 重复 |
| 用户状态 | 用户非冻结/黑名单 | 用户状态异常 |
| 员工身份 | 用户必须为员工身份 | 非员工用户 |
| 币种有效 | 币种在支持列表内 | 币种无效 |
| 金额范围 | 金额 > 0 | 金额无效 |

**校验结果展示**:
```
┌──────────────────────────────────────────────────────────────────┐
│ 校验结果                                                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ ✓ 校验完成                                                       │
│                                                                  │
│ 总记录数: 100                                                    │
│ ✓ 校验通过: 97                                                   │
│ ✗ 校验失败: 3                                                    │
│                                                                  │
│ ⚠️ 存在校验失败的记录，请处理后继续                               │
│                                                                  │
│ 失败记录:                                                        │
│ │ 行号 │ UID   │ 错误原因         │                              │
│ │ 15   │ 10003 │ 用户不存在       │                              │
│ │ 42   │ 10045 │ 用户状态异常      │                              │
│ │ 78   │ 10001 │ UID 重复（行 5）  │                              │
│                                                                  │
│ [下载失败记录]  [忽略失败继续]  [重新上传]                        │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 1.3 预览确认

**UI 组件**:
- **Statistic**: 汇总统计
- **Table**: 发放明细预览
- **Alert**: 重要提示

**预览内容**:
```
┌──────────────────────────────────────────────────────────────────┐
│ 发放预览                                                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 汇总信息                                                        │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐           │
│ │ 发放人数      │ │ 发放总额      │ │ 平均金额      │           │
│ │ 97 人         │ │ 485,000 USDT  │ │ 5,000 USDT    │           │
│ └───────────────┘ └───────────────┘ └───────────────┘           │
│                                                                  │
│ 币种分布                                                        │
│ │ 币种 │ 人数 │ 金额          │                                 │
│ │ USDT │ 80   │ 400,000.00   │                                 │
│ │ TRX  │ 17   │ 85,000.00    │                                 │
│                                                                  │
│ 发放明细 (前 10 条)                             [查看全部]       │
│ │UID    │ 金额      │ 币种 │ 备注           │                   │
│ │10001  │ 5,000.00  │ USDT │ 12月工资       │                   │
│ │10002  │ 3,000.00  │ USDT │ 12月工资       │                   │
│ ...                                                             │
│                                                                  │
│ ⚠️ 请仔细核对发放信息，提交后将进入审批流程                       │
│                                                                  │
│              [上一步]              [提交审批]                    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 1.4 提交审批

**提交确认对话框**:
```
┌────────────────────────────────────────┐
│  确认提交审批                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  确定提交此薪资发放批次吗？            │
│                                        │
│  发放人数: 97 人                       │
│  发放总额: 485,000.00 USDT            │
│                                        │
│  提交后:                               │
│  • 批次将进入审批队列                  │
│  • 批次有效期为 24 小时                │
│  • 超时未审批将自动作废                │
│                                        │
│         [取消]    [确认提交]           │
│                                        │
└────────────────────────────────────────┘
```

---

### 2. 待审批列表

**功能描述**: 展示待审批的薪资发放批次

**用户角色**: Finance

**UI 组件**:
- **Table**: 批次列表表格
- **Tag**: 状态标签
- **Button**: 操作按钮

**表格列**:
| 列名 | 字段 | 说明 |
|------|------|------|
| 批次号 | batch_id | 批次唯一标识 |
| 创建人 | creator | 创建者邮箱 |
| 发放人数 | count | 发放用户数量 |
| 发放总额 | total_amount | 总金额 |
| 创建时间 | created_at | 批次创建时间 |
| 有效期 | expires_at | 过期时间 |
| 状态 | status | 待审批/审批中 |
| 操作 | - | 查看详情、审批 |

**批次状态**:
| 状态 | 标签颜色 | 说明 |
|------|----------|------|
| pending | 蓝色 | 待审批 |
| reviewing | 黄色 | 审批中 |
| expired | 灰色 | 已过期 |

---

### 3. 批次审批

**功能描述**: 对薪资发放批次进行审批

**用户角色**: Finance（需要非创建人审批）

**UI 组件**:
- **Card**: 批次信息卡片
- **Table**: 发放明细表格
- **Button**: 审批操作按钮

#### 3.1 通过审批

**确认对话框**:
```
┌────────────────────────────────────────┐
│  确认审批通过                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  确定通过此薪资发放批次吗？            │
│                                        │
│  批次号: B20251210001                  │
│  发放人数: 97 人                       │
│  发放总额: 485,000.00 USDT            │
│                                        │
│  通过后将立即执行发放操作              │
│                                        │
│         [取消]    [确认通过]           │
│                                        │
└────────────────────────────────────────┘
```

#### 3.2 驳回审批

**驳回对话框**:
```
┌────────────────────────────────────────┐
│  驳回批次                         [×]  │
├────────────────────────────────────────┤
│                                        │
│  请输入驳回原因 *                      │
│  [________________________]            │
│  [________________________]            │
│                                        │
│  驳回后批次将作废，需重新创建          │
│                                        │
│         [取消]    [确认驳回]           │
│                                        │
└────────────────────────────────────────┘
```

---

### 4. 发放执行与追踪

**功能描述**: 查看发放执行进度和结果

**用户角色**: Admin / Finance

**UI 组件**:
- **Progress**: 发放进度条
- **Table**: 发放明细及状态
- **Statistic**: 成功/失败统计

**发放进度展示**:
```
┌──────────────────────────────────────────────────────────────────┐
│ 发放进度                                                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 批次号: B20251210001                  状态: 发放中              │
│                                                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━░░░░░░░░░░ 75%              │
│                                                                  │
│ 已处理: 73 / 97                                                  │
│ ✓ 成功: 71    ✗ 失败: 2                                         │
│                                                                  │
│ 失败记录:                                                        │
│ │ UID   │ 金额      │ 失败原因              │ 操作             │ │
│ │ 10045 │ 5,000.00  │ 用户钱包状态异常      │ [重试]           │ │
│ │ 10078 │ 3,000.00  │ 系统错误              │ [重试]           │ │
│                                                                  │
│                                   [重试全部失败] [导出结果]      │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

### 5. 发放日志

**功能描述**: 查询历史发放记录

**用户角色**: Admin / Finance

**UI 组件**:
- **DatePicker.RangePicker**: 日期范围选择
- **Select**: 状态筛选
- **Table**: 日志列表
- **Button**: 导出按钮

**筛选条件**:
| 字段 | 组件 | 说明 |
|------|------|------|
| 日期范围 | RangePicker | 创建时间范围 |
| 状态 | Select | 全部/已完成/部分失败/已取消 |
| 批次号 | Input | 精确搜索 |
| 创建人 | Select | 筛选创建人 |

**表格列**:
| 列名 | 字段 | 说明 |
|------|------|------|
| 批次号 | batch_id | 批次唯一标识 |
| 创建人 | creator | 创建者 |
| 审批人 | approver | 审批者 |
| 发放人数 | count | 总人数 |
| 成功/失败 | success/failed | 成功和失败数量 |
| 发放总额 | total_amount | 总金额 |
| 状态 | status | 最终状态 |
| 完成时间 | completed_at | 完成时间 |
| 操作 | - | 查看详情、导出 |

**导出功能**:
- 支持导出为 Excel 格式
- 包含完整的发放明细
- 包含成功/失败记录

---

## UI 组件列表

| 组件名称 | 类型 | 功能说明 |
|----------|------|----------|
| PayrollStepper | Steps | 新建发放步骤指示器 |
| FileUploader | Upload.Dragger | 文件上传区域 |
| ValidationResult | Custom | 校验结果展示 |
| PayrollPreview | Custom | 发放预览组件 |
| BatchList | Table | 批次列表表格 |
| BatchDetail | Card | 批次详情卡片 |
| PayrollProgress | Progress | 发放进度展示 |
| PayrollLogs | Table | 发放日志表格 |
| ApproveModal | Modal | 审批确认对话框 |
| RejectModal | Modal | 驳回对话框 |

---

## 状态与交互

### 批次生命周期

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 草稿    │ → │ 待审批   │ → │ 发放中   │ → │ 已完成   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │
     │              │              ▼
     │              │         ┌─────────┐
     │              │         │ 部分失败 │
     │              │         └─────────┘
     │              ▼
     │         ┌─────────┐
     │         │ 已驳回   │
     │         └─────────┘
     ▼
┌─────────┐
│ 已过期   │ (24小时未审批自动过期)
└─────────┘
```

### 页面状态

| 状态 | 描述 | UI 表现 |
|------|------|---------|
| Uploading | 文件上传中 | 显示上传进度 |
| Validating | 数据校验中 | 显示校验进度 |
| ValidationError | 校验有错误 | 显示错误列表 |
| Previewing | 预览确认 | 显示预览数据 |
| Submitting | 提交审批中 | 按钮 Loading |
| Executing | 发放执行中 | 显示执行进度 |

### 用户操作响应

| 操作 | 成功响应 | 失败响应 |
|------|----------|----------|
| 上传文件 | 进入校验步骤 | Toast 显示错误 |
| 提交审批 | Toast "已提交审批"，跳转待审批列表 | Alert 显示错误 |
| 通过审批 | Toast "审批通过，开始发放" | Alert 显示错误 |
| 驳回审批 | Toast "已驳回" | Alert 显示错误 |

---

## 权限控制

| 功能 | Admin | Finance |
|------|-------|---------|
| 创建薪资批次 | ✓ | ✓ |
| 审批薪资批次 | ✓ | ✓（非创建人） |
| 查看发放日志 | ✓ | ✓ |
| 导出发放记录 | ✓ | ✓ |

---

## 业务规则

### 审批规则

1. **创建人不能自己审批**: 创建人不能审批自己创建的批次
2. **有效期限制**: 批次有效期为 24 小时，超时自动作废
3. **幂等性**: 同一批次不能重复发放

### 金额限制

1. **单笔限制**: 根据系统配置
2. **批次限制**: 根据系统配置
3. **日限额**: 根据系统配置

### 错误处理

1. **部分失败**: 支持重试单条或全部失败记录
2. **系统错误**: 自动重试 3 次后标记为失败
3. **余额不足**: 整批暂停，提示补充 Vault 余额

---

> 返回 [后台管理前端目录](./README.md)
