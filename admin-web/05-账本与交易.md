# 账本与交易

> 返回 [后台管理前端目录](./README.md)

---

## 页面概述

- **页面路径**: `/admin/ledger`
- **权限要求**: Admin 或 Finance 角色
- **主要功能**: 交易历史查询、账本记录管理、充值记录管理、对账工具

---

## 页面布局

### 账本与交易主页面结构

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Header                                                                   │
├──────────┬───────────────────────────────────────────────────────────────┤
│          │  Breadcrumb: 首页 / 账本与交易                                 │
│  Sidebar ├───────────────────────────────────────────────────────────────┤
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ Tab 切换                                                  │ │
│          │  │ [交易历史] [充值记录] [账本查询] [对账工具]               │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ════════════════════════════════════════════════════════════ │
│          │                                                                │
│          │  [交易历史] Tab 内容:                                         │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │ 筛选区域                                                  │ │
│          │  │ [类型▼] [链▼] [状态▼] [日期范围] [UID搜索] [🔍] [重置]   │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
│          │  ┌──────────────────────────────────────────────────────────┐ │
│          │  │                                              [导出]       │ │
│          │  ├──────────────────────────────────────────────────────────┤ │
│          │  │ │交易ID │类型   │用户UID│金额      │链  │状态  │时间  │  │ │
│          │  │ ├───────┼───────┼───────┼──────────┼────┼──────┼──────┤  │ │
│          │  │ │TX001  │充值   │10001  │5,000 USDT│TRX │已完成│12-10 │  │ │
│          │  │ │TX002  │提现   │10002  │3,000 USDT│ETH │处理中│12-10 │  │ │
│          │  │ │TX003  │划转   │10003  │1,000 USDT│-   │已完成│12-10 │  │ │
│          │  │ ...                                                       │ │
│          │  ├──────────────────────────────────────────────────────────┤ │
│          │  │                    < 1 2 3 4 5 ... 10 >                   │ │
│          │  └──────────────────────────────────────────────────────────┘ │
│          │                                                                │
└──────────┴───────────────────────────────────────────────────────────────┘
```

---

## 功能模块

### 1. 交易历史

**功能描述**: 统一展示所有类型的交易记录

**用户角色**: Admin / Finance

#### 1.1 交易列表筛选

**UI 组件**:
- **Select**: 类型、链、状态筛选
- **DatePicker.RangePicker**: 日期范围
- **Input**: 用户 UID / 交易 ID 搜索
- **Button**: 搜索、重置、导出

**筛选条件**:
| 字段 | 组件 | 选项 |
|------|------|------|
| 交易类型 | Select | 全部、入账、出账、内部转账、Swap、薪资、调整 |
| 链 | Select | 全部、TRX、ETH、BSC、Polygon |
| 币种 | Select | 全部、USDT、USDC、TRX、ETH、BNB、MATIC |
| 状态 | Select | 全部、成功、处理中、失败 |
| 日期范围 | RangePicker | 交易时间范围 |
| 金额范围 | InputNumber | 最小/最大金额 |
| 关键词 | Input | 交易 ID 或用户 UID |

#### 1.2 交易列表展示

**表格列**:
| 列名 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 交易ID | tx_id | 120px | 交易唯一标识 |
| 类型 | type | 80px | 交易类型标签 |
| 用户UID | user_id | 80px | 关联用户 |
| 金额 | amount | 120px | 交易金额和币种 |
| 链 | chain | 60px | 区块链（划转为 -） |
| 状态 | status | 80px | 状态标签 |
| 时间 | created_at | 160px | 交易时间 |
| 操作 | - | 100px | 查看详情 |

**交易类型标签**:
| 类型 | 颜色 | 说明 |
|------|------|------|
| inbound | 绿色 | 入账（充值） |
| outbound | 蓝色 | 出账（提现） |
| internal | 紫色 | 内部转账 |
| swap | 橙色 | Swap 兑换 |
| payroll | 黄色 | 薪资发放 |
| adjustment | 灰色 | 调整 |

**交易状态标签**:
| 状态 | 颜色 | 说明 |
|------|------|------|
| success | 绿色 | 成功 |
| processing | 蓝色 | 处理中 |
| failed | 红色 | 失败 |

#### 1.3 交易详情抽屉

**UI 组件**:
- **Drawer**: 抽屉容器
- **Descriptions**: 详情列表
- **Timeline**: 状态变更记录

**详情内容**:
```
┌────────────────────────────────────────┐
│  交易详情                         [×]  │
├────────────────────────────────────────┤
│                                        │
│  基本信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 交易ID:     TX001                │  │
│  │ 交易类型:   入账                  │  │
│  │ 交易金额:   5,000.00 USDT        │  │
│  │ 链:         TRX                  │  │
│  │ 状态:       成功                 │  │
│  │ 创建时间:   2025-12-10 10:30:00  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  用户信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 用户UID:    10001                │  │
│  │ 手机号:     138****1234          │  │
│  └──────────────────────────────────┘  │
│                                        │
│  链上信息 (入账/出账/Swap)             │
│  ┌──────────────────────────────────┐  │
│  │ 交易哈希:   3a7b2c...   [复制]   │  │
│  │ From:       T9yD14...   [复制]   │  │
│  │ To:         TAbc12...   [复制]   │  │
│  │ 区块高度:   12345678             │  │
│  │ 确认数:     20                   │  │
│  │ 手续费:     2.00 TRX ($0.20)     │  │
│  │ [在浏览器中查看 ↗]               │  │
│  └──────────────────────────────────┘  │
│                                        │
│  备注/Memo                             │
│  ┌──────────────────────────────────┐  │
│  │ 用户备注内容（如有）              │  │
│  └──────────────────────────────────┘  │
│                                        │
│  状态变更记录                          │
│  ┌──────────────────────────────────┐  │
│  │ ● 2025-12-10 10:35 成功          │  │
│  │ │                                │  │
│  │ ○ 2025-12-10 10:32 确认中 (15/20)│  │
│  │ │                                │  │
│  │ ○ 2025-12-10 10:30 待确认        │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

**交易详情数据模型**:
```typescript
interface Transaction {
  id: string;
  type: '入账' | '出账' | '内部转账' | 'Swap';
  amount: number;
  currency: string;
  fromAddress: string;
  toAddress: string;
  network: string;
  txHash: string;
  status: '成功' | '处理中' | '失败';
  timestamp: string;
  fee: number;
  feeCurrency: string;
  note?: string;
}
```

**区块链浏览器链接**:
| 链 | 浏览器 | URL 模板 |
|-----|--------|----------|
| TRX | Tronscan | `https://tronscan.org/#/transaction/{hash}` |
| ETH | Etherscan | `https://etherscan.io/tx/{hash}` |
| BSC | BscScan | `https://bscscan.com/tx/{hash}` |

---

### 2. 账本查询

**功能描述**: 查询 Web2 钱包的账本记录（双重记账）

**用户角色**: Admin / Finance

**页面路径**: `/admin/ledger` → 账本查询 Tab

#### 2.1 账本筛选

**筛选条件**:
| 字段 | 组件 | 说明 |
|------|------|------|
| 记录类型 | Select | 全部、借方、贷方 |
| 账户类型 | Select | 全部、用户账户、Vault 账户、手续费账户 |
| 币种 | Select | USDT、TRX、ETH、BNB |
| 日期范围 | RangePicker | 记录时间 |
| 用户UID | Input | 搜索指定用户 |

#### 2.2 账本列表

**表格列**:
| 列名 | 字段 | 说明 |
|------|------|------|
| 记录ID | entry_id | 账本条目 ID |
| 时间 | created_at | 记录时间 |
| 账户 | account | 账户标识 |
| 类型 | type | 借方/贷方 |
| 金额 | amount | 金额 |
| 币种 | asset | 币种 |
| 关联交易 | tx_ref | 关联的交易 ID |
| 余额 | balance_after | 操作后余额 |
| 备注 | memo | 备注说明 |

**账本条目示例**:
```
┌────────────────────────────────────────────────────────────────────┐
│ 账本记录 - 充值入账示例                                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 交易: 用户 10001 充值 5,000 USDT                                   │
│                                                                    │
│ │ 账户           │ 类型 │ 金额         │ 余额         │           │
│ │ Vault-TRX-USDT │ 借方 │ +5,000 USDT  │ 105,000 USDT │           │
│ │ User-10001-USDT│ 贷方 │ +5,000 USDT  │ 15,000 USDT  │           │
│                                                                    │
│ 借方合计: 5,000 USDT = 贷方合计: 5,000 USDT ✓                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3. 充值记录

**功能描述**: 查看和管理用户充值记录，处理充值异常

**用户角色**: Admin / Finance

**页面路径**: `/admin/ledger` → 充值记录 Tab

#### 3.1 充值记录筛选

**UI 组件**:
- **Select**: 链、状态、币种筛选
- **DatePicker.RangePicker**: 日期范围
- **Input**: 用户 UID / 交易哈希搜索
- **Button**: 搜索、重置、导出

**筛选条件**:
| 字段 | 组件 | 选项 |
|------|------|------|
| 链 | Select | 全部、TRX、ETH、BSC、Polygon |
| 币种 | Select | 全部、USDT、USDC、TRX、ETH、BNB、MATIC |
| 状态 | Select | 全部、待确认、确认中、已到账、失败 |
| 金额级别 | Select | 全部、普通（<$1,000）、大额（≥$1,000）、超大额（≥$10,000） |
| 日期范围 | RangePicker | 充值时间范围 |
| 关键词 | Input | 用户 UID / 交易哈希 |

#### 3.2 充值记录列表

**表格列**:
| 列名 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 交易哈希 | tx_hash | 150px | 链上交易哈希（缩略+复制） |
| 用户UID | user_id | 80px | 关联用户 |
| 金额 | amount | 120px | 充值金额和币种 |
| 链 | chain | 60px | 区块链网络 |
| 确认数 | confirmations | 80px | 当前/需要确认数 |
| 状态 | status | 100px | 充值状态标签 |
| 时间 | created_at | 160px | 检测到时间 |
| 操作 | - | 120px | 查看/手动确认 |

**充值状态标签**:
| 状态 | 颜色 | 说明 |
|------|------|------|
| pending | 灰色 | 待确认（刚检测到） |
| confirming | 蓝色 | 确认中（等待区块确认） |
| completed | 绿色 | 已到账 |
| failed | 红色 | 失败（链上失败/超时） |

**大额标记**:
| 金额级别 | 标记 | 说明 |
|----------|------|------|
| < $1,000 | - | 普通充值 |
| ≥ $1,000 | 🔶 | 大额充值 |
| ≥ $10,000 | 🔴 | 超大额充值（自动通知） |

#### 3.3 充值记录列表展示

```
┌──────────────────────────────────────────────────────────────────┐
│ 充值记录                                           [导出]        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 统计卡片                                                        │
│ [今日充值: 125 笔]  [待确认: 8]  [大额充值: 3]  [异常: 1]       │
│                                                                  │
│ ┌──────────────────────────────────────────────────────────────┐ │
│ │ │交易哈希  │用户  │金额       │链  │确认│状态    │时间  │操作│ │
│ │ ├──────────┼──────┼───────────┼────┼────┼────────┼──────┼────┤ │
│ │ │0x1a2b... │10001 │🔴50,000USDT│ETH │20/20│已到账 │14:30│[详]│ │
│ │ │T9yD14... │10002 │🔶2,000 USDT│TRX │19/20│确认中 │14:25│[详]│ │
│ │ │0xabc1... │10003 │500 USDT   │BSC │0/15 │待确认 │14:20│[详]│ │
│ │ │0xdef2... │10004 │1,000 USDT │ETH │-    │失败   │14:15│[处]│ │
│ │ ...                                                          │ │
│ └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 3.4 充值详情抽屉

**详情内容**:
```
┌────────────────────────────────────────┐
│  充值详情                         [×]  │
├────────────────────────────────────────┤
│                                        │
│  基本信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 交易哈希:   0x1a2b3c...  [复制]  │  │
│  │ 链:         ETH                  │  │
│  │ 金额:       50,000.00 USDT 🔴    │  │
│  │ 状态:       已到账               │  │
│  │ 检测时间:   2025-12-10 14:30:00  │  │
│  │ 到账时间:   2025-12-10 14:35:00  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  用户信息                              │
│  ┌──────────────────────────────────┐  │
│  │ 用户UID:    10001                │  │
│  │ 手机号:     138****1234          │  │
│  │ 充值地址:   0xUser...   [复制]   │  │
│  └──────────────────────────────────┘  │
│                                        │
│  链上信息                              │
│  ┌──────────────────────────────────┐  │
│  │ From:       0xSender... [复制]   │  │
│  │ To:         0xUser...   [复制]   │  │
│  │ 区块高度:   18456789             │  │
│  │ 确认数:     20/20 ✓              │  │
│  │ Gas Fee:    0.003 ETH ($6.00)    │  │
│  │ [在浏览器中查看 ↗]               │  │
│  └──────────────────────────────────┘  │
│                                        │
│  状态变更记录                          │
│  ┌──────────────────────────────────┐  │
│  │ ● 14:35 已到账                   │  │
│  │ │                                │  │
│  │ ○ 14:32 确认中 (15/20)           │  │
│  │ │                                │  │
│  │ ○ 14:30 待确认 (检测到充值)       │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

#### 3.5 异常处理

**功能描述**: 处理充值异常情况

**异常类型**:
| 异常类型 | 说明 | 处理方式 |
|----------|------|----------|
| 超时未确认 | 超过预期时间未达到确认数 | 手动确认/标记失败 |
| 金额异常 | 到账金额与预期不符 | 人工核查 |
| 地址不匹配 | 充值地址未关联用户 | 手动关联 |

**异常处理对话框**:
```
┌────────────────────────────────────────┐
│  处理充值异常                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  交易: 0xdef2...                       │
│  异常: 链上确认失败                    │
│                                        │
│  处理方式 *                            │
│  [○ 手动确认到账                      ]│
│  [○ 标记为失败                        ]│
│  [○ 待进一步核查                      ]│
│                                        │
│  处理说明 *                            │
│  [________________________]            │
│                                        │
│  ⚠️ 手动确认将直接入账，请确认已核实   │
│                                        │
│         [取消]    [提交处理]           │
│                                        │
└────────────────────────────────────────┘
```

---

### 4. 账本查询

**功能描述**: 查询 Web2 钱包的账本记录（双重记账）

**用户角色**: Admin / Finance

**页面路径**: `/admin/ledger` → 账本查询 Tab

#### 4.1 账本筛选

**筛选条件**:
| 字段 | 组件 | 说明 |
|------|------|------|
| 记录类型 | Select | 全部、借方、贷方 |
| 账户类型 | Select | 全部、用户账户、Vault 账户、手续费账户 |
| 币种 | Select | USDT、TRX、ETH、BNB |
| 日期范围 | RangePicker | 记录时间 |
| 用户UID | Input | 搜索指定用户 |

#### 4.2 账本列表

**表格列**:
| 列名 | 字段 | 说明 |
|------|------|------|
| 记录ID | entry_id | 账本条目 ID |
| 时间 | created_at | 记录时间 |
| 账户 | account | 账户标识 |
| 类型 | type | 借方/贷方 |
| 金额 | amount | 金额 |
| 币种 | asset | 币种 |
| 关联交易 | tx_ref | 关联的交易 ID |
| 余额 | balance_after | 操作后余额 |
| 备注 | memo | 备注说明 |

**账本条目示例**:
```
┌────────────────────────────────────────────────────────────────────┐
│ 账本记录 - 充值入账示例                                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 交易: 用户 10001 充值 5,000 USDT                                   │
│                                                                    │
│ │ 账户           │ 类型 │ 金额         │ 余额         │           │
│ │ Vault-TRX-USDT │ 借方 │ +5,000 USDT  │ 105,000 USDT │           │
│ │ User-10001-USDT│ 贷方 │ +5,000 USDT  │ 15,000 USDT  │           │
│                                                                    │
│ 借方合计: 5,000 USDT = 贷方合计: 5,000 USDT ✓                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

### 5. 对账工具

**功能描述**: 账本余额与链上余额对账

**用户角色**: Finance

**页面路径**: `/admin/ledger` → 对账工具 Tab

#### 4.1 对账概览

**UI 组件**:
- **Card**: 对账状态卡片
- **Table**: 对账明细
- **Alert**: 差异提醒

**对账结果展示**:
```
┌──────────────────────────────────────────────────────────────────┐
│ 对账结果 - 2025-12-10                              [执行对账]    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 最后对账时间: 2025-12-10 06:00:00                               │
│ 对账结果: ✓ 账实相符                                            │
│                                                                  │
│ 对账明细                                                        │
│ ┌──────────────────────────────────────────────────────────────┐ │
│ │ │账户类型     │币种│账本余额      │链上余额      │差异│状态  │ │
│ │ ├─────────────┼────┼──────────────┼──────────────┼────┼──────┤ │
│ │ │Vault-TRX-Hot│USDT│80,000.00    │80,000.00    │0   │✓ 相符│ │
│ │ │Vault-ETH-Hot│USDT│60,000.00    │60,000.00    │0   │✓ 相符│ │
│ │ │Vault-BSC-Hot│USDT│40,000.00    │40,005.00    │+5  │⚠ 待查│ │
│ │ │用户托管合计 │USDT│500,000.00   │500,000.00   │0   │✓ 相符│ │
│ └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
│ ⚠️ 发现 1 处差异，请核查                                        │
│ [查看差异详情]  [下载对账报告]                                   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 4.2 差异处理

**差异详情对话框**:
```
┌────────────────────────────────────────┐
│  对账差异详情                     [×]  │
├────────────────────────────────────────┤
│                                        │
│  账户: Vault-BSC-Hot-USDT              │
│                                        │
│  账本余额:   40,000.00 USDT           │
│  链上余额:   40,005.00 USDT           │
│  差异金额:   +5.00 USDT (链上多)       │
│                                        │
│  可能原因:                             │
│  • 未入账的充值交易                    │
│  • 手续费返还                          │
│  • 系统未记录的转入                    │
│                                        │
│  近期相关交易:                         │
│  [查看最近 24h BSC 链交易]             │
│                                        │
│  处理方式:                             │
│  [○ 创建调整记录（账本 +5）           ]│
│  [○ 标记为待查                        ]│
│  [○ 忽略（记录原因）                  ]│
│                                        │
│         [取消]    [提交处理]           │
│                                        │
└────────────────────────────────────────┘
```

---

## UI 组件列表

| 组件名称 | 类型 | 功能说明 |
|----------|------|----------|
| TransactionFilter | Form | 交易筛选表单 |
| TransactionTable | Table | 交易列表表格 |
| TransactionDrawer | Drawer | 交易详情抽屉 |
| DepositFilter | Form | 充值记录筛选表单 |
| DepositTable | Table | 充值记录表格 |
| DepositDrawer | Drawer | 充值详情抽屉 |
| DepositExceptionModal | Modal | 充值异常处理对话框 |
| LedgerFilter | Form | 账本筛选表单 |
| LedgerTable | Table | 账本记录表格 |
| ReconcileResult | Card | 对账结果展示 |
| DiscrepancyModal | Modal | 差异处理对话框 |
| ExplorerLink | Link | 区块链浏览器链接 |

---

## 状态与交互

### 页面状态

| 状态 | 描述 | UI 表现 |
|------|------|---------|
| Loading | 数据加载中 | 显示骨架屏 |
| Empty | 无数据 | 显示空状态 |
| Error | 加载失败 | 显示错误提示 |
| Reconciling | 对账执行中 | 显示进度条 |

### 用户操作响应

| 操作 | 成功响应 | 失败响应 |
|------|----------|----------|
| 导出交易 | 开始下载文件 | Toast 显示错误 |
| 调整余额 | Toast "调整已提交" | Alert 显示错误 |
| 执行对账 | 显示对账结果 | Alert 显示错误 |

---

## 权限控制

| 功能 | Admin | Finance |
|------|-------|---------|
| 查看交易历史 | ✓ | ✓ |
| 导出交易记录 | ✓ | ✓ |
| 查看账本记录 | ✓ | ✓ |
| 查看 Vault 余额 | ✓ | ✓ |
| 调整 Vault 余额 | ✓ | （发起） |
| 执行对账 | ✓ | ✓ |
| 处理对账差异 | ✓ | ✓ |

---

## 数据导出

### 支持的导出格式

| 格式 | 说明 |
|------|------|
| Excel (.xlsx) | 完整数据，支持筛选 |
| CSV (.csv) | 纯文本格式 |

### 导出字段

交易历史导出字段：
- 交易ID、类型、用户UID、金额、币种、链
- 状态、创建时间、完成时间
- 交易哈希（链上交易）、手续费

账本记录导出字段：
- 记录ID、时间、账户、类型
- 金额、币种、操作后余额
- 关联交易、备注

---

## 排序与分页

**排序字段**:
- 交易历史：时间、金额、类型、状态、链、确认数
- 账本记录：时间、账户、金额、余额、类型
- 充值记录：时间、金额、链、状态、确认数

**分页**: 显示总数、每页 20/50/100、跨页选择用于导出或批量处理（仅限允许的操作）。

---

## 重组与确认策略

- 确认阈值来自系统设置（各链独立配置）；当链上重组导致确认回退时：
  - 在交易详情与列表上标注“确认回退”状态
  - 自动重新对账并在“对账工具”中记录差异
  - 发出告警（规则见系统设置 → 告警设置）

> 返回 [后台管理前端目录](./README.md)
